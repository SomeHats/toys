function t(t){return t&&t.__esModule?t.default:t}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},s={},i=e.parcelRequire0561;null==i&&((i=function(t){if(t in n)return n[t].exports;if(t in s){var e=s[t];delete s[t];var i={id:t,exports:{}};return n[t]=i,e.call(i.exports,i,i.exports),i.exports}var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(t,e){s[t]=e},e.parcelRequire0561=i);var r=i("aILhO");r=i("aILhO");r=i("aILhO"),r=i("aILhO");const o={};class a{hasScene(){return null!==this.scene}getScene(){return r.assert(this.scene,"scene must be present"),this.scene}draw(t,e){}update(t){}addTo(t){return t.addChild(this),this}onAddedToScene(t){this.scene=t}onRemovedFromScene(){this.scene=null}getSortOrder(){return 0}constructor(){var t;this.id=(t=this.constructor.name,o[t]||(o[t]=0),`${t}@${o[t]++}`),this.scene=null}}var c=i("gJsWu"),h=i("93VSc"),d=i("j18jr");class l{sampleCurveX(t){return((this.ax*t+this.bx)*t+this.cx)*t}sampleCurveY(t){return((this.ay*t+this.by)*t+this.cy)*t}sampleCurveDerivativeX(t){return(3*this.ax*t+2*this.bx)*t+this.cx}solveCurveX(t,e){let n=t;for(let s=0;s<l.NEWTON_METHOD_ITERATIONS;s++){let s=this.sampleCurveX(n);if(d.approxEq(s,t,e))return n;let i=this.sampleCurveDerivativeX(n);if(d.approxEq(i,0,1e-6))break;n-=(s-t)/i}let s=0,i=1;if(n=t,n<s)return s;if(n>i)return i;for(;s<i;){let r=this.sampleCurveX(n);if(d.approxEq(r,t,e))return n;t>r?s=n:i=n,n=(i-s)/2+s}return n}solve(t,e=l.DEFAULT_EPSILON){return this.sampleCurveY(this.solveCurveX(t,e))}constructor(t,e,n,s){const i=3*t,r=3*(n-t)-i,o=3*e,a=3*(s-e)-o;this.ax=1-i-r,this.bx=r,this.cx=i,this.ay=1-o-a,this.by=a,this.cy=o}}l.NEWTON_METHOD_ITERATIONS=8,l.DEFAULT_EPSILON=1e-6;const u=t=>t,g=t=>Math.sin(t/1*(.5*Math.PI)),_=(t=1.70158)=>e=>1*e*e*((t+1)*e-t);d=i("j18jr"),h=i("93VSc"),c=i("gJsWu"),d=i("j18jr");class m extends a{update(t){const e=t/this._duration;this._progress=Math.min(1,this._progress+e),this._circle=this._circle.withRadius(d.lerp(this._startRadius,this._endRadius,this._easeRadius(this._progress))),1===this._progress&&this._removeOnComplete&&this.getScene().removeChild(this)}draw(t){t.beginPath();const e=this._easeOpacity(this._progress);t.fillStyle=this._color.fade(e).toString(),h.circle(t,this._circle.center.x,this._circle.center.y,this._circle.radius),t.fill()}constructor({x:t,y:e,startRadius:n,endRadius:s,duration:i,color:r,easeRadius:o=u,easeOpacity:a=u,removeOnComplete:h=!1}){super(),this._circle=new c.default(t,e,n),this._startRadius=n,this._endRadius=s,this._duration=i,this._color=r,this._progress=0,this._easeRadius=o,this._easeOpacity=a,this._removeOnComplete=h}}var p=i("11cc8");new(t(p))("#F8FFE5");const f=new(t(p))("#06D6A0"),S=(new(t(p))("#1B9AAA"),new(t(p))("#EF476F")),T=new(t(p))("#FFC43D");var R,v;d=i("j18jr");(v=R||(R={})).IN="in",v.OUT="out";var C=R;class A{add(t,e){switch(e){case C.IN:this.addIncoming(t);break;case C.OUT:this.addOutgoing(t);break;default:throw new Error(`unknow connection direction ${e}`)}}addIncoming(t){this.incoming.push(t)}addOutgoing(t){this.outgoing.push(t)}sampleIncoming(){return d.sample(this.incoming)}sampleOutgoing(){return d.sample(this.outgoing)}constructor(){this.incoming=[],this.outgoing=[]}}const w=S.lighten(.2).desaturate(.5),P=S.darken(.2),y=S.lighten(.2).fade(.4);class I extends a{get position(){return this._circle.center}get canConsumeTraveller(){return this._timer>=this._cooldown}get incomingConnections(){return this._connectionSet.incoming}get outgoingConnections(){return this._connectionSet.outgoing}getVisualConnectionPointAtAngle(t){return this._visualConnectionCircle.pointOnCircumference(t)}getAllReachableNodes(t=new Set){return t.add(this),[this]}connectTo(t,e){this._connectionSet.add(t,e)}consumeTraveller(){r.assert(this.canConsumeTraveller,"must be ready to consumer traveller"),this._resetTimer(),this._pulse()}update(t){this._timer=d.constrain(0,this._cooldown,this._timer+t)}draw(t){const e=this._timer/this._cooldown,n=d.constrain(0,1,d.mapRange(0,150,1,0,this._timer)),s=w.mix(P,n);t.beginPath(),t.fillStyle=s.toString(),h.circle(t,this._circle.center.x,this._circle.center.y,this._circle.radius),t.fill(),t.beginPath(),t.fillStyle=P.toString(),t.moveTo(this._circle.center.x,this._circle.center.y),h.circle(t,this._circle.center.x,this._circle.center.y,this._circle.radius*e),t.fill()}_resetTimer(){this._timer=0}_pulse(){var t;this.getScene().addChildBefore(this,new m({x:this._circle.center.x,y:this._circle.center.y,endRadius:20,startRadius:25,duration:500,color:y,easeRadius:_(4),easeOpacity:(t=u,e=>t(1-e)),removeOnComplete:!0}))}constructor(t,e,n=1e3){super(),this.isDestination=!0,this._timer=0,this._connectionSet=new A,this._circle=new c.default(t,e,20),this._visualConnectionCircle=new c.default(t,e,30),this._cooldown=n}}c=i("gJsWu"),h=i("93VSc"),d=i("j18jr"),r=i("aILhO"),c=i("gJsWu");var x=i("gcFVl");d=i("j18jr"),r=i("aILhO");class O{getScene(){return r.assert(this.scene,"scene is required"),this.scene}afterAddToScene(t){this.scene=t}beforeRemoveFromScene(t){this.scene=null}beforeUpdate(t){}afterUpdate(t){}beforeDraw(t,e){}afterDraw(t,e){}constructor(){this.scene=null,r.assert(this.constructor!==O,"SceneSystem is an abstract class that must be extended"),r.assert("$$AbstractSceneSystem$$"!==this.constructor.systemName,"classes extending SceneSystem must override SceneSystem.systemName")}}O.systemName="$$AbstractSceneSystem$$";var b=i("44Lwt");class E{insert(t){const e=this._getPosition(t);if(!this.boundary.contains(e))return!1;if(this._nextItemIndex<E.NODE_CAPACITY)return this._items[this._nextItemIndex]=t,this._nextItemIndex++,!0;const n=this._getSubdivisions();if(n[0].insert(t))return!0;if(n[1].insert(t))return!0;if(n[2].insert(t))return!0;if(n[3].insert(t))return!0;throw new Error("Couldnt insert item")}remove(t){const e=this._getPosition(t);if(!this.boundary.contains(e))return!1;const n=this._items.indexOf(t);if(-1!==n)return this._items.splice(n,1),this._nextItemIndex--,!0;const s=this._subdivisions;if(s){if(s[0].remove(t))return!0;if(s[1].remove(t))return!0;if(s[2].remove(t))return!0;if(s[3].remove(t))return!0}return!1}clear(){for(let t=0;t<this._nextItemIndex;t++)this._items[t]=void 0,this._nextItemIndex=0;this._subdivisions&&this._subdivisions.forEach((t=>t.clear()))}findItemsInRect(t){const e=[];if(!this.boundary.intersects(t))return e;for(let n=0;n<this._nextItemIndex;n++){const s=this._items[n];if(null==s)continue;const i=this._getPosition(s);t.contains(i)&&e.push(s)}const n=this._subdivisions;return n?(n[0].boundary.intersects(t)&&e.push(...n[0].findItemsInRect(t)),n[1].boundary.intersects(t)&&e.push(...n[1].findItemsInRect(t)),n[2].boundary.intersects(t)&&e.push(...n[2].findItemsInRect(t)),n[3].boundary.intersects(t)&&e.push(...n[3].findItemsInRect(t)),e):e}findItemsInCircle(t){return this.findItemsInRect(t.getBoundingBox()).filter((e=>t.containsPoint(this._getPosition(e))))}_getSubdivisions(){if(this._subdivisions)return this._subdivisions;const t=this.boundary.getCenter(),e=[new E(b.default.fromLeftTopRightBottom(this.boundary.left,this.boundary.top,t.x,t.y),this._getPosition),new E(b.default.fromLeftTopRightBottom(t.x,this.boundary.top,this.boundary.right,t.y),this._getPosition),new E(b.default.fromLeftTopRightBottom(this.boundary.left,t.y,t.x,this.boundary.bottom),this._getPosition),new E(b.default.fromLeftTopRightBottom(t.x,t.y,this.boundary.right,this.boundary.bottom),this._getPosition)];return this._subdivisions=e,e}constructor(t,e){this._items=[],this._nextItemIndex=0,this._subdivisions=null,this.boundary=t,this._getPosition=e}}E.NODE_CAPACITY=4;b=i("44Lwt");class F extends O{removeTraveller(t){this._quadTree.remove(t)}afterAddToScene(t){super.afterAddToScene(t),this._quadTree=new E(b.default.fromLeftTopRightBottom(0,0,t.width,t.height),(t=>t.position))}beforeUpdate(){const t=this.getScene();this._quadTree.clear(),t.children.forEach((t=>{t instanceof J&&this._quadTree.insert(t)}))}findTravellersInCircle(t){return this._quadTree.findItemsInCircle(t)}}F.systemName="TravellerFinder";r=i("aILhO"),x=i("gcFVl"),d=i("j18jr"),r=i("aILhO");const N={getNextRoad(t,e){const n=new Set(t.getAllReachableNodes());n.add(t),r.assert(n.has(e),"destination must be reachable");const s=new Map,i=new Map;for(s.set(t,0);n.size;){const{node:r,cost:o}=N._nodeWithShortestDistance(n,s);if(n.delete(r),r===e)return N._nextRoadFromRoute(i,t,e);N._updateNeighbours(r,s,o,i)}throw new Error("unreachable i hope")},_nodeWithShortestDistance(t,e){let n=1/0,s=null;return t.forEach((t=>{const i=e.get(t);null!=i&&i<=n&&(n=i,s=t)})),r.assert(s,"node must be found"),{node:s,cost:n}},_updateNeighbours(t,e,n,s){t.outgoingConnections.forEach((t=>{const i=t.to,r=e.get(i),o=n+t.expectedTimeFromStartToEnd;(null==r||o<=r)&&(e.set(i,o),s.set(i,t))}))},_nextRoadFromRoute(t,e,n){let s=n;for(;t.has(s);){const n=t.get(s);if(r.assert(n,"road must exist"),s=n.from,s===e)return n}throw new Error("prev road must be found")}};var D=N;class L{get incomingConnections(){return this._connectionSet.incoming}get outgoingConnections(){return this._connectionSet.outgoing}get canConsumeTraveller(){return!0}consumeTraveller(t){const e=t.destination;r.assert(e,"traveller must have destination");const n=D.getNextRoad(this,e);r.assert(this.outgoingConnections.includes(n),"nextRoad must be from this intersection"),t.removeFromCurrentRoad(),n.addTravellerAtStart(t)}getAllReachableNodes(t=new Set){return t.add(this),d.uniq(d.flatten(this._connectionSet.outgoing.map((e=>e.getAllReachableNodes(t)))))}getVisualConnectionPointAtAngle(){return this.position}getClosestOutgoingTraveller(){let t=null,e=1/0;return this.outgoingConnections.forEach((n=>{const s=n.getTravellerAfterPosition(-1);s&&s.positionOnCurrentRoad<e&&(t=s,e=s.positionOnCurrentRoad)})),t}getClosestIncomingTraveller(){let t=null,e=1/0;return this.incomingConnections.forEach((n=>{const s=n.getTravellerBeforePosition(n.length);s&&s.distanceToEndOfCurrentRoad<e&&(t=s,e=s.distanceToEndOfCurrentRoad)})),t}connectTo(t,e){this._connectionSet.add(t,e)}constructor(t,e){this.isDestination=!1,this._connectionSet=new A,this.position=new x.default(t,e)}}r=i("aILhO");var B=i("5WDzG");class j extends B.default{getSortOrder(){return this.getSortOrderFn(this.entity)}constructor(t,e){super(t),this.getSortOrderFn=e}}class k extends a{addComponent(t,...e){r.assert(!this.componentInstances.has(t),`component instance ${t.name} already exists`);const n=new t(this,...e);return this.componentInstances.set(t,n),n}hasComponent(t){return this.componentInstances.has(t)}getComponent(t){const e=this.componentInstances.get(t);return r.assert(e,`no instance for ${t.name} exists`),r.assert(e instanceof t,"wrong instance type"),e}removeComponent(t){const e=this.getComponent(t);return this.componentInstances.delete(t),e.onRemove(),e}draw(t,e){for(const n of this.componentInstances.values())n.beforeDraw(t,e);for(const n of this.componentInstances.values())n.draw(t,e);for(const n of this.componentInstances.values())n.afterDraw(t,e)}update(t){for(const e of this.componentInstances.values())e.beforeUpdate(t);for(const e of this.componentInstances.values())e.update(t);for(const e of this.componentInstances.values())e.afterUpdate(t)}onAddedToScene(t){super.onAddedToScene(t);for(const e of this.componentInstances.values())e.onAddedToScene(t)}onRemovedFromScene(){const t=this.getScene();super.onRemovedFromScene();for(const e of this.componentInstances.values())e.onRemovedFromScene(t)}getSortOrder(){return this.hasComponent(j)?this.getComponent(j).getSortOrder():super.getSortOrder()}constructor(...t){super(...t),this.componentInstances=new Map}}var q=i("hGok8"),M=i("180ke"),V=i("6QVeV"),$=i("7n8qG"),U=i("181T4");q=i("hGok8");const W=((t=1.70158)=>e=>1*((e-=1)*e*((t+1)*e+t)+1))(3),H=_(3);var X,G;(G=X||(X={})).STOPPED_FOR_DESTINATION="STOPPED_FOR_DESTINATION",G.STOPPED_FOR_TRAFFIC_IN_FRONT="STOPPED_FOR_TRAFFIC_IN_FRONT",G.STOPPED_FOR_TRAFFIC_NEARBY="STOPPED_FOR_TRAFFIC_NEARBY";class J extends a{get currentRoad(){return this._currentRoad}get position(){return r.assert(this._currentRoad,"currentRoad must be defined"),this._currentRoad.getPointAtPosition(this._positionOnCurrentRoad)}get predictedStopPoint(){const t=this._currentRoad;r.assert(t,"currentRoad must be defined");const e=this._getPredictedStopPositionIfDecelerating();return this._getPredictedPointForPosition(t,e)}get predictedStopArea(){const t=this.predictedStopPoint;return new c.default(t.x,t.y,this.safeRadius)}get potentialNextPredictedStopPoint(){const t=this._currentRoad;r.assert(t,"currentRoad must be defined");const e=this._getPredictedStopPositionIfDecelerating();return this._getPredictedPointForPosition(t,e+1)}get positionOnCurrentRoad(){return this._positionOnCurrentRoad}get distanceToEndOfCurrentRoad(){return r.assert(this._currentRoad,"traveller is not on a road"),this._currentRoad.length-this._positionOnCurrentRoad}get destination(){return this._destination}get speed(){return this._speed}get isStopped(){return 0===this.speed}get stoppedTime(){return this._stoppedTime}get stopReason(){return this._stopReason}isStoppedFor(t){return this._stoppedFor.includes(t)}onAddedToRoad(t){this._currentRoad=t,this._positionOnCurrentRoad=0,this._destination||this._pickDestination()}onRemovedFromRoad(){this.getScene().getSystem(F).removeTraveller(this),this._currentRoad=null}onRemovedFromScene(){this.removeFromCurrentRoad()}removeFromCurrentRoad(){this._currentRoad&&this._currentRoad.removeTraveller(this)}update(t){this._age+=t,this._stopReason=null,this._stoppedFor=[];const e=this._currentRoad;r.assert(e,"current road must be defined"),this._move(t,e);const n=this._getPal();n.getComponent(q.PalAbsoluteController).setPosition(this.position,e.getAngleAtPosition(this._positionOnCurrentRoad),t/1e3),n.update(t),this._getEnterTransitionScale(),this._checkAtEndOfRoad(e),this._checkExit()}draw(t,e){const n=this._currentRoad;r.assert(n,"current road must be defined"),this._getPal().draw(t,e)}getSortOrder(){return this.position.y}get _isExiting(){return null!==this._exitStartedAt}_getPal(){return this._pal||(this._pal=function(t){const e=new k;e.addComponent(q.PalAbsoluteController,t);const n=M.generateRandomPalConfig();return e.addComponent(V.default,n).setAnimationController(new $.default(n)),e.addComponent(U.default,n),e}(this.position)),this._pal}_getEnterTransitionScale(){return W(d.constrain(0,1,d.mapRange(0,400,0,1,this._age)))}_getExitTransitionScale(){return null===this._exitStartedAt?1:1-H(d.constrain(0,1,d.mapRange(this._exitStartedAt,this._exitStartedAt+400,0,1,this._age)))}_getPredictedStopPositionIfDecelerating(){const t=-this._speed/-200;return this._positionOnCurrentRoad+this._speed*t+-100*t*t}_getPredictedPointForPosition(t,e){if(e<=t.length)return t.getPointAtPosition(e);const n=e-t.length,s=t.getAngleAtPosition(t.length);return x.default.fromPolar(s,n).add(t.end)}_pickDestination(){if(!this._currentRoad)return;const t=this._currentRoad.getAllReachableNodes().filter((t=>t.isDestination)),e=d.sample(t);this._destination=e}_move(t,e){const n=t/1e3;this._forceAccelerateTimer=d.constrain(0,100,this._forceAccelerateTimer-t),this._forceAccelerateTimer<=0&&this._shouldDecelerate(e)?this._accelerate(-200,n,e):this._accelerate(200,n,e),0===this._speed?this._stoppedTime+=t:this._stoppedTime=0}_shouldDecelerate(t){const e=this._getPredictedStopPositionIfDecelerating();if(t.to===this._destination&&t.length+0<e)return this._stopReason=X.STOPPED_FOR_DESTINATION,!0;const n=t.getTravellerAfterPosition(this._positionOnCurrentRoad),s=e+this.comfortableRadius;if(n&&n.positionOnCurrentRoad<s)return this._stopReason=X.STOPPED_FOR_TRAFFIC_IN_FRONT,this._stoppedFor.push(n),!0;if(t.to instanceof L){const e=t.to,n=e.getClosestOutgoingTraveller();if(n){if(t.length+n.positionOnCurrentRoad<s)return this._stopReason=X.STOPPED_FOR_TRAFFIC_IN_FRONT,this._stoppedFor.push(n),!0}const i=e.getClosestIncomingTraveller();if(i&&i!==this){if(t.length-i.distanceToEndOfCurrentRoad<s)return this._stopReason=X.STOPPED_FOR_TRAFFIC_IN_FRONT,this._stoppedFor.push(i),!0}}return!!this._shouldDecelerateForNearbyTravellers(t)&&(this._stopReason=X.STOPPED_FOR_TRAFFIC_NEARBY,!0)}_shouldDecelerateForNearbyTravellers(t){const e=this.getScene().getSystem(F),n=this.predictedStopArea,s=n.center,i=this.potentialNextPredictedStopPoint,r=n.withRadius(200),o=e.findTravellersInCircle(r);for(const t of o){if(t===this)continue;const e=t.predictedStopArea,r=e.center;if(!n.intersectsCircle(e))continue;const o=t.potentialNextPredictedStopPoint,a=s.distanceTo(e.center);if(i.distanceTo(o)>a)continue;const c=s.distanceTo(o),h=r.distanceTo(i);if(!(c<h)&&!(c-h<.15)){if(c===h)return Math.random()<.5;if(this._stoppedTime>1500&&!t.isStopped)return this._forceAcceleration(),!1;t.isStoppedFor(this)||this._stoppedFor.push(t)}}return!!this._stoppedFor.length}_forceAcceleration(){this._forceAccelerateTimer=100}_accelerate(t,e,n){const s=this._speed;this._speed=d.constrain(0,80,this._speed+t*e);const i=(s+this._speed)/2;this._positionOnCurrentRoad=d.constrain(0,n.length,this._positionOnCurrentRoad+i*e)}_checkAtEndOfRoad(t){if(this._positionOnCurrentRoad===t.length){if(this._isExiting)return;this._onReachEndOfCurrentRoad(t)}}_checkExit(){this._isExiting&&(r.assert(this._exitStartedAt),this._age>=this._exitStartedAt+400&&this._onExit())}_onReachEndOfCurrentRoad(t){const e=t.to,n=this._destination;e.canConsumeTraveller&&(e.consumeTraveller(this),e===n&&this._onReachDestination())}_onReachDestination(){this._exit()}_onExit(){this.getScene().removeChild(this)}_exit(){this._exitStartedAt=this._age}constructor(...t){super(...t),this.comfortableRadius=d.random(60,60),this.safeRadius=d.random(30,30),this._currentRoad=null,this._destination=null,this._positionOnCurrentRoad=0,this._speed=5,this._age=0,this._exitStartedAt=null,this._stoppedTime=0,this._forceAccelerateTimer=0,this._stopReason=null,this._stoppedFor=[],this._pal=null}}J.MAX_SPEED=80,J.StopReason=X;r=i("aILhO"),d=i("j18jr"),c=i("gJsWu");var Y=i("izhPG"),z=i("cGqeu"),Q=i("jIpjz");class K{static straightThroughPoints(...t){let[e,...n]=t;const s=new K;for(const t of n)s.addSegment(new Y.default(e,t)),e=t;return s}static segmentAcrossCircle(t,e,n){e+=Math.PI;const s=t.pointOnCircumference(e),i=t.pointOnCircumference(n),r=new Q.default(t.center,s).perpendicularLineThroughPoint(s),o=new Q.default(t.center,i).perpendicularLineThroughPoint(i);if(r.isParallelTo(o))return new Y.default(s,i);const a=r.pointAtIntersectionWith(o),c=s.distanceTo(a);return new z.default(a,c,s.sub(a).angle,i.sub(a).angle)}getStart(){return this.segments[0].getStart()}getEnd(){return this.segments[this.segments.length-1].getEnd()}getLength(){return this.segments.reduce(((t,e)=>t+e.getLength()),0)}getPointAtPosition(t){const e=d.constrain(0,this.getLength(),t);let n=0;for(const t of this.segments){if(e<=n+t.getLength())return t.getPointAtPosition(e-n);n+=t.getLength()}throw new Error("this is supposed to be unreachable oops")}getAngleAtPosition(t){const e=d.constrain(0,this.getLength(),t);let n=0;for(const t of this.segments){if(e<=n+t.getLength())return t.getAngleAtPosition(e-n);n+=t.getLength()}throw new Error("this is supposed to be unreachable oops")}addSegment(t){const e=this.segments[this.segments.length-1];return e&&r.assert(e.getEnd().equals(t.getStart()),`segments must neatly join together - ${e.getEnd().toString()} !== ${t.getStart().toString()}`),this.segments.push(t),this}addSegments(...t){return t.forEach((t=>this.addSegment(t))),this}autoRound(t){const e=this.segments.map(((e,n)=>{const s=0===n?null:this.segments[n-1];if(!s)return e instanceof Y.default?null:e;if(!(e instanceof Y.default))return e;if(!(s instanceof Y.default))return null;r.assert(s.getEnd().equals(e.getStart()),"segments must join");const i=s.angle,o=e.angle,a=Math.min(t,s.getLength()/2,e.getLength()/2),h=new c.default(e.getStart().x,e.getStart().y,a);return K.segmentAcrossCircle(h,i,o)})),n=d.compact(e),s=this.getStart(),i=this.getEnd();let o=s;return this.segments=[],n.forEach((t=>{t.getStart().equals(o)||this.addSegment(new Y.default(o,t.getStart())),this.addSegment(t),o=t.getEnd()})),o.equals(i)||this.addSegment(new Y.default(o,i)),this}constructor(...t){this.segments=[],this.addSegments(...t)}}Y=i("izhPG"),h=i("93VSc"),d=i("j18jr"),c=i("gJsWu");class Z extends a{get position(){return this._circle.center}onAddedToScene(t){super.onAddedToScene(t),this._roads.forEach((e=>t.addChild(e)))}getVisualConnectionPointAtAngle(t){return this._circle.pointOnCircumference(t)}connectToRoadAtAngle(t,e,n){const s=this._intersectionAtAngle(e);s.connectTo(t,n);const i=n===C.IN||this._incomingIntersections.has(s),r=n===C.OUT||this._outgoingIntersections.has(s);return i&&this._incomingIntersections.add(s),r&&this._outgoingIntersections.add(s),this._intersections.forEach((t=>{if(t!==s){if(i&&this._outgoingIntersections.has(t)){const e=new K(K.segmentAcrossCircle(this._circle,this._circle.center.sub(s.position).angle,t.position.sub(this._circle.center).angle));this._addRoad(new st(s,t,{path:e}))}if(r&&this._incomingIntersections.has(t)){const e=new K(K.segmentAcrossCircle(this._circle,this._circle.center.sub(t.position).angle,s.position.sub(this._circle.center).angle));this._addRoad(new st(t,s,{path:e}))}}})),s}_intersectionAtAngle(t){const e=t.toString();if(this._intersectionsByAngle[e])return this._intersectionsByAngle[e];const n=this._createIntersectionAtAngle(t);return this._intersectionsByAngle[e]=n,n}_createIntersectionAtAngle(t){const e=this.getVisualConnectionPointAtAngle(t);return new L(e.x,e.y)}get _intersections(){return d.compact(Object.keys(this._intersectionsByAngle).map((t=>this._intersectionsByAngle[t])))}_addRoad(t){this._roads.push(t),this.hasScene()&&this.getScene().addChild(t)}constructor(t,e,n){super(),this._intersectionsByAngle={},this._incomingIntersections=new Set,this._outgoingIntersections=new Set,this._roads=[],this._circle=new c.default(t,e,n)}}const tt=T.darken(.2),et=[5,10],nt=et.reduce(((t,e)=>t+e),0);class st extends a{get length(){return this._path.getLength()}get start(){return this._path.getStart()}get end(){return this._path.getEnd()}get expectedTimeFromStartToEnd(){if(this._currentTravellers.length){const t=this._currentTravellers.reduce(((t,e)=>t+e.speed),0)/this._currentTravellers.length;return this.length/t}return this.length/(.7*J.MAX_SPEED)}canAddTravellerAtStart(){const t=this.getTravellerAfterPosition(0);return!t||t.positionOnCurrentRoad>t.comfortableRadius}addTravellerAtStart(t){this._currentTravellers.push(t),t.onAddedToRoad(this)}removeTraveller(t){const e=this._currentTravellers.indexOf(t);return-1!==e&&(this.removeTravellerAtIndex(e),!0)}removeTravellerAtIndex(t){const e=this._currentTravellers[t];return this._currentTravellers.splice(t,1),e.onRemovedFromRoad(),e}getAllReachableNodes(t=new Set){return t.has(this.to)?[]:[...this.to.getAllReachableNodes(t),this.to]}getPointAtPosition(t){return this._path.getPointAtPosition(t)}getAngleAtPosition(t){return this._path.getAngleAtPosition(t)}getTravellerAfterPosition(t){let e=null,n=1/0;return this._currentTravellers.forEach((s=>{const i=s.positionOnCurrentRoad-t;i<=0||i<n&&(n=i,e=s)})),e}getTravellerBeforePosition(t){let e=null,n=1/0;return this._currentTravellers.forEach((s=>{const i=t-s.positionOnCurrentRoad;i<=0||i<n&&(n=i,e=s)})),e}draw(t,e){t.beginPath(),t.lineCap="round",t.lineJoin="round",h.path(t,this._path);const n=this._getLineDashScale(),s=nt*n;t.setLineDash(et.map((t=>t*n))),t.strokeStyle=tt.toString(),t.lineDashOffset=.05*-e*n%s,t.lineWidth=3,t.stroke()}_getLineDashScale(){const t=Math.floor(this.length/nt)*nt;return this.length-t<t+nt-this.length?this.length/t:this.length/(t+nt)}constructor(t,e,{points:n,autoRound:s,path:i}={}){super(),this.isNode=!1,this._currentTravellers=[];const r=n?t.position.angleTo(n[0]):t.position.angleTo(e.position),o=n?e.position.angleTo(n[n.length-1]):e.position.angleTo(t.position);this._path=i||(n?K.straightThroughPoints(t.getVisualConnectionPointAtAngle(r),...n,e.getVisualConnectionPointAtAngle(o)):(new K).addSegment(new Y.default(t.getVisualConnectionPointAtAngle(r),e.getVisualConnectionPointAtAngle(o)))),null!=s&&this._path.autoRound(s),t instanceof Z?this.from=t.connectToRoadAtAngle(this,r,C.OUT):(this.from=t,t.connectTo(this,C.OUT)),e instanceof Z?this.to=e.connectToRoadAtAngle(this,o,C.IN):(this.to=e,e.connectTo(this,C.IN))}}const it=f.lighten(.1),rt=f.darken(.1),ot=f.lighten(.2).fade(.1);class at extends a{get position(){return this._circle.center}get incomingConnections(){return this._connectionSet.incoming}get outgoingConnections(){return this._connectionSet.outgoing}getAllReachableNodes(t=new Set){return t.add(this),d.uniq(d.flatten(this._connectionSet.outgoing.map((e=>e.getAllReachableNodes(t)))))}getVisualConnectionPointAtAngle(t){return this._visualConnectionCircle.pointOnCircumference(t)}consumeTraveller(){throw new Error("producer cannot consume traveller")}connectTo(t,e){this._connectionSet.add(t,e)}update(t){this._timer=d.constrain(0,this._cooldown,this._timer+t),this._timer>=this._cooldown&&this._onTimerEnd()}draw(t){const e=this._timer/this._cooldown,n=d.constrain(0,1,d.mapRange(0,150,1,0,this._timer)),s=it.mix(rt,n);t.beginPath(),t.fillStyle=s.toString(),h.circle(t,this._circle.center.x,this._circle.center.y,this._circle.radius),t.fill(),t.beginPath(),t.fillStyle=rt.toString(),t.moveTo(this._circle.center.x,this._circle.center.y),t.arc(this._circle.center.x,this._circle.center.y,this._circle.radius,-Math.PI/2,2*e*Math.PI-Math.PI/2,!1),t.fill(),t.beginPath(),t.fillStyle=it.toString(),h.circle(t,this._circle.center.x,this._circle.center.y,14),t.fill()}_resetTimer(){this._timer=0}_onTimerEnd(){this._attemptEmitTraveller()&&(this._pulse(),this._resetTimer())}_pulse(){this.getScene().addChildBefore(this,new m({x:this._circle.center.x,y:this._circle.center.y,startRadius:20,endRadius:35,duration:500,color:ot,easeRadius:g,removeOnComplete:!0}))}_attemptEmitTraveller(){const t=this._connectionSet.sampleOutgoing();if(!(t instanceof st))return!1;if(t.canAddTravellerAtStart()){const e=new J;return t.addTravellerAtStart(e),this.getScene().addChild(e),!0}return!1}constructor(t,e,n=500){super(),this.isDestination=!1,this.canConsumeTraveller=!1,this._connectionSet=new A,this._circle=new c.default(t,e,20),this._visualConnectionCircle=new c.default(t,e,30),this._cooldown=n,this._timer=n}}x=i("gcFVl");const ct=new class{get width(){return this.canvas.width/this._scaleFactor}get height(){return this.canvas.height/this._scaleFactor}get scaleFactor(){return this._scaleFactor}get isPlaying(){return null!==this.frameHandle&&this._isPlaying}set isPlaying(t){r.assert(null!==this.frameHandle,"cannot set isPlaying without calling start"),this._isPlaying=t}get children(){return this._children}appendTo(t){t.appendChild(this.canvas)}hasSystem(t){return this.systemsByClass.has(t)}getSystem(t){const e=this.systemsByClass.get(t);return r.assert(e,`system, ${t.systemName} not found`),r.assert(e instanceof t,"system is wrong instance type"),e}addSystem(t){r.assert(!this.hasSystem(t.constructor),"only one system of each type allowed"),this.systemsByClass.set(t.constructor,t),t.afterAddToScene(this)}removeSystem(t){this.getSystem(t).beforeRemoveFromScene(this),this.systemsByClass.delete(t)}addChild(t){this._children.push(t),t.onAddedToScene(this)}addChildBefore(t,e){const n=this._children.indexOf(t);r.assert(-1!==n,"target child must be present"),this.addChildAtIndex(n,e)}addChildAfter(t,e){const n=this._children.indexOf(t);r.assert(-1!==n,"target child must be present"),this.addChildAtIndex(n+1,e)}addChildAtIndex(t,e){this._children.splice(t,0,e),e.onAddedToScene(this)}removeChild(t){const e=this._children.indexOf(t);return-1!==e&&(this.removeChildAtIndex(e),!0)}removeChildAtIndex(t){const e=this._children[t];return this._children.splice(t,1),e.onRemovedFromScene(),e}update(t){for(let e=0;e<1;e++){for(const e of this.systemsByClass.values())e.beforeUpdate(t);this._children.forEach((e=>e.update(t)));for(const e of this.systemsByClass.values())e.afterUpdate(t)}}draw(t){this.ctx.save(),this.ctx.scale(this._scaleFactor,this._scaleFactor),this.ctx.clearRect(0,0,this.width,this.height);for(const e of this.systemsByClass.values())e.beforeDraw(this.ctx,t);this._children.sort(((t,e)=>t.getSortOrder()-e.getSortOrder())).forEach((e=>e.draw(this.ctx,t)));for(const e of this.systemsByClass.values())e.afterDraw(this.ctx,t);this.ctx.restore()}start(){this._isPlaying=!0,this.frameHandle=window.requestAnimationFrame(this._tick)}stop(){null!==this.frameHandle&&(window.cancelAnimationFrame(this.frameHandle),this.frameHandle=null),this._isPlaying=!1,this.lastElapsedTime=null}_setupVisiblityChange(){let t=!1;document.addEventListener("visibilitychange",(()=>{document.hidden&&this.isPlaying&&(t=!0,this.stop()),t&&!document.hidden&&(t=!1,this.start())}))}constructor(t,e,n=1){this._children=[],this._isPlaying=!1,this.frameHandle=null,this.lastElapsedTime=null,this.systemsByClass=new Map,this._tick=t=>{t*=1;const e=this.lastElapsedTime;if(null!==e){const n=t-e;this.isPlaying&&(this.update(n),this.draw(t))}this.lastElapsedTime=t,this.frameHandle=window.requestAnimationFrame(this._tick)},this.canvas=document.createElement("canvas"),this.canvas.width=t*n,this.canvas.height=e*n,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`;const s=this.canvas.getContext("2d");r.assert(s,"ctx"),this.ctx=s,this._scaleFactor=1*n,this._setupVisiblityChange()}}(800,600,window.devicePixelRatio),ht=document.getElementById("root");r.assert(ht,"#root must be present"),ct.appendTo(ht),ct.addSystem(new F),function(){const t=new I(300,550,1500),e=new I(100,450,1500),n=new I(100,250,1500),s=new at(600,150,500),i=new at(100,100,500);ct.addChild(t),ct.addChild(e),ct.addChild(n),ct.addChild(s),ct.addChild(i);const r=new Z(300,150,50),o=new Z(500,370,50),a=new Z(330,400,50);ct.addChild(r),ct.addChild(o),ct.addChild(a),ct.addChild(new st(i,r)),ct.addChild(new st(s,o)),ct.addChild(new st(o,a)),ct.addChild(new st(o,r,{points:[new x.default(400,300),new x.default(500,50)],autoRound:50})),ct.addChild(new st(r,a)),ct.addChild(new st(a,t)),ct.addChild(new st(r,e)),ct.addChild(new st(r,n))}(),ct.start();
//# sourceMappingURL=index.7e7ee871.js.map
