import{o as h,m as L,n as l,w as a,x as D,r as p,y as b,l as O,z as M,q as R,t as w,a as T}from"./chunk_assert.b3c9f562.js";import{C as u}from"./chunk_index.9d850002.js";import{V as c}from"./chunk_Vector2.6df6a1fc.js";import{C as f}from"./chunk_Entity.b2dd83d8.js";import{L as I,C as Y}from"./chunk_Circle.1704d412.js";class E{constructor(t,e){this.line=new I(t,e),this.delta=this.line.getDelta(),Object.freeze(this)}getStart(){return this.line.start}getEnd(){return this.line.end}getDelta(){return this.delta}getLength(){return this.delta.magnitude}get angle(){return this.delta.angle}getPointAtPosition(t){const e=h(0,this.getLength(),t);return this.delta.withMagnitude(e).add(this.line.start)}getAngleAtPosition(){return this.delta.angle}}class H{constructor(t,e,i,s){this.circle=Y.create(t.x,t.y,e),this.startAngle=i,this.endAngle=s,Object.freeze(this)}getStart(){return this.circle.pointOnCircumference(this.startAngle)}getEnd(){return this.circle.pointOnCircumference(this.endAngle)}get angleDifference(){return Math.atan2(Math.sin(this.endAngle-this.startAngle),Math.cos(this.endAngle-this.startAngle))}getLength(){const t=Math.abs(this.angleDifference)/(Math.PI*2);return this.circle.circumference*t}get isAnticlockwise(){return this.angleDifference<0}getPointAtPosition(t){const e=L(0,this.getLength(),this.startAngle,this.startAngle+this.angleDifference,h(0,this.getLength(),t));return this.circle.pointOnCircumference(e)}getAngleAtPosition(t){return this.isAnticlockwise?L(0,this.getLength(),this.startAngle,this.startAngle+this.angleDifference,h(0,this.getLength(),t))-Math.PI/2:L(0,this.getLength(),this.startAngle,this.startAngle+this.angleDifference,h(0,this.getLength(),t))+Math.PI/2}}function y(n,t,e,i){n.arc(t,e,i,0,2*Math.PI,!1)}function _(n,t){t.segments.length&&n.moveTo(t.segments[0].getStart().x,t.segments[0].getStart().y);for(const e of t.segments)if(e instanceof E)n.lineTo(e.getEnd().x,e.getEnd().y);else if(e instanceof H)n.arc(e.circle.center.x,e.circle.center.y,e.circle.radius,e.startAngle,e.endAngle,e.isAnticlockwise);else throw new Error(`Unknown path segment type: ${e.toString()}`)}const B=80,v=200,Z=200;class S extends f{constructor(t,e){super(t),this.speed=0,this.heading=0,this.headingVelocity=0,this.position=e}getVelocity(){return this.getHeadingVec().scale(this.speed)}getHeadingVec(){return c.fromPolar(this.heading,1)}}class N extends f{constructor(t,e){super(t),this.target=e,this.data=t.addComponent(S,e)}setTarget(t){this.target=t}update(t){const e=t/1e3,i=this.data.position.angleTo(this.target),s=this.target.distanceTo(this.data.position);if(s>15?this.accelerate(v,e):this.accelerate(-Z,e),s>10){const o=l(i-this.data.heading),r=this.data.heading;this.data.heading+=o/10,this.data.headingVelocity=l(this.data.heading-r)/e}else this.data.headingVelocity=0}accelerate(t,e){const i=this.data.speed;this.data.speed=h(0,B,this.data.speed+t*e);const s=(i+this.data.speed)/2;this.data.position=this.data.position.add(c.fromPolar(this.data.heading,s*e))}}class $ extends f{constructor(t,e){super(t),this.data=t.addComponent(S,e)}setPosition(t,e,i){const s=this.data.position,o=this.data.heading;this.data.heading=e,this.data.headingVelocity=l(this.data.heading-o)/i,this.data.speed=s.distanceTo(t)/i,this.data.position=t}}new u("#F8FFE5");new u("#06D6A0");const k=new u("#1B9AAA");new u("#EF476F");new u("#FFC43D");k.lighten(.2);const J=()=>{const n=a(14,.2),t=a(n*.7,.3),e=a(n*2,.3),i=e-(n-t);return{radius:n,bodHeight:e,bodBob:a(n,.2),eyeY:a(n*.5,.2),eyeX:a(n*.4,.3),eyeRadius:a(n*.15,.4),mouthThickness:a(n*.15,.4),mouthY:D(0,n*.2),mouthWidth:a(n*.5,.3),mouthSmile:a(n*.3,.3),buttTop:a(n*.4,.2),buttBottom:a(n*.85,.15),buttThickness:a(n*.1,.5),color:k.lighten(p(-.2,.2)).saturate(p(-.2,.2)).rotate(p(-10,10)),hipHeight:t,kneeScale:D(1.3,.3),legMaxLift:p(.2,.5),kneeMaxOut:a(i*.6,.4),stepDuration:a(i*.01,.4),stepRestDuration:a(i*.0083,.4),stepThreshold:a(i*.01,.4),fullStepDistance:a(i*.7,.4),legWidth:a(n*.3,.4),legPairs:b(1,4)}},F=({radius:n,hipHeight:t,legWidth:e})=>Math.sqrt(n*n-(n-t)*(n-t))-e;class C{constructor(t,e,i,s){this.palData=t,this.palGeom=e,this.config=i,this.angleOffset=s,this.liftAmount=0,this.hipRadius=F(i),this.kneeRadius=F(i)*i.kneeScale,this.floorRadius=F(i),this.footXY=this.getIdealFootRestingXY(),this.footOrigin=this.getIdealFootRestingXY()}update(t){this.footXY=t.footXY,this.footOrigin=t.footProjectionOrigin,this.liftAmount=t.liftAmount}getIdealFootRestingXY(){return c.fromPolar(this.palData.heading+this.angleOffset,this.floorRadius).add(this.palData.position)}getFootXY(){return this.footXY}getFootZ(){return O(0,this.getHipZ()*this.config.legMaxLift,this.liftAmount)}getFootOrigin(){return this.footOrigin}getKneeXY(){return this.palData.position.add(c.fromPolar(this.palData.heading+this.angleOffset,this.kneeRadius)).add(c.fromPolar(this.palData.heading,this.liftAmount*this.config.kneeMaxOut))}getKneeZ(){return(this.getFootZ()+this.getHipZ())/2}getKneeOrigin(){return this.getHipOrigin().lerp(this.getFootOrigin(),.5)}getHipXY(){return this.palData.position.add(c.fromPolar(this.palData.heading+this.angleOffset,this.hipRadius))}getHipZ(){const t=this.palGeom.getBod();return this.palData.position.y-t.center.y-(t.radius-this.config.hipHeight)}getHipOrigin(){return this.palData.position}}const m=Math.PI/2;class V extends f{constructor(t,e){super(t),this.config=e,this.animationController=null,this.bobAmount=0,this.controlData=t.getComponent(S),this.legs=M(R(w(e.legPairs,i=>{const s=(i+1)/(e.legPairs+1);return[new C(this.controlData,this,e,O(m-1,m+1,s)),new C(this.controlData,this,e,O(-m+1,-m-1,s))]})))}setAnimationController(t){this.animationController=t}update(t){if(this.animationController){const e=this.animationController.update(t,this.controlData,this.legs);this.bobAmount=e.bobAmount,T(e.legs.length===this.legs.length),this.legs.forEach((i,s)=>i.update(e.legs[s]))}}getBod(){const t=this.config.bodBob*this.bobAmount;return Y.create(this.controlData.position.x,this.controlData.position.y-this.config.bodHeight-t,this.config.radius)}}function P({stepProgress:n}){return n>0}function W({restTimer:n}){return n>0}class Q{constructor(t){this.config=t,this.legStates=new Map}update(t,e,i){const s=t/1e3;for(const g of i)this.updateLegState(s,e,i,g);const o=i.map(g=>this.getLegUpdate(e,g));return{bobAmount:o.reduce((g,X)=>g+X.liftAmount,0)/i.length,legs:o}}canLiftLeg(t,e,i){T(e.includes(i),"whos leg even is this");const s=e.filter(r=>r!==i&&!P(this.getLegState(t,i))).length>Math.floor(Math.log(e.length)),o=e.some(r=>{const d=this.getLegState(t,r);return d.stepProgress>0&&d.stepProgress<1/(e.length/2)});return s&&!o}updateLegState(t,e,i,s){const o=this.getLegState(e,s);if(o.restTimer=h(0,this.config.stepRestDuration,o.restTimer-t),!W(o))if(P(o))o.stepProgress=h(0,1,o.stepProgress+t/this.config.stepDuration),o.stepProgress===1&&(o.lastFootOnFloorXY=this.getFootXY(e,s,o),o.lastFootOnFloorPalPosition=e.position,o.stepProgress=0,o.restTimer=this.config.stepDuration);else{const r=s.getFootXY().distanceTo(s.getIdealFootRestingXY());r>this.config.stepThreshold&&this.canLiftLeg(e,i,s)&&(o.currentStepMaxLift=h(0,1,L(this.config.stepThreshold,this.config.fullStepDistance,.1,1,r)),o.stepProgress=h(0,1,o.stepProgress+t/this.config.stepDuration))}}getInitialLegState(t,e){return{lastFootOnFloorXY:e.getIdealFootRestingXY(),lastFootOnFloorPalPosition:t.position,stepProgress:0,restTimer:0,currentStepMaxLift:1}}getLegState(t,e){const i=this.legStates.get(e);if(i)return i;const s=this.getInitialLegState(t,e);return this.legStates.set(e,s),s}getLegUpdate(t,e){const i=this.getLegState(t,e);return{footXY:this.getFootXY(t,e,i),footProjectionOrigin:this.getFootOrigin(t,e,i),liftAmount:this.getLegLiftAmount(i)}}getFootXY(t,e,i){if(P(i)){const s=i.lastFootOnFloorXY,o=this.getPredictedIdealFootXYAtEndOfOfStep(t,e,i);return s.lerp(o,i.stepProgress)}return i.lastFootOnFloorXY}getFootOrigin(t,e,i){return P(i)?i.lastFootOnFloorPalPosition.lerp(t.position,i.stepProgress):i.lastFootOnFloorPalPosition}getPredictedIdealFootXYAtEndOfOfStep(t,e,i){const s=(1.4-i.stepProgress)*this.config.stepDuration,o=t.getVelocity().scale(s).add(t.position),r=t.heading+t.headingVelocity*s;return c.fromPolar(r+e.angleOffset,e.floorRadius).add(o)}getLegLiftAmount({stepProgress:t,currentStepMaxLift:e}){return Math.sin(t*Math.PI)*e}}const j=.3,A=Math.PI/2;class x extends f{constructor(t,e){super(t),this.config=e,this.data=t.getComponent(S),this.geom=t.getComponent(V)}draw(t){const e=l(this.data.heading);t.setLineDash([]),t.beginPath();const i=this.geom.getBod();t.ellipse(this.data.position.x,this.data.position.y,i.radius*.8,i.radius*.8*.3,0,0,2*Math.PI),t.fillStyle="rgba(0, 0, 0, 0.2)",t.fill(),this.geom.legs.filter(s=>l(s.angleOffset+e)<0).forEach(s=>this.drawLeg(t,s)),this.geom.legs.filter(s=>l(s.angleOffset+e)>=0).forEach(s=>this.drawLeg(t,s)),this.drawBod(t,i)}drawLeg(t,e){t.beginPath();const i=this.data.heading+e.angleOffset,s=h(0,1,Math.abs(l(-A-i)/A)),o=this.config.color.darken(.2*(1-s*s)),r=this.projectZ(e.getHipXY(),e.getHipZ(),e.getHipOrigin()),d=this.projectZ(e.getKneeXY(),e.getKneeZ(),e.getKneeOrigin()),g=this.projectZ(e.getFootXY(),e.getFootZ(),e.getFootOrigin());t.moveTo(r.x,r.y),t.quadraticCurveTo(d.x,d.y,g.x,g.y),t.lineCap="round",t.strokeStyle=o.toString(),t.lineWidth=this.config.legWidth,t.stroke()}drawBod(t,e){t.save(),t.beginPath(),y(t,e.center.x,e.center.y,this.config.radius),t.fillStyle=this.config.color.toString(),t.fill(),t.clip();const i=l(A-this.data.heading)/A*this.config.radius;t.beginPath(),y(t,i+e.center.x+this.config.eyeX,e.center.y-this.config.eyeY,this.config.eyeRadius),y(t,i+e.center.x-this.config.eyeX,e.center.y-this.config.eyeY,this.config.eyeRadius),t.fillStyle=this.config.color.darken(.5).toString(),t.fill(),t.beginPath(),t.moveTo(i+e.center.x-this.config.mouthWidth,e.center.y-this.config.mouthY),t.quadraticCurveTo(i+e.center.x,e.center.y-this.config.mouthY+this.config.mouthSmile,i+e.center.x+this.config.mouthWidth,e.center.y-this.config.mouthY),t.lineWidth=this.config.mouthThickness,t.strokeStyle=this.config.color.darken(.5).toString(),t.stroke(),t.beginPath(),this.makeButtLine(t,e,i+this.config.radius*2),this.makeButtLine(t,e,i-this.config.radius*2),t.lineWidth=this.config.buttThickness,t.strokeStyle=this.config.color.darken(.3).toString(),t.stroke(),t.restore()}makeButtLine(t,e,i){t.moveTo(i*1.6+e.center.x,e.center.y+this.config.buttTop),t.quadraticCurveTo(i*1.7+e.center.x,e.center.y+(this.config.buttTop+this.config.buttBottom)*.65,i+e.center.x,e.center.y+this.config.buttBottom)}projectZ(t,e,i){return new c(t.x,i.y-e+(t.y-i.y)*j)}}export{H as C,$ as P,E as S,V as a,Q as b,y as c,x as d,N as e,J as g,_ as p};
