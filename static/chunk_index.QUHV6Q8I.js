var Vs=Object.defineProperty;var Ws=(o,e,t)=>e in o?Vs(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var y=(o,e,t)=>Ws(o,typeof e!="symbol"?e+"":e,t);import{a as qe,d as I,U as j,b as we,s as oe,c as Z,i as Ye,R as Qe,w as Re,E as Fs,e as Gs,f as ue,g as Zs,h as Ys}from"./chunk_index.X4Vi_3QD.js";import{c as De,g as Qs}from"./chunk__commonjsHelpers.Cpj98o6Y.js";function Xs(o,e){if(o===e)return!0;if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(!Object.is(o[t],e[t]))return!1;return!0}class Js{constructor(){y(this,"items",new WeakMap)}get(e,t){return this.items.has(e)||this.items.set(e,t(e)),this.items.get(e)}}/*!
 * MIT License: https://github.com/ai/nanoid/blob/main/LICENSE
 * Modified code originally from <https://github.com/ai/nanoid>
 * Copyright 2017 Andrey Sitnik <andrey@sitnik.ru>
 *
 * `nanoid` is currently only distributed as an ES module. Some tools (jest, playwright) don't
 * properly support ESM-only code yet, and tldraw itself is distributed as both an ES module and a
 * CommonJS module. By including nanoid here, we can make sure it works well in every environment
 * where tldraw is used. We can also remove some unused features like custom alphabets.
 */const Wt=globalThis.crypto,ks="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",en=128;let re,ae;function tn(o){!re||re.length<o?(re=new Uint8Array(o*en),Wt.getRandomValues(re),ae=0):ae+o>re.length&&(Wt.getRandomValues(re),ae=0),ae+=o}function rn(o=21){tn(o-=0);let e="";for(let t=ae-o;t<ae;t++)e+=ks[re[t]&63];return e}let sn=rn;function cr(o){return sn(o)}function nn(o,e){return Object.prototype.hasOwnProperty.call(o,e)}function it(o,e){if(nn(o,e))return o[e]}function on(o){return Object.keys(o)}function x(o){return Object.values(o)}function fe(o){return Object.entries(o)}function Xe(o,e){const t={};let r=!1;for(const[s,n]of fe(o))e(s,n)?t[s]=n:r=!0;return r?t:o}const an=()=>typeof process<"u"&&!1,ce=[],cn=60,Pe=Math.ceil(1e3/cn);let ve,Je=0,ot=0;const un=()=>{const o=ce.splice(0,ce.length);for(const e of o)e()};function ur(){if(ve)return;const o=Date.now(),e=o-ot;if(Je+e<Pe){ve=requestAnimationFrame(()=>{ve=void 0,ur()});return}ve=requestAnimationFrame(()=>{ve=void 0,ot=o,Je=Math.min(Je+e-Pe,Pe*10),un()})}let Ft=!1;function fn(o){return an()?(o(),()=>{}):(ce.includes(o)||(ce.push(o),Ft||(Ft=!0,ot=Date.now()-Pe-1),ur()),()=>{const e=ce.indexOf(o);e>-1&&ce.splice(e,1)})}/*!
 * This file was lovingly and delicately extracted from Immutable.js
 * MIT License: https://github.com/immutable-js/immutable-js/blob/main/LICENSE
 * Copyright (c) 2014-present, Lee Byron and other contributors.
 */function ct(o){return o>>>1&1073741824|o&3221225471}const dn=Object.prototype.valueOf;function se(o){if(o==null)return Gt(o);if(typeof o.hashCode=="function")return ct(o.hashCode(o));const e=_n(o);if(e==null)return Gt(e);switch(typeof e){case"boolean":return e?1108378657:1108378656;case"number":return hn(e);case"string":return e.length>mn?ln(e):at(e);case"object":case"function":return gn(e);case"symbol":return pn(e);default:if(typeof e.toString=="function")return at(e.toString());throw new Error("Value type "+typeof e+" cannot be hashed.")}}function Gt(o){return o===null?1108378658:1108378659}function hn(o){if(o!==o||o===1/0)return 0;let e=o|0;for(e!==o&&(e^=o*4294967295);o>4294967295;)o/=4294967295,e^=o;return ct(e)}function ln(o){let e=tt[o];return e===void 0&&(e=at(o),et===yn&&(et=0,tt={}),et++,tt[o]=e),e}function at(o){let e=0;for(let t=0;t<o.length;t++)e=31*e+o.charCodeAt(t)|0;return ct(e)}function pn(o){let e=Yt[o];return e!==void 0||(e=fr(),Yt[o]=e),e}function gn(o){let e=Zt.get(o);return e!==void 0||(e=fr(),Zt.set(o,e)),e}function _n(o){return o.valueOf!==dn&&typeof o.valueOf=="function"?o.valueOf(o):o}function fr(){const o=++ke;return ke&1073741824&&(ke=0),o}const Zt=new WeakMap,Yt=Object.create(null);let ke=0;const mn=16,yn=255;let et=0,tt={};const he=5,be=1<<he,le=be-1,K={};function Qt(){return{value:!1}}function $(o){o&&(o.value=!0)}function ut(o,e){e=e||0;const t=Math.max(0,o.length-e),r=new Array(t);for(let s=0;s<t;s++)r[s]=o[s+e];return r}const pe=Object.is;class dr{}class ft{constructor(e){y(this,"_root");y(this,"size");y(this,"__ownerID");y(this,"__hash");y(this,"__altered");return e==null?de():e instanceof ft?e:de().withMutations(t=>{for(const[r,s]of e)t.set(r,s)})}get(e,t){return this._root?this._root.get(0,void 0,e,t):t}set(e,t){return kt(this,e,t)}delete(e){return kt(this,e,K)}deleteAll(e){return this.withMutations(t=>{for(const r of e)t.delete(r)})}__ensureOwner(e){return e===this.__ownerID?this:e?lt(this.size,this._root,e,this.__hash):this.size===0?de():(this.__ownerID=e,this.__altered=!1,this)}withMutations(e){const t=this.asMutable();return e(t),t.wasAltered()?t.__ensureOwner(this.__ownerID):this}wasAltered(){return this.__altered}asMutable(){return this.__ownerID?this:this.__ensureOwner(new dr)}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}entries(){return new rt(this,vn,!1)}keys(){return new rt(this,hr,!1)}values(){return new rt(this,lr,!1)}}class dt{constructor(e,t){this.ownerID=e,this.entries=t}get(e,t,r,s){const n=this.entries;for(let c=0,f=n.length;c<f;c++)if(pe(r,n[c][0]))return n[c][1];return s}update(e,t,r,s,n,c,f){const d=n===K,p=this.entries;let h=0;const g=p.length;for(;h<g&&!pe(s,p[h][0]);h++);const _=h<g;if(_?p[h][1]===n:d)return this;if($(f),(d||!_)&&$(c),d&&p.length===1)return;if(!_&&!d&&p.length>=Tn)return An(e,p,s,n);const v=e&&e===this.ownerID,w=v?p:ut(p);return _?d?h===g-1?w.pop():w[h]=w.pop():w[h]=[s,n]:w.push([s,n]),v?(this.entries=w,this):new dt(e,w)}}class ze{constructor(e,t,r){this.ownerID=e,this.bitmap=t,this.nodes=r}get(e,t,r,s){t===void 0&&(t=se(r));const n=1<<((e===0?t:t>>>e)&le),c=this.bitmap;return c&n?this.nodes[tr(c&n-1)].get(e+he,t,r,s):s}update(e,t,r,s,n,c,f){r===void 0&&(r=se(s));const d=(t===0?r:r>>>t)&le,p=1<<d,h=this.bitmap,g=(h&p)!==0;if(!g&&n===K)return this;const _=tr(h&p-1),v=this.nodes,w=g?v[_]:void 0,m=pt(w,e,t+he,r,s,n,c,f);if(m===w)return this;if(!g&&m&&v.length>=On)return Cn(e,v,h,d,m);if(g&&!m&&v.length===2&&er(v[_^1]))return v[_^1];if(g&&m&&v.length===1&&er(m))return m;const H=e&&e===this.ownerID,Y=g?m?h:h^p:h|p,N=g?m?pr(v,_,m,H):In(v,_,H):Sn(v,_,m,H);return H?(this.bitmap=Y,this.nodes=N,this):new ze(e,Y,N)}}class ht{constructor(e,t,r){this.ownerID=e,this.count=t,this.nodes=r}get(e,t,r,s){t===void 0&&(t=se(r));const n=(e===0?t:t>>>e)&le,c=this.nodes[n];return c?c.get(e+he,t,r,s):s}update(e,t,r,s,n,c,f){r===void 0&&(r=se(s));const d=(t===0?r:r>>>t)&le,p=n===K,h=this.nodes,g=h[d];if(p&&!g)return this;const _=pt(g,e,t+he,r,s,n,c,f);if(_===g)return this;let v=this.count;if(!g)v++;else if(!_&&(v--,v<Mn))return En(e,h,v,d);const w=e&&e===this.ownerID,m=pr(h,d,_,w);return w?(this.count=v,this.nodes=m,this):new ht(e,v,m)}}class Ne{constructor(e,t,r){this.ownerID=e,this.keyHash=t,this.entries=r}get(e,t,r,s){const n=this.entries;for(let c=0,f=n.length;c<f;c++)if(pe(r,n[c][0]))return n[c][1];return s}update(e,t,r,s,n,c,f){r===void 0&&(r=se(s));const d=n===K;if(r!==this.keyHash)return d?this:($(f),$(c),gt(this,e,t,r,[s,n]));const p=this.entries;let h=0;const g=p.length;for(;h<g&&!pe(s,p[h][0]);h++);const _=h<g;if(_?p[h][1]===n:d)return this;if($(f),(d||!_)&&$(c),d&&g===2)return new ne(e,this.keyHash,p[h^1]);const v=e&&e===this.ownerID,w=v?p:ut(p);return _?d?h===g-1?w.pop():w[h]=w.pop():w[h]=[s,n]:w.push([s,n]),v?(this.entries=w,this):new Ne(e,this.keyHash,w)}}class ne{constructor(e,t,r){this.ownerID=e,this.keyHash=t,this.entry=r}get(e,t,r,s){return pe(r,this.entry[0])?this.entry[1]:s}update(e,t,r,s,n,c,f){const d=n===K,p=pe(s,this.entry[0]);if(p?n===this.entry[1]:d)return this;if($(f),d){$(c);return}return p?e&&e===this.ownerID?(this.entry[1]=n,this):new ne(e,this.keyHash,[s,n]):($(c),gt(this,e,t,se(s),[s,n]))}}class rt{constructor(e,t,r){y(this,"_stack");this._type=t,this._reverse=r,this._stack=e._root&&Xt(e._root)}[Symbol.iterator](){return this}next(){const e=this._type;let t=this._stack;for(;t;){const r=t.node,s=t.index++;let n;if(r.entry){if(s===0)return st(e,r.entry)}else if("entries"in r&&r.entries){if(n=r.entries.length-1,s<=n)return st(e,r.entries[this._reverse?n-s:s])}else if(n=r.nodes.length-1,s<=n){const c=r.nodes[this._reverse?n-s:s];if(c){if(c.entry)return st(e,c.entry);t=this._stack=Xt(c,t)}continue}t=this._stack=this._stack.__prev}return bn()}}function st(o,e){return wn(o,e[0],e[1])}function Xt(o,e){return{node:o,index:0,__prev:e}}const hr=0,lr=1,vn=2;function wn(o,e,t,r){const s=o===hr?e:o===lr?t:[e,t];return r?r.value=s:r={value:s,done:!1},r}function bn(){return{value:void 0,done:!0}}function lt(o,e,t,r){const s=Object.create(ft.prototype);return s.size=o,s._root=e,s.__ownerID=t,s.__hash=r,s.__altered=!1,s}let Jt;function de(){return Jt||(Jt=lt(0))}function kt(o,e,t){let r,s;if(o._root){const n=Qt(),c=Qt();if(r=pt(o._root,o.__ownerID,0,void 0,e,t,n,c),!c.value)return o;s=o.size+(n.value?t===K?-1:1:0)}else{if(t===K)return o;s=1,r=new dt(o.__ownerID,[[e,t]])}return o.__ownerID?(o.size=s,o._root=r,o.__hash=void 0,o.__altered=!0,o):r?lt(s,r):de()}function pt(o,e,t,r,s,n,c,f){return o?o.update(e,t,r,s,n,c,f):n===K?o:($(f),$(c),new ne(e,r,[s,n]))}function er(o){return o.constructor===ne||o.constructor===Ne}function gt(o,e,t,r,s){if(o.keyHash===r)return new Ne(e,r,[o.entry,s]);const n=(t===0?o.keyHash:o.keyHash>>>t)&le,c=(t===0?r:r>>>t)&le;let f;const d=n===c?[gt(o,e,t+he,r,s)]:(f=new ne(e,r,s),n<c?[o,f]:[f,o]);return new ze(e,1<<n|1<<c,d)}function An(o,e,t,r){o||(o=new dr);let s=new ne(o,se(t),[t,r]);for(let n=0;n<e.length;n++){const c=e[n];s=s.update(o,0,void 0,c[0],c[1])}return s}function En(o,e,t,r){let s=0,n=0;const c=new Array(t);for(let f=0,d=1,p=e.length;f<p;f++,d<<=1){const h=e[f];h!==void 0&&f!==r&&(s|=d,c[n++]=h)}return new ze(o,s,c)}function Cn(o,e,t,r,s){let n=0;const c=new Array(be);for(let f=0;t!==0;f++,t>>>=1)c[f]=t&1?e[n++]:void 0;return c[r]=s,new ht(o,n+1,c)}function tr(o){return o-=o>>1&1431655765,o=(o&858993459)+(o>>2&858993459),o=o+(o>>4)&252645135,o+=o>>8,o+=o>>16,o&127}function pr(o,e,t,r){const s=r?o:ut(o);return s[e]=t,s}function Sn(o,e,t,r){const s=o.length+1;if(r&&e+1===s)return o[e]=t,o;const n=new Array(s);let c=0;for(let f=0;f<s;f++)f===e?(n[f]=t,c=-1):n[f]=o[f+c];return n}function In(o,e,t){const r=o.length-1;if(t&&e===r)return o.pop(),o;const s=new Array(r);let n=0;for(let c=0;c<r;c++)c===e&&(n=1),s[c]=o[c+n];return s}const Tn=be/4,On=be/2,Mn=be/4;var or,ar;class rr{constructor(e,t){y(this,"atoms");y(this,or,"AtomMap");this.name=e;let r=de();t&&(r=r.withMutations(s=>{for(const[n,c]of t)s.set(n,qe(`${e}:${String(n)}`,c))})),this.atoms=qe(`${e}:atoms`,r)}getAtom(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);if(!t){this.atoms.get();return}return t}get(e){var r;const t=(r=this.getAtom(e))==null?void 0:r.get();return I(t!==j),t}__unsafe__getWithoutCapture(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);if(!t)return;const r=t.__unsafe__getWithoutCapture();return I(r!==j),r}has(e){const t=this.getAtom(e);return t?t.get()!==j:!1}__unsafe__hasWithoutCapture(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);return t?(I(t.__unsafe__getWithoutCapture()!==j),!0):!1}set(e,t){const r=this.atoms.__unsafe__getWithoutCapture().get(e);return r?r.set(t):this.atoms.update(s=>s.set(e,qe(`${this.name}:${String(e)}`,t))),this}update(e,t){const r=this.atoms.__unsafe__getWithoutCapture().get(e);if(!r)throw new Error(`AtomMap: key ${e} not found`);const s=r.__unsafe__getWithoutCapture();I(s!==j),r.set(t(s))}delete(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);return t?(we(()=>{t.set(j),this.atoms.update(r=>r.delete(e))}),!0):!1}deleteMany(e){return we(()=>{const t=[],r=this.atoms.get().withMutations(s=>{for(const n of e){const c=s.get(n);if(!c)continue;const f=c.get();I(f!==j),t.push([n,f]),s.delete(n),c.set(j)}});return t.length&&this.atoms.set(r),t})}clear(){return we(()=>{for(const e of this.atoms.__unsafe__getWithoutCapture().values())e.set(j);this.atoms.set(de())})}*entries(){for(const[e,t]of this.atoms.get()){const r=t.get();I(r!==j),yield[e,r]}}*keys(){for(const e of this.atoms.get().keys())yield e}*values(){for(const e of this.atoms.get().values()){const t=e.get();I(t!==j),yield t}}get size(){return this.atoms.get().size}forEach(e,t){for(const[r,s]of this.entries())e.call(t,s,r,this)}[(ar=Symbol.iterator,or=Symbol.toStringTag,ar)](){return this.entries()}}class nt{constructor(e){y(this,"nextValue");y(this,"diff");this.previousValue=e}get(){var r,s,n,c;const e=((s=(r=this.diff)==null?void 0:r.removed)==null?void 0:s.size)??0,t=((c=(n=this.diff)==null?void 0:n.added)==null?void 0:c.size)??0;if(!(e===0&&t===0))return{value:this.nextValue,diff:this.diff}}_add(e,t){var r,s;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.add(e),this.diff??(this.diff={}),t?(r=this.diff.removed)==null||r.delete(e):((s=this.diff).added??(s.added=new Set),this.diff.added.add(e))}add(e){var s,n,c;const t=this.previousValue.has(e);if(t)return((n=(s=this.diff)==null?void 0:s.removed)==null?void 0:n.has(e))?this._add(e,t):void 0;(c=this.nextValue)!=null&&c.has(e)||this._add(e,t)}_remove(e,t){var r,s;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.delete(e),this.diff??(this.diff={}),t?((r=this.diff).removed??(r.removed=new Set),this.diff.removed.add(e)):(s=this.diff.added)==null||s.delete(e)}remove(e){var s,n,c,f;const t=this.previousValue.has(e);if(!t)return((n=(s=this.diff)==null?void 0:s.added)==null?void 0:n.has(e))?this._remove(e,t):void 0;(f=(c=this.diff)==null?void 0:c.removed)!=null&&f.has(e)||this._remove(e,t)}}class _t{constructor(e,t){y(this,"createDefaultProperties");y(this,"validator");y(this,"ephemeralKeys");y(this,"ephemeralKeySet");y(this,"scope");this.typeName=e,this.createDefaultProperties=t.createDefaultProperties,this.validator=t.validator??{validate:s=>s},this.scope=t.scope??"document",this.ephemeralKeys=t.ephemeralKeys;const r=new Set;if(t.ephemeralKeys)for(const[s,n]of fe(t.ephemeralKeys))n&&r.add(s);this.ephemeralKeySet=r}create(e){const t={...this.createDefaultProperties(),id:"id"in e?e.id:this.createId()};for(const[r,s]of Object.entries(e))s!==void 0&&(t[r]=s);return t.typeName=this.typeName,t}clone(e){return{...oe(e),id:this.createId()}}createId(e){return this.typeName+":"+(e??cr())}createCustomId(e){return this.typeName+":"+e}parseId(e){if(!this.isId(e))throw new Error(`ID "${e}" is not a valid ID for type "${this.typeName}"`);return e.slice(this.typeName.length+1)}isInstance(e){return(e==null?void 0:e.typeName)===this.typeName}isId(e){if(!e)return!1;for(let t=0;t<this.typeName.length;t++)if(e[t]!==this.typeName[t])return!1;return e[this.typeName.length]===":"}withDefaultProperties(e){return new _t(this.typeName,{createDefaultProperties:e,validator:this.validator,scope:this.scope,ephemeralKeys:this.ephemeralKeys})}validate(e,t){return t&&this.validator.validateUsingKnownGoodVersion?this.validator.validateUsingKnownGoodVersion(t,e):this.validator.validate(e)}}function Vn(o,e){return new _t(o,{createDefaultProperties:()=>({}),validator:e.validator,scope:e.scope,ephemeralKeys:e.ephemeralKeys})}function gr(o){const e={added:{},removed:{},updated:{}};return Hn(e,o),e}function Hn(o,e){for(const t of e){for(const[r,s]of fe(t.added))if(o.removed[r]){const n=o.removed[r];delete o.removed[r],n!==s&&(o.updated[r]=[n,s])}else o.added[r]=s;for(const[r,[s,n]]of fe(t.updated)){if(o.added[r]){o.added[r]=n,delete o.updated[r],delete o.removed[r];continue}if(o.updated[r]){o.updated[r]=[o.updated[r][0],n],delete o.removed[r];continue}o.updated[r]=t.updated[r],delete o.removed[r]}for(const[r,s]of fe(t.removed))o.added[r]?delete o.added[r]:o.updated[r]?(o.removed[r]=o.updated[r][0],delete o.updated[r]):o.removed[r]=s}}var je={exports:{}};je.exports;(function(o,e){var t=200,r="__lodash_hash_undefined__",s=1,n=2,c=9007199254740991,f="[object Arguments]",d="[object Array]",p="[object AsyncFunction]",h="[object Boolean]",g="[object Date]",_="[object Error]",v="[object Function]",w="[object GeneratorFunction]",m="[object Map]",H="[object Number]",Y="[object Null]",N="[object Object]",mt="[object Promise]",yr="[object Proxy]",yt="[object RegExp]",Ae="[object Set]",vt="[object String]",vr="[object Symbol]",wr="[object Undefined]",Le="[object WeakMap]",wt="[object ArrayBuffer]",Ee="[object DataView]",br="[object Float32Array]",Ar="[object Float64Array]",Er="[object Int8Array]",Cr="[object Int16Array]",Sr="[object Int32Array]",Ir="[object Uint8Array]",Tr="[object Uint8ClampedArray]",Or="[object Uint16Array]",Mr="[object Uint32Array]",Hr=/[\\^$.*+?()[\]{}|]/g,xr=/^\[object .+?Constructor\]$/,Rr=/^(?:0|[1-9]\d*)$/,A={};A[br]=A[Ar]=A[Er]=A[Cr]=A[Sr]=A[Ir]=A[Tr]=A[Or]=A[Mr]=!0,A[f]=A[d]=A[wt]=A[h]=A[Ee]=A[g]=A[_]=A[v]=A[m]=A[H]=A[N]=A[yt]=A[Ae]=A[vt]=A[Le]=!1;var bt=typeof De=="object"&&De&&De.Object===Object&&De,Dr=typeof self=="object"&&self&&self.Object===Object&&self,L=bt||Dr||Function("return this")(),At=e&&!e.nodeType&&e,Et=At&&!0&&o&&!o.nodeType&&o,Ct=Et&&Et.exports===At,Be=Ct&&bt.process,St=function(){try{return Be&&Be.binding&&Be.binding("util")}catch{}}(),It=St&&St.isTypedArray;function qr(i,a){for(var u=-1,l=i==null?0:i.length,E=0,b=[];++u<l;){var S=i[u];a(S,u,i)&&(b[E++]=S)}return b}function Pr(i,a){for(var u=-1,l=a.length,E=i.length;++u<l;)i[E+u]=a[u];return i}function jr(i,a){for(var u=-1,l=i==null?0:i.length;++u<l;)if(a(i[u],u,i))return!0;return!1}function $r(i,a){for(var u=-1,l=Array(i);++u<i;)l[u]=a(u);return l}function zr(i){return function(a){return i(a)}}function Nr(i,a){return i.has(a)}function Lr(i,a){return i==null?void 0:i[a]}function Br(i){var a=-1,u=Array(i.size);return i.forEach(function(l,E){u[++a]=[E,l]}),u}function Ur(i,a){return function(u){return i(a(u))}}function Kr(i){var a=-1,u=Array(i.size);return i.forEach(function(l){u[++a]=l}),u}var Vr=Array.prototype,Wr=Function.prototype,Ce=Object.prototype,Ue=L["__core-js_shared__"],Tt=Wr.toString,z=Ce.hasOwnProperty,Ot=function(){var i=/[^.]+$/.exec(Ue&&Ue.keys&&Ue.keys.IE_PROTO||"");return i?"Symbol(src)_1."+i:""}(),Mt=Ce.toString,Fr=RegExp("^"+Tt.call(z).replace(Hr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ht=Ct?L.Buffer:void 0,Se=L.Symbol,xt=L.Uint8Array,Rt=Ce.propertyIsEnumerable,Gr=Vr.splice,Q=Se?Se.toStringTag:void 0,Dt=Object.getOwnPropertySymbols,Zr=Ht?Ht.isBuffer:void 0,Yr=Ur(Object.keys,Object),Ke=ie(L,"DataView"),ge=ie(L,"Map"),Ve=ie(L,"Promise"),We=ie(L,"Set"),Fe=ie(L,"WeakMap"),_e=ie(Object,"create"),Qr=k(Ke),Xr=k(ge),Jr=k(Ve),kr=k(We),es=k(Fe),qt=Se?Se.prototype:void 0,Ge=qt?qt.valueOf:void 0;function X(i){var a=-1,u=i==null?0:i.length;for(this.clear();++a<u;){var l=i[a];this.set(l[0],l[1])}}function ts(){this.__data__=_e?_e(null):{},this.size=0}function rs(i){var a=this.has(i)&&delete this.__data__[i];return this.size-=a?1:0,a}function ss(i){var a=this.__data__;if(_e){var u=a[i];return u===r?void 0:u}return z.call(a,i)?a[i]:void 0}function ns(i){var a=this.__data__;return _e?a[i]!==void 0:z.call(a,i)}function is(i,a){var u=this.__data__;return this.size+=this.has(i)?0:1,u[i]=_e&&a===void 0?r:a,this}X.prototype.clear=ts,X.prototype.delete=rs,X.prototype.get=ss,X.prototype.has=ns,X.prototype.set=is;function B(i){var a=-1,u=i==null?0:i.length;for(this.clear();++a<u;){var l=i[a];this.set(l[0],l[1])}}function os(){this.__data__=[],this.size=0}function as(i){var a=this.__data__,u=Te(a,i);if(u<0)return!1;var l=a.length-1;return u==l?a.pop():Gr.call(a,u,1),--this.size,!0}function cs(i){var a=this.__data__,u=Te(a,i);return u<0?void 0:a[u][1]}function us(i){return Te(this.__data__,i)>-1}function fs(i,a){var u=this.__data__,l=Te(u,i);return l<0?(++this.size,u.push([i,a])):u[l][1]=a,this}B.prototype.clear=os,B.prototype.delete=as,B.prototype.get=cs,B.prototype.has=us,B.prototype.set=fs;function J(i){var a=-1,u=i==null?0:i.length;for(this.clear();++a<u;){var l=i[a];this.set(l[0],l[1])}}function ds(){this.size=0,this.__data__={hash:new X,map:new(ge||B),string:new X}}function hs(i){var a=Oe(this,i).delete(i);return this.size-=a?1:0,a}function ls(i){return Oe(this,i).get(i)}function ps(i){return Oe(this,i).has(i)}function gs(i,a){var u=Oe(this,i),l=u.size;return u.set(i,a),this.size+=u.size==l?0:1,this}J.prototype.clear=ds,J.prototype.delete=hs,J.prototype.get=ls,J.prototype.has=ps,J.prototype.set=gs;function Ie(i){var a=-1,u=i==null?0:i.length;for(this.__data__=new J;++a<u;)this.add(i[a])}function _s(i){return this.__data__.set(i,r),this}function ms(i){return this.__data__.has(i)}Ie.prototype.add=Ie.prototype.push=_s,Ie.prototype.has=ms;function V(i){var a=this.__data__=new B(i);this.size=a.size}function ys(){this.__data__=new B,this.size=0}function vs(i){var a=this.__data__,u=a.delete(i);return this.size=a.size,u}function ws(i){return this.__data__.get(i)}function bs(i){return this.__data__.has(i)}function As(i,a){var u=this.__data__;if(u instanceof B){var l=u.__data__;if(!ge||l.length<t-1)return l.push([i,a]),this.size=++u.size,this;u=this.__data__=new J(l)}return u.set(i,a),this.size=u.size,this}V.prototype.clear=ys,V.prototype.delete=vs,V.prototype.get=ws,V.prototype.has=bs,V.prototype.set=As;function Es(i,a){var u=Me(i),l=!u&&zs(i),E=!u&&!l&&Ze(i),b=!u&&!l&&!E&&Kt(i),S=u||l||E||b,T=S?$r(i.length,String):[],O=T.length;for(var C in i)z.call(i,C)&&!(S&&(C=="length"||E&&(C=="offset"||C=="parent")||b&&(C=="buffer"||C=="byteLength"||C=="byteOffset")||Ds(C,O)))&&T.push(C);return T}function Te(i,a){for(var u=i.length;u--;)if(Nt(i[u][0],a))return u;return-1}function Cs(i,a,u){var l=a(i);return Me(i)?l:Pr(l,u(i))}function me(i){return i==null?i===void 0?wr:Y:Q&&Q in Object(i)?xs(i):$s(i)}function Pt(i){return ye(i)&&me(i)==f}function jt(i,a,u,l,E){return i===a?!0:i==null||a==null||!ye(i)&&!ye(a)?i!==i&&a!==a:Ss(i,a,u,l,jt,E)}function Ss(i,a,u,l,E,b){var S=Me(i),T=Me(a),O=S?d:W(i),C=T?d:W(a);O=O==f?N:O,C=C==f?N:C;var R=O==N,P=C==N,M=O==C;if(M&&Ze(i)){if(!Ze(a))return!1;S=!0,R=!1}if(M&&!R)return b||(b=new V),S||Kt(i)?$t(i,a,u,l,E,b):Ms(i,a,O,u,l,E,b);if(!(u&s)){var D=R&&z.call(i,"__wrapped__"),q=P&&z.call(a,"__wrapped__");if(D||q){var F=D?i.value():i,U=q?a.value():a;return b||(b=new V),E(F,U,u,l,b)}}return M?(b||(b=new V),Hs(i,a,u,l,E,b)):!1}function Is(i){if(!Ut(i)||Ps(i))return!1;var a=Lt(i)?Fr:xr;return a.test(k(i))}function Ts(i){return ye(i)&&Bt(i.length)&&!!A[me(i)]}function Os(i){if(!js(i))return Yr(i);var a=[];for(var u in Object(i))z.call(i,u)&&u!="constructor"&&a.push(u);return a}function $t(i,a,u,l,E,b){var S=u&s,T=i.length,O=a.length;if(T!=O&&!(S&&O>T))return!1;var C=b.get(i);if(C&&b.get(a))return C==a;var R=-1,P=!0,M=u&n?new Ie:void 0;for(b.set(i,a),b.set(a,i);++R<T;){var D=i[R],q=a[R];if(l)var F=S?l(q,D,R,a,i,b):l(D,q,R,i,a,b);if(F!==void 0){if(F)continue;P=!1;break}if(M){if(!jr(a,function(U,ee){if(!Nr(M,ee)&&(D===U||E(D,U,u,l,b)))return M.push(ee)})){P=!1;break}}else if(!(D===q||E(D,q,u,l,b))){P=!1;break}}return b.delete(i),b.delete(a),P}function Ms(i,a,u,l,E,b,S){switch(u){case Ee:if(i.byteLength!=a.byteLength||i.byteOffset!=a.byteOffset)return!1;i=i.buffer,a=a.buffer;case wt:return!(i.byteLength!=a.byteLength||!b(new xt(i),new xt(a)));case h:case g:case H:return Nt(+i,+a);case _:return i.name==a.name&&i.message==a.message;case yt:case vt:return i==a+"";case m:var T=Br;case Ae:var O=l&s;if(T||(T=Kr),i.size!=a.size&&!O)return!1;var C=S.get(i);if(C)return C==a;l|=n,S.set(i,a);var R=$t(T(i),T(a),l,E,b,S);return S.delete(i),R;case vr:if(Ge)return Ge.call(i)==Ge.call(a)}return!1}function Hs(i,a,u,l,E,b){var S=u&s,T=zt(i),O=T.length,C=zt(a),R=C.length;if(O!=R&&!S)return!1;for(var P=O;P--;){var M=T[P];if(!(S?M in a:z.call(a,M)))return!1}var D=b.get(i);if(D&&b.get(a))return D==a;var q=!0;b.set(i,a),b.set(a,i);for(var F=S;++P<O;){M=T[P];var U=i[M],ee=a[M];if(l)var Vt=S?l(ee,U,M,a,i,b):l(U,ee,M,i,a,b);if(!(Vt===void 0?U===ee||E(U,ee,u,l,b):Vt)){q=!1;break}F||(F=M=="constructor")}if(q&&!F){var He=i.constructor,xe=a.constructor;He!=xe&&"constructor"in i&&"constructor"in a&&!(typeof He=="function"&&He instanceof He&&typeof xe=="function"&&xe instanceof xe)&&(q=!1)}return b.delete(i),b.delete(a),q}function zt(i){return Cs(i,Bs,Rs)}function Oe(i,a){var u=i.__data__;return qs(a)?u[typeof a=="string"?"string":"hash"]:u.map}function ie(i,a){var u=Lr(i,a);return Is(u)?u:void 0}function xs(i){var a=z.call(i,Q),u=i[Q];try{i[Q]=void 0;var l=!0}catch{}var E=Mt.call(i);return l&&(a?i[Q]=u:delete i[Q]),E}var Rs=Dt?function(i){return i==null?[]:(i=Object(i),qr(Dt(i),function(a){return Rt.call(i,a)}))}:Us,W=me;(Ke&&W(new Ke(new ArrayBuffer(1)))!=Ee||ge&&W(new ge)!=m||Ve&&W(Ve.resolve())!=mt||We&&W(new We)!=Ae||Fe&&W(new Fe)!=Le)&&(W=function(i){var a=me(i),u=a==N?i.constructor:void 0,l=u?k(u):"";if(l)switch(l){case Qr:return Ee;case Xr:return m;case Jr:return mt;case kr:return Ae;case es:return Le}return a});function Ds(i,a){return a=a??c,!!a&&(typeof i=="number"||Rr.test(i))&&i>-1&&i%1==0&&i<a}function qs(i){var a=typeof i;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?i!=="__proto__":i===null}function Ps(i){return!!Ot&&Ot in i}function js(i){var a=i&&i.constructor,u=typeof a=="function"&&a.prototype||Ce;return i===u}function $s(i){return Mt.call(i)}function k(i){if(i!=null){try{return Tt.call(i)}catch{}try{return i+""}catch{}}return""}function Nt(i,a){return i===a||i!==i&&a!==a}var zs=Pt(function(){return arguments}())?Pt:function(i){return ye(i)&&z.call(i,"callee")&&!Rt.call(i,"callee")},Me=Array.isArray;function Ns(i){return i!=null&&Bt(i.length)&&!Lt(i)}var Ze=Zr||Ks;function Ls(i,a){return jt(i,a)}function Lt(i){if(!Ut(i))return!1;var a=me(i);return a==v||a==w||a==p||a==yr}function Bt(i){return typeof i=="number"&&i>-1&&i%1==0&&i<=c}function Ut(i){var a=typeof i;return i!=null&&(a=="object"||a=="function")}function ye(i){return i!=null&&typeof i=="object"}var Kt=It?zr(It):Ts;function Bs(i){return Ns(i)?Es(i):Os(i)}function Us(){return[]}function Ks(){return!1}o.exports=Ls})(je,je.exports);var xn=je.exports;const _r=Qs(xn);function Rn(o){if(o.length===0)return new Set;const e=o[0],t=o.slice(1),r=new Set;for(const s of e)t.every(n=>n.has(s))&&r.add(s);return r}function Dn(o,e){const t={};for(const r of e)o.has(r)||(t.added??(t.added=new Set),t.added.add(r));for(const r of o)e.has(r)||(t.removed??(t.removed=new Set),t.removed.add(r));return t.added||t.removed?t:void 0}function sr(o,e){for(const[t,r]of Object.entries(o)){const s=r,n=e[t];if("eq"in s&&n!==s.eq||"neq"in s&&n===s.neq||"gt"in s&&(typeof n!="number"||n<=s.gt))return!1}return!0}function nr(o,e,t){const r=Object.fromEntries(Object.keys(t).map(s=>[s,new Set]));for(const[s,n]of Object.entries(t))if("eq"in n){const f=o.index(e,s).get().get(n.eq);if(f)for(const d of f)r[s].add(d)}else if("neq"in n){const c=o.index(e,s);for(const[f,d]of c.get())if(f!==n.neq)for(const p of d)r[s].add(p)}else if("gt"in n){const c=o.index(e,s);for(const[f,d]of c.get())if(f>n.gt)for(const p of d)r[s].add(p)}return Rn(Object.values(r))}class qn{constructor(e,t){y(this,"indexCache",new Map);y(this,"historyCache",new Map);this.recordMap=e,this.history=t}filterHistory(e){if(this.historyCache.has(e))return this.historyCache.get(e);const t=Z("filterHistory:"+e,(r,s)=>{if(Ye(r))return this.history.get();const n=this.history.getDiffSince(s);if(n===Qe)return this.history.get();const c={added:{},removed:{},updated:{}};let f=0,d=0,p=0;for(const h of n){for(const g of x(h.added))if(g.typeName===e)if(c.removed[g.id]){const _=c.removed[g.id];delete c.removed[g.id],d--,_!==g&&(c.updated[g.id]=[_,g],p++)}else c.added[g.id]=g,f++;for(const[g,_]of x(h.updated))_.typeName===e&&(c.added[_.id]?c.added[_.id]=_:c.updated[_.id]?c.updated[_.id]=[c.updated[_.id][0],_]:(c.updated[_.id]=[g,_],p++));for(const g of x(h.removed))g.typeName===e&&(c.added[g.id]?(delete c.added[g.id],f--):c.updated[g.id]?(c.removed[g.id]=c.updated[g.id][0],delete c.updated[g.id],p--,d++):(c.removed[g.id]=g,d++))}return f||d||p?Re(this.history.get(),c):r},{historyLength:100});return this.historyCache.set(e,t),t}index(e,t){const r=e+":"+t;if(this.indexCache.has(r))return this.indexCache.get(r);const s=this.__uncached_createIndex(e,t);return this.indexCache.set(r,s),s}__uncached_createIndex(e,t){const r=this.filterHistory(e),s=()=>{r.get();const n=new Map;for(const c of this.recordMap.values())if(c.typeName===e){const f=c[t];n.has(f)||n.set(f,new Set),n.get(f).add(c.id)}return n};return Z("index:"+e+":"+t,(n,c)=>{if(Ye(n))return s();const f=r.getDiffSince(c);if(f===Qe)return s();const d=new Map,p=(v,w)=>{let m=d.get(v);m||(m=new nt(n.get(v)??new Set)),m.add(w),d.set(v,m)},h=(v,w)=>{let m=d.get(v);m||(m=new nt(n.get(v)??new Set)),m.remove(w),d.set(v,m)};for(const v of f){for(const w of x(v.added))if(w.typeName===e){const m=w[t];p(m,w.id)}for(const[w,m]of x(v.updated))if(m.typeName===e){const H=w[t],Y=m[t];H!==Y&&(h(H,m.id),p(Y,m.id))}for(const w of x(v.removed))if(w.typeName===e){const m=w[t];h(m,w.id)}}let g,_;for(const[v,w]of d){const m=w.get();m&&(g||(g=new Map(n)),_||(_=new Map),m.value.size===0?g.delete(v):g.set(v,m.value),_.set(v,m.diff))}return g&&_?Re(g,_):n},{historyLength:100})}record(e,t=()=>({}),r="record:"+e+(t?":"+t.toString():"")){const s=this.ids(e,t,r);return Z(r,()=>{for(const n of s.get())return this.recordMap.get(n)})}records(e,t=()=>({}),r="records:"+e+(t?":"+t.toString():"")){const s=this.ids(e,t,"ids:"+r);return Z(r,()=>Array.from(s.get(),n=>this.recordMap.get(n)),{isEqual:Xs})}ids(e,t=()=>({}),r="ids:"+e+(t?":"+t.toString():"")){const s=this.filterHistory(e),n=()=>{s.get();const d=t();if(Object.keys(d).length===0){const p=new Set;for(const h of this.recordMap.values())h.typeName===e&&p.add(h.id);return p}return nr(this,e,d)},c=d=>{const p=n(),h=Dn(d,p);return h?Re(p,h):d},f=Z("ids_query:"+r,t,{isEqual:_r});return Z("query:"+r,(d,p)=>{const h=f.get();if(Ye(d))return n();if(p<f.lastChangedEpoch)return c(d);const g=s.getDiffSince(p);if(g===Qe)return c(d);const _=new nt(d);for(const w of g){for(const m of x(w.added))m.typeName===e&&sr(h,m)&&_.add(m.id);for(const[m,H]of x(w.updated))H.typeName===e&&(sr(h,H)?_.add(H.id):_.remove(H.id));for(const m of x(w.removed))m.typeName===e&&_.remove(m.id)}const v=_.get();return v?Re(v.value,v.diff):d},{historyLength:50})}exec(e,t){const r=nr(this,e,t);return r.size===0?Fs:Array.from(r,s=>this.recordMap.get(s))}}class Pn{constructor(e){y(this,"_beforeCreateHandlers",{});y(this,"_afterCreateHandlers",{});y(this,"_beforeChangeHandlers",{});y(this,"_afterChangeHandlers",{});y(this,"_beforeDeleteHandlers",{});y(this,"_afterDeleteHandlers",{});y(this,"_operationCompleteHandlers",[]);y(this,"_isEnabled",!0);this.store=e}isEnabled(){return this._isEnabled}setIsEnabled(e){this._isEnabled=e}handleBeforeCreate(e,t){if(!this._isEnabled)return e;const r=this._beforeCreateHandlers[e.typeName];if(r){let s=e;for(const n of r)s=n(s,t);return s}return e}handleAfterCreate(e,t){if(!this._isEnabled)return;const r=this._afterCreateHandlers[e.typeName];if(r)for(const s of r)s(e,t)}handleBeforeChange(e,t,r){if(!this._isEnabled)return t;const s=this._beforeChangeHandlers[t.typeName];if(s){let n=t;for(const c of s)n=c(e,n,r);return n}return t}handleAfterChange(e,t,r){if(!this._isEnabled)return;const s=this._afterChangeHandlers[t.typeName];if(s)for(const n of s)n(e,t,r)}handleBeforeDelete(e,t){if(!this._isEnabled)return!0;const r=this._beforeDeleteHandlers[e.typeName];if(r){for(const s of r)if(s(e,t)===!1)return!1}return!0}handleAfterDelete(e,t){if(!this._isEnabled)return;const r=this._afterDeleteHandlers[e.typeName];if(r)for(const s of r)s(e,t)}handleOperationComplete(e){if(this._isEnabled)for(const t of this._operationCompleteHandlers)t(e)}register(e){const t=[];for(const[r,s]of Object.entries(e))s!=null&&s.beforeCreate&&t.push(this.registerBeforeCreateHandler(r,s.beforeCreate)),s!=null&&s.afterCreate&&t.push(this.registerAfterCreateHandler(r,s.afterCreate)),s!=null&&s.beforeChange&&t.push(this.registerBeforeChangeHandler(r,s.beforeChange)),s!=null&&s.afterChange&&t.push(this.registerAfterChangeHandler(r,s.afterChange)),s!=null&&s.beforeDelete&&t.push(this.registerBeforeDeleteHandler(r,s.beforeDelete)),s!=null&&s.afterDelete&&t.push(this.registerAfterDeleteHandler(r,s.afterDelete));return()=>{for(const r of t)r()}}registerBeforeCreateHandler(e,t){return this._beforeCreateHandlers[e]||(this._beforeCreateHandlers[e]=[]),this._beforeCreateHandlers[e].push(t),()=>te(this._beforeCreateHandlers[e],t)}registerAfterCreateHandler(e,t){return this._afterCreateHandlers[e]||(this._afterCreateHandlers[e]=[]),this._afterCreateHandlers[e].push(t),()=>te(this._afterCreateHandlers[e],t)}registerBeforeChangeHandler(e,t){return this._beforeChangeHandlers[e]||(this._beforeChangeHandlers[e]=[]),this._beforeChangeHandlers[e].push(t),()=>te(this._beforeChangeHandlers[e],t)}registerAfterChangeHandler(e,t){return this._afterChangeHandlers[e]||(this._afterChangeHandlers[e]=[]),this._afterChangeHandlers[e].push(t),()=>te(this._afterChangeHandlers[e],t)}registerBeforeDeleteHandler(e,t){return this._beforeDeleteHandlers[e]||(this._beforeDeleteHandlers[e]=[]),this._beforeDeleteHandlers[e].push(t),()=>te(this._beforeDeleteHandlers[e],t)}registerAfterDeleteHandler(e,t){return this._afterDeleteHandlers[e]||(this._afterDeleteHandlers[e]=[]),this._afterDeleteHandlers[e].push(t),()=>te(this._afterDeleteHandlers[e],t)}registerOperationCompleteHandler(e){return this._operationCompleteHandlers.push(e),()=>te(this._operationCompleteHandlers,e)}}function te(o,e){const t=o.indexOf(e);t>=0&&o.splice(t,1)}let Wn=class{constructor(e){y(this,"id");y(this,"records");y(this,"history",qe("history",0,{historyLength:1e3}));y(this,"query");y(this,"listeners",new Set);y(this,"historyAccumulator",new $n);y(this,"historyReactor");y(this,"schema");y(this,"props");y(this,"scopedTypes");y(this,"sideEffects",new Pn(this));y(this,"isMergingRemoteChanges",!1);y(this,"_integrityChecker");y(this,"_isPossiblyCorrupted",!1);y(this,"pendingAfterEvents",null);y(this,"_isInAtomicOp",!1);const{initialData:t,schema:r,id:s}=e;this.id=s??cr(),this.schema=r,this.props=e.props,t?this.records=new rr("store",fe(t).map(([n,c])=>[n,this.schema.validateRecord(this,c,"initialize",null)])):this.records=new rr("store"),this.query=new qn(this.records,this.history),this.historyReactor=Gs("Store.historyReactor",()=>{this.history.get(),this._flushHistory()},{scheduleEffect:n=>this.cancelHistoryReactor=fn(n)}),this.scopedTypes={document:new Set(x(this.schema.types).filter(n=>n.scope==="document").map(n=>n.typeName)),session:new Set(x(this.schema.types).filter(n=>n.scope==="session").map(n=>n.typeName)),presence:new Set(x(this.schema.types).filter(n=>n.scope==="presence").map(n=>n.typeName))}}cancelHistoryReactor(){}_flushHistory(){if(this.historyAccumulator.hasChanges()){const e=this.historyAccumulator.flush();for(const{changes:t,source:r}of e){let s=null,n=null,c=null;for(const{onHistory:f,filters:d}of this.listeners)if(!(d.source!=="all"&&d.source!==r))if(d.scope!=="all")if(d.scope==="document"){if(n??(n=this.filterChangesByScope(t,"document")),!n)continue;f({changes:n,source:r})}else if(d.scope==="session"){if(s??(s=this.filterChangesByScope(t,"session")),!s)continue;f({changes:s,source:r})}else{if(c??(c=this.filterChangesByScope(t,"presence")),!c)continue;f({changes:c,source:r})}else f({changes:t,source:r})}}}dispose(){this.cancelHistoryReactor()}filterChangesByScope(e,t){const r={added:Xe(e.added,(s,n)=>this.scopedTypes[t].has(n.typeName)),updated:Xe(e.updated,(s,n)=>this.scopedTypes[t].has(n[1].typeName)),removed:Xe(e.removed,(s,n)=>this.scopedTypes[t].has(n.typeName))};return Object.keys(r.added).length===0&&Object.keys(r.updated).length===0&&Object.keys(r.removed).length===0?null:r}updateHistory(e){this.historyAccumulator.add({changes:e,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.get()+1,e)}validate(e){this.allRecords().forEach(t=>this.schema.validateRecord(this,t,e,null))}put(e,t){this.atomic(()=>{const r={},s={};let n,c=!1;const f=this.isMergingRemoteChanges?"remote":"user";for(let d=0,p=e.length;d<p;d++){n=e[d];const h=this.records.__unsafe__getWithoutCapture(n.id);if(h){if(n=this.sideEffects.handleBeforeChange(h,n,f),this.schema.validateRecord(this,n,t??"updateRecord",h)===h)continue;n=n,this.records.set(n.id,n),c=!0,r[n.id]=[h,n],this.addDiffForAfterEvent(h,n)}else n=this.sideEffects.handleBeforeCreate(n,f),c=!0,n=this.schema.validateRecord(this,n,t??"createRecord",null),n=n,s[n.id]=n,this.addDiffForAfterEvent(null,n),this.records.set(n.id,n)}c&&this.updateHistory({added:s,updated:r,removed:{}})})}remove(e){this.atomic(()=>{const t=new Set(e),r=this.isMergingRemoteChanges?"remote":"user";if(this.sideEffects.isEnabled())for(const c of e){const f=this.records.__unsafe__getWithoutCapture(c);f&&this.sideEffects.handleBeforeDelete(f,r)===!1&&t.delete(c)}const s=this.records.deleteMany(t);if(s.length===0)return;const n={};for(const[c,f]of s)n[c]=f,this.addDiffForAfterEvent(f,null);this.updateHistory({added:{},updated:{},removed:n})})}get(e){return this.records.get(e)}unsafeGetWithoutCapture(e){return this.records.__unsafe__getWithoutCapture(e)}serialize(e="document"){const t={};for(const[r,s]of this.records)(e==="all"||this.scopedTypes[e].has(s.typeName))&&(t[r]=s);return t}getStoreSnapshot(e="document"){return{store:this.serialize(e),schema:this.schema.serialize()}}getSnapshot(e="document"){return console.warn("[tldraw] `Store.getSnapshot` is deprecated and will be removed in a future release. Use `getSnapshot` from the `tldraw` package instead."),this.getStoreSnapshot(e)}migrateSnapshot(e){const t=this.schema.migrateStoreSnapshot(e);if(t.type==="error")throw new Error(`Failed to migrate snapshot: ${t.reason}`);return{store:t.value,schema:this.schema.serialize()}}loadStoreSnapshot(e){const t=this.schema.migrateStoreSnapshot(e);if(t.type==="error")throw new Error(`Failed to migrate snapshot: ${t.reason}`);const r=this.sideEffects.isEnabled();try{this.sideEffects.setIsEnabled(!1),this.atomic(()=>{this.clear(),this.put(Object.values(t.value)),this.ensureStoreIsUsable()})}finally{this.sideEffects.setIsEnabled(r)}}loadSnapshot(e){console.warn("[tldraw] `Store.loadSnapshot` is deprecated and will be removed in a future release. Use `loadSnapshot` from the 'tldraw' package instead."),this.loadStoreSnapshot(e)}allRecords(){return Array.from(this.records.values())}clear(){this.remove(Array.from(this.records.keys()))}update(e,t){const r=this.unsafeGetWithoutCapture(e);if(!r){console.error(`Record ${e} not found. This is probably an error`);return}this.put([t(r)])}has(e){return this.records.has(e)}listen(e,t){this._flushHistory();const r={onHistory:e,filters:{source:(t==null?void 0:t.source)??"all",scope:(t==null?void 0:t.scope)??"all"}};return this.historyReactor.scheduler.isActivelyListening||(this.historyReactor.start(),this.historyReactor.scheduler.execute()),this.listeners.add(r),()=>{this.listeners.delete(r),this.listeners.size===0&&this.historyReactor.stop()}}mergeRemoteChanges(e){if(this.isMergingRemoteChanges)return e();if(this._isInAtomicOp)throw new Error("Cannot merge remote changes while in atomic operation");try{this.atomic(e,!0,!0)}finally{this.ensureStoreIsUsable()}}extractingChanges(e){const t=[],r=this.historyAccumulator.addInterceptor(s=>t.push(s.changes));try{return we(e),gr(t)}finally{r()}}applyDiff(e,{runCallbacks:t=!0,ignoreEphemeralKeys:r=!1}={}){this.atomic(()=>{const s=x(e.added);for(const[c,f]of x(e.updated)){const d=this.schema.getType(f.typeName);if(r&&d.ephemeralKeySet.size){const p=this.get(f.id);if(!p){s.push(f);continue}let h=null;for(const[g,_]of Object.entries(f))d.ephemeralKeySet.has(g)||Object.is(_,it(p,g))||(h||(h={...p}),h[g]=_);h&&s.push(h)}else s.push(f)}const n=on(e.removed);s.length&&this.put(s),n.length&&this.remove(n)},t)}createCache(e){const t=new Js;return{get:r=>{const s=this.records.getAtom(r);if(s)return t.get(s,()=>e(r,s)).get()}}}createComputedCache(e,t,r){return this.createCache((s,n)=>{const c=r!=null&&r.areRecordsEqual?Z(`${e}:${s}:isEqual`,()=>n.get(),{isEqual:r.areRecordsEqual}):n;return Z(e+":"+s,()=>t(c.get()),{isEqual:r==null?void 0:r.areResultsEqual})})}ensureStoreIsUsable(){this.atomic(()=>{var e;this._integrityChecker??(this._integrityChecker=this.schema.createIntegrityChecker(this)),(e=this._integrityChecker)==null||e.call(this)})}markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}addDiffForAfterEvent(e,t){if(I(this.pendingAfterEvents,"must be in event operation"),e===t||(e&&t&&I(e.id===t.id),!e&&!t))return;const r=(e||t).id,s=this.pendingAfterEvents.get(r);s?s.after=t:this.pendingAfterEvents.set(r,{before:e,after:t})}flushAtomicCallbacks(e){let t=0,r=e?"remote":"user";for(;this.pendingAfterEvents;){const s=this.pendingAfterEvents;if(this.pendingAfterEvents=null,!!this.sideEffects.isEnabled()){if(t++,t>100)throw new Error("Maximum store update depth exceeded, bailing out");for(const{before:n,after:c}of s.values())n&&c&&n!==c&&!_r(n,c)?this.sideEffects.handleAfterChange(n,c,r):n&&!c?this.sideEffects.handleAfterDelete(n,r):!n&&c&&this.sideEffects.handleAfterCreate(c,r);this.pendingAfterEvents?r="user":this.sideEffects.handleOperationComplete(r)}}}atomic(e,t=!0,r=!1){return we(()=>{if(this._isInAtomicOp){this.pendingAfterEvents||(this.pendingAfterEvents=new Map);const n=this.sideEffects.isEnabled();I(!r,"cannot call mergeRemoteChanges while in atomic operation");try{return n&&!t&&this.sideEffects.setIsEnabled(!1),e()}finally{this.sideEffects.setIsEnabled(n)}}this.pendingAfterEvents=new Map;const s=this.sideEffects.isEnabled();this.sideEffects.setIsEnabled(t??s),this._isInAtomicOp=!0,r&&(this.isMergingRemoteChanges=!0);try{const n=e();return this.isMergingRemoteChanges=!1,this.flushAtomicCallbacks(r),n}finally{this.pendingAfterEvents=null,this.sideEffects.setIsEnabled(s),this._isInAtomicOp=!1,this.isMergingRemoteChanges=!1}})}addHistoryInterceptor(e){return this.historyAccumulator.addInterceptor(t=>e(t,this.isMergingRemoteChanges?"remote":"user"))}};function jn(o){if(o.length===0)return[];const e=[];let t=[o[0]],r;for(let s=1,n=o.length;s<n;s++)r=o[s],t[0].source!==r.source&&(e.push(t),t=[]),t.push(r);return e.push(t),e.map(s=>({source:s[0].source,changes:gr(s.map(n=>n.changes))}))}class $n{constructor(){y(this,"_history",[]);y(this,"_interceptors",new Set)}addInterceptor(e){return this._interceptors.add(e),()=>{this._interceptors.delete(e)}}add(e){this._history.push(e);for(const t of this._interceptors)t(e)}flush(){const e=jn(this._history);return this._history=[],e}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function zn(o){const e=new Map(o.map(n=>[n.id,n])),t=new Set,r=[];function s(n){I(!t.has(n.id),`Circular dependency in migrations: ${n.id}`),t.add(n.id);const{version:c,sequenceId:f}=$e(n.id),d=e.get(`${f}/${c-1}`);if(d&&s(d),n.dependsOn)for(const p of n.dependsOn){const h=e.get(p);h&&s(h)}e.delete(n.id),r.push(n)}for(const n of e.values())s(n);return r}function $e(o){const[e,t]=o.split("/");return{sequenceId:e,version:parseInt(t)}}function ir(o,e){e&&I(o.startsWith(e+"/"),`Every migration in sequence '${e}' must have an id starting with '${e}/'. Got invalid id: '${o}'`),I(o.match(/^(.*?)\/(0|[1-9]\d*)$/),`Invalid migration id: '${o}'`)}function Nn(o){if(I(!o.sequenceId.includes("/"),`sequenceId cannot contain a '/', got ${o.sequenceId}`),I(o.sequenceId.length,"sequenceId must be a non-empty string"),o.sequence.length===0)return;ir(o.sequence[0].id,o.sequenceId);let e=$e(o.sequence[0].id).version;I(e===1,`Expected the first migrationId to be '${o.sequenceId}/1' but got '${o.sequence[0].id}'`);for(let t=1;t<o.sequence.length;t++){const r=o.sequence[t].id;ir(r,o.sequenceId);const s=$e(r).version;I(s===e+1,`Migration id numbers must increase in increments of 1, expected ${o.sequenceId}/${e+1} but got '${o.sequence[t].id}'`),e=s}}var G=(o=>(o.IncompatibleSubtype="incompatible-subtype",o.UnknownType="unknown-type",o.TargetVersionTooNew="target-version-too-new",o.TargetVersionTooOld="target-version-too-old",o.MigrationError="migration-error",o.UnrecognizedSubtype="unrecognized-subtype",o))(G||{});function Ln(o){if(o.schemaVersion>2||o.schemaVersion<1)return ue.err("Bad schema version");if(o.schemaVersion===2)return ue.ok(o);const e={schemaVersion:2,sequences:{"com.tldraw.store":o.storeVersion}};for(const[t,r]of Object.entries(o.recordVersions))if(e.sequences[`com.tldraw.${t}`]=r.version,"subTypeKey"in r)for(const[s,n]of Object.entries(r.subTypeVersions))e.sequences[`com.tldraw.${t}.${s}`]=n;return ue.ok(e)}class mr{constructor(e,t){y(this,"migrations",{});y(this,"sortedMigrations");var s;this.types=e,this.options=t;for(const n of t.migrations??[])I(!this.migrations[n.sequenceId],`Duplicate migration sequenceId ${n.sequenceId}`),Nn(n),this.migrations[n.sequenceId]=n;const r=Object.values(this.migrations).flatMap(n=>n.sequence);this.sortedMigrations=zn(r);for(const n of this.sortedMigrations)if((s=n.dependsOn)!=null&&s.length)for(const c of n.dependsOn){const f=r.find(d=>d.id===c);I(f,`Migration '${n.id}' depends on missing migration '${c}'`)}}static create(e,t){return new mr(e,t??{})}validateRecord(e,t,r,s){try{const n=it(this.types,t.typeName);if(!n)throw new Error(`Missing definition for record type ${t.typeName}`);return n.validate(t,s??void 0)}catch(n){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:e,record:t,phase:r,recordBefore:s,error:n});throw n}}getMigrationsSince(e){const t=Ln(e);if(!t.ok)return t;const r=t.value,s=new Set(Object.keys(r.sequences).filter(c=>this.migrations[c]));for(const c in this.migrations)r.sequences[c]===void 0&&this.migrations[c].retroactive&&s.add(c);if(s.size===0)return ue.ok([]);const n=new Set;for(const c of s){const f=r.sequences[c];if(typeof f!="number"&&this.migrations[c].retroactive||f===0){for(const h of this.migrations[c].sequence)n.add(h.id);continue}const d=`${c}/${f}`,p=this.migrations[c].sequence.findIndex(h=>h.id===d);if(p===-1)return ue.err("Incompatible schema?");for(const h of this.migrations[c].sequence.slice(p+1))n.add(h.id)}return ue.ok(this.sortedMigrations.filter(({id:c})=>n.has(c)))}migratePersistedRecord(e,t,r="up"){const s=this.getMigrationsSince(t);if(!s.ok)return console.error("Error migrating record",s.error),{type:"error",reason:G.MigrationError};let n=s.value;if(n.length===0)return{type:"success",value:e};if(n.some(c=>c.scope==="store"))return{type:"error",reason:r==="down"?G.TargetVersionTooOld:G.TargetVersionTooNew};if(r==="down"){if(!n.every(c=>c.down))return{type:"error",reason:G.TargetVersionTooOld};n=n.slice().reverse()}e=oe(e);try{for(const c of n){if(c.scope==="store")throw new Error;if(!(c.filter?c.filter(e):!0))continue;const d=c[r](e);d&&(e=oe(d))}}catch(c){return console.error("Error migrating record",c),{type:"error",reason:G.MigrationError}}return{type:"success",value:e}}migrateStoreSnapshot(e){let{store:t}=e;const r=this.getMigrationsSince(e.schema);if(!r.ok)return console.error("Error migrating store",r.error),{type:"error",reason:G.MigrationError};const s=r.value;if(s.length===0)return{type:"success",value:t};t=oe(t);try{for(const n of s)if(n.scope==="record")for(const[c,f]of Object.entries(t)){if(!(n.filter?n.filter(f):!0))continue;const p=n.up(f);p&&(t[c]=oe(p))}else if(n.scope==="store"){const c=n.up(t);c&&(t=oe(c))}else Zs(n)}catch(n){return console.error("Error migrating store",n),{type:"error",reason:G.MigrationError}}return{type:"success",value:t}}createIntegrityChecker(e){var t,r;return((r=(t=this.options).createIntegrityChecker)==null?void 0:r.call(t,e))??void 0}serialize(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e,sequence:t})=>[e,t.length?$e(t.at(-1).id).version:0]))}}serializeEarliestVersion(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e})=>[e,0]))}}getType(e){const t=it(this.types,e);return I(t,"record type does not exists"),t}}Ys("@tldraw/store","3.13.3","esm");export{mr as S,Wn as a,Vn as c};
