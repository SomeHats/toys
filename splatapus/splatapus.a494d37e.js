import{a as E,b as X,l as fe,K as j,L as be,t as ge,s as Ie,M as ze,h as ie,g as B,N as Ce,f as me,C as Le,B as ae,E as Ae,i as Me,d as D,O as Re}from"../chunks/chunk_assert.8eca55a7.js";/* empty css                               */import{a as De,r as y,R as Ne}from"../chunks/chunk_index.0b2a17fa.js";import{V as k,b as Y,R as U,P as $e,d as Ke,c as N,a as Te,e as ce,p as je}from"../chunks/chunk_Vector2.3a87ad23.js";import{R as Be,j as V,a as W,F as Fe,c as Z}from"../chunks/chunk_ResizeObserver.f9437ff6.js";import{b as Ue}from"../chunks/chunk_easings.276a717e.js";import"../chunks/chunk__commonjsHelpers.fbcca4d8.js";var Q=function n(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,s,c;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(s=r;s--!==0;)if(!n(e[s],t[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(c=Object.keys(e),r=c.length,r!==Object.keys(t).length)return!1;for(s=r;s--!==0;)if(!Object.prototype.hasOwnProperty.call(t,c[s]))return!1;for(s=r;s--!==0;){var a=c[s];if(!n(e[a],t[a]))return!1}return!0}return e!==e&&t!==t},ye,le=De.exports;ye=le.createRoot,le.hydrateRoot;let H;const G=new Map;function Ge(n){for(const e of n)for(const t of X(G.get(e.target),"callback does not exist for tracked entry"))t(e)}function Se(){return H||(H=new Be(Ge)),H}function qe(n,e){let t=G.get(n);t||(t=new Set,G.set(n,t),Se().observe(n)),t.add(e)}function We(n,e){const t=G.get(n);E(t,"element is not tracked");const r=t.delete(e);E(r,"callback did not exist for element"),t.size===0&&(G.delete(n),Se().unobserve(n))}function Ze(n,e){const[t,r]=y.exports.useState(null);return y.exports.useEffect(()=>{if(!n)return;const s=c=>{r(e(c))};return qe(n,s),()=>{We(n,s)}},[n,e]),t}function He(n){return new k(n.contentRect.width,n.contentRect.height)}const{min:R,PI:Vt}=Math,ue=.275;function we(n,e={}){const{size:t=16,smoothing:r=.5,thinning:s=.5,simulatePressure:c=!0,easing:a=m=>m,start:l={},end:f={},last:v=!1}=e,{cap:S=!0,easing:o=m=>m*(2-m)}=l,{cap:i=!0,easing:u=m=>--m*m*m+1}=f;if(n.length===0||t<=0)return[];const p=n[n.length-1].runningLength,g=l.taper===!1?0:l.taper===!0?Math.max(t,p):l.taper,P=f.taper===!1?0:f.taper===!0?Math.max(t,p):f.taper,M=Math.pow(t*r,2),d=[];let h=n.slice(0,10).reduce((m,b)=>{let I=b.pressure;if(c){const K=R(1,b.distance/t),q=R(1,1-K);I=R(1,m+(q-m)*(K*ue))}return(m+I)/2},n[0].pressure),w=pe(t,s,n[n.length-1].pressure,a);n[0].vector;let x=n[0].point,O=x;for(let m=0;m<n.length;m++){let{pressure:b}=n[m];const{point:I,vector:K,distance:q,runningLength:T}=n[m];if(m<n.length-1&&p-T<3)continue;if(s){if(c){const oe=R(1,q/t),Oe=R(1,1-oe);b=R(1,h+(Oe-h)*(oe*ue))}w=pe(t,s,b,a)}else w=t/2;const ke=T<g?o(T/g):1,Ee=p-T<P?u((p-T)/P):1;if(w=Math.max(.01,w*Math.min(ke,Ee)),m===n.length-1){d.push({center:I,radius:w});continue}const se=n[m+1].vector,Ve=K.dot(se);se.lerp(K,Ve).perpendicular().scale(w),O=I,(m<=1||x.distanceToSq(O)>M)&&(d.push({center:I,radius:w}),x=O),h=b}return d}function Pe(n,e={}){var i,u;const{streamline:t=.5,size:r=16,last:s=!1}=e;if(n.length===0)return[];const c=.15+(1-t)*.85;let a=n.map(p=>({point:k.fromVectorLike(p),pressure:p.pressure}));if(a.length===2){const p=a[1];a=a.slice(0,-1);for(let g=1;g<5;g++)a.push({point:a[0].point.lerp(p.point,g/4),pressure:p.pressure})}a.length===1&&a.push({point:a[0].point.add(k.UNIT),pressure:a[0].pressure});const l=[{point:a[0].point,pressure:a[0].pressure!=null&&a[0].pressure>=0?a[0].pressure:.25,vector:k.UNIT,distance:0,runningLength:0}];let f=!1,v=0,S=l[0];const o=a.length-1;for(let p=1;p<a.length;p++){const g=a[p],P=s&&p===o?g.point:S.point.lerp(g.point,c);if(S.point.equals(P))continue;const M=P.distanceTo(S.point);if(v+=M,p<o&&!f){if(v<r)continue;f=!0}S={point:P,pressure:g.pressure!=null&&g.pressure>=0?g.pressure:.5,vector:S.point.sub(P).normalize(),distance:M,runningLength:v},l.push(S)}return l[0].vector=(u=(i=l[1])==null?void 0:i.vector)!=null?u:k.ZERO,l}function pe(n,e,t,r=s=>s){return n*r(.5-e*(.5-t))}function Je(n){if(!n.length)return"";const e=["M",n[0].x,n[0].y,"Q"];for(let t=0;t<n.length;t++){const r=n[t],s=n[(t+1)%n.length],c=r.add(s).scale(.5);e.push(r.x,r.y,c.x,c.y)}return e.push("Z"),e.join(" ")}function ve(n,e){const t=[n[0]];if(n.length===0)return[];let r=e,s=n[0],c=n[0].center;for(let a=1;a<n.length;a++){const l=n[a],f=n[Math.min(a+1,n.length-1)],v=l.center.add(f.center).scale(.5),S=l.center.distanceTo(s.center),o=c,i=l.center,u=v;let p=0;for(;S-p>=r;){const g=(r+p)/S;t.push({center:o.lerp(i,g).lerp(i.lerp(u,g),g),radius:fe(s.radius,l.radius,g)}),p+=r,r=e}r-=S-p,s=l,c=v}return t.push(n[n.length-1]),t}function Qe(n){const e=[],t=[];if(n.length===0)return[];if(n.length===1){const o=[];for(let i=0;i<12;i++)o.push(n[0].center.add(k.fromPolar(i*Math.PI/6,n[0].radius)));return o}const r=n[0],c=n[1].center.sub(r.center).normalize(),a=c.perpendicular().scale(r.radius);e.push(r.center.sub(c.scale(r.radius))),e.push(r.center.sub(a)),t.push(r.center.add(a));for(let o=1;o<n.length-1;o++){const i=n[o-1],u=n[o],P=n[o+1].center.sub(i.center).normalize().perpendicular().scale(u.radius);e.push(u.center.sub(P)),t.push(u.center.add(P))}const l=n[n.length-2],f=n[n.length-1],v=f.center.sub(l.center).normalize(),S=v.perpendicular().scale(f.radius);return e.push(f.center.sub(S)),e.push(f.center.add(v.scale(f.radius))),t.push(f.center.add(S)),e.concat(t.reverse())}function L(n){const e=y.exports.useRef();return y.exports.useLayoutEffect(()=>{e.current=n}),y.exports.useCallback((...t)=>{const r=e.current;return E(r,"fn does not exist"),r(...t)},[])}const Xe=30,Ye=500,F={size:16,streamline:.5,smoothing:.5,thinning:.5,simulatePressure:!0,easing:n=>n,start:{},end:{},last:!1};function _e(n){const[e,t]=y.exports.useState(()=>({undoStates:[],redoStates:null,pendingOp:null,current:{...n(),options:{}}})),r=L(()=>{console.log("BEGIN");const o=Math.random();return t(i=>(E(i.pendingOp==null,"Pending op already in progress"),{...i,pendingOp:{id:o,initialDoc:i.current.doc,initialOptions:i.current.options},current:{...i.current,options:{}}})),{update:i=>s(o,i),revert:()=>c(o),commit:(i={})=>a(o,i)}}),s=y.exports.useCallback((o,i)=>{t(u=>{var p;return console.log("UPDATE"),E(((p=u.pendingOp)==null?void 0:p.id)===o,"Pending op mismatch"),{...u,current:{...u.current,doc:j(u.current.doc,i)}}})},[]),c=y.exports.useCallback(o=>{console.log("REVERT"),t(i=>{var u;return E(((u=i.pendingOp)==null?void 0:u.id)===o,"Pending op mismatch"),{...i,pendingOp:null,current:{doc:i.pendingOp.initialDoc,location:i.current.location,options:i.pendingOp.initialOptions}}})},[]),a=y.exports.useCallback((o,i)=>{console.log("COMMIT"),t(u=>{var P;E(((P=u.pendingOp)==null?void 0:P.id)===o,"Pending op mismatch");const p=[{doc:u.pendingOp.initialDoc,location:u.current.location,options:u.pendingOp.initialOptions},...u.undoStates];for(;p.length>Xe;)p.pop();const g={...u.current,options:i};return i.lockstepLocation&&(g.location=j(g.location,i.lockstepLocation)),{...u,current:g,pendingOp:null,undoStates:p,redoStates:null}})},[]),l=L((o,i={})=>{const u=r();u.update(o),u.commit(i)}),f=y.exports.useCallback(()=>{console.log("UNDO"),t(o=>{var g;if(E(o.pendingOp==null,"Pending op in progress"),o.undoStates.length==0)return o;const[i,...u]=o.undoStates;if(!Q(i.location,o.current.location)&&!o.current.options.lockstepLocation)return{...o,current:{...o.current,location:i.location}};const p=[o.current,...(g=o.redoStates)!=null?g:[]];return{...o,current:i,undoStates:u,redoStates:p}})},[]),v=y.exports.useCallback(()=>{console.log("REDO"),t(o=>{if(E(o.pendingOp==null,"pendign op in progress"),!o.redoStates||o.redoStates.length==0)return o;const[i,...u]=o.redoStates;if(!Q(i.location,o.current.location)&&!i.options.lockstepLocation)return{...o,current:{...o.current,location:i.location}};const p=[o.current,...o.undoStates];return{...o,current:i.options.lockstepLocation?{...i,location:j(o.current.location,i.options.lockstepLocation)}:i,undoStates:p,redoStates:u.length===0?null:u}})},[]),S=y.exports.useCallback(o=>{t(i=>({...i,current:{...i.current,location:j(i.current.location,o)}}))},[]);return y.exports.useMemo(()=>{console.log("UNDO STATE CHANGED",e)},[e]),y.exports.useMemo(()=>({document:e.current.doc,location:e.current.location,beginOperation:r,updateDocument:l,updateLocation:S,undo:f,redo:v}),[r,l,S,v,e,f])}function et(n){return be?n.metaKey:n.ctrlKey}function de(n,e){const t=L(r=>{var c,a,l;const s=typeof n=="string"?{key:n}:n;r.key.toLowerCase()===s.key.toLowerCase()&&((c=s.command)!=null?c:!1)===et(r)&&((a=s.shift)!=null?a:!1)===r.shiftKey&&((l=s.alt)!=null?l:!1)===r.altKey&&r.repeat===!1&&(r.preventDefault(),console.log("ACTIVATING!",s,r),e(r))});y.exports.useEffect(()=>(document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)),[t])}const tt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");class _{constructor(e,t=16){this.randomLength=t,this.debugIdCounter=0,this.prefix=e,this.Id=`${e}.SAMPLE`;const r=new RegExp(`^${this.prefix}\\.([a-zA-Z0-9_]+)$`);this.parse=Y(Ke,s=>r.test(s)?U.ok(s):U.error(new $e(`Expected ${this.prefix}.*, got ${s}`,[])))}generate(){const e=ge(this.randomLength,()=>Ie(tt)).join("");return`${this.prefix}.${e}`}}const $=new _("key"),nt=N({id:$.parse,position:k.parse}),ee=new _("shv"),rt=N({id:ee.parse,keyPointId:$.parse,rawPoints:Te(k.parse)}),xe=new _("doc"),st=N({id:xe.parse,keyPoints:ce($.parse,nt),shapeVersions:ce(ee.parse,rt)});function ot(){return{id:xe.generate(),keyPoints:{},shapeVersions:{}}}class te{constructor(e,t,r,s,c){this.id=e,this.keyPoints=t,this.shapeVersions=r,this.keyPointIdByShapeVersion=s,this.normalizedShapeVersions=c}with(e){var t,r,s,c,a;return new te((t=e.id)!=null?t:this.id,(r=e.keyPoints)!=null?r:this.keyPoints,(s=e.shapeVersions)!=null?s:this.shapeVersions,(c=e.keyPointIdByShapeVersion)!=null?c:this.keyPointIdByShapeVersion,(a=e.normalizedCenterPointsByShapeVersion)!=null?a:this.normalizedShapeVersions)}}class z{static fromArray(e){return new z(ze(e.map(t=>[t.id,t])))}constructor(e){this.data=e}has(e){return ie(this.data,e)}getIfExists(e){return B(this.data,e)}get(e){const t=this.getIfExists(e);return E(t!=null,`Item with id ${e} not found`),t}insert(e){return new z({...this.data,[e.id]:e})}delete(e){const{[e]:t,...r}=this.data;return new z(r)}*[Symbol.iterator](){for(const e in this.data)ie(this.data,e)&&(yield X(this.data[e]))}}class C{constructor(e={}){this.inverse=e}static build(e,t){const r={};for(const s of t){const c=s.id,a=s[e],l=B(r,a);l?l.push(c):r[a]=[c]}return new C(r)}lookupInverseIfExists(e){var t;return(t=B(this.inverse,e))==null?void 0:t[0]}lookupInverse(e){const t=this.lookupInverseIfExists(e);return E(t!=null,`Item with id ${e} not found`),t}add(e,t){const r=B(this.inverse,t);return r?(E(!r.includes(e),`relation ${t}<->${e} already exists in index`),new C({...this.inverse,[t]:[...r,e]})):new C({...this.inverse,[t]:[e]})}remove(e,t){const r=B(this.inverse,t);if(r){const s=r.indexOf(e);if(s>=0)return r.length>1?new C({...this.inverse,[t]:Ce(r,s)}):new C({...this.inverse,[t]:void 0})}me(`relation ${t}<->${e} not found in index`)}}function J(n){var s,c;if(n.length===0)return{versions:new z({})};const e=[];let t=0;for(const a of n){const l=Pe(a.rawPoints),f=(c=(s=l[l.length-1])==null?void 0:s.runningLength)!=null?c:0;e.push({id:a.id,strokePoints:l,length:f}),f>t&&(t=f)}const r=Math.floor(t/F.size);return{versions:z.fromArray(e.map(({strokePoints:a,length:l,id:f})=>({id:f,length:l,normalizedCenterPoints:ve(we(a,F),l/r)})))}}class A{constructor(e,t=0,r=!0){if(this.data=e,this.version=t,!r)return;const s=this.serialize(),c=A.deserialize(s,this.version);Q(this,c)||me(`Mismatch after update:
Actual:
${JSON.stringify(this,null,2)}

Expected:
${JSON.stringify(c,null,2)}`)}static create(){return A.deserialize(ot())}static deserialize(e,t=0){const r=new z(e.shapeVersions);return new A(new te(e.id,new z(e.keyPoints),r,C.build("keyPointId",r),J(Array.from(r)).versions),t,!1)}with(...e){return new A(this.data.with(...e),this.version+1)}serialize(){return{id:this.data.id,keyPoints:this.data.keyPoints.data,shapeVersions:this.data.shapeVersions.data}}get keyPoints(){return this.data.keyPoints}get shapeVersions(){return this.data.shapeVersions}getShapeVersionForKeyPoint(e){return this.shapeVersions.get(this.data.keyPointIdByShapeVersion.lookupInverse(e))}addKeyPoint(e){console.log("doc.addKeyPoint",e);const t=ee.generate(),r=this.keyPoints.insert({id:e,position:k.UNIT}),s=this.shapeVersions.insert({id:t,keyPointId:e,rawPoints:[]});return this.with({keyPoints:r,shapeVersions:s,keyPointIdByShapeVersion:this.data.keyPointIdByShapeVersion.add(t,e),normalizedCenterPointsByShapeVersion:J(Array.from(s)).versions})}replaceShapeVersionPoints(e,t){console.log("doc.replaceShapeVersionPoints",e);const r=this.shapeVersions.insert({...this.shapeVersions.get(e),rawPoints:t});return this.with({shapeVersions:r,normalizedCenterPointsByShapeVersion:J(Array.from(r)).versions})}}const it=N({pan:k.parse,zoom:je});class at{constructor({pan:e,zoom:t},r,s){this.screenSize=r,this.update=s,this.pan=e,this.zoom=t}handleWheelEvent(e){console.log("wheel",e),e.preventDefault(),e.stopImmediatePropagation(),console.log(e.ctrlKey);const{deltaX:t,deltaY:r}=e;this.update(({pan:s,zoom:c})=>({pan:s.add(new k(t,r)),zoom:c}))}screenToScene(e){return e.add(this.pan)}sceneToScreen(e){return e.sub(this.pan)}}const ct=N({keyPointId:$.parse,viewport:it}),ne=class{constructor({keyPointId:n,viewport:e={pan:k.ZERO,zoom:1}}){this.keyPointId=n,this.viewportState=e}serialize(){return{keyPointId:this.keyPointId,viewport:this.viewportState}}with(n){var e,t;return new ne({keyPointId:(e=n.keyPointId)!=null?e:this.keyPointId,viewport:(t=n.viewport)!=null?t:this.viewportState})}};let re=ne;re.parse=Y(ct,n=>U.ok(new ne(n)));const lt=N({doc:Y(st,n=>U.ok(A.deserialize(n))),location:re.parse});function ut(n){return ae(`splatapus.${n}`)?lt(ae(`splatapus.${n}`)).mapErr(t=>t.toString()):U.error("No saved data found")}function pt(n,{doc:e,location:t}){Ae(`splatapus.${n}`,{doc:e.serialize(),location:t.serialize()})}const dt=Le(Ye,pt);function he(){const n=$.generate();return{doc:A.create().addKeyPoint(n),location:new re({keyPointId:n})}}function ht(){const[n,e]=y.exports.useState(null),t=Ze(n,He);return V("div",{ref:e,className:"absolute inset-0 touch-none",children:t&&V(gt,{size:t})})}const ft=1e3;function gt({size:n}){const[e,t]=y.exports.useState(null),[r,s]=y.exports.useState({type:"idle"}),{document:c,location:a,updateDocument:l,updateLocation:f,undo:v,redo:S}=_e(()=>{{const d=ut("autosave");if(d.isOk())return d.value;console.error(`Error loading autosave: ${d.error}`)}return he()}),o=y.exports.useCallback(d=>f(h=>h.with({viewport:j(h.viewportState,d)})),[f]),i=y.exports.useMemo(()=>new at(a.viewportState,n,o),[a.viewportState,n,o]);y.exports.useEffect(()=>{dt("autosave",{doc:c,location:a})},[c,a]),de({key:"z",command:!0},v),de({key:"z",command:!0,shift:!0},S),y.exports.useEffect(()=>{let d=!1;return Me((h,w)=>{if(d){w();return}s(x=>{switch(x.type){case"idle":case"drawing":return x;case"lerp":{const O=Re(x.startedAtMs,x.startedAtMs+ft,h);return O>1?{type:"idle"}:{...x,progress:O}}default:D(x)}})}),()=>{d=!0}});const u=L(d=>{d.preventDefault(),s(h=>{switch(h.type){case"lerp":return h;case"idle":return{type:"drawing",points:[i.screenToScene(k.fromEvent(d))]};case"drawing":return h;default:D(h)}})}),p=L(d=>{d.preventDefault(),s(h=>{switch(h.type){case"idle":case"lerp":return h;case"drawing":return{...h,points:[...h.points,i.screenToScene(k.fromEvent(d))]};default:D(h)}})}),g=L(d=>{d.preventDefault(),s(h=>{switch(h.type){case"idle":case"lerp":return h;case"drawing":return l(w=>w.replaceShapeVersionPoints(w.getShapeVersionForKeyPoint(a.keyPointId).id,h.points)),{type:"idle"};default:D(h)}})}),P=L(d=>i.handleWheelEvent(d));y.exports.useEffect(()=>{if(!!e)return window.addEventListener("wheel",P,{passive:!1}),()=>{window.removeEventListener("wheel",P)}});const M=y.exports.useMemo(()=>{switch(r.type){case"idle":return c.data.normalizedShapeVersions.get(c.getShapeVersionForKeyPoint(a.keyPointId).id).normalizedCenterPoints;case"drawing":return ve(we(Pe(r.points,F),F),F.size);case"lerp":{const d=c.getShapeVersionForKeyPoint(r.from),h=c.getShapeVersionForKeyPoint(r.to),w=c.data.normalizedShapeVersions.get(d.id).normalizedCenterPoints,x=c.data.normalizedShapeVersions.get(h.id).normalizedCenterPoints,O=Ue(r.progress);return ge(Math.max(w.length,x.length),m=>{const b=w[Math.min(m,w.length-1)],I=x[Math.min(m,x.length-1)];return{center:b.center.lerp(I.center,O),radius:fe(b.radius,I.radius,O)}})}default:D(r)}},[r,c,a.keyPointId]);return W(Fe,{children:[V("div",{className:"pointer-events-none absolute top-0",children:mt(r)}),V("svg",{ref:t,viewBox:`0 0 ${n.x} ${n.y}`,onPointerDown:u,onPointerMove:p,onPointerUp:g,children:V("g",{transform:`translate(${-i.pan.x}, ${-i.pan.y})`,children:V("path",{d:Je(Qe(M))})})}),W("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-center gap-3 p-3",children:[W("div",{className:"flex min-w-0 flex-auto items-center justify-center gap-3",children:[Array.from(c.keyPoints,(d,h)=>V("button",{className:Z("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1",d.id===a.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:()=>{f(w=>w.with({keyPointId:d.id})),s({type:"lerp",from:a.keyPointId,to:d.id,startedAtMs:performance.now(),progress:0})},children:h+1},d.id)),V("button",{className:Z("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const d=$.generate();l(h=>h.addKeyPoint(d),{lockstepLocation:h=>h.with({keyPointId:d})})},children:"+"})]}),V("button",{className:Z("flex h-10 flex-none items-center justify-center justify-self-end rounded-full border border-stone-200 px-3 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const{doc:d,location:h}=he();l(d,{lockstepLocation:h})},children:"reset"})]})]})}function mt(n){switch(n.type){case"idle":return"idle";case"lerp":return`lerp(from = ${n.from}, to = ${n.to}, progress = ${n.progress})`;case"drawing":return`drawing(points = ${n.points.length})`;default:D(n)}}const yt=X(document.getElementById("root"));ye(yt).render(V(Ne.StrictMode,{children:V(ht,{})}));
