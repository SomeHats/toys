import{a as x,b as pe,L as U,t as _e,s as Ye,M as et,h as ee,g as q,N as tt,f as ze,l as nt,D as rt,C as Ce,F as ot,e as Ne,c as b,d as M,O as st}from"../chunks/chunk_assert.df27ef91.js";/* empty css                               */import{a as it,r as P}from"../chunks/chunk_index.b0b8f4df.js";import{R as at,j as w,c as D,F as Me,a as B}from"../chunks/chunk_ResizeObserver.38aa3088.js";import{V as S,b as fe,R as Z,P as ct,d as ut,c as F,a as lt,e as ke,f as dt,p as pt}from"../chunks/chunk_Vector2.71f22924.js";import{A as ft}from"../chunks/chunk_AABB.d6b0d8c0.js";var ae=function n(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,o,s;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(o=r;o--!==0;)if(!n(e[o],t[o]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(s=Object.keys(e),r=s.length,r!==Object.keys(t).length)return!1;for(o=r;o--!==0;)if(!Object.prototype.hasOwnProperty.call(t,s[o]))return!1;for(o=r;o--!==0;){var i=s[o];if(!n(e[i],t[i]))return!1}return!0}return e!==e&&t!==t},Re,Ie=it.exports;Re=Ie.createRoot,Ie.hydrateRoot;let oe;const J=new Map,$e=new WeakMap;function ht(n){for(const e of n){$e.set(e.target,e);for(const t of pe(J.get(e.target),"callback does not exist for tracked entry"))t(e)}}function Ke(){return oe||(oe=new at(ht)),oe}function gt(n,e){let t=J.get(n);t||(t=new Set,J.set(n,t),Ke().observe(n));const r=$e.get(n);r&&e(r),t.add(e)}function mt(n,e){const t=J.get(n);x(t,"element is not tracked");const r=t.delete(e);x(r,"callback did not exist for element"),t.size===0&&(J.delete(n),Ke().unobserve(n))}function yt(n,e){const[t,r]=P.exports.useState(null);return P.exports.useLayoutEffect(()=>{if(!n)return;const o=s=>{console.log({entry:s}),r(e(s))};return gt(n,o),()=>{mt(n,o)}},[n,e]),t}function vt(n){return new S(n.contentRect.width,n.contentRect.height)}function C(n){const e=P.exports.useRef();return P.exports.useLayoutEffect(()=>{e.current=n}),P.exports.useCallback((...t)=>{const r=e.current;return x(r,"fn does not exist"),r(...t)},[])}const wt=30,St=500,W={size:16,streamline:.5,smoothing:.5,thinning:.5,simulatePressure:!0,easing:n=>n,start:{},end:{},last:!1};function Pt(n){const[e,t]=P.exports.useState(()=>({undoStates:[],redoStates:null,pendingOp:null,current:{...n(),options:{}}})),r=C(()=>{console.log("BEGIN");const l=Math.random();return t(d=>(x(d.pendingOp==null,"Pending op already in progress"),{...d,pendingOp:{id:l,initialDoc:d.current.doc,initialOptions:d.current.options},current:{...d.current,options:{}}})),{update:d=>o(l,d),revert:()=>s(l),commit:(d={})=>i(l,d)}}),o=P.exports.useCallback((l,d)=>{t(u=>{var p;return console.log("UPDATE"),x(((p=u.pendingOp)==null?void 0:p.id)===l,"Pending op mismatch"),{...u,current:{...u.current,doc:U(u.current.doc,d)}}})},[]),s=P.exports.useCallback(l=>{console.log("REVERT"),t(d=>{var u;return x(((u=d.pendingOp)==null?void 0:u.id)===l,"Pending op mismatch"),{...d,pendingOp:null,current:{doc:d.pendingOp.initialDoc,location:d.current.location,options:d.pendingOp.initialOptions}}})},[]),i=P.exports.useCallback((l,d)=>{console.log("COMMIT"),t(u=>{var y;x(((y=u.pendingOp)==null?void 0:y.id)===l,"Pending op mismatch");const p=[{doc:u.pendingOp.initialDoc,location:u.current.location,options:u.pendingOp.initialOptions},...u.undoStates];for(;p.length>wt;)p.pop();const f={...u.current,options:d};return d.lockstepLocation&&(f.location=U(f.location,d.lockstepLocation)),{...u,current:f,pendingOp:null,undoStates:p,redoStates:null}})},[]),a=C((l,d={})=>{const u=r();u.update(l),u.commit(d)}),c=P.exports.useCallback(()=>{console.log("UNDO"),t(l=>{var f;if(x(l.pendingOp==null,"Pending op in progress"),l.undoStates.length==0)return l;const[d,...u]=l.undoStates;if(!ae(d.location,l.current.location)&&!l.current.options.lockstepLocation)return{...l,current:{...l.current,location:d.location}};const p=[l.current,...(f=l.redoStates)!=null?f:[]];return{...l,current:d,undoStates:u,redoStates:p}})},[]),h=P.exports.useCallback(()=>{console.log("REDO"),t(l=>{if(x(l.pendingOp==null,"pendign op in progress"),!l.redoStates||l.redoStates.length==0)return l;const[d,...u]=l.redoStates;if(!ae(d.location,l.current.location)&&!d.options.lockstepLocation)return{...l,current:{...l.current,location:d.location}};const p=[l.current,...l.undoStates];return{...l,current:d.options.lockstepLocation?{...d,location:U(l.current.location,d.options.lockstepLocation)}:d,undoStates:p,redoStates:u.length===0?null:u}})},[]),m=P.exports.useCallback(l=>{t(d=>({...d,current:{...d.current,location:U(d.current.location,l)}}))},[]);return P.exports.useMemo(()=>{console.log("UNDO STATE CHANGED",e)},[e]),P.exports.useMemo(()=>({document:e.current.doc,location:e.current.location,beginOperation:r,updateDocument:a,updateLocation:m,undo:c,redo:h}),[r,a,m,h,e,c])}const xt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");class he{constructor(e,t=16){this.randomLength=t,this.debugIdCounter=0,this.prefix=e,this.Id=`${e}.SAMPLE`;const r=new RegExp(`^${this.prefix}\\.([a-zA-Z0-9_]+)$`);this.parse=fe(ut,o=>r.test(o)?Z.ok(o):Z.error(new ct(`Expected ${this.prefix}.*, got ${o}`,[])))}generate(){const e=_e(this.randomLength,()=>Ye(xt)).join("");return`${this.prefix}.${e}`}}const L=new he("key"),Et=F({id:L.parse,position:S.parse}),ge=new he("shv"),Ct=F({id:ge.parse,keyPointId:L.parse,rawPoints:lt(S.parse)}),Ae=new he("doc"),kt=F({id:Ae.parse,keyPoints:ke(L.parse,Et),shapeVersions:ke(ge.parse,Ct)});function It(){return{id:Ae.generate(),keyPoints:{},shapeVersions:{}}}class me{constructor(e,t,r,o,s){this.id=e,this.keyPoints=t,this.shapeVersions=r,this.keyPointIdByShapeVersion=o,this.normalizedShapeVersions=s}with(e){var t,r,o,s,i;return new me((t=e.id)!=null?t:this.id,(r=e.keyPoints)!=null?r:this.keyPoints,(o=e.shapeVersions)!=null?o:this.shapeVersions,(s=e.keyPointIdByShapeVersion)!=null?s:this.keyPointIdByShapeVersion,(i=e.normalizedCenterPointsByShapeVersion)!=null?i:this.normalizedShapeVersions)}}class O{static fromArray(e){return new O(et(e.map(t=>[t.id,t])))}constructor(e){this.data=e}has(e){return ee(this.data,e)}getIfExists(e){return q(this.data,e)}get(e){const t=this.getIfExists(e);return x(t!=null,`Item with id ${e} not found`),t}insert(e){return new O({...this.data,[e.id]:e})}update(e,t){const r=this.get(e),o=U(r,t);return x(r.id===o.id),this.insert(o)}delete(e){const{[e]:t,...r}=this.data;return new O(r)}*[Symbol.iterator](){for(const e in this.data)ee(this.data,e)&&(yield pe(this.data[e]))}}class z{constructor(e={}){this.inverse=e}static build(e,t){const r={};for(const o of t){const s=o.id,i=o[e],a=q(r,i);a?a.push(s):r[i]=[s]}return new z(r)}lookupInverseIfExists(e){var t;return(t=q(this.inverse,e))==null?void 0:t[0]}lookupInverse(e){const t=this.lookupInverseIfExists(e);return x(t!=null,`Item with id ${e} not found`),t}add(e,t){const r=q(this.inverse,t);return r?(x(!r.includes(e),`relation ${t}<->${e} already exists in index`),new z({...this.inverse,[t]:[...r,e]})):new z({...this.inverse,[t]:[e]})}remove(e,t){const r=q(this.inverse,t);if(r){const o=r.indexOf(e);if(o>=0)return r.length>1?new z({...this.inverse,[t]:tt(r,o)}):new z({...this.inverse,[t]:void 0})}ze(`relation ${t}<->${e} not found in index`)}}const{min:A,PI:hn}=Math,Te=.275;function Be(n,e={}){const{size:t=16,smoothing:r=.5,thinning:o=.5,simulatePressure:s=!0,easing:i=E=>E,start:a={},end:c={},last:h=!1}=e,{cap:m=!0,easing:l=E=>E*(2-E)}=a,{cap:d=!0,easing:u=E=>--E*E*E+1}=c;if(n.length===0||t<=0)return[];const p=n[n.length-1].runningLength,f=a.taper===!1?0:a.taper===!0?Math.max(t,p):a.taper,y=c.taper===!1?0:c.taper===!0?Math.max(t,p):c.taper,g=Math.pow(t*r,2),v=[];let k=n.slice(0,10).reduce((E,$)=>{let K=$.pressure;if(s){const G=A(1,$.distance/t),re=A(1,1-G);K=A(1,E+(re-E)*(G*Te))}return(E+K)/2},n[0].pressure),I=De(t,o,n[n.length-1].pressure,i);n[0].vector;let R=n[0].point,ne=R;for(let E=0;E<n.length;E++){let{pressure:$}=n[E];const{point:K,vector:G,distance:re,runningLength:H}=n[E];if(E<n.length-1&&p-H<3)continue;if(o){if(s){const Ee=A(1,re/t),Xe=A(1,1-Ee);$=A(1,k+(Xe-k)*(Ee*Te))}I=De(t,o,$,i)}else I=t/2;const Ze=H<f?l(H/f):1,Je=p-H<y?u((p-H)/y):1;if(I=Math.max(.01,I*Math.min(Ze,Je)),E===n.length-1){v.push({center:K,radius:I});continue}const xe=n[E+1].vector,Qe=G.dot(xe);xe.lerp(G,Qe).perpendicular().scale(I),ne=K,(E<=1||R.distanceToSq(ne)>g)&&(v.push({center:K,radius:I}),R=ne),k=$}return v}function Ue(n,e={}){var d,u;const{streamline:t=.5,size:r=16,last:o=!1}=e;if(n.length===0)return[];const s=.15+(1-t)*.85;let i=n.map(p=>({point:S.fromVectorLike(p),pressure:p.pressure}));if(i.length===2){const p=i[1];i=i.slice(0,-1);for(let f=1;f<5;f++)i.push({point:i[0].point.lerp(p.point,f/4),pressure:p.pressure})}i.length===1&&i.push({point:i[0].point.add(S.UNIT),pressure:i[0].pressure});const a=[{point:i[0].point,pressure:i[0].pressure!=null&&i[0].pressure>=0?i[0].pressure:.25,vector:S.UNIT,distance:0,runningLength:0}];let c=!1,h=0,m=a[0];const l=i.length-1;for(let p=1;p<i.length;p++){const f=i[p],y=o&&p===l?f.point:m.point.lerp(f.point,s);if(m.point.equals(y))continue;const g=y.distanceTo(m.point);if(h+=g,p<l&&!c){if(h<r)continue;c=!0}m={point:y,pressure:f.pressure!=null&&f.pressure>=0?f.pressure:.5,vector:m.point.sub(y).normalize(),distance:g,runningLength:h},a.push(m)}return a[0].vector=(u=(d=a[1])==null?void 0:d.vector)!=null?u:S.ZERO,a}function De(n,e,t,r=o=>o){return n*r(.5-e*(.5-t))}function Tt(n){if(!n.length)return"";const e=["M",n[0].x,n[0].y,"Q"];for(let t=0;t<n.length;t++){const r=n[t],o=n[(t+1)%n.length],s=r.add(o).scale(.5);e.push(r.x,r.y,s.x,s.y)}return e.push("Z"),e.join(" ")}function Fe(n,e){const t=[n[0]];if(n.length===0)return[];let r=e,o=n[0],s=n[0].center;for(let i=1;i<n.length;i++){const a=n[i],c=n[Math.min(i+1,n.length-1)],h=a.center.add(c.center).scale(.5),m=a.center.distanceTo(o.center),l=s,d=a.center,u=h;let p=0;for(;m-p>=r;){const f=(r+p)/m;t.push({center:l.lerp(d,f).lerp(d.lerp(u,f),f),radius:nt(o.radius,a.radius,f)}),p+=r,r=e}r-=m-p,o=a,s=h}return t.push(n[n.length-1]),t}function se(n){var o,s;if(n.length===0)return{versions:new O({})};const e=[];let t=0;for(const i of n){const a=Ue(i.rawPoints),c=(s=(o=a[a.length-1])==null?void 0:o.runningLength)!=null?s:0;e.push({id:i.id,strokePoints:a,length:c}),c>t&&(t=c)}const r=Math.floor(t/W.size);return{versions:O.fromArray(e.map(({strokePoints:i,length:a,id:c})=>({id:c,length:a,normalizedCenterPoints:Fe(Be(i,W),a/r)})))}}function V(){}V.prototype={diff:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=r.callback;typeof r=="function"&&(o=r,r={}),this.options=r;var s=this;function i(f){return o?(setTimeout(function(){o(void 0,f)},0),!0):f}e=this.castInput(e),t=this.castInput(t),e=this.removeEmpty(this.tokenize(e)),t=this.removeEmpty(this.tokenize(t));var a=t.length,c=e.length,h=1,m=a+c;r.maxEditLength&&(m=Math.min(m,r.maxEditLength));var l=[{newPos:-1,components:[]}],d=this.extractCommon(l[0],t,e,0);if(l[0].newPos+1>=a&&d+1>=c)return i([{value:this.join(t),count:t.length}]);function u(){for(var f=-1*h;f<=h;f+=2){var y=void 0,g=l[f-1],v=l[f+1],k=(v?v.newPos:0)-f;g&&(l[f-1]=void 0);var I=g&&g.newPos+1<a,R=v&&0<=k&&k<c;if(!I&&!R){l[f]=void 0;continue}if(!I||R&&g.newPos<v.newPos?(y=bt(v),s.pushComponent(y.components,void 0,!0)):(y=g,y.newPos++,s.pushComponent(y.components,!0,void 0)),k=s.extractCommon(y,t,e,f),y.newPos+1>=a&&k+1>=c)return i(Dt(s,y.components,t,e,s.useLongestToken));l[f]=y}h++}if(o)(function f(){setTimeout(function(){if(h>m)return o();u()||f()},0)})();else for(;h<=m;){var p=u();if(p)return p}},pushComponent:function(e,t,r){var o=e[e.length-1];o&&o.added===t&&o.removed===r?e[e.length-1]={count:o.count+1,added:t,removed:r}:e.push({count:1,added:t,removed:r})},extractCommon:function(e,t,r,o){for(var s=t.length,i=r.length,a=e.newPos,c=a-o,h=0;a+1<s&&c+1<i&&this.equals(t[a+1],r[c+1]);)a++,c++,h++;return h&&e.components.push({count:h}),e.newPos=a,c},equals:function(e,t){return this.options.comparator?this.options.comparator(e,t):e===t||this.options.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Dt(n,e,t,r,o){for(var s=0,i=e.length,a=0,c=0;s<i;s++){var h=e[s];if(h.removed){if(h.value=n.join(r.slice(c,c+h.count)),c+=h.count,s&&e[s-1].added){var l=e[s-1];e[s-1]=e[s],e[s]=l}}else{if(!h.added&&o){var m=t.slice(a,a+h.count);m=m.map(function(u,p){var f=r[c+p];return f.length>u.length?f:u}),h.value=n.join(m)}else h.value=n.join(t.slice(a,a+h.count));a+=h.count,h.added||(c+=h.count)}}var d=e[i-1];return i>1&&typeof d.value=="string"&&(d.added||d.removed)&&n.equals("",d.value)&&(e[i-2].value+=d.value,e.pop()),e}function bt(n){return{newPos:n.newPos,components:n.components.slice(0)}}var be=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,Oe=/\S/,Ge=new V;Ge.equals=function(n,e){return this.options.ignoreCase&&(n=n.toLowerCase(),e=e.toLowerCase()),n===e||this.options.ignoreWhitespace&&!Oe.test(n)&&!Oe.test(e)};Ge.tokenize=function(n){for(var e=n.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),t=0;t<e.length-1;t++)!e[t+1]&&e[t+2]&&be.test(e[t])&&be.test(e[t+2])&&(e[t]+=e[t+2],e.splice(t+1,2),t--);return e};var ye=new V;ye.tokenize=function(n){var e=[],t=n.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(var r=0;r<t.length;r++){var o=t[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=o:(this.options.ignoreWhitespace&&(o=o.trim()),e.push(o))}return e};function Ot(n,e,t){return ye.diff(n,e,t)}var Lt=new V;Lt.tokenize=function(n){return n.split(/(\S.+?[.!?])(?=\s+|$)/)};var Vt=new V;Vt.tokenize=function(n){return n.split(/([{}:;,]|\s+)/)};function Y(n){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?Y=function(e){return typeof e}:Y=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Y(n)}var zt=Object.prototype.toString,Q=new V;Q.useLongestToken=!0;Q.tokenize=ye.tokenize;Q.castInput=function(n){var e=this.options,t=e.undefinedReplacement,r=e.stringifyReplacer,o=r===void 0?function(s,i){return typeof i>"u"?t:i}:r;return typeof n=="string"?n:JSON.stringify(ce(n,null,null,o),o,"  ")};Q.equals=function(n,e){return V.prototype.equals.call(Q,n.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function ce(n,e,t,r,o){e=e||[],t=t||[],r&&(n=r(o,n));var s;for(s=0;s<e.length;s+=1)if(e[s]===n)return t[s];var i;if(zt.call(n)==="[object Array]"){for(e.push(n),i=new Array(n.length),t.push(i),s=0;s<n.length;s+=1)i[s]=ce(n[s],e,t,r,o);return e.pop(),t.pop(),i}if(n&&n.toJSON&&(n=n.toJSON()),Y(n)==="object"&&n!==null){e.push(n),i={},t.push(i);var a=[],c;for(c in n)n.hasOwnProperty(c)&&a.push(c);for(a.sort(),s=0;s<a.length;s+=1)c=a[s],i[c]=ce(n[c],e,t,r,c);e.pop(),t.pop()}else i=n;return i}var ue=new V;ue.tokenize=function(n){return n.slice()};ue.join=ue.removeEmpty=function(n){return n};class N{constructor(e,t=0,r=!0){if(this.data=e,this.version=t,!r)return;const o=this.serialize(),s=N.deserialize(o,this.version);if(!ae(this,s)){const i=JSON.stringify(this,null,2),a=JSON.stringify(s,null,2),c=Ot(i,a);console.log(c),ze(`Mismatch after update:
Actual:
${JSON.stringify(this,null,2)}

Expected:
${JSON.stringify(s,null,2)}`)}}static create(){return N.deserialize(It())}static deserialize(e,t=0){const r=new O(e.shapeVersions);return new N(new me(e.id,new O(e.keyPoints),r,z.build("keyPointId",r),se(Array.from(r)).versions),t,!1)}with(...e){return new N(this.data.with(...e),this.version+1)}serialize(){return{id:this.data.id,keyPoints:this.data.keyPoints.data,shapeVersions:this.data.shapeVersions.data}}get keyPoints(){return this.data.keyPoints}get shapeVersions(){return this.data.shapeVersions}getShapeVersionForKeyPoint(e){return this.shapeVersions.get(this.data.keyPointIdByShapeVersion.lookupInverse(e))}addKeyPoint(e){console.log("doc.addKeyPoint",e);const t=ge.generate(),r=this.keyPoints.insert({id:e,position:S.UNIT}),o=this.shapeVersions.insert({id:t,keyPointId:e,rawPoints:[]});return this.with({keyPoints:r,shapeVersions:o,keyPointIdByShapeVersion:this.data.keyPointIdByShapeVersion.add(t,e),normalizedCenterPointsByShapeVersion:se(Array.from(o)).versions})}updateKeypoint(e,t){return this.with({keyPoints:this.keyPoints.update(e,t)})}replaceShapeVersionPoints(e,t){console.log("doc.replaceShapeVersionPoints",e);const r=this.shapeVersions.insert({...this.shapeVersions.get(e),rawPoints:t});return this.with({shapeVersions:r,normalizedCenterPointsByShapeVersion:se(Array.from(r)).versions})}}var T=(n=>(n.Draw="draw",n.KeyPoint="keypoint",n))(T||{});const Nt=dt(T),Mt=F({pan:S.parse,zoom:pt});class Rt{constructor({pan:e,zoom:t},r,o){this.screenSize=r,this.update=o,this.pan=e,this.zoom=t}handleWheelEvent(e){console.log("wheel",e),e.preventDefault(),e.stopImmediatePropagation(),console.log(e.ctrlKey);const{deltaX:t,deltaY:r}=e;this.update(({pan:o,zoom:s})=>({pan:o.add(new S(t,r)),zoom:s}))}origin(){return this.pan.sub(this.screenSize.scale(.5))}visibleSceneBounds(){return new ft(this.origin(),this.screenSize)}screenToScene(e){return e.add(this.origin())}sceneToScreen(e){return e.sub(this.origin())}getSceneTransform(){const e=this.origin();return`translate(${-e.x}, ${-e.y})`}}const $t=F({keyPointId:L.parse,viewport:Mt,tool:Nt}),ve=class{constructor({keyPointId:n,viewport:e={pan:S.ZERO,zoom:1},tool:t=T.Draw}){this.keyPointId=n,this.viewportState=e,this.tool=t}serialize(){return{keyPointId:this.keyPointId,viewport:this.viewportState,tool:this.tool}}with(n){var e,t,r;return new ve({keyPointId:(e=n.keyPointId)!=null?e:this.keyPointId,viewport:(t=n.viewport)!=null?t:this.viewportState,tool:(r=n.tool)!=null?r:this.tool})}};let we=ve;we.parse=fe($t,n=>Z.ok(new ve(n)));const Kt=F({doc:fe(kt,n=>Z.ok(N.deserialize(n))),location:we.parse});function At(n){return Ce(`splatapus.${n}`)?Kt(Ce(`splatapus.${n}`)).mapErr(t=>t.toString()):Z.error("No saved data found")}function Bt(n,{doc:e,location:t}){ot(`splatapus.${n}`,{doc:e.serialize(),location:t.serialize()})}const Ut=rt(St,Bt);function Le(){const n=L.generate();return{doc:N.create().addKeyPoint(n),location:new we({keyPointId:n})}}function Se(n){class e extends Ft{constructor(r){super(n,r)}}return e}function ie(){return null}class Ft{constructor(e,t){this.name=e,this.state=t}with(e){const t=this.constructor;return new t(e)}canvasClassName(){return""}onKeyDown(e){return this}onKeyUp(e){return this}onTap(e){return this}onDragStart(e){return{state:this.state,gesture:{couldBeTap:!0,onCancel:t=>t,onMove:t=>t,onEnd:t=>t}}}getPointsForShapeVersion(e,t){return e.data.normalizedShapeVersions.get(t.id).normalizedCenterPoints}getSceneSvgComponent(){return ie}getScreenSvgComponent(){return ie}getScreenHtmlComponent(){return ie}toDebugString(){const e=Ne(this.debugProperties()).map(([t,r])=>t.startsWith("_")?r:`${t} = ${r}`).join(", ");return`${this.name}(${e})`}}class X extends Se(T.Draw){isIdle(){return this.state.type==="idle"}getSelected(){return this}onDragStart({viewport:e,event:t}){return{state:{type:"drawing",points:[e.screenToScene(S.fromEvent(t))]},gesture:{couldBeTap:!1,onMove(r,{event:o,viewport:s}){return console.log("draw.onMove",r),x(r.type==="drawing"),{type:"drawing",points:[...r.points,s.screenToScene(S.fromEvent(o))]}},onEnd(r,{updateDocument:o,location:s}){return console.log("draw.onEnd",r),x(r.type==="drawing"),o(i=>i.replaceShapeVersionPoints(i.getShapeVersionForKeyPoint(s.keyPointId).id,r.points)),{type:"idle"}},onCancel(r){return console.log("draw.onCancel",r),{type:"idle"}}}}}getPointsForShapeVersion(e,t){switch(this.state.type){case"idle":return super.getPointsForShapeVersion(e,t);case"drawing":return Fe(Be(Ue(this.state.points,W),W),W.size);default:b(this.state)}}debugProperties(){switch(this.state.type){case"idle":return{_:"idle"};case"drawing":return{_:"drawing",points:String(this.state.points.length)};default:b(this.state)}}}X.toolName=T.Draw;function le(n,e){x(n instanceof HTMLElement);const t={};let r=!1;for(const[o,s]of Ne(e)){const i=n.dataset[o];if(typeof s=="string")if(s===i)t[o]=s;else{r=!0;break}else{const a=s(i);if(a.isOk())t[o]=a.value;else{r=!0;break}}}return r?n.parentElement?le(n.parentElement,e):null:{element:n,data:t}}function Gt({position:n,children:e,className:t,style:r,...o}){return w("div",{className:D("absolute top-0 left-0",t),style:{transform:`translate(${n.x}px, ${n.y}px)`,...r},...o,children:e})}function Ht({position:n,viewport:e,screenOffset:t=S.ZERO,...r}){return w(Gt,{position:e.sceneToScreen(n).add(t),...r})}class _ extends Se(T.KeyPoint){getSelected(){return this}isIdle(){return this.state.type==="idle"}onTap({event:e,updateLocation:t}){const r=le(e.target,{keyPointId:L.parse});return r&&t(o=>o.with({keyPointId:r.data.keyPointId})),this}onDragStart({event:e,document:t,viewport:r,updateLocation:o}){const s=le(e.target,{type:"onCanvasKeyPoint",keyPointId:L.parse});if(!s)return null;e.preventDefault();const i=t.keyPoints.get(s.data.keyPointId);o(c=>c.with({keyPointId:i.id}));const a=r.screenToScene(S.fromEvent(e));return{state:{type:"draggingKeyPoint",keypointId:i.id,delta:S.ZERO},gesture:{couldBeTap:!0,onMove:(c,{event:h})=>({type:"draggingKeyPoint",keypointId:i.id,delta:r.screenToScene(S.fromEvent(h)).sub(a)}),onEnd:(c,{event:h,updateDocument:m})=>{const l=r.screenToScene(S.fromEvent(h)).sub(a);return m(d=>d.updateKeypoint(i.id,u=>({...u,position:u.position.add(l)}))),{type:"idle"}},onCancel:()=>({type:"idle"})}}}getScreenHtmlComponent(){return qt}debugProperties(){return{_:this.state.type}}}_.toolName=T.KeyPoint;const jt=new S(-12,-12);function qt({viewport:n,document:e,location:t,updateTool:r,state:o}){return w(Me,{children:Array.from(e.data.keyPoints,(s,i)=>{const a=o.type==="draggingKeyPoint"&&o.keypointId===s.id?s.position.add(o.delta):s.position;return w(Ht,{position:a,screenOffset:jt,viewport:n,className:D("flex h-6 w-6 cursor-move items-center justify-center rounded-full border border-stone-200 bg-white text-xs text-stone-400 shadow-md",s.id===t.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),"data-type":"onCanvasKeyPoint","data-key-point-id":s.id,children:i+1},s.id)})})}function Wt({tool:n,onSelectTool:e}){const t=n.getSelected();return B("div",{className:"pointer-events-none absolute top-0 bottom-0 flex cursor-wait flex-col items-center justify-center gap-3 p-3",children:[w(Ve,{letter:"d",isSelected:t.name==="draw",onClick:()=>e(new X({type:"idle"}))}),w(Ve,{letter:"k",isSelected:t.name==="keypoint",onClick:()=>e(new _({type:"idle"}))})]})}function Ve({letter:n,onClick:e,isSelected:t}){return w("button",{className:D("pointer-events-auto flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 bg-white shadow-md",t?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:e,children:n})}const Zt=10,He=M,je=()=>({couldBeTap:!0,onCancel:M,onMove:M,onEnd:M});class Jt{constructor(e=He,t=je){this.onTap=e,this.onDragStart=t,this.state={type:"idle"}}isGestureInProgress(){return this.state.type!=="idle"}onPointerDown(e){var t;switch(this.state.type){case"idle":{const r=this.onDragStart(e);(t=r.couldBeTap)==null||t?this.state={type:"dragUnconfirmed",pointerId:e.pointerId,startPosition:S.fromEvent(e),dragHandler:r}:this.state={type:"dragConfirmed",pointerId:e.pointerId,dragHandler:r};return}case"dragUnconfirmed":case"dragConfirmed":return;default:b(this.state)}}onPointerMove(e){switch(this.state.type){case"idle":return;case"dragUnconfirmed":if(this.state.pointerId!==e.pointerId)return;this.state.dragHandler.onMove(e),this.state.startPosition.distanceTo(S.fromEvent(e))>=Zt&&(this.state={type:"dragConfirmed",pointerId:this.state.pointerId,dragHandler:this.state.dragHandler});return;case"dragConfirmed":if(this.state.pointerId!==e.pointerId)return;this.state.dragHandler.onMove(e);return;default:b(this.state)}}onPointerUp(e){switch(this.state.type){case"idle":return;case"dragUnconfirmed":if(this.state.pointerId!==e.pointerId)return;this.state.dragHandler.onCancel(e),this.onTap(e),this.state={type:"idle"};return;case"dragConfirmed":if(this.state.pointerId!==e.pointerId)return;this.state.dragHandler.onEnd(e),this.state={type:"idle"};return;default:b(this.state)}}onPointerCancel(e){switch(this.state.type){case"idle":return;case"dragUnconfirmed":case"dragConfirmed":if(this.state.pointerId!==e.pointerId)return;this.state.dragHandler.onCancel(e),this.state={type:"idle"};return;default:b(this.state)}}}function Qt(n){var i,a;const e=C((i=n.onTap)!=null?i:He),t=C((a=n.onDragStart)!=null?a:je),[r]=P.exports.useState(()=>new Jt(e,t)),[o,s]=P.exports.useState(!1);return{isGestureInProgress:o,events:P.exports.useMemo(()=>({onPointerDown:c=>{r.onPointerDown(c),s(r.isGestureInProgress())},onPointerMove:c=>{r.onPointerMove(c),s(r.isGestureInProgress())},onPointerUp:c=>{r.onPointerUp(c),s(r.isGestureInProgress())},onPointerCancel:c=>{r.onPointerCancel(c),s(r.isGestureInProgress())}}),[r])}}function Xt(n){return st?n.metaKey:n.ctrlKey}function de(n,e){var r,o,s;const t=typeof e=="string"?{key:e}:e;return n.key.toLowerCase()===t.key.toLowerCase()&&((r=t.command)!=null?r:!1)===Xt(n)&&((o=t.shift)!=null?o:!1)===n.shiftKey&&((s=t.alt)!=null?s:!1)===n.altKey}function j(n,e){return de(n,e)&&n.repeat===!1}class te extends Se("quickPan"){getSelected(){return this.state.previousTool}isIdle(){return!0}canvasClassName(){return"cursor-grab"}onDragStart({event:e,location:t}){return x(this.state.type==="idle"),{state:{type:"dragging",previousTool:this.state.previousTool,initialPan:t.viewportState.pan,previousScreenPoint:S.fromEvent(e)},gesture:{couldBeTap:!1,onMove(r,{updateViewport:o,event:s}){x(r.type==="dragging");const i=S.fromEvent(s);return o(({pan:a,zoom:c})=>({pan:a.add(r.previousScreenPoint.sub(i).scale(c)),zoom:c})),{...r,previousScreenPoint:i}},onEnd(r){return x(r.type==="dragging"),{type:"idle",previousTool:r.previousTool}},onCancel(r,{updateViewport:o}){return x(r.type==="dragging"),o(({zoom:s})=>({zoom:s,pan:r.initialPan})),{type:"idle",previousTool:r.previousTool}}}}}debugProperties(){switch(this.state.type){case"idle":return{_:this.state.type,prev:this.state.previousTool.toDebugString()};case"dragging":return{_:this.state.type,point:this.state.previousScreenPoint.toString(2),prev:this.state.previousTool.toDebugString()};default:b(this.state)}}}te.toolName="quickPan";function _t(n,e){const t=C(e),[r,o]=P.exports.useState(()=>{switch(n){case T.Draw:return new X({type:"idle"});case T.KeyPoint:return new _({type:"idle"});default:b(n)}}),s=Qt({onTap:u=>o(p=>p.onTap(t(u))),onDragStart:u=>{const p=r,f=r.onDragStart(t(u));return f?(o(p.with(f.state)),{couldBeTap:f.gesture.couldBeTap,onMove:y=>o(g=>{x(p.name===g.name,"tool should not change during gesture");const v=f.gesture.onMove(g.state,t(y));return g.with(v)}),onEnd:y=>o(g=>{x(p.name===g.name,"tool should not change during gesture");const v=f.gesture.onEnd(g.state,t(y));return g.with(v)}),onCancel:y=>o(g=>{x(p.name===g.name,"tool should not change during gesture");const v=f.gesture.onCancel(g.state,t(y));return g.with(v)})}):{couldBeTap:!0,onMove:M,onEnd:M,onCancel:M}}}),i=C(u=>o(p=>{const f=t(u);if(en(p)&&p.isIdle()&&!s.isGestureInProgress){if(j(u," "))return new te({type:"idle",previousTool:p});if(j(u,"d"))return new X({type:"idle"});if(j(u,"k"))return new _({type:"idle"});if(j(u,{key:"z",command:!0}))return f.undo(),p;j(u,{key:"z",command:!0,shift:!0})&&f.redo()}return de(u,{key:"0",command:!0})?(f.updateViewport({pan:S.ZERO,zoom:1}),p):p.onKeyDown(f)})),a=C(u=>o(p=>p instanceof te&&de(u,{key:" "})?p.state.previousTool:p.onKeyUp(t(u)))),c=C(u=>s.events.onPointerDown(u)),h=C(u=>s.events.onPointerMove(u)),m=C(u=>s.events.onPointerUp(u)),l=C(u=>s.events.onPointerCancel(u)),d=C(u=>o(p=>p.isIdle()&&!s.isGestureInProgress?u:p));return{events:{onKeyDown:i,onKeyUp:a,onPointerCancel:l,onPointerDown:c,onPointerMove:h,onPointerUp:m,onSelectTool:d},tool:r,updateTool:o}}const qe=[X,_],Yt=Pe(qe);function en(n){return ee(Yt,n.name)}const We=[te];Pe(We);Pe([...qe,...We]);function Pe(n){const e={};for(const t of n)x(!ee(e,t.toolName),`tool ${t.toolName} already exists`),e[t.toolName]=t;return e}function tn(n){const e=[],t=[];if(n.length===0)return[];if(n.length===1){const l=[];for(let d=0;d<12;d++)l.push(n[0].center.add(S.fromPolar(d*Math.PI/6,n[0].radius)));return l}const r=n[0],s=n[1].center.sub(r.center).normalize(),i=s.perpendicular().scale(r.radius);e.push(r.center.sub(s.scale(r.radius))),e.push(r.center.sub(i)),t.push(r.center.add(i));for(let l=1;l<n.length-1;l++){const d=n[l-1],u=n[l],y=n[l+1].center.sub(d.center).normalize().perpendicular().scale(u.radius);e.push(u.center.sub(y)),t.push(u.center.add(y))}const a=n[n.length-2],c=n[n.length-1],h=c.center.sub(a.center).normalize(),m=h.perpendicular().scale(c.radius);return e.push(c.center.sub(m)),e.push(c.center.add(h.scale(c.radius))),t.push(c.center.add(m)),e.concat(t.reverse())}function nn({centerPoints:n}){return w("path",{d:Tt(tn(n))})}function rn({document:n,keyPointId:e,tool:t}){const r=n.getShapeVersionForKeyPoint(e);return w(nn,{centerPoints:t.getPointsForShapeVersion(n,r)})}function on(){const[n,e]=P.exports.useState(null),t=yt(n,vt);return console.log(t),w("div",{ref:e,className:"absolute inset-0 touch-none",children:t&&w(sn,{size:t})})}function sn({size:n}){const{document:e,location:t,updateDocument:r,updateLocation:o,undo:s,redo:i}=Pt(()=>{{const g=At("autosave");if(g.isOk())return g.value;console.error(`Error loading autosave: ${g.error}`)}return Le()});P.exports.useEffect(()=>{Ut("autosave",{doc:e,location:t})},[e,t]);const a=P.exports.useCallback(g=>o(v=>v.with({viewport:U(v.viewportState,g)})),[o]),c=P.exports.useMemo(()=>new Rt(t.viewportState,n,a),[t.viewportState,n,a]),{tool:h,events:m,updateTool:l}=_t(t.tool,g=>({event:g,viewport:c,document:e,location:t,updateDocument:r,updateLocation:o,updateViewport:a,undo:s,redo:i}));P.exports.useEffect(()=>{const g=h.getSelected().name;o(v=>v.tool!==g?v.with({tool:g}):v)},[h,o]);const d=C(g=>c.handleWheelEvent(g));P.exports.useEffect(()=>(window.addEventListener("wheel",d,{passive:!1}),window.addEventListener("keydown",m.onKeyDown),window.addEventListener("keyup",m.onKeyUp),()=>{window.removeEventListener("wheel",d),window.removeEventListener("keydown",m.onKeyDown),window.removeEventListener("keyup",m.onKeyUp)}),[d,m]);const u={viewport:c,document:e,location:t,updateTool:l,state:h.state},p=h.getSceneSvgComponent(),f=h.getScreenSvgComponent(),y=h.getScreenHtmlComponent();return B(Me,{children:[w("div",{className:"pointer-events-none absolute top-0",children:h.toDebugString()}),B("div",{className:"absolute inset-0",onPointerDown:m.onPointerDown,onPointerMove:m.onPointerMove,onPointerUp:m.onPointerUp,onPointerCancel:m.onPointerCancel,children:[w("svg",{viewBox:`0 0 ${n.x} ${n.y}`,className:D("absolute top-0 left-0",h.canvasClassName()),children:w("g",{transform:c.getSceneTransform(),children:w(rn,{document:e,keyPointId:t.keyPointId,tool:h})})}),B("svg",{viewBox:`0 0 ${n.x} ${n.y}`,className:"absolute top-0 left-0",children:[w("g",{transform:c.getSceneTransform(),children:w(p,{...u})}),w(f,{...u})]}),w("div",{className:D("absolute inset-0",h.canvasClassName()),children:w(y,{...u})})]}),w(Wt,{tool:h,onSelectTool:m.onSelectTool}),B("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-center gap-3 p-3",children:[B("div",{className:"flex min-w-0 flex-auto items-center justify-center gap-3",children:[Array.from(e.keyPoints,(g,v)=>w("button",{className:D("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1",g.id===t.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:()=>{o(k=>k.with({keyPointId:g.id}))},children:v+1},g.id)),w("button",{className:D("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const g=L.generate();r(v=>v.addKeyPoint(g),{lockstepLocation:v=>v.with({keyPointId:g})})},children:"+"})]}),w("button",{className:D("absolute right-3 flex h-10 flex-none items-center justify-center justify-self-end rounded-full border border-stone-200 px-3 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const{doc:g,location:v}=Le();r(g,{lockstepLocation:v})},children:"reset"})]})]})}const an=pe(document.getElementById("root"));Re(an).render(w(on,{}));
