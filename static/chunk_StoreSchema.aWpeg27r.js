var Gr=Object.defineProperty;var qr=(u,t,r)=>t in u?Gr(u,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[t]=r;var p=(u,t,r)=>qr(u,typeof t!="symbol"?t+"":t,r);import{c as L,i as Ve,R as Re,w as pe,E as $r,a as ge,d as Fr,b as Y}from"./chunk_track.BfnN30_R.js";import"./chunk_index.C5eOxiyT.js";import{c as ye,g as Wr}from"./chunk__commonjsHelpers.Cpj98o6Y.js";class Ie{constructor(t){p(this,"nextValue");p(this,"diff");this.previousValue=t}get(){var i,n,o,c;const t=((n=(i=this.diff)==null?void 0:i.removed)==null?void 0:n.size)??0,r=((c=(o=this.diff)==null?void 0:o.added)==null?void 0:c.size)??0;if(!(t===0&&r===0))return{value:this.nextValue,diff:this.diff}}_add(t,r){var i,n;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.add(t),this.diff??(this.diff={}),r?(i=this.diff.removed)==null||i.delete(t):((n=this.diff).added??(n.added=new Set),this.diff.added.add(t))}add(t){var n,o,c;const r=this.previousValue.has(t);if(r)return((o=(n=this.diff)==null?void 0:n.removed)==null?void 0:o.has(t))?this._add(t,r):void 0;(c=this.nextValue)!=null&&c.has(t)||this._add(t,r)}_remove(t,r){var i,n;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.delete(t),this.diff??(this.diff={}),r?((i=this.diff).removed??(i.removed=new Set),this.diff.removed.add(t)):(n=this.diff.added)==null||n.delete(t)}remove(t){var n,o,c,f;const r=this.previousValue.has(t);if(!r)return((o=(n=this.diff)==null?void 0:n.added)==null?void 0:o.has(t))?this._remove(t,r):void 0;(f=(c=this.diff)==null?void 0:c.removed)!=null&&f.has(t)||this._remove(t,r)}}function Qr(u,t){return Object.prototype.hasOwnProperty.call(u,t)}function ct(u,t){if(Qr(u,t))return u[t]}function ft(u){return Object.keys(u)}function x(u){return Object.values(u)}function X(u){return Object.entries(u)}function Jr(u){return Object.fromEntries(u)}function je(u,t){const r={};let i=!1;for(const[n,o]of X(u))t(n,o)?r[n]=o:i=!0;return i?r:u}const Yr=()=>typeof process<"u"&&!1,ve=[],Xr=()=>{const u=ve.splice(0,ve.length);for(const t of u)t()};let Me;function Zr(){Me||(Me=requestAnimationFrame(()=>{Me=void 0,Xr()}))}function kr(u){if(Yr())return u();ve.includes(u)||(ve.push(u),Zr())}const es=typeof window<"u"&&window.structuredClone?window.structuredClone:u=>u&&JSON.parse(JSON.stringify(u));let pt=(u=21)=>crypto.getRandomValues(new Uint8Array(u)).reduce((t,r)=>(r&=63,r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r>62?t+="-":t+="_",t),"");class Pe{constructor(t,r){p(this,"createDefaultProperties");p(this,"migrations");p(this,"validator");p(this,"scope");p(this,"isInstance",t=>(t==null?void 0:t.typeName)===this.typeName);this.typeName=t,this.createDefaultProperties=r.createDefaultProperties,this.migrations=r.migrations,this.validator=r.validator??{validate:i=>i},this.scope=r.scope??"document"}create(t){const r={...this.createDefaultProperties(),id:this.createId()};for(const[i,n]of Object.entries(t))n!==void 0&&(r[i]=n);return r.typeName=this.typeName,r}clone(t){return{...es(t),id:this.createId()}}createId(t){return this.typeName+":"+(t??pt())}createCustomId(t){return this.typeName+":"+t}parseId(t){if(!this.isId(t))throw new Error(`ID "${t}" is not a valid ID for type "${this.typeName}"`);return t.slice(this.typeName.length+1)}isId(t){if(!t)return!1;for(let r=0;r<this.typeName.length;r++)if(t[r]!==this.typeName[r])return!1;return t[this.typeName.length]===":"}withDefaultProperties(t){return new Pe(this.typeName,{createDefaultProperties:t,migrations:this.migrations,validator:this.validator,scope:this.scope})}validate(t){return this.validator.validate(t)}}function ps(u,t){return new Pe(u,{createDefaultProperties:()=>({}),migrations:t.migrations??{currentVersion:0,firstVersion:0,migrators:{}},validator:t.validator,scope:t.scope})}class dt{constructor(){p(this,"items",new WeakMap)}get(t,r){return this.items.has(t)||this.items.set(t,r(t)),this.items.get(t)}}var _e={exports:{}};_e.exports;(function(u,t){var r=200,i="__lodash_hash_undefined__",n=1,o=2,c=9007199254740991,f="[object Arguments]",l="[object Array]",v="[object AsyncFunction]",_="[object Boolean]",h="[object Date]",m="[object Error]",b="[object Function]",w="[object GeneratorFunction]",y="[object Map]",P="[object Number]",se="[object Null]",Q="[object Object]",De="[object Promise]",mt="[object Proxy]",ze="[object RegExp]",ne="[object Set]",Ne="[object String]",vt="[object Symbol]",_t="[object Undefined]",be="[object WeakMap]",He="[object ArrayBuffer]",ie="[object DataView]",bt="[object Float32Array]",wt="[object Float64Array]",Tt="[object Int8Array]",St="[object Int16Array]",Ct="[object Int32Array]",At="[object Uint8Array]",xt="[object Uint8ClampedArray]",Ot="[object Uint16Array]",Et="[object Uint32Array]",Vt=/[\\^$.*+?()[\]{}|]/g,Rt=/^\[object .+?Constructor\]$/,It=/^(?:0|[1-9]\d*)$/,T={};T[bt]=T[wt]=T[Tt]=T[St]=T[Ct]=T[At]=T[xt]=T[Ot]=T[Et]=!0,T[f]=T[l]=T[He]=T[_]=T[ie]=T[h]=T[m]=T[b]=T[y]=T[P]=T[Q]=T[ze]=T[ne]=T[Ne]=T[be]=!1;var Le=typeof ye=="object"&&ye&&ye.Object===Object&&ye,jt=typeof self=="object"&&self&&self.Object===Object&&self,z=Le||jt||Function("return this")(),Ue=t&&!t.nodeType&&t,Be=Ue&&!0&&u&&!u.nodeType&&u,Ke=Be&&Be.exports===Ue,we=Ke&&Le.process,Ge=function(){try{return we&&we.binding&&we.binding("util")}catch{}}(),qe=Ge&&Ge.isTypedArray;function Mt(e,s){for(var a=-1,d=e==null?0:e.length,S=0,g=[];++a<d;){var A=e[a];s(A,a,e)&&(g[S++]=A)}return g}function Pt(e,s){for(var a=-1,d=s.length,S=e.length;++a<d;)e[S+a]=s[a];return e}function Dt(e,s){for(var a=-1,d=e==null?0:e.length;++a<d;)if(s(e[a],a,e))return!0;return!1}function zt(e,s){for(var a=-1,d=Array(e);++a<e;)d[a]=s(a);return d}function Nt(e){return function(s){return e(s)}}function Ht(e,s){return e.has(s)}function Lt(e,s){return e==null?void 0:e[s]}function Ut(e){var s=-1,a=Array(e.size);return e.forEach(function(d,S){a[++s]=[S,d]}),a}function Bt(e,s){return function(a){return e(s(a))}}function Kt(e){var s=-1,a=Array(e.size);return e.forEach(function(d){a[++s]=d}),a}var Gt=Array.prototype,qt=Function.prototype,oe=Object.prototype,Te=z["__core-js_shared__"],$e=qt.toString,D=oe.hasOwnProperty,Fe=function(){var e=/[^.]+$/.exec(Te&&Te.keys&&Te.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),We=oe.toString,$t=RegExp("^"+$e.call(D).replace(Vt,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Qe=Ke?z.Buffer:void 0,ae=z.Symbol,Je=z.Uint8Array,Ye=oe.propertyIsEnumerable,Ft=Gt.splice,G=ae?ae.toStringTag:void 0,Xe=Object.getOwnPropertySymbols,Wt=Qe?Qe.isBuffer:void 0,Qt=Bt(Object.keys,Object),Se=J(z,"DataView"),Z=J(z,"Map"),Ce=J(z,"Promise"),Ae=J(z,"Set"),xe=J(z,"WeakMap"),k=J(Object,"create"),Jt=F(Se),Yt=F(Z),Xt=F(Ce),Zt=F(Ae),kt=F(xe),Ze=ae?ae.prototype:void 0,Oe=Ze?Ze.valueOf:void 0;function q(e){var s=-1,a=e==null?0:e.length;for(this.clear();++s<a;){var d=e[s];this.set(d[0],d[1])}}function er(){this.__data__=k?k(null):{},this.size=0}function tr(e){var s=this.has(e)&&delete this.__data__[e];return this.size-=s?1:0,s}function rr(e){var s=this.__data__;if(k){var a=s[e];return a===i?void 0:a}return D.call(s,e)?s[e]:void 0}function sr(e){var s=this.__data__;return k?s[e]!==void 0:D.call(s,e)}function nr(e,s){var a=this.__data__;return this.size+=this.has(e)?0:1,a[e]=k&&s===void 0?i:s,this}q.prototype.clear=er,q.prototype.delete=tr,q.prototype.get=rr,q.prototype.has=sr,q.prototype.set=nr;function N(e){var s=-1,a=e==null?0:e.length;for(this.clear();++s<a;){var d=e[s];this.set(d[0],d[1])}}function ir(){this.__data__=[],this.size=0}function or(e){var s=this.__data__,a=ce(s,e);if(a<0)return!1;var d=s.length-1;return a==d?s.pop():Ft.call(s,a,1),--this.size,!0}function ar(e){var s=this.__data__,a=ce(s,e);return a<0?void 0:s[a][1]}function ur(e){return ce(this.__data__,e)>-1}function cr(e,s){var a=this.__data__,d=ce(a,e);return d<0?(++this.size,a.push([e,s])):a[d][1]=s,this}N.prototype.clear=ir,N.prototype.delete=or,N.prototype.get=ar,N.prototype.has=ur,N.prototype.set=cr;function $(e){var s=-1,a=e==null?0:e.length;for(this.clear();++s<a;){var d=e[s];this.set(d[0],d[1])}}function fr(){this.size=0,this.__data__={hash:new q,map:new(Z||N),string:new q}}function dr(e){var s=fe(this,e).delete(e);return this.size-=s?1:0,s}function lr(e){return fe(this,e).get(e)}function hr(e){return fe(this,e).has(e)}function pr(e,s){var a=fe(this,e),d=a.size;return a.set(e,s),this.size+=a.size==d?0:1,this}$.prototype.clear=fr,$.prototype.delete=dr,$.prototype.get=lr,$.prototype.has=hr,$.prototype.set=pr;function ue(e){var s=-1,a=e==null?0:e.length;for(this.__data__=new $;++s<a;)this.add(e[s])}function gr(e){return this.__data__.set(e,i),this}function yr(e){return this.__data__.has(e)}ue.prototype.add=ue.prototype.push=gr,ue.prototype.has=yr;function U(e){var s=this.__data__=new N(e);this.size=s.size}function mr(){this.__data__=new N,this.size=0}function vr(e){var s=this.__data__,a=s.delete(e);return this.size=s.size,a}function _r(e){return this.__data__.get(e)}function br(e){return this.__data__.has(e)}function wr(e,s){var a=this.__data__;if(a instanceof N){var d=a.__data__;if(!Z||d.length<r-1)return d.push([e,s]),this.size=++a.size,this;a=this.__data__=new $(d)}return a.set(e,s),this.size=a.size,this}U.prototype.clear=mr,U.prototype.delete=vr,U.prototype.get=_r,U.prototype.has=br,U.prototype.set=wr;function Tr(e,s){var a=de(e),d=!a&&Nr(e),S=!a&&!d&&Ee(e),g=!a&&!d&&!S&&at(e),A=a||d||S||g,O=A?zt(e.length,String):[],E=O.length;for(var C in e)D.call(e,C)&&!(A&&(C=="length"||S&&(C=="offset"||C=="parent")||g&&(C=="buffer"||C=="byteLength"||C=="byteOffset")||jr(C,E)))&&O.push(C);return O}function ce(e,s){for(var a=e.length;a--;)if(st(e[a][0],s))return a;return-1}function Sr(e,s,a){var d=s(e);return de(e)?d:Pt(d,a(e))}function ee(e){return e==null?e===void 0?_t:se:G&&G in Object(e)?Rr(e):zr(e)}function ke(e){return te(e)&&ee(e)==f}function et(e,s,a,d,S){return e===s?!0:e==null||s==null||!te(e)&&!te(s)?e!==e&&s!==s:Cr(e,s,a,d,et,S)}function Cr(e,s,a,d,S,g){var A=de(e),O=de(s),E=A?l:B(e),C=O?l:B(s);E=E==f?Q:E,C=C==f?Q:C;var R=E==Q,M=C==Q,V=E==C;if(V&&Ee(e)){if(!Ee(s))return!1;A=!0,R=!1}if(V&&!R)return g||(g=new U),A||at(e)?tt(e,s,a,d,S,g):Er(e,s,E,a,d,S,g);if(!(a&n)){var I=R&&D.call(e,"__wrapped__"),j=M&&D.call(s,"__wrapped__");if(I||j){var K=I?e.value():e,H=j?s.value():s;return g||(g=new U),S(K,H,a,d,g)}}return V?(g||(g=new U),Vr(e,s,a,d,S,g)):!1}function Ar(e){if(!ot(e)||Pr(e))return!1;var s=nt(e)?$t:Rt;return s.test(F(e))}function xr(e){return te(e)&&it(e.length)&&!!T[ee(e)]}function Or(e){if(!Dr(e))return Qt(e);var s=[];for(var a in Object(e))D.call(e,a)&&a!="constructor"&&s.push(a);return s}function tt(e,s,a,d,S,g){var A=a&n,O=e.length,E=s.length;if(O!=E&&!(A&&E>O))return!1;var C=g.get(e);if(C&&g.get(s))return C==s;var R=-1,M=!0,V=a&o?new ue:void 0;for(g.set(e,s),g.set(s,e);++R<O;){var I=e[R],j=s[R];if(d)var K=A?d(j,I,R,s,e,g):d(I,j,R,e,s,g);if(K!==void 0){if(K)continue;M=!1;break}if(V){if(!Dt(s,function(H,W){if(!Ht(V,W)&&(I===H||S(I,H,a,d,g)))return V.push(W)})){M=!1;break}}else if(!(I===j||S(I,j,a,d,g))){M=!1;break}}return g.delete(e),g.delete(s),M}function Er(e,s,a,d,S,g,A){switch(a){case ie:if(e.byteLength!=s.byteLength||e.byteOffset!=s.byteOffset)return!1;e=e.buffer,s=s.buffer;case He:return!(e.byteLength!=s.byteLength||!g(new Je(e),new Je(s)));case _:case h:case P:return st(+e,+s);case m:return e.name==s.name&&e.message==s.message;case ze:case Ne:return e==s+"";case y:var O=Ut;case ne:var E=d&n;if(O||(O=Kt),e.size!=s.size&&!E)return!1;var C=A.get(e);if(C)return C==s;d|=o,A.set(e,s);var R=tt(O(e),O(s),d,S,g,A);return A.delete(e),R;case vt:if(Oe)return Oe.call(e)==Oe.call(s)}return!1}function Vr(e,s,a,d,S,g){var A=a&n,O=rt(e),E=O.length,C=rt(s),R=C.length;if(E!=R&&!A)return!1;for(var M=E;M--;){var V=O[M];if(!(A?V in s:D.call(s,V)))return!1}var I=g.get(e);if(I&&g.get(s))return I==s;var j=!0;g.set(e,s),g.set(s,e);for(var K=A;++M<E;){V=O[M];var H=e[V],W=s[V];if(d)var ut=A?d(W,H,V,s,e,g):d(H,W,V,e,s,g);if(!(ut===void 0?H===W||S(H,W,a,d,g):ut)){j=!1;break}K||(K=V=="constructor")}if(j&&!K){var le=e.constructor,he=s.constructor;le!=he&&"constructor"in e&&"constructor"in s&&!(typeof le=="function"&&le instanceof le&&typeof he=="function"&&he instanceof he)&&(j=!1)}return g.delete(e),g.delete(s),j}function rt(e){return Sr(e,Ur,Ir)}function fe(e,s){var a=e.__data__;return Mr(s)?a[typeof s=="string"?"string":"hash"]:a.map}function J(e,s){var a=Lt(e,s);return Ar(a)?a:void 0}function Rr(e){var s=D.call(e,G),a=e[G];try{e[G]=void 0;var d=!0}catch{}var S=We.call(e);return d&&(s?e[G]=a:delete e[G]),S}var Ir=Xe?function(e){return e==null?[]:(e=Object(e),Mt(Xe(e),function(s){return Ye.call(e,s)}))}:Br,B=ee;(Se&&B(new Se(new ArrayBuffer(1)))!=ie||Z&&B(new Z)!=y||Ce&&B(Ce.resolve())!=De||Ae&&B(new Ae)!=ne||xe&&B(new xe)!=be)&&(B=function(e){var s=ee(e),a=s==Q?e.constructor:void 0,d=a?F(a):"";if(d)switch(d){case Jt:return ie;case Yt:return y;case Xt:return De;case Zt:return ne;case kt:return be}return s});function jr(e,s){return s=s??c,!!s&&(typeof e=="number"||It.test(e))&&e>-1&&e%1==0&&e<s}function Mr(e){var s=typeof e;return s=="string"||s=="number"||s=="symbol"||s=="boolean"?e!=="__proto__":e===null}function Pr(e){return!!Fe&&Fe in e}function Dr(e){var s=e&&e.constructor,a=typeof s=="function"&&s.prototype||oe;return e===a}function zr(e){return We.call(e)}function F(e){if(e!=null){try{return $e.call(e)}catch{}try{return e+""}catch{}}return""}function st(e,s){return e===s||e!==e&&s!==s}var Nr=ke(function(){return arguments}())?ke:function(e){return te(e)&&D.call(e,"callee")&&!Ye.call(e,"callee")},de=Array.isArray;function Hr(e){return e!=null&&it(e.length)&&!nt(e)}var Ee=Wt||Kr;function Lr(e,s){return et(e,s)}function nt(e){if(!ot(e))return!1;var s=ee(e);return s==b||s==w||s==v||s==mt}function it(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=c}function ot(e){var s=typeof e;return e!=null&&(s=="object"||s=="function")}function te(e){return e!=null&&typeof e=="object"}var at=qe?Nt(qe):xr;function Ur(e){return Hr(e)?Tr(e):Or(e)}function Br(){return[]}function Kr(){return!1}u.exports=Lr})(_e,_e.exports);var ts=_e.exports;const rs=Wr(ts);function ss(u){if(u.length===0)return new Set;const t=u[0],r=u.slice(1),i=new Set;for(const n of t)r.every(o=>o.has(n))&&i.add(n);return i}function ns(u,t){const r={};for(const i of t)u.has(i)||(r.added??(r.added=new Set),r.added.add(i));for(const i of u)t.has(i)||(r.removed??(r.removed=new Set),r.removed.add(i));return r.added||r.removed?r:void 0}function lt(u,t){for(const[r,i]of Object.entries(u)){const n=i,o=t[r];if("eq"in n&&o!==n.eq||"neq"in n&&o===n.neq||"gt"in n&&(typeof o!="number"||o<=n.gt))return!1}return!0}function ht(u,t,r){const i=Object.fromEntries(Object.keys(r).map(n=>[n,new Set]));for(const[n,o]of Object.entries(r))if("eq"in o){const f=u.index(t,n).value.get(o.eq);if(f)for(const l of f)i[n].add(l)}else if("neq"in o){const c=u.index(t,n);for(const[f,l]of c.value)if(f!==o.neq)for(const v of l)i[n].add(v)}else if("gt"in o){const c=u.index(t,n);for(const[f,l]of c.value)if(f>o.gt)for(const v of l)i[n].add(v)}return ss(Object.values(i))}class is{constructor(t,r){p(this,"indexCache",new Map);p(this,"historyCache",new Map);this.atoms=t,this.history=r}filterHistory(t){if(this.historyCache.has(t))return this.historyCache.get(t);const r=L("filterHistory:"+t,(i,n)=>{if(Ve(i))return this.history.value;const o=this.history.getDiffSince(n);if(o===Re)return this.history.value;const c={added:{},removed:{},updated:{}};let f=0,l=0,v=0;for(const _ of o){for(const h of x(_.added))if(h.typeName===t)if(c.removed[h.id]){const m=c.removed[h.id];delete c.removed[h.id],l--,m!==h&&(c.updated[h.id]=[m,h],v++)}else c.added[h.id]=h,f++;for(const[h,m]of x(_.updated))m.typeName===t&&(c.added[m.id]?c.added[m.id]=m:c.updated[m.id]?c.updated[m.id]=[c.updated[m.id][0],m]:(c.updated[m.id]=[h,m],v++));for(const h of x(_.removed))h.typeName===t&&(c.added[h.id]?(delete c.added[h.id],f--):c.updated[h.id]?(c.removed[h.id]=c.updated[h.id][0],delete c.updated[h.id],v--,l++):(c.removed[h.id]=h,l++))}return f||l||v?pe(this.history.value,c):i},{historyLength:100});return this.historyCache.set(t,r),r}index(t,r){const i=t+":"+r;if(this.indexCache.has(i))return this.indexCache.get(i);const n=this.__uncached_createIndex(t,r);return this.indexCache.set(i,n),n}__uncached_createIndex(t,r){const i=this.filterHistory(t),n=()=>{i.value;const o=new Map;for(const c of x(this.atoms.value)){const f=c.value;if(f.typeName===t){const l=f[r];o.has(l)||o.set(l,new Set),o.get(l).add(f.id)}}return o};return L("index:"+t+":"+r,(o,c)=>{if(Ve(o))return n();const f=i.getDiffSince(c);if(f===Re)return n();const l=new Map,v=(b,w)=>{let y=l.get(b);y||(y=new Ie(o.get(b)??new Set)),y.add(w),l.set(b,y)},_=(b,w)=>{let y=l.get(b);y||(y=new Ie(o.get(b)??new Set)),y.remove(w),l.set(b,y)};for(const b of f){for(const w of x(b.added))if(w.typeName===t){const y=w[r];v(y,w.id)}for(const[w,y]of x(b.updated))if(y.typeName===t){const P=w[r],se=y[r];P!==se&&(_(P,y.id),v(se,y.id))}for(const w of x(b.removed))if(w.typeName===t){const y=w[r];_(y,w.id)}}let h,m;for(const[b,w]of l){const y=w.get();y&&(h||(h=new Map(o)),m||(m=new Map),y.value.size===0?h.delete(b):h.set(b,y.value),m.set(b,y.diff))}return h&&m?pe(h,m):o},{historyLength:100})}record(t,r=()=>({}),i="record:"+t+(r?":"+r.toString():"")){const n=this.ids(t,r,i);return L(i,()=>{var o;for(const c of n.value)return(o=this.atoms.value[c])==null?void 0:o.value})}records(t,r=()=>({}),i="records:"+t+(r?":"+r.toString():"")){const n=this.ids(t,r,"ids:"+i);return L(i,()=>[...n.value].map(o=>{const c=this.atoms.value[o];if(!c)throw new Error("no atom found for record id: "+o);return c.value}))}ids(t,r=()=>({}),i="ids:"+t+(r?":"+r.toString():"")){const n=this.filterHistory(t),o=()=>{n.value;const l=r();return Object.keys(l).length===0?new Set(x(this.atoms.value).flatMap(v=>{const _=v.value;return _.typeName===t?_.id:[]})):ht(this,t,l)},c=l=>{const v=o(),_=ns(l,v);return _?pe(v,_):l},f=L("ids_query:"+i,r,{isEqual:rs});return L("query:"+i,(l,v)=>{const _=f.value;if(Ve(l))return o();if(v<f.lastChangedEpoch)return c(l);const h=n.getDiffSince(v);if(h===Re)return c(l);const m=new Ie(l);for(const w of h){for(const y of x(w.added))y.typeName===t&&lt(_,y)&&m.add(y.id);for(const[y,P]of x(w.updated))P.typeName===t&&(lt(_,P)?m.add(P.id):m.remove(P.id));for(const y of x(w.removed))y.typeName===t&&m.remove(y.id)}const b=m.get();return b?pe(b.value,b.diff):l},{historyLength:50})}exec(t,r){const i=ht(this,t,r);if(i.size===0)return $r;const n=this.atoms.value;return[...i].map(o=>n[o].value)}}let gs=class{constructor(t){p(this,"id",pt());p(this,"atoms",ge("store_atoms",{}));p(this,"history",ge("history",0,{historyLength:1e3}));p(this,"query",new is(this.atoms,this.history));p(this,"listeners",new Set);p(this,"historyAccumulator",new as);p(this,"historyReactor");p(this,"schema");p(this,"props");p(this,"scopedTypes");p(this,"onAfterCreate");p(this,"onAfterChange");p(this,"onBeforeDelete");p(this,"onAfterDelete");p(this,"_runCallbacks",!0);p(this,"put",(t,r)=>{Y(()=>{const i={},n={},o=this.atoms.__unsafe__getWithoutCapture();let c=null,f,l=!1;for(let h=0,m=t.length;h<m;h++){f=t[h];const b=(c??o)[f.id];if(b){const w=b.__unsafe__getWithoutCapture();f=this.schema.validateRecord(this,f,r??"updateRecord",w),b.set(f);const y=b.__unsafe__getWithoutCapture();w!==y&&(l=!0,i[f.id]=[w,y])}else l=!0,f=this.schema.validateRecord(this,f,r??"createRecord",null),n[f.id]=f,c||(c={...o}),c[f.id]=ge("atom:"+f.id,f)}if(c&&this.atoms.set(c),!l)return;this.updateHistory({added:n,updated:i,removed:{}});const{onAfterCreate:v,onAfterChange:_}=this;v&&this._runCallbacks&&Object.values(n).forEach(h=>{v(h)}),_&&this._runCallbacks&&Object.values(i).forEach(([h,m])=>{_(h,m)})})});p(this,"remove",t=>{Y(()=>{if(this.onBeforeDelete&&this._runCallbacks)for(const i of t){const n=this.atoms.__unsafe__getWithoutCapture()[i];n&&this.onBeforeDelete(n.value)}let r;if(this.atoms.update(i=>{let n;for(const o of t)o in i&&(n||(n={...i}),r||(r={}),delete n[o],r[o]=i[o].value);return n??i}),!!r&&(this.updateHistory({added:{},updated:{},removed:r}),this.onAfterDelete&&this._runCallbacks))for(let i=0,n=t.length;i<n;i++)this.onAfterDelete(r[t[i]])})});p(this,"get",t=>{var r;return(r=this.atoms.value[t])==null?void 0:r.value});p(this,"unsafeGetWithoutCapture",t=>{var r;return(r=this.atoms.value[t])==null?void 0:r.__unsafe__getWithoutCapture()});p(this,"serialize",(t="document")=>{const r={};for(const[i,n]of X(this.atoms.value)){const o=n.value;(t==="all"||this.scopedTypes[t].has(o.typeName))&&(r[i]=o)}return r});p(this,"allRecords",()=>x(this.atoms.value).map(t=>t.value));p(this,"clear",()=>{this.remove(ft(this.atoms.value))});p(this,"update",(t,r)=>{const i=this.atoms.value[t];if(!i){console.error(`Record ${t} not found. This is probably an error`);return}this.put([r(i.__unsafe__getWithoutCapture())])});p(this,"has",t=>!!this.atoms.value[t]);p(this,"listen",(t,r)=>{this._flushHistory();const i={onHistory:t,filters:{source:(r==null?void 0:r.source)??"all",scope:(r==null?void 0:r.scope)??"all"}};return this.listeners.add(i),this.historyReactor.scheduler.isActivelyListening||this.historyReactor.start(),()=>{this.listeners.delete(i),this.listeners.size===0&&this.historyReactor.stop()}});p(this,"isMergingRemoteChanges",!1);p(this,"mergeRemoteChanges",t=>{if(this.isMergingRemoteChanges)return t();try{this.isMergingRemoteChanges=!0,Y(t)}finally{this.isMergingRemoteChanges=!1}});p(this,"createComputedCache",(t,r)=>{const i=new dt;return{get:n=>{const o=this.atoms.value[n];if(o)return i.get(o,()=>L(t+":"+n,()=>r(o.value))).value}}});p(this,"createSelectedComputedCache",(t,r,i)=>{const n=new dt;return{get:o=>{const c=this.atoms.value[o];if(!c)return;const f=L(t+":"+o+":selector",()=>r(c.value));return n.get(c,()=>L(t+":"+o,()=>i(f.value))).value}}});p(this,"_integrityChecker");p(this,"_isPossiblyCorrupted",!1);const{initialData:r,schema:i}=t;this.schema=i,this.props=t.props,r&&this.atoms.set(Jr(X(r).map(([n,o])=>[n,ge("atom:"+n,this.schema.validateRecord(this,o,"initialize",null))]))),this.historyReactor=Fr("Store.historyReactor",()=>{this.history.value,this._flushHistory()},{scheduleEffect:n=>kr(n)}),this.scopedTypes={document:new Set(x(this.schema.types).filter(n=>n.scope==="document").map(n=>n.typeName)),session:new Set(x(this.schema.types).filter(n=>n.scope==="session").map(n=>n.typeName)),presence:new Set(x(this.schema.types).filter(n=>n.scope==="presence").map(n=>n.typeName))}}_flushHistory(){if(this.historyAccumulator.hasChanges()){const t=this.historyAccumulator.flush();for(const{changes:r,source:i}of t){let n=null,o=null,c=null;for(const{onHistory:f,filters:l}of this.listeners)if(!(l.source!=="all"&&l.source!==i))if(l.scope!=="all")if(l.scope==="document"){if(o??(o=this.filterChangesByScope(r,"document")),!o)continue;f({changes:o,source:i})}else if(l.scope==="session"){if(n??(n=this.filterChangesByScope(r,"session")),!n)continue;f({changes:n,source:i})}else{if(c??(c=this.filterChangesByScope(r,"presence")),!c)continue;f({changes:c,source:i})}else f({changes:r,source:i})}}}filterChangesByScope(t,r){const i={added:je(t.added,(n,o)=>this.scopedTypes[r].has(o.typeName)),updated:je(t.updated,(n,o)=>this.scopedTypes[r].has(o[1].typeName)),removed:je(t.removed,(n,o)=>this.scopedTypes[r].has(o.typeName))};return Object.keys(i.added).length===0&&Object.keys(i.updated).length===0&&Object.keys(i.removed).length===0?null:i}updateHistory(t){this.historyAccumulator.add({changes:t,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.value+1,t)}validate(t){this.allRecords().forEach(r=>this.schema.validateRecord(this,r,t,null))}getSnapshot(t="document"){return{store:this.serialize(t),schema:this.schema.serialize()}}loadSnapshot(t){const r=this.schema.migrateStoreSnapshot(t);if(r.type==="error")throw new Error(`Failed to migrate snapshot: ${r.reason}`);Y(()=>{this.clear(),this.put(Object.values(r.value)),this.ensureStoreIsUsable()})}extractingChanges(t){const r=[],i=this.historyAccumulator.intercepting(n=>r.push(n.changes));try{return Y(t),gt(r)}finally{i()}}applyDiff(t,r=!0){const i=this._runCallbacks;try{this._runCallbacks=r,Y(()=>{const n=x(t.added).concat(x(t.updated).map(([c,f])=>f)),o=ft(t.removed);n.length&&this.put(n),o.length&&this.remove(o)})}finally{this._runCallbacks=i}}ensureStoreIsUsable(){var t;this._integrityChecker??(this._integrityChecker=this.schema.createIntegrityChecker(this)),(t=this._integrityChecker)==null||t.call(this)}markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}};function gt(u){const t={added:{},removed:{},updated:{}};for(const r of u){for(const[i,n]of X(r.added))if(t.removed[i]){const o=t.removed[i];delete t.removed[i],o!==n&&(t.updated[i]=[o,n])}else t.added[i]=n;for(const[i,[n,o]]of X(r.updated)){if(t.added[i]){t.added[i]=o,delete t.updated[i],delete t.removed[i];continue}if(t.updated[i]){t.updated[i][1]=o,delete t.removed[i];continue}t.updated[i]=r.updated[i],delete t.removed[i]}for(const[i,n]of X(r.removed))t.added[i]?delete t.added[i]:t.updated[i]?(t.removed[i]=t.updated[i][0],delete t.updated[i]):t.removed[i]=n}return t}function os(u){const t=[];let r=u[0],i;for(let n=1,o=u.length;n<o;n++)i=u[n],r.source!==i.source?(t.push(r),r=i):r={source:r.source,changes:gt([r.changes,i.changes])};return t.push(r),t}class as{constructor(){p(this,"_history",[]);p(this,"_interceptors",new Set)}intercepting(t){return this._interceptors.add(t),()=>{this._interceptors.delete(t)}}add(t){this._history.push(t);for(const r of this._interceptors)r(t)}flush(){const t=os(this._history);return this._history=[],t}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function us(u){return typeof u=="object"&&u!==null&&"id"in u&&"typeName"in u}var re=(u=>(u.IncompatibleSubtype="incompatible-subtype",u.UnknownType="unknown-type",u.TargetVersionTooNew="target-version-too-new",u.TargetVersionTooOld="target-version-too-old",u.MigrationError="migration-error",u.UnrecognizedSubtype="unrecognized-subtype",u))(re||{});function me({record:u,migrations:t,fromVersion:r,toVersion:i}){let n=r;if(!us(u))throw new Error("[migrateRecord] object is not a record");const{typeName:o,id:c,...f}=u;let l=f;for(;n<i;){const v=n+1,_=t.migrators[v];if(!_)return{type:"error",reason:"target-version-too-new"};l=_.up(l),n=v}for(;n>i;){const v=n-1,_=t.migrators[n];if(!_)return{type:"error",reason:"target-version-too-old"};l=_.down(l),n=v}return{type:"success",value:{...l,id:c,typeName:o}}}function cs({value:u,migrations:t,fromVersion:r,toVersion:i}){let n=r;for(;n<i;){const o=n+1,c=t.migrators[o];if(!c)return{type:"error",reason:"target-version-too-new"};u=c.up(u),n=o}for(;n>i;){const o=n-1,c=t.migrators[n];if(!c)return{type:"error",reason:"target-version-too-old"};u=c.down(u),n=o}return{type:"success",value:u}}class yt{constructor(t,r){this.types=t,this.options=r}static create(t,r){return new yt(t,r??{})}get currentStoreVersion(){var t;return((t=this.options.snapshotMigrations)==null?void 0:t.currentVersion)??0}validateRecord(t,r,i,n){try{const o=ct(this.types,r.typeName);if(!o)throw new Error(`Missing definition for record type ${r.typeName}`);return o.validate(r)}catch(o){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:t,record:r,phase:i,recordBefore:n,error:o});throw o}}migratePersistedRecord(t,r,i="up"){var h;const n=ct(this.types,t.typeName),o=r.recordVersions[t.typeName];if(!o||!n)return{type:"error",reason:re.UnknownType};const c=n.migrations.currentVersion,f=o.version;if(c!==f){const m=me(i==="up"?{record:t,migrations:n.migrations,fromVersion:f,toVersion:c}:{record:t,migrations:n.migrations,fromVersion:c,toVersion:f});if(m.type==="error")return m;t=m.value}if(!n.migrations.subTypeKey)return{type:"success",value:t};const l=(h=n.migrations.subTypeMigrations)==null?void 0:h[t[n.migrations.subTypeKey]],v="subTypeVersions"in o?o.subTypeVersions[t[n.migrations.subTypeKey]]:void 0;if(l===void 0)return{type:"error",reason:re.UnrecognizedSubtype};if(v===void 0)return{type:"error",reason:re.IncompatibleSubtype};const _=me(i==="up"?{record:t,migrations:l,fromVersion:v,toVersion:l.currentVersion}:{record:t,migrations:l,fromVersion:l.currentVersion,toVersion:v});return _.type==="error"?_:{type:"success",value:_.value}}migrateStoreSnapshot(t){let{store:r}=t;const i=this.options.snapshotMigrations;if(!i)return{type:"success",value:r};const n=i.currentVersion,o=t.schema.storeVersion??0;if(n<o)return{type:"error",reason:re.TargetVersionTooOld};if(n>o){const f=cs({value:r,migrations:i,fromVersion:o,toVersion:n});if(f.type==="error")return f;r=f.value}const c=[];for(const f of x(r)){const l=this.migratePersistedRecord(f,t.schema);if(l.type==="error")return l;l.value&&l.value!==f&&c.push(l.value)}if(c.length){r={...r};for(const f of c)r[f.id]=f}return{type:"success",value:r}}createIntegrityChecker(t){var r,i;return((i=(r=this.options).createIntegrityChecker)==null?void 0:i.call(r,t))??void 0}serialize(){var t;return{schemaVersion:1,storeVersion:((t=this.options.snapshotMigrations)==null?void 0:t.currentVersion)??0,recordVersions:Object.fromEntries(x(this.types).map(r=>[r.typeName,r.migrations.subTypeKey&&r.migrations.subTypeMigrations?{version:r.migrations.currentVersion,subTypeKey:r.migrations.subTypeKey,subTypeVersions:r.migrations.subTypeMigrations?Object.fromEntries(Object.entries(r.migrations.subTypeMigrations).map(([i,n])=>[i,n.currentVersion])):void 0}:{version:r.migrations.currentVersion}]))}}serializeEarliestVersion(){var t;return{schemaVersion:1,storeVersion:((t=this.options.snapshotMigrations)==null?void 0:t.firstVersion)??0,recordVersions:Object.fromEntries(x(this.types).map(r=>[r.typeName,r.migrations.subTypeKey&&r.migrations.subTypeMigrations?{version:r.migrations.firstVersion,subTypeKey:r.migrations.subTypeKey,subTypeVersions:r.migrations.subTypeMigrations?Object.fromEntries(Object.entries(r.migrations.subTypeMigrations).map(([i,n])=>[i,n.firstVersion])):void 0}:{version:r.migrations.firstVersion}]))}}}export{gs as S,yt as a,ps as c};
