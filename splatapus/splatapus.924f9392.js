import{a as C,b as pe,t as M,s as st,L as at,h as Oe,g as Y,M as R,N as ct,f as Z,l as $e,D as lt,C as Ve,F as ut,O as dt,c as T,P as W,e as pt,r as Le}from"../chunks/chunk_assert.66f3ec42.js";/* empty css                               */import{a as ht,r as k}from"../chunks/chunk_index.b0b8f4df.js";import{R as ft,j as P,c as B,F as Ue,a as j}from"../chunks/chunk_ResizeObserver.38aa3088.js";import{V as g,b as ye,R as ne,P as gt,d as vt,c as Q,a as mt,e as Ae,f as wt,p as yt}from"../chunks/chunk_Vector2.e9b23424.js";import{A as je}from"../chunks/chunk_AABB.36b4d245.js";var ve=function t(e,n){if(e===n)return!0;if(e&&n&&typeof e=="object"&&typeof n=="object"){if(e.constructor!==n.constructor)return!1;var r,o,i;if(Array.isArray(e)){if(r=e.length,r!=n.length)return!1;for(o=r;o--!==0;)if(!t(e[o],n[o]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if(i=Object.keys(e),r=i.length,r!==Object.keys(n).length)return!1;for(o=r;o--!==0;)if(!Object.prototype.hasOwnProperty.call(n,i[o]))return!1;for(o=r;o--!==0;){var s=i[o];if(!t(e[s],n[s]))return!1}return!0}return e!==e&&n!==n},Ze,xe=ht.exports;Ze=xe.createRoot,xe.hydrateRoot;let he;const re=new Map,We=new WeakMap;function Pt(t){for(const e of t){We.set(e.target,e);for(const n of pe(re.get(e.target),"callback does not exist for tracked entry"))n(e)}}function Qe(){return he||(he=new ft(Pt)),he}function St(t,e){let n=re.get(t);n||(n=new Set,re.set(t,n),Qe().observe(t));const r=We.get(t);r&&e(r),n.add(e)}function Et(t,e){const n=re.get(t);C(n,"element is not tracked");const r=n.delete(e);C(r,"callback did not exist for element"),n.size===0&&(re.delete(t),Qe().unobserve(t))}function Ct(t,e){const[n,r]=k.exports.useState(null);return k.exports.useLayoutEffect(()=>{if(!t)return;const o=i=>{console.log({entry:i}),r(e(i))};return St(t,o),()=>{Et(t,o)}},[t,e]),n}function It(t){return new g(t.contentRect.width,t.contentRect.height)}const Dt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");class Pe{constructor(e,n=16){this.randomLength=n,this.debugIdCounter=0,this.prefix=e,this.Id=`${e}.SAMPLE`;const r=new RegExp(`^${this.prefix}\\.([a-zA-Z0-9_]+)$`);this.parse=ye(vt,o=>r.test(o)?ne.ok(o):ne.error(new gt(`Expected ${this.prefix}.*, got ${o}`,[])))}generate(){const e=M(this.randomLength,()=>st(Dt)).join("");return`${this.prefix}.${e}`}}const G=new Pe("key"),Tt=Q({id:G.parse,position:g.parse}),Se=new Pe("shv"),zt=Q({id:Se.parse,keyPointId:G.parse,rawPoints:mt(g.parse)}),Ge=new Pe("doc"),kt=Q({id:Ge.parse,keyPoints:Ae(G.parse,Tt),shapeVersions:Ae(Se.parse,zt)});function bt(){return{id:Ge.generate(),keyPoints:{},shapeVersions:{}}}const Ot=30,Vt=500,Lt=10,ee={size:16,streamline:.5,smoothing:.5,thinning:.5,simulatePressure:!0,easing:t=>t,start:{},end:{},last:!1};class Ee{constructor(e,n,r,o,i){this.id=e,this.keyPoints=n,this.shapeVersions=r,this.keyPointIdByShapeVersion=o,this.normalizedShapeVersions=i}with(e){var n,r,o,i,s;return new Ee((n=e.id)!=null?n:this.id,(r=e.keyPoints)!=null?r:this.keyPoints,(o=e.shapeVersions)!=null?o:this.shapeVersions,(i=e.keyPointIdByShapeVersion)!=null?i:this.keyPointIdByShapeVersion,(s=e.normalizedCenterPointsByShapeVersion)!=null?s:this.normalizedShapeVersions)}}class A{static fromArray(e){return new A(at(e.map(n=>[n.id,n])))}constructor(e){this.data=e}has(e){return Oe(this.data,e)}getIfExists(e){return Y(this.data,e)}get(e){const n=this.getIfExists(e);return C(n!=null,`Item with id ${e} not found`),n}insert(e){return new A({...this.data,[e.id]:e})}update(e,n){const r=this.get(e),o=R(r,n);return C(r.id===o.id),this.insert(o)}delete(e){const{[e]:n,...r}=this.data;return new A(r)}*[Symbol.iterator](){for(const e in this.data)Oe(this.data,e)&&(yield pe(this.data[e]))}}class K{constructor(e={}){this.inverse=e}static build(e,n){const r={};for(const o of n){const i=o.id,s=o[e],a=Y(r,s);a?a.push(i):r[s]=[i]}return new K(r)}lookupInverseIfExists(e){var n;return(n=Y(this.inverse,e))==null?void 0:n[0]}lookupInverse(e){const n=this.lookupInverseIfExists(e);return C(n!=null,`Item with id ${e} not found`),n}add(e,n){const r=Y(this.inverse,n);return r?(C(!r.includes(e),`relation ${n}<->${e} already exists in index`),new K({...this.inverse,[n]:[...r,e]})):new K({...this.inverse,[n]:[e]})}remove(e,n){const r=Y(this.inverse,n);if(r){const o=r.indexOf(e);if(o>=0)return r.length>1?new K({...this.inverse,[n]:ct(r,o)}):new K({...this.inverse,[n]:void 0})}Z(`relation ${n}<->${e} not found in index`)}}const{min:U,PI:Sn}=Math,Ne=.275;function Je(t,e={}){const{size:n=16,smoothing:r=.5,thinning:o=.5,simulatePressure:i=!0,easing:s=y=>y,start:a={},end:c={}}=e,{easing:l=y=>y*(2-y)}=a,{easing:d=y=>--y*y*y+1}=c;if(t.length===0||n<=0)return[];const u=t[t.length-1].runningLength,p=a.taper===!1?0:a.taper===!0?Math.max(n,u):a.taper,m=c.taper===!1?0:c.taper===!0?Math.max(n,u):c.taper,v=Math.pow(n*r,2),h=[];let w=t.slice(0,10).reduce((y,V)=>{let $=V.pressure;if(i){const ce=U(1,V.distance/n),F=U(1,1-ce);$=U(1,y+(F-y)*(ce*Ne))}return(y+$)/2},t[0].pressure),f=Fe(n,o,t[t.length-1].pressure,s),E=t[0].point,S=E;for(let y=0;y<t.length;y++){let{pressure:V}=t[y];const{point:$,distance:ce,runningLength:F}=t[y];if(y<t.length-1&&u-F<3)continue;if(o){if(i){const be=U(1,ce/n),it=U(1,1-be);V=U(1,w+(it-w)*(be*Ne))}f=Fe(n,o,V,s)}else f=n/2;const rt=F<p?l(F/p):1,ot=u-F<m?d((u-F)/m):1;if(f=Math.max(.01,f*Math.min(rt,ot)),y===t.length-1){h.push({center:$,radius:f});continue}S=$,(y<=1||E.distanceToSq(S)>v)&&(h.push({center:$,radius:f}),E=S),w=V}return h}function He(t,e={}){var p,m;const{streamline:n=.5,size:r=16,last:o=!1}=e;if(t.length===0)return[];const i=.15+(1-n)*.85;let s=t.map(v=>({point:g.fromVectorLike(v),pressure:v.pressure}));if(s.length===2){const v=s[1];s=s.slice(0,-1);for(let h=1;h<5;h++)s.push({point:s[0].point.lerp(v.point,h/4),pressure:v.pressure})}s.length===1&&s.push({point:s[0].point.add(g.UNIT),pressure:s[0].pressure});const a=[{point:s[0].point,pressure:s[0].pressure!=null&&s[0].pressure>=0?s[0].pressure:.25,vector:g.UNIT,distance:0,runningLength:0}];let c=!1,l=0,d=a[0];const u=s.length-1;for(let v=1;v<s.length;v++){const h=s[v],w=o&&v===u?h.point:d.point.lerp(h.point,i);if(d.point.equals(w))continue;const f=w.distanceTo(d.point);if(l+=f,v<u&&!c){if(l<r)continue;c=!0}d={point:w,pressure:h.pressure!=null&&h.pressure>=0?h.pressure:.5,vector:d.point.sub(w).normalize(),distance:f,runningLength:l},a.push(d)}return a[0].vector=(m=(p=a[1])==null?void 0:p.vector)!=null?m:g.ZERO,a}function Fe(t,e,n,r=o=>o){return t*r(.5-e*(.5-n))}function At(t){if(!t.length)return"";const e=["M",t[0].x,t[0].y,"Q"];for(let n=0;n<t.length;n++){const r=t[n],o=t[(n+1)%t.length],i=r.add(o).scale(.5);e.push(r.x,r.y,i.x,i.y)}return e.push("Z"),e.join(" ")}function Xe(t,e){const n=[t[0]];if(t.length===0)return[];let r=e,o=t[0],i=t[0].center;for(let s=1;s<t.length;s++){const a=t[s],c=t[Math.min(s+1,t.length-1)],l=a.center.add(c.center).scale(.5),d=a.center.distanceTo(o.center),u=i,p=a.center,m=l;let v=0;for(;d-v>=r;){const h=(r+v)/d;n.push({center:u.lerp(p,h).lerp(p.lerp(m,h),h),radius:$e(o.radius,a.radius,h)}),v+=r,r=e}r-=d-v,o=a,i=l}return n.push(t[t.length-1]),n}function fe(t){var o,i;if(t.length===0)return{versions:new A({})};const e=[];let n=0;for(const s of t){const a=He(s.rawPoints),c=(i=(o=a[a.length-1])==null?void 0:o.runningLength)!=null?i:0;e.push({id:s.id,strokePoints:a,length:c}),c>n&&(n=c)}const r=Math.floor(n/ee.size);return{versions:A.fromArray(e.map(({strokePoints:s,length:a,id:c})=>({id:c,length:a,normalizedCenterPoints:Xe(Je(s,ee),a/r)})))}}function N(){}N.prototype={diff:function(e,n){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=r.callback;typeof r=="function"&&(o=r,r={}),this.options=r;var i=this;function s(h){return o?(setTimeout(function(){o(void 0,h)},0),!0):h}e=this.castInput(e),n=this.castInput(n),e=this.removeEmpty(this.tokenize(e)),n=this.removeEmpty(this.tokenize(n));var a=n.length,c=e.length,l=1,d=a+c;r.maxEditLength&&(d=Math.min(d,r.maxEditLength));var u=[{newPos:-1,components:[]}],p=this.extractCommon(u[0],n,e,0);if(u[0].newPos+1>=a&&p+1>=c)return s([{value:this.join(n),count:n.length}]);function m(){for(var h=-1*l;h<=l;h+=2){var w=void 0,f=u[h-1],E=u[h+1],S=(E?E.newPos:0)-h;f&&(u[h-1]=void 0);var y=f&&f.newPos+1<a,V=E&&0<=S&&S<c;if(!y&&!V){u[h]=void 0;continue}if(!y||V&&f.newPos<E.newPos?(w=Nt(E),i.pushComponent(w.components,void 0,!0)):(w=f,w.newPos++,i.pushComponent(w.components,!0,void 0)),S=i.extractCommon(w,n,e,h),w.newPos+1>=a&&S+1>=c)return s(xt(i,w.components,n,e,i.useLongestToken));u[h]=w}l++}if(o)(function h(){setTimeout(function(){if(l>d)return o();m()||h()},0)})();else for(;l<=d;){var v=m();if(v)return v}},pushComponent:function(e,n,r){var o=e[e.length-1];o&&o.added===n&&o.removed===r?e[e.length-1]={count:o.count+1,added:n,removed:r}:e.push({count:1,added:n,removed:r})},extractCommon:function(e,n,r,o){for(var i=n.length,s=r.length,a=e.newPos,c=a-o,l=0;a+1<i&&c+1<s&&this.equals(n[a+1],r[c+1]);)a++,c++,l++;return l&&e.components.push({count:l}),e.newPos=a,c},equals:function(e,n){return this.options.comparator?this.options.comparator(e,n):e===n||this.options.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],r=0;r<e.length;r++)e[r]&&n.push(e[r]);return n},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function xt(t,e,n,r,o){for(var i=0,s=e.length,a=0,c=0;i<s;i++){var l=e[i];if(l.removed){if(l.value=t.join(r.slice(c,c+l.count)),c+=l.count,i&&e[i-1].added){var u=e[i-1];e[i-1]=e[i],e[i]=u}}else{if(!l.added&&o){var d=n.slice(a,a+l.count);d=d.map(function(m,v){var h=r[c+v];return h.length>m.length?h:m}),l.value=t.join(d)}else l.value=t.join(n.slice(a,a+l.count));a+=l.count,l.added||(c+=l.count)}}var p=e[s-1];return s>1&&typeof p.value=="string"&&(p.added||p.removed)&&t.equals("",p.value)&&(e[s-2].value+=p.value,e.pop()),e}function Nt(t){return{newPos:t.newPos,components:t.components.slice(0)}}var Me=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,Ke=/\S/,Ye=new N;Ye.equals=function(t,e){return this.options.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t===e||this.options.ignoreWhitespace&&!Ke.test(t)&&!Ke.test(e)};Ye.tokenize=function(t){for(var e=t.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&Me.test(e[n])&&Me.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};var Ce=new N;Ce.tokenize=function(t){var e=[],n=t.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var r=0;r<n.length;r++){var o=n[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=o:(this.options.ignoreWhitespace&&(o=o.trim()),e.push(o))}return e};function Ft(t,e,n){return Ce.diff(t,e,n)}var Mt=new N;Mt.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var Kt=new N;Kt.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function ue(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ue=function(e){return typeof e}:ue=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ue(t)}var Rt=Object.prototype.toString,oe=new N;oe.useLongestToken=!0;oe.tokenize=Ce.tokenize;oe.castInput=function(t){var e=this.options,n=e.undefinedReplacement,r=e.stringifyReplacer,o=r===void 0?function(i,s){return typeof s>"u"?n:s}:r;return typeof t=="string"?t:JSON.stringify(me(t,null,null,o),o,"  ")};oe.equals=function(t,e){return N.prototype.equals.call(oe,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function me(t,e,n,r,o){e=e||[],n=n||[],r&&(t=r(o,t));var i;for(i=0;i<e.length;i+=1)if(e[i]===t)return n[i];var s;if(Rt.call(t)==="[object Array]"){for(e.push(t),s=new Array(t.length),n.push(s),i=0;i<t.length;i+=1)s[i]=me(t[i],e,n,r,o);return e.pop(),n.pop(),s}if(t&&t.toJSON&&(t=t.toJSON()),ue(t)==="object"&&t!==null){e.push(t),s={},n.push(s);var a=[],c;for(c in t)t.hasOwnProperty(c)&&a.push(c);for(a.sort(),i=0;i<a.length;i+=1)c=a[i],s[c]=me(t[c],e,n,r,c);e.pop(),n.pop()}else s=t;return s}var we=new N;we.tokenize=function(t){return t.slice()};we.join=we.removeEmpty=function(t){return t};class q{constructor(e,n=0,r=!0){if(this.data=e,this.version=n,!r)return;const o=this.serialize(),i=q.deserialize(o,this.version);if(!ve(this,i)){const s=JSON.stringify(this,null,2),a=JSON.stringify(i,null,2),c=Ft(s,a);console.log(c),Z(`Mismatch after update:
Actual:
${JSON.stringify(this,null,2)}

Expected:
${JSON.stringify(i,null,2)}`)}}static create(){return q.deserialize(bt())}static deserialize(e,n=0){const r=new A(e.shapeVersions);return new q(new Ee(e.id,new A(e.keyPoints),r,K.build("keyPointId",r),fe(Array.from(r)).versions),n,!1)}with(...e){return new q(this.data.with(...e),this.version+1)}serialize(){return{id:this.data.id,keyPoints:this.data.keyPoints.data,shapeVersions:this.data.shapeVersions.data}}get keyPoints(){return this.data.keyPoints}get shapeVersions(){return this.data.shapeVersions}getShapeVersionForKeyPoint(e){return this.shapeVersions.get(this.data.keyPointIdByShapeVersion.lookupInverse(e))}addKeyPoint(e,n){console.log("doc.addKeyPoint",e);const r=Se.generate(),o=this.keyPoints.insert({id:e,position:n}),i=this.shapeVersions.insert({id:r,keyPointId:e,rawPoints:[]});return this.with({keyPoints:o,shapeVersions:i,keyPointIdByShapeVersion:this.data.keyPointIdByShapeVersion.add(r,e),normalizedCenterPointsByShapeVersion:fe(Array.from(i)).versions})}updateKeypoint(e,n){return this.with({keyPoints:this.keyPoints.update(e,n)})}replaceShapeVersionPoints(e,n){console.log("doc.replaceShapeVersionPoints",e);const r=this.shapeVersions.insert({...this.shapeVersions.get(e),rawPoints:n});return this.with({shapeVersions:r,normalizedCenterPointsByShapeVersion:fe(Array.from(r)).versions})}}var I=(t=>(t.Draw="draw",t.KeyPoint="keyPoint",t))(I||{});const Bt=wt(I);var ie=(t=>(t.Pan="quickPan",t))(ie||{});const qt=Q({pan:g.parse,zoom:yt});class $t{constructor({pan:e,zoom:n},r,o){this.screenSize=r,this.update=o,this.pan=e,this.zoom=n}handleWheelEvent(e){console.log("wheel",e),e.preventDefault(),e.stopImmediatePropagation();const{deltaX:n,deltaY:r}=e;if(e.ctrlKey){const o=g.fromEvent(e);this.update(({pan:i,zoom:s})=>{const a=Math.exp(-r/100)*s,c=o.add(i).scale(a/s).sub(o);return{zoom:a,pan:c}})}else this.update(({pan:o,zoom:i})=>({pan:o.add(new g(n,r)),zoom:i}))}origin(){return this.pan.sub(this.screenSize.scale(.5*this.zoom))}visibleSceneBounds(){return new je(this.origin(),this.screenSize)}screenToScene(e){return e.add(this.origin()).scale(1/this.zoom)}sceneToScreen(e){return e.scale(this.zoom).sub(this.origin())}eventSceneCoords(e){return this.screenToScene(g.fromEvent(e))}getSceneTransform(){const e=this.origin();return`translate(${-e.x}, ${-e.y}) scale(${this.zoom}) `}}const Ut=Q({keyPointId:G.parse,viewport:qt,tool:Bt}),Ie=class{constructor({keyPointId:t,viewport:e={pan:g.ZERO,zoom:1},tool:n=I.Draw}){this.keyPointId=t,this.viewportState=e,this.tool=n}serialize(){return{keyPointId:this.keyPointId,viewport:this.viewportState,tool:this.tool}}with(t){var e,n,r;return new Ie({keyPointId:(e=t.keyPointId)!=null?e:this.keyPointId,viewport:(n=t.viewport)!=null?n:this.viewportState,tool:(r=t.tool)!=null?r:this.tool})}};let De=Ie;De.parse=ye(Ut,t=>ne.ok(new Ie(t)));const jt=Q({doc:ye(kt,t=>ne.ok(q.deserialize(t))),location:De.parse});function Zt(t){return Ve(`splatapus.${t}`)?jt(Ve(`splatapus.${t}`)).mapErr(n=>n.toString()):ne.error("No saved data found")}function Wt(t,{doc:e,location:n}){ut(`splatapus.${t}`,{doc:e.serialize(),location:n.serialize()})}const Qt=lt(Vt,Wt);function Re(){const t=G.generate();return{doc:q.create().addKeyPoint(t,g.ZERO),location:new De({keyPointId:t})}}function _e(t){const e=k.exports.useRef();return k.exports.useLayoutEffect(()=>{e.current=t}),k.exports.useCallback((...n)=>{const r=e.current;return C(r,"fn does not exist"),r(...n)},[])}function Gt(t){return dt?t.metaKey:t.ctrlKey}function et(t,e){var r,o,i;const n=typeof e=="string"?{key:e}:e;return t.key.toLowerCase()===n.key.toLowerCase()&&((r=n.command)!=null?r:!1)===Gt(t)&&((o=n.shift)!=null?o:!1)===t.shiftKey&&((i=n.alt)!=null?i:!1)===t.altKey}function z(t,e){return et(t,e)&&t.repeat===!1}const Be={initialize(){return{state:"idle"}},onPointerEvent(t,e){switch(t.eventType){case"down":switch(e.state){case"idle":return{pan:{state:"oneFingerDown",pointerA:{id:t.event.pointerId,startScreenPosition:g.fromEvent(t.event),currentScreenPosition:g.fromEvent(t.event),startEvent:t.event}},passthroughContext:t};case"oneFingerDown":return{pan:{state:"bothFingersDown",pointerA:e.pointerA,pointerB:{id:t.event.pointerId,startScreenPosition:g.fromEvent(t.event),currentScreenPosition:g.fromEvent(t.event),startEvent:t.event},initialPan:t.viewport.pan,initialZoom:t.viewport.zoom},passthroughContext:{...t,eventType:"cancel",event:e.pointerA.startEvent}};case"bothFingersDown":return{pan:e,passthroughContext:t};default:throw T(e)}case"move":switch(e.state){case"idle":return{pan:e,passthroughContext:t};case"oneFingerDown":return e.pointerA.id===t.event.pointerId?{pan:{...e,pointerA:{...e.pointerA,currentScreenPosition:g.fromEvent(t.event)}},passthroughContext:t}:{pan:e,passthroughContext:t};case"bothFingersDown":if(t.event.pointerId===e.pointerA.id||t.event.pointerId===e.pointerB.id){const n=t.event.pointerId===e.pointerA.id?g.fromEvent(t.event):e.pointerA.currentScreenPosition,r=t.event.pointerId===e.pointerB.id?g.fromEvent(t.event):e.pointerB.currentScreenPosition,o=e.pointerA.startScreenPosition.distanceTo(e.pointerB.startScreenPosition),s=n.distanceTo(r)/o,a=e.pointerA.startScreenPosition.lerp(e.pointerB.startScreenPosition,.5),c=n.lerp(r,.5);return t.updateViewport(()=>{const l=a.add(e.initialPan).scale(s).sub(c);return{zoom:e.initialZoom*s,pan:l}}),{pan:{...e,pointerA:{...e.pointerA,currentScreenPosition:n},pointerB:{...e.pointerB,currentScreenPosition:r}},passthroughContext:null}}return{pan:e,passthroughContext:t};default:throw T(e)}case"up":case"cancel":switch(e.state){case"idle":return{pan:e,passthroughContext:t};case"oneFingerDown":return t.event.pointerId===e.pointerA.id?{pan:{state:"idle"},passthroughContext:t}:{pan:e,passthroughContext:t};case"bothFingersDown":return t.event.pointerId===e.pointerA.id||t.event.pointerId===e.pointerB.id?{pan:{state:"idle"},passthroughContext:null}:{pan:e,passthroughContext:t};default:throw T(e)}default:T(t.eventType)}}};function Jt(t){return null}function Te(){return function(e){return{getCanvasClassName:n=>"",getPreviewPosition:n=>null,Overlay:Jt,...e}}}function ze(t){const e={initialize:n=>({state:"idle",childState:n}),isIdle:n=>n.state==="idle",getState:n=>n.childState,onPointerEvent:(n,r,o)=>{switch(n.eventType){case"down":switch(r.state){case"idle":{const i=t.onDragStart(n,r.childState,o);return i?(n.event.preventDefault(),t.onTap?{state:"dragUnconfirmed",pointerId:n.event.pointerId,startPosition:g.fromEvent(n.event),childState:i,startArg:o}:{state:"dragConfirmed",pointerId:n.event.pointerId,childState:i,startArg:o}):r}case"dragUnconfirmed":case"dragConfirmed":return r;default:throw T(r)}case"move":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragMove(n,r.childState);return r.startPosition.distanceTo(g.fromEvent(n.event))>=Lt?{state:"dragConfirmed",pointerId:r.pointerId,childState:i,startArg:r.startArg}:Object.is(r.childState,i)?r:{...r,childState:i}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragMove(n,r.childState);return Object.is(r.childState,i)?r:{...r,childState:i}}default:throw T(r)}case"up":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;let i=t.onDragCancel(n,r.childState);return i=t.onTap?t.onTap(n,i,r.startArg):i,{state:"idle",childState:i}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragEnd(n,r.childState);return{state:"idle",childState:i}}default:throw T(r)}case"cancel":switch(r.state){case"idle":return r;case"dragUnconfirmed":case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragCancel(n,r.childState);return{state:"idle",childState:i}}default:throw T(r)}default:T(n.eventType)}},createOnPointerEvent:n=>(r,o,i)=>W(o,n,s=>e.onPointerEvent(r,s,i))};return e}const J=ze({onDragStart:({event:t,viewport:e})=>({state:"drawing",points:[e.eventSceneCoords(t)]}),onDragMove:({event:t,viewport:e},n)=>({state:"drawing",points:[...n.points,e.eventSceneCoords(t)]}),onDragEnd:({updateDocument:t,location:e},n)=>(t(r=>r.replaceShapeVersionPoints(r.getShapeVersionForKeyPoint(e.keyPointId).id,n.points)),{state:"idle"}),onDragCancel:(t,e)=>({state:"idle"})}),se=Te()({initialize:()=>({type:I.Draw,gesture:J.initialize({state:"idle"})}),isIdle:t=>J.isIdle(t.gesture),getDebugProperties:t=>{const e=J.getState(t.gesture);switch(e.state){case"idle":return{_:"idle"};case"drawing":return{_:"drawing",points:String(e.points.length)};default:T(e)}},getState:t=>J.getState(t.gesture),onPointerEvent:J.createOnPointerEvent("gesture")}),ke={interpolated:t=>({type:"interpolated",scenePosition:t}),keyPointId:t=>({type:"keyPointId",keyPointId:t}),toDebugString:t=>{switch(t.type){case"interpolated":return`interpolated(${t.scenePosition.toString(2)})`;case"keyPointId":return`keyPointId(${t.keyPointId})`;default:T(t)}}};function Ht({position:t,children:e,className:n,style:r,...o}){return P("div",{className:B("absolute top-0 left-0",n),style:{transform:`translate(${t.x}px, ${t.y}px)`,...r},...o,children:e})}function Xt({position:t,viewport:e,screenOffset:n=g.ZERO,...r}){return P(Ht,{position:e.sceneToScreen(t).add(n),...r})}const H=ze({onTap:({updateLocation:t},e,n)=>(n&&t(r=>r.with({keyPointId:n})),e),onDragStart:({updateLocation:t,viewport:e,event:n},r,o)=>o?(t(i=>i.with({keyPointId:o})),{state:"moving",keyPointId:o,delta:g.ZERO,startingPosition:e.eventSceneCoords(n)}):null,onDragMove:({viewport:t,event:e},n)=>({...n,delta:t.eventSceneCoords(e).sub(n.startingPosition)}),onDragEnd:({event:t,viewport:e,updateDocument:n},r)=>{const o=e.eventSceneCoords(t).sub(r.startingPosition);return n(i=>i.updateKeypoint(r.keyPointId,s=>({...s,position:s.position.add(o)}))),{state:"idle"}},onDragCancel:()=>({state:"idle"})}),Yt=new g(-12,-12),ae=Te()({initialize:()=>({type:I.KeyPoint,gesture:H.initialize({state:"idle"}),previewPosition:null}),isIdle:t=>!0,getDebugProperties:t=>{const e=H.getState(t.gesture);switch(e.state){case"idle":return{_:e.state};case"moving":return{_:e.state,keyPointId:e.keyPointId,delta:e.delta.toString(2)}}},getPreviewPosition:t=>H.isIdle(t.gesture)&&t.previewPosition?ke.interpolated(t.previewPosition):null,onPointerEvent:(t,e,n)=>({...e,previewPosition:t.viewport.eventSceneCoords(t.event),gesture:H.onPointerEvent(t,e.gesture,n)}),Overlay:({tool:t,document:e,viewport:n,location:r,onUpdateTool:o})=>{const i=H.getState(t.gesture);return P(Ue,{children:Array.from(e.data.keyPoints,(s,a)=>{const c=i.state==="moving"&&i.keyPointId===s.id?s.position.add(i.delta):s.position;return P(Xt,{position:c,screenOffset:Yt,viewport:n,className:B("flex h-6 w-6 cursor-move items-center justify-center rounded-full border border-stone-200 bg-white text-xs text-stone-400 shadow-md",s.id===r.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onPointerDown:l=>{o((d,u)=>ae.onPointerEvent({...d,event:l,eventType:"down"},u,s.id))},children:a+1},s.id)})})}}),le=ze({onDragStart:({event:t,location:e})=>({state:"active",initialPan:e.viewportState.pan,previousScreenPoint:g.fromEvent(t)}),onDragMove:({event:t,updateViewport:e},n)=>{const r=g.fromEvent(t);return e(({pan:o,zoom:i})=>({pan:o.add(n.previousScreenPoint.sub(r).scale(i)),zoom:i})),{...n,previousScreenPoint:r}},onDragEnd:()=>({state:"idle"}),onDragCancel:({updateViewport:t},e)=>(t(({zoom:n})=>({zoom:n,pan:e.initialPan})),{state:"idle"})}),de=Te()({initialize:()=>({type:ie.Pan,gesture:le.initialize({state:"idle"})}),getDebugProperties:t=>{const e=le.getState(t.gesture);switch(e.state){case"idle":return{_:e.state};case"active":return{_:e.state,initialPan:e.initialPan.toString(2),previousScreenPoint:e.previousScreenPoint.toString(0)}}},isIdle:t=>le.isIdle(t.gesture),getCanvasClassName:t=>de.isIdle(t)?"cursor-grab":"cursor-grabbing",gesture:le}),tt={[I.Draw]:se,[I.KeyPoint]:ae,[ie.Pan]:de};function _(t){return tt[t]}function nt(t){const e=_(t.type).getDebugProperties(t),n=pt(e).map(([r,o])=>r.startsWith("_")?o:`${r} = ${o}`).join(", ");return`${t.type}(${n})`}const L={initialize:t=>_(t).initialize(),initializeForKeyDown:({event:t})=>z(t,"d")?se.initialize():z(t,"k")?ae.initialize():null,isIdle:t=>_(t.type).isIdle(t),getCanvasClassName:t=>_(t.type).getCanvasClassName(t),getPreviewPosition:t=>_(t.type).getPreviewPosition(t),toDebugString:nt,onPointerEvent:(t,e)=>{switch(e.type){case I.Draw:return se.onPointerEvent(t,e);case I.KeyPoint:return ae.onPointerEvent(t,e);default:T(e)}}},X={initializeForKeyDown:({event:t})=>z(t," ")?de.initialize():null,toDebugString:nt,getCanvasClassName:t=>tt[t.type].getCanvasClassName(t),onPointerEvent:(t,e)=>{switch(e.type){case ie.Pan:return W(e,"gesture",n=>de.gesture.onPointerEvent(t,n))}},onKeyUp:({event:t},e)=>{switch(e.type){case ie.Pan:return et(t," ")?null:e}}},x={initialize:t=>({undoStates:[],redoStates:[],pendingOp:null,current:{...t,options:{}}}),beginOperation:t=>{const e=Math.random();return C(t.pendingOp==null,"pending op already in progress"),{undoStack:{...t,pendingOp:{txId:e,initialDoc:t.current.doc,initialOptions:t.current.options},current:{...t.current,options:{}}},txId:e}},updateOperation:(t,e,n)=>{var r;return C(((r=t.pendingOp)==null?void 0:r.txId)===e,"pending op mismatch"),{...t,current:{...t.current,doc:R(t.current.doc,n)}}},revertOperation:(t,e)=>{var n;return C(((n=t.pendingOp)==null?void 0:n.txId)===e,"Pending op mismatch"),{...t,pendingOp:null,current:{doc:t.pendingOp.initialDoc,location:t.current.location,options:t.pendingOp.initialOptions}}},commitOperation:(t,e,n={})=>{var i;C(((i=t.pendingOp)==null?void 0:i.txId)===e,"Pending op mismatch");const r=[{doc:t.pendingOp.initialDoc,location:t.current.location,options:t.pendingOp.initialOptions},...t.undoStates];for(;r.length>Ot;)r.pop();const o={...t.current,options:n};return n.lockstepLocation&&(o.location=R(o.location,n.lockstepLocation)),{...t,current:o,pendingOp:null,undoStates:r,redoStates:null}},updateDocument:(t,e,n)=>{let r;return{undoStack:t,txId:r}=x.beginOperation(t),t=x.updateOperation(t,r,e),x.commitOperation(t,r,n)},undo:t=>{var o;if(C(t.pendingOp==null,"Pending op in progress"),t.undoStates.length==0)return t;const[e,...n]=t.undoStates;if(!ve(e.location,t.current.location)&&!t.current.options.lockstepLocation)return{...t,current:{...t.current,location:e.location}};const r=[t.current,...(o=t.redoStates)!=null?o:[]];return{...t,current:e,undoStates:n,redoStates:r}},redo:t=>{if(C(t.pendingOp==null,"pending op in progress"),!t.redoStates||t.redoStates.length==0)return t;const[e,...n]=t.redoStates;if(!ve(e.location,t.current.location)&&!e.options.lockstepLocation)return{...t,current:{...t.current,location:e.location}};const r=[t.current,...t.undoStates];return{...t,current:e.options.lockstepLocation?{...e,location:R(t.current.location,e.options.lockstepLocation)}:e,undoStates:r,redoStates:n.length===0?null:n}},updateLocation:(t,e)=>({...t,current:{...t.current,location:R(t.current.location,e)}})},b={initialize:t=>({multiTouchPan:Be.initialize(),quickTool:null,selectedTool:L.initialize(t)}),toDebugString:t=>t.quickTool?X.toDebugString(t.quickTool):L.toDebugString(t.selectedTool),getCanvasClassName:t=>t.quickTool?X.getCanvasClassName(t.quickTool):L.getCanvasClassName(t.selectedTool),getPreviewPosition:t=>L.getPreviewPosition(t.selectedTool),updateSelectedTool:(t,e)=>W(t,"selectedTool",e),updateQuickTool:(t,e)=>W(t,"quickTool",e),requestSetSelectedTool:(t,e)=>t.quickTool||!L.isIdle(t.selectedTool)?t:{...t,selectedTool:L.initialize(e)},onKeyDown:(t,e)=>{if(L.isIdle(e.selectedTool)){if(!e.quickTool){const o=X.initializeForKeyDown(t);if(o)return{...e,quickTool:o}}const r=L.initializeForKeyDown(t);if(r&&!e.quickTool)return{...e,selectedTool:r};if(z(t.event,{key:"z",command:!0}))return t.updateUndoStack(o=>x.undo(o)),e;if(z(t.event,{key:"z",command:!0,shift:!0}))return t.updateUndoStack(o=>x.redo(o)),e}if(z(t.event,{key:"0",command:!0}))return t.updateViewport({pan:g.ZERO,zoom:1}),e;const n=r=>{var i;const o=(i=[...t.document.keyPoints][r])==null?void 0:i.id;o&&t.updateLocation(s=>s.with({keyPointId:o}))};return z(t.event,"1")&&n(0),z(t.event,"2")&&n(1),z(t.event,"3")&&n(2),z(t.event,"4")&&n(3),z(t.event,"5")&&n(4),z(t.event,"6")&&n(5),z(t.event,"7")&&n(6),z(t.event,"8")&&n(7),z(t.event,"9")&&n(8),e},onKeyUp:(t,e)=>{if(e.quickTool){const n=X.onKeyUp(t,e.quickTool);if(n!==e.quickTool)return{...e,quickTool:n}}return e},onPointerEvent:(t,e)=>{const{pan:n,passthroughContext:r}=Be.onPointerEvent(t,e.multiTouchPan);return n!==e.multiTouchPan&&(e={...e,multiTouchPan:n}),r?e.quickTool?b.updateQuickTool(e,o=>X.onPointerEvent(r,pe(o))):b.updateSelectedTool(e,o=>L.onPointerEvent(r,o)):e},Overlay:({interaction:t,onUpdateInteraction:e,...n})=>{const r=o=>e((i,s)=>b.updateSelectedTool(s,a=>(C(a.type===s.selectedTool.type),o(i,a))));switch(t.selectedTool.type){case I.Draw:return P(se.Overlay,{tool:t.selectedTool,onUpdateTool:r,...n});case I.KeyPoint:return P(ae.Overlay,{tool:t.selectedTool,onUpdateTool:r,...n});default:T(t.selectedTool)}}};function _t({selectedToolType:t,updateInteraction:e}){const n=r=>()=>e((o,i)=>b.requestSetSelectedTool(i,r));return j("div",{className:"pointer-events-none absolute top-0 bottom-0 flex cursor-wait flex-col items-center justify-center gap-3 p-3",children:[P(qe,{letter:"d",isSelected:t===I.Draw,onClick:n(I.Draw)}),P(qe,{letter:"k",isSelected:t===I.KeyPoint,onClick:n(I.KeyPoint)})]})}function qe({letter:t,onClick:e,isSelected:n}){return P("button",{className:B("pointer-events-auto flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 bg-white shadow-md",n?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:e,children:t})}class te{static distance(e,n){let r=0;for(let o=0;o<e.length;o++)r+=Math.pow(e[o]-n[o],2);return Math.sqrt(r)}static kernel(e,n){const r=te.distance(e,n);return r===0?0:Math.pow(r,2)*Math.log(r)}constructor(e,n){e.length===0&&Z("bad centers array :/"),e.every(l=>l.length===e[0].length)||Z("centers must have same dimensions :/"),this.centers=e;const r=n.slice(),o=[],i=[];for(let l=0;l<e.length;l++){const d=[],u=[1];for(let p=0;p<e[l].length;p++)u.push(e[l][p]);for(let p=0;p<e.length;p++)d.push(te.kernel(e[l],e[p]));i.push(u),o.push(d.concat(u))}const a=D.transpose(i).map(l=>{for(let d=l.length;d<o[0].length;d++)l.push(0);return l});for(let l=0;l<a.length;l++)o.push(a[l]),r.push(0);const c=this.solve(r,o);c||Z("rbf failed to compile with given centers./nCenters must be unique :/"),this.ws=c}solve(e,n){const r=D.inverse(n);return r?D.multiplyVector(r,e):null}getValue(e){C(this.ws);let n=0,r=0;for(r=0;r<this.centers.length;r++)n+=Number(this.ws[r])*te.kernel(e,this.centers[r]);for(n+=Number(this.ws[this.centers.length]),r=0;r<e.length;r++)n+=e[r]*Number(this.ws[this.centers.length+(r+1)]);return n}}const D={create(t){return t.map(e=>e.slice())},fromVector(t){return t.map(e=>[e])},identity(t){return M(t,e=>M(t,n=>e===n?1:0))},col(t,e){return t.map(n=>n[e-1])},clone(t){return t.slice()},canMultiplyFromLeft(t,e){return t[0].length===e.length},multiplyMatrix(t,e){if(!D.canMultiplyFromLeft(t,e))return null;const n=t[0].length;return M(t.length,r=>M(e[0].length,o=>{let i=0;for(let s=0;s<n;s++)i+=t[r][s]*e[s][o];return i}))},multiplyVector(t,e){return D.multiplyMatrix(t,D.fromVector(e))},transpose(t){return M(t[0].length,e=>M(t.length,n=>t[n][e]))},isSquare(t){return t.length===t[0].length},toRightTriangular(t){const e=D.clone(t),n=t.length,r=t[0].length;for(let o=0;o<n;o++){if(e[o][o]===0){for(let i=o+1;i<n;i++)if(e[i][o]!==0){const s=[];for(let a=0;a<r;a++)s.push(e[o][a]+e[i][a]);e[o]=s;break}}if(e[o][o]!==0)for(let i=o+1;i<n;i++){const s=e[i][o]/e[o][o],a=[];for(let c=0;c<r;c++)a.push(c<=o?0:e[i][c]-e[o][c]*s);e[i]=a}}return e},determinant(t){if(!D.isSquare(t))return null;const e=D.toRightTriangular(t);let n=e[0][0];for(let r=1;r<e.length;r++)n=n*e[r][r];return n},isSingular(t){return D.isSquare(t)&&D.determinant(t)===0},augment(t,e){const n=D.clone(t),r=n[0].length;C(n.length===e.length);for(let o=0;o<n.length;o++)for(let i=0;i<e[0].length;i++)n[o][r+i]=e[o][i];return n},inverse(t){if(!D.isSquare(t)||D.isSingular(t))return null;const e=t.length,n=[],r=D.toRightTriangular(D.augment(t,D.identity(e))),o=r[0].length;let i=t.length;for(;i--;){const s=[];n[i]=[];const a=r[i][i];for(let l=0;l<o;l++){const d=r[i][l]/a;s.push(d),l>=e&&n[i].push(d)}r[i]=s;let c=i;for(;c--;){const l=[];for(let d=0;d<o;d++)l.push(r[c][d]-r[i][d]*r[c][i]);r[c]=l}}return n}};class en{constructor(e){this.value=e}interpolate(e){return this.value}}class tn{constructor(e,n,r,o){this.centerA=e,this.centerB=n,this.valueA=r,this.valueB=o}interpolate(e){const n=this.centerB.sub(this.centerA),o=e.sub(this.centerA).dot(n)/n.dot(n);return $e(this.valueA,this.valueB,o)}}class nn extends te{constructor(e,n){super(e.map(({x:r,y:o})=>[r,o]),n)}interpolate(e){return this.getValue([e.x,e.y])}}class ge{constructor(e,n){switch(C(e.length===n.length),e.length){case 0:throw Z("must have at least one point to interpolate");case 1:this.interpolator=new en(n[0]);break;case 2:this.interpolator=new tn(e[0],e[1],n[0],n[1]);break;default:this.interpolator=new nn(e,n)}}interpolate(e){return this.interpolator.interpolate(e)}}class rn{constructor(){this.cachedVersions=new Set,this.cachedKeyPoints=new Set,this.tpsForEachPoint=null}getCenterPointsAtPosition(e,n){switch(n.type){case"keyPointId":{const r=e.getShapeVersionForKeyPoint(n.keyPointId);return e.data.normalizedShapeVersions.get(r.id).normalizedCenterPoints}case"interpolated":return this.getCenterPointsAtInterpolatedPosition(e,n.scenePosition);default:T(n)}}getCenterPointsAtInterpolatedPosition(e,n){const r=new Set(e.shapeVersions),o=new Set(e.keyPoints);return(!this.matchesCache(r,o)||!this.tpsForEachPoint)&&(this.tpsForEachPoint=this.calculateTpsForEachPoint(e,r),this.cachedVersions=r),this.tpsForEachPoint.map(({x:s,y:a,r:c})=>({center:new g(s.interpolate(n),a.interpolate(n)),radius:c.interpolate(n)}))}calculateTpsForEachPoint(e,n){console.time("calculateTpsForEachPoint");const r=Array.from(n,a=>({normalizedCenterPoints:e.data.normalizedShapeVersions.get(a.id).normalizedCenterPoints,version:a,keyPoint:e.keyPoints.get(a.keyPointId)})),o=r.map(({keyPoint:a})=>a.position),i=Math.min(...r.map(({normalizedCenterPoints:a})=>a.length)),s=[];for(let a=0;a<i;a++){const c=r.map(({normalizedCenterPoints:u})=>u[a].center.x),l=r.map(({normalizedCenterPoints:u})=>u[a].center.y),d=r.map(({normalizedCenterPoints:u})=>u[a].radius);s.push({x:new ge(o,c),y:new ge(o,l),r:new ge(o,d)})}return console.timeEnd("calculateTpsForEachPoint"),s}matchesCache(e,n){if(e.size!==this.cachedVersions.size||n.size!==this.cachedKeyPoints.size)return!1;for(const r of e)if(!this.cachedVersions.has(r))return!1;for(const r of n)if(!this.cachedKeyPoints.has(r))return!1;return!0}}const on=new rn;function sn(t){const e=[],n=[];if(t.length===0)return[];if(t.length===1){const u=[];for(let p=0;p<12;p++)u.push(t[0].center.add(g.fromPolar(p*Math.PI/6,t[0].radius)));return u}const r=t[0],i=t[1].center.sub(r.center).normalize(),s=i.perpendicular().scale(r.radius);e.push(r.center.sub(i.scale(r.radius))),e.push(r.center.sub(s)),n.push(r.center.add(s));for(let u=1;u<t.length-1;u++){const p=t[u-1],m=t[u],w=t[u+1].center.sub(p.center).normalize().perpendicular().scale(m.radius);e.push(m.center.sub(w)),n.push(m.center.add(w))}const a=t[t.length-2],c=t[t.length-1],l=c.center.sub(a.center).normalize(),d=l.perpendicular().scale(c.radius);return e.push(c.center.sub(d)),e.push(c.center.add(l.scale(c.radius))),n.push(c.center.add(d)),e.concat(n.reverse())}function an({centerPoints:t}){return P("path",{d:At(sn(t))})}function cn({document:t,previewPosition:e,interaction:n}){let r=null;switch(n.selectedTool.type){case I.Draw:{const o=se.getState(n.selectedTool);switch(o.state){case"drawing":r=Xe(Je(He(o.points,ee),ee),ee.size);break;case"idle":break;default:T(o)}break}case I.KeyPoint:break;default:T(n.selectedTool)}return r||(r=on.getCenterPointsAtPosition(t,e)),P(an,{centerPoints:r})}const O={initialize:t=>({undoStack:x.initialize(t),interaction:b.initialize(I.Draw)}),updateUndoStack:(t,e)=>W(t,"undoStack",e),updateLocation:(t,e)=>O.updateUndoStack(t,n=>x.updateLocation(n,e)),updateDocument:(t,e,n)=>O.updateUndoStack(t,r=>x.updateDocument(r,e,n)),updateViewport:(t,e)=>O.updateLocation(t,n=>n.with({viewport:R(n.viewportState,e)})),updateInteraction:(t,e)=>W(t,"interaction",e)};function ln(t){return(e,n)=>{const r=[];let o=!1;function i(a){C(!o),r.push(a)}const s=t();n({update:i,updateUndoStack:a=>i(c=>O.updateUndoStack(c,a)),updateLocation:a=>i(c=>O.updateLocation(c,a)),updateDocument:(a,c)=>i(l=>O.updateDocument(l,a,c)),updateViewport:a=>i(c=>O.updateViewport(c,a)),updateInteraction:a=>i(c=>O.updateInteraction(c,a)),document:e.undoStack.current.doc,location:e.undoStack.current.location,viewport:s.viewport});for(let a=0;a<r.length;a++)e=r[a](e);return o=!0,e}}function un(t,e){const n=_e(e),r=k.exports.useMemo(()=>ln(n),[n]),[o,i]=k.exports.useReducer(r,null,t),s=k.exports.useMemo(()=>{const c=d=>i(u=>u.updateInteraction(p=>d(u,p))),l=d=>u=>c((p,m)=>b.onPointerEvent({...p,event:u,eventType:d},m));return{updateUndoStack:d=>i(u=>u.updateUndoStack(p=>d(u,p))),updateLocation:d=>i(u=>u.updateLocation(p=>d(u,p))),updateDocument:(d,u)=>i(p=>p.updateDocument(m=>d(p,m),u)),updateViewport:d=>i(u=>u.updateViewport(p=>d(u,p))),updateInteraction:c,onPointerDown:l("down"),onPointerMove:l("move"),onPointerUp:l("up"),onPointerCancel:l("cancel"),onKeyDown:d=>c((u,p)=>b.onKeyDown({...u,event:d},p)),onKeyUp:d=>c((u,p)=>b.onKeyUp({...u,event:d},p))}},[]),a=o.undoStack.current.location.keyPointId;return{...s,document:o.undoStack.current.doc,location:o.undoStack.current.location,interaction:o.interaction,previewPosition:k.exports.useMemo(()=>{var c;return(c=b.getPreviewPosition(o.interaction))!=null?c:ke.keyPointId(a)},[a,o.interaction])}}function dn(t,e){const n=e.visibleSceneBounds(),r=je.fromLeftTopRightBottom(n.left+n.width/10,n.top+n.height/10,n.right-n.width/10,n.bottom-n.height/10),o=Array.from(t.keyPoints,c=>c.position),s=(Math.min(n.width,n.height)/10)**2;let a=r.getCenter();for(let c=0;c<500;c++){if(o.every(l=>l.distanceToSq(a)>s))return a;a=new g(Le(r.left,r.right),Le(r.top,r.bottom))}return a}function pn(){const[t,e]=k.exports.useState(null),n=Ct(t,It);return console.log(n),P("div",{ref:e,className:"absolute inset-0 touch-none",children:n&&P(hn,{size:n})})}function hn({size:t}){const{document:e,location:n,interaction:r,previewPosition:o,updateDocument:i,updateLocation:s,updateInteraction:a,onPointerDown:c,onPointerMove:l,onPointerUp:d,onPointerCancel:u,onKeyDown:p,onKeyUp:m}=un(()=>{{const f=Zt("autosave");if(f.isOk())return O.initialize(f.value);console.error(`Error loading autosave: ${f.error}`)}return O.initialize(Re())},()=>({viewport:h}));k.exports.useEffect(()=>{Qt("autosave",{doc:e,location:n})},[e,n]);const v=k.exports.useCallback(f=>s((E,S)=>S.with({viewport:R(S.viewportState,f)})),[s]),h=k.exports.useMemo(()=>new $t(n.viewportState,t,v),[n.viewportState,t,v]);k.exports.useEffect(()=>{const f=r.selectedTool.type;s((E,S)=>S.tool!==f?S.with({tool:f}):S)},[r.selectedTool.type,s]);const w=_e(f=>h.handleWheelEvent(f));return k.exports.useEffect(()=>(window.addEventListener("wheel",w,{passive:!1}),window.addEventListener("keydown",p),window.addEventListener("keyup",m),()=>{window.removeEventListener("wheel",w),window.removeEventListener("keydown",p),window.removeEventListener("keyup",m)}),[p,m,w]),j(Ue,{children:[j("div",{className:"pointer-events-none absolute top-0",children:[ke.toDebugString(o)," |"," ",b.toDebugString(r)]}),j("div",{className:"absolute inset-0",onPointerDown:c,onPointerMove:l,onPointerUp:d,onPointerCancel:u,children:[P("svg",{viewBox:`0 0 ${t.x} ${t.y}`,className:B("absolute top-0 left-0",b.getCanvasClassName(r)),children:P("g",{transform:h.getSceneTransform(),children:P(cn,{document:e,previewPosition:o,interaction:r})})}),P(b.Overlay,{interaction:r,viewport:h,document:e,location:n,onUpdateInteraction:a})]}),P(_t,{selectedToolType:r.selectedTool.type,updateInteraction:a}),j("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-center gap-3 p-3",children:[j("div",{className:"flex min-w-0 flex-auto items-center justify-center gap-3",children:[Array.from(e.keyPoints,(f,E)=>P("button",{className:B("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1",f.id===n.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:()=>{s((S,y)=>y.with({keyPointId:f.id}))},children:E+1},f.id)),P("button",{className:B("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const f=G.generate();i((E,S)=>S.addKeyPoint(f,dn(S,h)),{lockstepLocation:E=>E.with({keyPointId:f})})},children:"+"})]}),P("button",{className:B("absolute right-3 flex h-10 flex-none items-center justify-center justify-self-end rounded-full border border-stone-200 px-3 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const{doc:f,location:E}=Re();i(()=>f,{lockstepLocation:E})},children:"reset"})]})]})}const fn=pe(document.getElementById("root"));Ze(fn).render(P(pn,{}));
