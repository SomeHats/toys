function e(e){return e&&e.__esModule?e.default:e}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},r={},i=t.parcelRequire0561;null==i&&((i=function(e){if(e in n)return n[e].exports;if(e in r){var t=r[e];delete r[e];var i={id:e,exports:{}};return n[e]=i,t.call(i.exports,i,i.exports),i.exports}var o=new Error("Cannot find module '"+e+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(e,t){r[e]=t},t.parcelRequire0561=i);var o=i("bh6RR");function s(e,t){const n=[];for(let r=0;r<e;r++)n.push(t(r));return n}function a(e,t,n){return(t-e)*n+e}function u(e,t,n,r,i){return a(n,r,function(e,t,n){return(n-e)/(t-e)}(e,t,i))}function l(e,t){return"number"==typeof t?a(e,t,Math.random()):a(0,e,Math.random())}function h(e,t){return l(e-t,e+t)}function c(e){return e[Math.floor(l(e.length))]}function d(e,t,n){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),n))}function f(e,t=null){try{const n=window.localStorage.getItem(e);return n?JSON.parse(n):t}catch(e){return console.log(e),t}}function p(e,t){const n=JSON.stringify(t);try{window.localStorage.setItem(e,n)}catch(e){console.log(e)}}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function g(e,t){e||function(e){throw new Error(e)}(t||"Assertion Error")}class v{static fromPolar(e,t){return new v(t*Math.cos(e),t*Math.sin(e))}static average(e){return e.reduce(((e,t)=>e.add(t)),v.ZERO).div(e.length)}static fromVectorLike({x:e,y:t}){return new v(e,t)}toString(){return`Vector2(${this.x}, ${this.y})`}get magnitudeSquared(){return this.x*this.x+this.y*this.y}get magnitude(){return Math.sqrt(this.magnitudeSquared)}get angle(){return Math.atan2(this.y,this.x)}isInPolygon(e){const{x:t,y:n}=this;let r=!1;for(let i=0,o=e.length-1;i<e.length;o=i++){const{x:s,y:a}=e[i],{x:u,y:l}=e[o];a>n!=l>n&&t<(u-s)*(n-a)/(l-a)+s&&(r=!r)}return r}equals(e){return this===e||this.x===e.x&&this.y===e.y}distanceTo({x:e,y:t}){const n=e-this.x,r=t-this.y;return Math.sqrt(n*n+r*r)}angleTo(e){return e.sub(this).angle}angleBetween(e){return t=Math.atan2(e.y,e.x)-Math.atan2(this.y,this.x),function(e,t,n){const r=t-e;for(n-=e;n<0;)n+=r;return e+n%r}(-Math.PI,Math.PI,t);var t}dot(e){return this.x*e.x+this.y*e.y}div(e){return new v(this.x/e,this.y/e)}scale(e){return new v(this.x*e,this.y*e)}negate(){return this.scale(-1)}add({x:e,y:t}){return new v(this.x+e,this.y+t)}sub({x:e,y:t}){return new v(this.x-e,this.y-t)}floor(){return new v(Math.floor(this.x),Math.floor(this.y))}ceil(){return new v(Math.ceil(this.x),Math.ceil(this.y))}round(){return new v(Math.round(this.x),Math.round(this.y))}withMagnitude(e){return v.fromPolar(this.angle,e)}normalize(){return this.withMagnitude(1)}withAngle(e){return v.fromPolar(e,this.magnitude)}rotate(e){return this.withAngle(this.angle+e)}lerp(e,t){return new v(a(this.x,e.x,t),a(this.y,e.y,t))}constructor(e,t){this.x=e,this.y=t}}v.ZERO=new v(0,0);const b=new v(5,0),y=.75*Math.PI;class E{clear(e){e?(this.applyFillOptions({fill:e}),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)):this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}beginPath(){this.ctx.beginPath()}moveTo({x:e,y:t}){this.ctx.moveTo(e,t)}lineTo({x:e,y:t}){this.ctx.lineTo(e,t)}arc({x:e,y:t},n,r,i,o){this.ctx.arc(e,t,n,r,i,o)}arcTo(e,t,n){this.ctx.arcTo(e.x,e.y,t.x,t.y,n)}applyStrokeOptions({strokeWidth:e=1,stroke:t,strokeCap:n="butt",strokeDash:r=[],strokeDashOffset:i=0,strokeJoin:o="round"}){t&&(this.ctx.lineWidth=e,this.ctx.strokeStyle=t,this.ctx.lineCap=n,this.ctx.setLineDash(r),this.ctx.lineDashOffset=i,this.ctx.lineJoin=o)}stroke(e){e.stroke&&(this.applyStrokeOptions(e),this.ctx.stroke())}applyFillOptions({fill:e}){e&&(this.ctx.fillStyle=e)}fill(e){e.fill&&(this.applyFillOptions(e),this.ctx.fill())}applyStrokeAndFillOptions(e){this.applyFillOptions(e),this.applyStrokeOptions(e)}strokeAndFill(e){this.fill(e),this.stroke(e)}getDebugStrokeOptions(e="magenta"){return{stroke:e,strokeWidth:.5}}debugStroke(e="magenta"){this.stroke(this.getDebugStrokeOptions(e))}fillText(e,t,n={}){this.applyFillOptions(n),this.ctx.fillText(e,t.x,t.y)}circle(e,t,n){this.beginPath(),this.arc(e,t,0,2*Math.PI),this.strokeAndFill(n)}ellipse(e,t,n,r){this.beginPath(),this.ctx.ellipse(e.x,e.y,t,n,0,0,2*Math.PI),this.strokeAndFill(r)}debugLabel(e,t,n){e&&(this.applyFillOptions({fill:n}),this.fillText(e,t.add(b)))}debugPointX(e,{color:t="magenta",label:n}={}){this.debugLabel(n,e,t),this.beginPath(),this.ctx.moveTo(e.x-3,e.y-3),this.ctx.lineTo(e.x+3,e.y+3),this.ctx.moveTo(e.x+3,e.y-3),this.ctx.lineTo(e.x-3,e.y+3),this.stroke({strokeWidth:.5,stroke:t})}debugPointO(e,{color:t="magenta",label:n}={}){this.debugLabel(n,e,t),this.circle(e,3,{strokeWidth:.5,stroke:t})}debugArrow(e,t,{color:n="magenta",label:r}={}){this.debugLabel(r,v.average([e,t]),n),this.ctx.beginPath(),this.moveTo(e),this.lineTo(t);const i=t.sub(e),o=i.rotate(-y).withMagnitude(5).add(t),s=i.rotate(+y).withMagnitude(5).add(t);this.moveTo(o),this.lineTo(t),this.lineTo(s),this.stroke({strokeWidth:.5,stroke:n})}debugVectorAtPoint(e,t,n){this.debugArrow(t,t.add(e),n)}polygon(e,t={}){this.beginPath(),this.moveTo(e[e.length-1]);for(const t of e)this.lineTo(t);this.strokeAndFill(t)}polyLine(e,t={}){this.beginPath(),this.moveTo(e[0]);for(let t=1;t<e.length;t++)this.lineTo(e[t]);this.stroke(t)}debugPolygon(e,{color:t="magenta",label:n}={}){this.debugLabel(n,e[0],t),this.polygon(e,this.getDebugStrokeOptions(t))}debugPolyLine(e,{color:t="magenta",label:n}={}){this.debugLabel(n,e[0],t),this.polyLine(e,this.getDebugStrokeOptions(t))}aabb(e,t){t.debug&&this.debugLabel(t.debug.label,e.origin,t.debug.color||"magenta"),this.ctx.beginPath(),this.ctx.rect(e.left,e.top,e.width,e.height),this.strokeAndFill(t)}constructor(e){this.ctx=e}}o=i("bh6RR");var _={};!function(){var e={}.hasOwnProperty;function t(){for(var n=[],r=0;r<arguments.length;r++){var i=arguments[r];if(i){var o=typeof i;if("string"===o||"number"===o)n.push(i);else if(Array.isArray(i)){if(i.length){var s=t.apply(null,i);s&&n.push(s)}}else if("object"===o)if(i.toString===Object.prototype.toString)for(var a in i)e.call(i,a)&&i[a]&&n.push(a);else n.push(i.toString())}}return n.join(" ")}_?(t.default=t,_=t):"function"==typeof define&&"object"==typeof define.amd&&define.amd?define("classnames",[],(function(){return t})):window.classNames=t}();const S=o.memo((({offset:t,isAccidental:n,styles:r,isNoteDown:i,note:s,setRefForKey:a})=>{const u=n?{left:t-r.accidentalWidth/2,width:r.accidentalWidth,height:r.accidentalHeight,position:"absolute",zIndex:1,borderWidth:1.5*r.scale}:{left:t,width:r.standardWidth,height:r.standardHeight,position:"absolute",borderWidth:1.5*r.scale};return o.createElement("div",{ref:e=>a(e,s),style:u,className:e(_)("border-gray-600",{"bg-black hover:bg-blue-900":n,"bg-white hover:bg-blue-200":!n,"bg-purple-800":n&&i,"bg-purple-300":!n&&i})})}));function M({lowestNote:e,highestNote:t,scale:n,top:r,left:i,notesDown:a,setRefForKey:u}){const l=o.useMemo((()=>{const r=45*n,i=.6*r;return{standardWidth:r,accidentalWidth:i,standardHeight:6*r,accidentalHeight:6*i,scale:n,totalWidth:7/12*(t-e)*r}}),[e,t,n]),h=l.totalWidth+16*n,c=l.standardHeight+16*n;let d=0;return o.createElement("div",{className:"absolute border-gray-600 bg-gray-600",style:{width:h,height:c,borderWidth:8*n,borderRadius:8*n,top:r-c/2,left:i-h/2}},s(t-e,(t=>{const n=e+t,r=function(e){const t=e%12;return 1===t||3===t||6===t||8===t||10===t}(n),i=o.createElement(S,{key:n,note:n,offset:d,isAccidental:r,styles:l,isNoteDown:a.includes(n),setRefForKey:u});return d+=r?0:l.standardWidth,i})))}var w=o.memo(M),I=(o=i("bh6RR"),i("6afFj")),T={};!function(e){function t(){if(t.prototype._singleton)throw new Error("WebMidi is a singleton, it cannot be instantiated directly.");(t.prototype._singleton=this)._inputs=[],this._outputs=[],this._userHandlers={},this._stateChangeQueue=[],this._processingStateChange=!1,this._midiInterfaceEvents=["connected","disconnected"],this._nrpnBuffer=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this._nrpnEventsEnabled=!0,this._nrpnTypes=["entry","increment","decrement"],this._notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this._semitones={C:0,D:2,E:4,F:5,G:7,A:9,B:11},Object.defineProperties(this,{MIDI_SYSTEM_MESSAGES:{value:{sysex:240,timecode:241,songposition:242,songselect:243,tuningrequest:246,sysexend:247,clock:248,start:250,continue:251,stop:252,activesensing:254,reset:255,midimessage:0,unknownsystemmessage:-1},writable:!1,enumerable:!0,configurable:!1},MIDI_CHANNEL_MESSAGES:{value:{noteoff:8,noteon:9,keyaftertouch:10,controlchange:11,channelmode:11,nrpn:11,programchange:12,channelaftertouch:13,pitchbend:14},writable:!1,enumerable:!0,configurable:!1},MIDI_REGISTERED_PARAMETER:{value:{pitchbendrange:[0,0],channelfinetuning:[0,1],channelcoarsetuning:[0,2],tuningprogram:[0,3],tuningbank:[0,4],modulationrange:[0,5],azimuthangle:[61,0],elevationangle:[61,1],gain:[61,2],distanceratio:[61,3],maximumdistance:[61,4],maximumdistancegain:[61,5],referencedistanceratio:[61,6],panspreadangle:[61,7],rollangle:[61,8]},writable:!1,enumerable:!0,configurable:!1},MIDI_CONTROL_CHANGE_MESSAGES:{value:{bankselectcoarse:0,modulationwheelcoarse:1,breathcontrollercoarse:2,footcontrollercoarse:4,portamentotimecoarse:5,dataentrycoarse:6,volumecoarse:7,balancecoarse:8,pancoarse:10,expressioncoarse:11,effectcontrol1coarse:12,effectcontrol2coarse:13,generalpurposeslider1:16,generalpurposeslider2:17,generalpurposeslider3:18,generalpurposeslider4:19,bankselectfine:32,modulationwheelfine:33,breathcontrollerfine:34,footcontrollerfine:36,portamentotimefine:37,dataentryfine:38,volumefine:39,balancefine:40,panfine:42,expressionfine:43,effectcontrol1fine:44,effectcontrol2fine:45,holdpedal:64,portamento:65,sustenutopedal:66,softpedal:67,legatopedal:68,hold2pedal:69,soundvariation:70,resonance:71,soundreleasetime:72,soundattacktime:73,brightness:74,soundcontrol6:75,soundcontrol7:76,soundcontrol8:77,soundcontrol9:78,soundcontrol10:79,generalpurposebutton1:80,generalpurposebutton2:81,generalpurposebutton3:82,generalpurposebutton4:83,reverblevel:91,tremololevel:92,choruslevel:93,celestelevel:94,phaserlevel:95,databuttonincrement:96,databuttondecrement:97,nonregisteredparametercoarse:98,nonregisteredparameterfine:99,registeredparametercoarse:100,registeredparameterfine:101},writable:!1,enumerable:!0,configurable:!1},MIDI_NRPN_MESSAGES:{value:{entrymsb:6,entrylsb:38,increment:96,decrement:97,paramlsb:98,parammsb:99,nullactiveparameter:127},writable:!1,enumerable:!0,configurable:!1},MIDI_CHANNEL_MODE_MESSAGES:{value:{allsoundoff:120,resetallcontrollers:121,localcontrol:122,allnotesoff:123,omnimodeoff:124,omnimodeon:125,monomodeon:126,polymodeon:127},writable:!1,enumerable:!0,configurable:!1},octaveOffset:{value:0,writable:!0,enumerable:!0,configurable:!1}}),Object.defineProperties(this,{supported:{enumerable:!0,get:function(){return"requestMIDIAccess"in navigator}},enabled:{enumerable:!0,get:function(){return void 0!==this.interface}.bind(this)},inputs:{enumerable:!0,get:function(){return this._inputs}.bind(this)},outputs:{enumerable:!0,get:function(){return this._outputs}.bind(this)},sysexEnabled:{enumerable:!0,get:function(){return!(!this.interface||!this.interface.sysexEnabled)}.bind(this)},nrpnEventsEnabled:{enumerable:!0,get:function(){return!!this._nrpnEventsEnabled}.bind(this),set:function(e){return this._nrpnEventsEnabled=e,this._nrpnEventsEnabled}},nrpnTypes:{enumerable:!0,get:function(){return this._nrpnTypes}.bind(this)},time:{enumerable:!0,get:function(){return performance.now()}}})}var n=new t;function r(e){var t=this;this._userHandlers={channel:{},system:{}},this._midiInput=e,Object.defineProperties(this,{connection:{enumerable:!0,get:function(){return t._midiInput.connection}},id:{enumerable:!0,get:function(){return t._midiInput.id}},manufacturer:{enumerable:!0,get:function(){return t._midiInput.manufacturer}},name:{enumerable:!0,get:function(){return t._midiInput.name}},state:{enumerable:!0,get:function(){return t._midiInput.state}},type:{enumerable:!0,get:function(){return t._midiInput.type}}}),this._initializeUserHandlers(),this._midiInput.onmidimessage=this._onMidiMessage.bind(this)}function i(e){var t=this;this._midiOutput=e,Object.defineProperties(this,{connection:{enumerable:!0,get:function(){return t._midiOutput.connection}},id:{enumerable:!0,get:function(){return t._midiOutput.id}},manufacturer:{enumerable:!0,get:function(){return t._midiOutput.manufacturer}},name:{enumerable:!0,get:function(){return t._midiOutput.name}},state:{enumerable:!0,get:function(){return t._midiOutput.state}},type:{enumerable:!0,get:function(){return t._midiOutput.type}}})}t.prototype.enable=function(e,t){this.enabled||(this.supported?navigator.requestMIDIAccess({sysex:t}).then(function(t){var n,r=[],i=[];this.interface=t,this._resetInterfaceUserHandlers(),this.interface.onstatechange=function(e){r.push(e)};for(var o=t.inputs.values(),s=o.next();s&&!s.done;s=o.next())i.push(s.value.open());for(var a=t.outputs.values(),u=a.next();u&&!u.done;u=a.next())i.push(u.value.open());function l(){clearTimeout(n),this._updateInputsAndOutputs(),this.interface.onstatechange=this._onInterfaceStateChange.bind(this),"function"==typeof e&&e.call(this),r.forEach(function(e){this._onInterfaceStateChange(e)}.bind(this))}n=setTimeout(l.bind(this),200),Promise&&Promise.all(i).catch((function(e){})).then(l.bind(this))}.bind(this),function(t){"function"==typeof e&&e.call(this,t)}.bind(this)):"function"==typeof e&&e(new Error("The Web MIDI API is not supported by your browser.")))},t.prototype.disable=function(){if(!this.supported)throw new Error("The Web MIDI API is not supported by your browser.");this.enabled&&(this.removeListener(),this.inputs.forEach((function(e){e.removeListener()}))),this.interface&&(this.interface.onstatechange=void 0),this.interface=void 0,this._inputs=[],this._outputs=[],this._nrpnEventsEnabled=!0,this._resetInterfaceUserHandlers()},t.prototype.addListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before adding event listeners.");if("function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(!(0<=this._midiInterfaceEvents.indexOf(e)))throw new TypeError("The specified event type is not supported.");return this._userHandlers[e].push(t),this},t.prototype.hasListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before checking event listeners.");if("function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(!(0<=this._midiInterfaceEvents.indexOf(e)))throw new TypeError("The specified event type is not supported.");for(var n=0;n<this._userHandlers[e].length;n++)if(this._userHandlers[e][n]===t)return!0;return!1},t.prototype.removeListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before removing event listeners.");if(void 0!==t&&"function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(0<=this._midiInterfaceEvents.indexOf(e))if(t)for(var n=0;n<this._userHandlers[e].length;n++)this._userHandlers[e][n]===t&&this._userHandlers[e].splice(n,1);else this._userHandlers[e]=[];else{if(void 0!==e)throw new TypeError("The specified event type is not supported.");this._resetInterfaceUserHandlers()}return this},t.prototype.toMIDIChannels=function(e){var t;if("all"===e||void 0===e)t=["all"];else{if("none"===e)return[];t=Array.isArray(e)?e:[e]}return-1<t.indexOf("all")&&(t=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),t.map((function(e){return parseInt(e)})).filter((function(e){return 1<=e&&e<=16}))},t.prototype.getInputById=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");e=String(e);for(var t=0;t<this.inputs.length;t++)if(this.inputs[t].id===e)return this.inputs[t];return!1},t.prototype.getOutputById=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");e=String(e);for(var t=0;t<this.outputs.length;t++)if(this.outputs[t].id===e)return this.outputs[t];return!1},t.prototype.getInputByName=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");for(var t=0;t<this.inputs.length;t++)if(~this.inputs[t].name.indexOf(e))return this.inputs[t];return!1},t.prototype.getOctave=function(e){if(null!=e&&0<=e&&e<=127)return Math.floor(Math.floor(e)/12-1)+Math.floor(n.octaveOffset)},t.prototype.getOutputByName=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");for(var t=0;t<this.outputs.length;t++)if(~this.outputs[t].name.indexOf(e))return this.outputs[t];return!1},t.prototype.guessNoteNumber=function(e){var t=!1;if(e&&e.toFixed&&0<=e&&e<=127?t=Math.round(e):0<=parseInt(e)&&parseInt(e)<=127?t=parseInt(e):("string"==typeof e||e instanceof String)&&(t=this.noteNameToNumber(e)),!1===t)throw new Error("Invalid input value ("+e+").");return t},t.prototype.noteNameToNumber=function(e){"string"!=typeof e&&(e="");var t=e.match(/([CDEFGAB])(#{0,2}|b{0,2})(-?\d+)/i);if(!t)throw new RangeError("Invalid note name.");var r=n._semitones[t[1].toUpperCase()],i=12*(parseInt(t[3])+1-Math.floor(n.octaveOffset))+r;if(-1<t[2].toLowerCase().indexOf("b")?i-=t[2].length:-1<t[2].toLowerCase().indexOf("#")&&(i+=t[2].length),i<0||127<i)throw new RangeError("Invalid note name or note outside valid range.");return i},t.prototype._updateInputsAndOutputs=function(){this._updateInputs(),this._updateOutputs()},t.prototype._updateInputs=function(){for(var e=0;e<this._inputs.length;e++){for(var t=!0,n=this.interface.inputs.values(),i=n.next();i&&!i.done;i=n.next())if(this._inputs[e]._midiInput===i.value){t=!1;break}t&&this._inputs.splice(e,1)}this.interface&&this.interface.inputs.forEach(function(e){for(var t=!0,n=0;n<this._inputs.length;n++)this._inputs[n]._midiInput===e&&(t=!1);t&&this._inputs.push(new r(e))}.bind(this))},t.prototype._updateOutputs=function(){for(var e=0;e<this._outputs.length;e++){for(var t=!0,n=this.interface.outputs.values(),r=n.next();r&&!r.done;r=n.next())if(this._outputs[e]._midiOutput===r.value){t=!1;break}t&&this._outputs.splice(e,1)}this.interface&&this.interface.outputs.forEach(function(e){for(var t=!0,n=0;n<this._outputs.length;n++)this._outputs[n]._midiOutput===e&&(t=!1);t&&this._outputs.push(new i(e))}.bind(this))},t.prototype._onInterfaceStateChange=function(e){this._updateInputsAndOutputs();var t={timestamp:e.timeStamp,type:e.port.state};this.interface&&"connected"===e.port.state?"output"===e.port.type?t.port=this.getOutputById(e.port.id):"input"===e.port.type&&(t.port=this.getInputById(e.port.id)):t.port={connection:"closed",id:e.port.id,manufacturer:e.port.manufacturer,name:e.port.name,state:e.port.state,type:e.port.type},this._userHandlers[e.port.state].forEach((function(e){e(t)}))},t.prototype._resetInterfaceUserHandlers=function(){for(var e=0;e<this._midiInterfaceEvents.length;e++)this._userHandlers[this._midiInterfaceEvents[e]]=[]},r.prototype.on=r.prototype.addListener=function(e,t,r){var i=this;if(void 0===t&&(t="all"),Array.isArray(t)||(t=[t]),t.forEach((function(e){if("all"!==e&&!(1<=e&&e<=16))throw new RangeError("The 'channel' parameter is invalid.")})),"function"!=typeof r)throw new TypeError("The 'listener' parameter must be a function.");if(void 0!==n.MIDI_SYSTEM_MESSAGES[e])this._userHandlers.system[e]||(this._userHandlers.system[e]=[]),this._userHandlers.system[e].push(r);else{if(void 0===n.MIDI_CHANNEL_MESSAGES[e])throw new TypeError("The specified event type is not supported.");if(-1<t.indexOf("all")){t=[];for(var o=1;o<=16;o++)t.push(o)}this._userHandlers.channel[e]||(this._userHandlers.channel[e]=[]),t.forEach((function(t){i._userHandlers.channel[e][t]||(i._userHandlers.channel[e][t]=[]),i._userHandlers.channel[e][t].push(r)}))}return this},r.prototype.hasListener=function(e,t,r){var i=this;if("function"!=typeof r)throw new TypeError("The 'listener' parameter must be a function.");if(void 0===t&&(t="all"),t.constructor!==Array&&(t=[t]),void 0!==n.MIDI_SYSTEM_MESSAGES[e]){for(var o=0;o<this._userHandlers.system[e].length;o++)if(this._userHandlers.system[e][o]===r)return!0}else if(void 0!==n.MIDI_CHANNEL_MESSAGES[e]){if(-1<t.indexOf("all")){t=[];for(var s=1;s<=16;s++)t.push(s)}return!!this._userHandlers.channel[e]&&t.every((function(t){var n=i._userHandlers.channel[e][t];return n&&-1<n.indexOf(r)}))}return!1},r.prototype.removeListener=function(e,t,r){var i=this;if(void 0!==r&&"function"!=typeof r)throw new TypeError("The 'listener' parameter must be a function.");if(void 0===t&&(t="all"),t.constructor!==Array&&(t=[t]),void 0!==n.MIDI_SYSTEM_MESSAGES[e])if(void 0===r)this._userHandlers.system[e]=[];else for(var o=0;o<this._userHandlers.system[e].length;o++)this._userHandlers.system[e][o]===r&&this._userHandlers.system[e].splice(o,1);else if(void 0!==n.MIDI_CHANNEL_MESSAGES[e]){if(-1<t.indexOf("all")){t=[];for(var s=1;s<=16;s++)t.push(s)}if(!this._userHandlers.channel[e])return this;t.forEach((function(t){var n=i._userHandlers.channel[e][t];if(n)if(void 0===r)i._userHandlers.channel[e][t]=[];else for(var o=0;o<n.length;o++)n[o]===r&&n.splice(o,1)}))}else{if(void 0!==e)throw new TypeError("The specified event type is not supported.");this._initializeUserHandlers()}return this},r.prototype._initializeUserHandlers=function(){for(var e in n.MIDI_CHANNEL_MESSAGES)Object.prototype.hasOwnProperty.call(n.MIDI_CHANNEL_MESSAGES,e)&&(this._userHandlers.channel[e]={});for(var t in n.MIDI_SYSTEM_MESSAGES)Object.prototype.hasOwnProperty.call(n.MIDI_SYSTEM_MESSAGES,t)&&(this._userHandlers.system[t]=[])},r.prototype._onMidiMessage=function(e){if(0<this._userHandlers.system.midimessage.length){var t={target:this,data:e.data,timestamp:e.timeStamp,type:"midimessage"};this._userHandlers.system.midimessage.forEach((function(e){e(t)}))}e.data[0]<240?(this._parseChannelEvent(e),this._parseNrpnEvent(e)):e.data[0]<=255&&this._parseSystemEvent(e)},r.prototype._parseNrpnEvent=function(e){var t,r,i=e.data[0]>>4,o=15&e.data[0],s=1+o;if(1<e.data.length&&(t=e.data[1],r=2<e.data.length?e.data[2]:void 0),n.nrpnEventsEnabled&&i===n.MIDI_CHANNEL_MESSAGES.controlchange&&(t>=n.MIDI_NRPN_MESSAGES.increment&&t<=n.MIDI_NRPN_MESSAGES.parammsb||t===n.MIDI_NRPN_MESSAGES.entrymsb||t===n.MIDI_NRPN_MESSAGES.entrylsb)){var a={target:this,type:"controlchange",data:e.data,timestamp:e.timeStamp,channel:s,controller:{number:t,name:this.getCcNameByNumber(t)},value:r};if(a.controller.number===n.MIDI_NRPN_MESSAGES.parammsb&&a.value!=n.MIDI_NRPN_MESSAGES.nullactiveparameter)n._nrpnBuffer[o]=[],n._nrpnBuffer[o][0]=a;else if(1===n._nrpnBuffer[o].length&&a.controller.number===n.MIDI_NRPN_MESSAGES.paramlsb)n._nrpnBuffer[o].push(a);else if(2!==n._nrpnBuffer[o].length||a.controller.number!==n.MIDI_NRPN_MESSAGES.increment&&a.controller.number!==n.MIDI_NRPN_MESSAGES.decrement&&a.controller.number!==n.MIDI_NRPN_MESSAGES.entrymsb)if(3===n._nrpnBuffer[o].length&&n._nrpnBuffer[o][2].number===n.MIDI_NRPN_MESSAGES.entrymsb&&a.controller.number===n.MIDI_NRPN_MESSAGES.entrylsb)n._nrpnBuffer[o].push(a);else if(3<=n._nrpnBuffer[o].length&&n._nrpnBuffer[o].length<=4&&a.controller.number===n.MIDI_NRPN_MESSAGES.parammsb&&a.value===n.MIDI_NRPN_MESSAGES.nullactiveparameter)n._nrpnBuffer[o].push(a);else if(4<=n._nrpnBuffer[o].length&&n._nrpnBuffer[o].length<=5&&a.controller.number===n.MIDI_NRPN_MESSAGES.paramlsb&&a.value===n.MIDI_NRPN_MESSAGES.nullactiveparameter){n._nrpnBuffer[o].push(a);var u=[];n._nrpnBuffer[o].forEach((function(e){u.push(e.data)}));var l=n._nrpnBuffer[o][0].value<<7|n._nrpnBuffer[o][1].value,h=n._nrpnBuffer[o][2].value;6===n._nrpnBuffer[o].length&&(h=n._nrpnBuffer[o][2].value<<7|n._nrpnBuffer[o][3].value);var c="";switch(n._nrpnBuffer[o][2].controller.number){case n.MIDI_NRPN_MESSAGES.entrymsb:c=n._nrpnTypes[0];break;case n.MIDI_NRPN_MESSAGES.increment:c=n._nrpnTypes[1];break;case n.MIDI_NRPN_MESSAGES.decrement:c=n._nrpnTypes[2];break;default:throw new Error("The NPRN type was unidentifiable.")}var d={timestamp:a.timestamp,channel:a.channel,type:"nrpn",data:u,controller:{number:l,type:c,name:"Non-Registered Parameter "+l},value:h};n._nrpnBuffer[o]=[],this._userHandlers.channel[d.type]&&this._userHandlers.channel[d.type][d.channel]&&this._userHandlers.channel[d.type][d.channel].forEach((function(e){e(d)}))}else n._nrpnBuffer[o]=[];else n._nrpnBuffer[o].push(a)}},r.prototype._parseChannelEvent=function(e){var t,r,i=e.data[0]>>4,o=1+(15&e.data[0]);1<e.data.length&&(t=e.data[1],r=2<e.data.length?e.data[2]:void 0);var s={target:this,data:e.data,timestamp:e.timeStamp,channel:o};i===n.MIDI_CHANNEL_MESSAGES.noteoff||i===n.MIDI_CHANNEL_MESSAGES.noteon&&0===r?(s.type="noteoff",s.note={number:t,name:n._notes[t%12],octave:n.getOctave(t)},s.velocity=r/127,s.rawVelocity=r):i===n.MIDI_CHANNEL_MESSAGES.noteon?(s.type="noteon",s.note={number:t,name:n._notes[t%12],octave:n.getOctave(t)},s.velocity=r/127,s.rawVelocity=r):i===n.MIDI_CHANNEL_MESSAGES.keyaftertouch?(s.type="keyaftertouch",s.note={number:t,name:n._notes[t%12],octave:n.getOctave(t)},s.value=r/127):i===n.MIDI_CHANNEL_MESSAGES.controlchange&&0<=t&&t<=119?(s.type="controlchange",s.controller={number:t,name:this.getCcNameByNumber(t)},s.value=r):i===n.MIDI_CHANNEL_MESSAGES.channelmode&&120<=t&&t<=127?(s.type="channelmode",s.controller={number:t,name:this.getChannelModeByNumber(t)},s.value=r):i===n.MIDI_CHANNEL_MESSAGES.programchange?(s.type="programchange",s.value=t):i===n.MIDI_CHANNEL_MESSAGES.channelaftertouch?(s.type="channelaftertouch",s.value=t/127):i===n.MIDI_CHANNEL_MESSAGES.pitchbend?(s.type="pitchbend",s.value=((r<<7)+t-8192)/8192):s.type="unknownchannelmessage",this._userHandlers.channel[s.type]&&this._userHandlers.channel[s.type][o]&&this._userHandlers.channel[s.type][o].forEach((function(e){e(s)}))},r.prototype.getCcNameByNumber=function(e){if(!(0<=(e=Math.floor(e))&&e<=119))throw new RangeError("The control change number must be between 0 and 119.");for(var t in n.MIDI_CONTROL_CHANGE_MESSAGES)if(Object.prototype.hasOwnProperty.call(n.MIDI_CONTROL_CHANGE_MESSAGES,t)&&e===n.MIDI_CONTROL_CHANGE_MESSAGES[t])return t},r.prototype.getChannelModeByNumber=function(e){if(!(120<=(e=Math.floor(e))&&status<=127))throw new RangeError("The control change number must be between 120 and 127.");for(var t in n.MIDI_CHANNEL_MODE_MESSAGES)if(Object.prototype.hasOwnProperty.call(n.MIDI_CHANNEL_MODE_MESSAGES,t)&&e===n.MIDI_CHANNEL_MODE_MESSAGES[t])return t},r.prototype._parseSystemEvent=function(e){var t=e.data[0],r={target:this,data:e.data,timestamp:e.timeStamp};t===n.MIDI_SYSTEM_MESSAGES.sysex?r.type="sysex":t===n.MIDI_SYSTEM_MESSAGES.timecode?r.type="timecode":t===n.MIDI_SYSTEM_MESSAGES.songposition?r.type="songposition":t===n.MIDI_SYSTEM_MESSAGES.songselect?(r.type="songselect",r.song=e.data[1]):t===n.MIDI_SYSTEM_MESSAGES.tuningrequest?r.type="tuningrequest":t===n.MIDI_SYSTEM_MESSAGES.clock?r.type="clock":t===n.MIDI_SYSTEM_MESSAGES.start?r.type="start":t===n.MIDI_SYSTEM_MESSAGES.continue?r.type="continue":t===n.MIDI_SYSTEM_MESSAGES.stop?r.type="stop":t===n.MIDI_SYSTEM_MESSAGES.activesensing?r.type="activesensing":t===n.MIDI_SYSTEM_MESSAGES.reset?r.type="reset":r.type="unknownsystemmessage",this._userHandlers.system[r.type]&&this._userHandlers.system[r.type].forEach((function(e){e(r)}))},i.prototype.send=function(e,t,n){if(!(128<=e&&e<=255))throw new RangeError("The status byte must be an integer between 128 (0x80) and 255 (0xFF).");void 0===t&&(t=[]),Array.isArray(t)||(t=[t]);var r=[];return t.forEach((function(e){var t=Math.floor(e);if(!(0<=t&&t<=255))throw new RangeError("Data bytes must be integers between 0 (0x00) and 255 (0xFF).");r.push(t)})),this._midiOutput.send([e].concat(r),parseFloat(n)||0),this},i.prototype.sendSysex=function(e,t,r){if(!n.sysexEnabled)throw new Error("Sysex message support must first be activated.");return r=r||{},e=[].concat(e),t.forEach((function(e){if(e<0||127<e)throw new RangeError("The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).")})),t=e.concat(t,n.MIDI_SYSTEM_MESSAGES.sysexend),this.send(n.MIDI_SYSTEM_MESSAGES.sysex,t,this._parseTimeParameter(r.time)),this},i.prototype.sendTimecodeQuarterFrame=function(e,t){return t=t||{},this.send(n.MIDI_SYSTEM_MESSAGES.timecode,e,this._parseTimeParameter(t.time)),this},i.prototype.sendSongPosition=function(e,t){t=t||{};var r=(e=Math.floor(e)||0)>>7&127,i=127&e;return this.send(n.MIDI_SYSTEM_MESSAGES.songposition,[r,i],this._parseTimeParameter(t.time)),this},i.prototype.sendSongSelect=function(e,t){if(t=t||{},!(0<=(e=Math.floor(e))&&e<=127))throw new RangeError("The song number must be between 0 and 127.");return this.send(n.MIDI_SYSTEM_MESSAGES.songselect,[e],this._parseTimeParameter(t.time)),this},i.prototype.sendTuningRequest=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.tuningrequest,void 0,this._parseTimeParameter(e.time)),this},i.prototype.sendClock=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.clock,void 0,this._parseTimeParameter(e.time)),this},i.prototype.sendStart=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.start,void 0,this._parseTimeParameter(e.time)),this},i.prototype.sendContinue=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.continue,void 0,this._parseTimeParameter(e.time)),this},i.prototype.sendStop=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.stop,void 0,this._parseTimeParameter(e.time)),this},i.prototype.sendActiveSensing=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.activesensing,[],this._parseTimeParameter(e.time)),this},i.prototype.sendReset=function(e){return e=e||{},this.send(n.MIDI_SYSTEM_MESSAGES.reset,void 0,this._parseTimeParameter(e.time)),this},i.prototype.stopNote=function(e,t,r){if("all"===e)return this.sendChannelMode("allnotesoff",0,t,r);var i=64;return(r=r||{}).rawVelocity?!isNaN(r.velocity)&&0<=r.velocity&&r.velocity<=127&&(i=r.velocity):!isNaN(r.velocity)&&0<=r.velocity&&r.velocity<=1&&(i=127*r.velocity),this._convertNoteToArray(e).forEach(function(e){n.toMIDIChannels(t).forEach(function(t){this.send((n.MIDI_CHANNEL_MESSAGES.noteoff<<4)+(t-1),[e,Math.round(i)],this._parseTimeParameter(r.time))}.bind(this))}.bind(this)),this},i.prototype.playNote=function(e,t,r){var i,o=64;if((r=r||{}).rawVelocity?!isNaN(r.velocity)&&0<=r.velocity&&r.velocity<=127&&(o=r.velocity):!isNaN(r.velocity)&&0<=r.velocity&&r.velocity<=1&&(o=127*r.velocity),i=this._parseTimeParameter(r.time),this._convertNoteToArray(e).forEach(function(e){n.toMIDIChannels(t).forEach(function(t){this.send((n.MIDI_CHANNEL_MESSAGES.noteon<<4)+(t-1),[e,Math.round(o)],i)}.bind(this))}.bind(this)),!isNaN(r.duration)){r.duration<=0&&(r.duration=0);var s=64;r.rawVelocity?!isNaN(r.release)&&0<=r.release&&r.release<=127&&(s=r.release):!isNaN(r.release)&&0<=r.release&&r.release<=1&&(s=127*r.release),this._convertNoteToArray(e).forEach(function(e){n.toMIDIChannels(t).forEach(function(t){this.send((n.MIDI_CHANNEL_MESSAGES.noteoff<<4)+(t-1),[e,Math.round(s)],(i||n.time)+r.duration)}.bind(this))}.bind(this))}return this},i.prototype.sendKeyAftertouch=function(e,t,r,i){var o=this;if(i=i||{},t<1||16<t)throw new RangeError("The channel must be between 1 and 16.");(isNaN(r)||r<0||1<r)&&(r=.5);var s=Math.round(127*r);return this._convertNoteToArray(e).forEach((function(e){n.toMIDIChannels(t).forEach((function(t){o.send((n.MIDI_CHANNEL_MESSAGES.keyaftertouch<<4)+(t-1),[e,s],o._parseTimeParameter(i.time))}))})),this},i.prototype.sendControlChange=function(e,t,r,i){if(i=i||{},"string"==typeof e){if(void 0===(e=n.MIDI_CONTROL_CHANGE_MESSAGES[e]))throw new TypeError("Invalid controller name.")}else if(!(0<=(e=Math.floor(e))&&e<=119))throw new RangeError("Controller numbers must be between 0 and 119.");if(!(0<=(t=Math.floor(t)||0)&&t<=127))throw new RangeError("Controller value must be between 0 and 127.");return n.toMIDIChannels(r).forEach(function(r){this.send((n.MIDI_CHANNEL_MESSAGES.controlchange<<4)+(r-1),[e,t],this._parseTimeParameter(i.time))}.bind(this)),this},i.prototype._selectRegisteredParameter=function(e,t,r){var i=this;if(e[0]=Math.floor(e[0]),!(0<=e[0]&&e[0]<=127))throw new RangeError("The control65 value must be between 0 and 127");if(e[1]=Math.floor(e[1]),!(0<=e[1]&&e[1]<=127))throw new RangeError("The control64 value must be between 0 and 127");return n.toMIDIChannels(t).forEach((function(){i.sendControlChange(101,e[0],t,{time:r}),i.sendControlChange(100,e[1],t,{time:r})})),this},i.prototype._selectNonRegisteredParameter=function(e,t,r){var i=this;if(e[0]=Math.floor(e[0]),!(0<=e[0]&&e[0]<=127))throw new RangeError("The control63 value must be between 0 and 127");if(e[1]=Math.floor(e[1]),!(0<=e[1]&&e[1]<=127))throw new RangeError("The control62 value must be between 0 and 127");return n.toMIDIChannels(t).forEach((function(){i.sendControlChange(99,e[0],t,{time:r}),i.sendControlChange(98,e[1],t,{time:r})})),this},i.prototype._setCurrentRegisteredParameter=function(e,t,r){var i=this;if((e=[].concat(e))[0]=Math.floor(e[0]),!(0<=e[0]&&e[0]<=127))throw new RangeError("The msb value must be between 0 and 127");return n.toMIDIChannels(t).forEach((function(){i.sendControlChange(6,e[0],t,{time:r})})),e[1]=Math.floor(e[1]),0<=e[1]&&e[1]<=127&&n.toMIDIChannels(t).forEach((function(){i.sendControlChange(38,e[1],t,{time:r})})),this},i.prototype._deselectRegisteredParameter=function(e,t){var r=this;return n.toMIDIChannels(e).forEach((function(){r.sendControlChange(101,127,e,{time:t}),r.sendControlChange(100,127,e,{time:t})})),this},i.prototype.setRegisteredParameter=function(e,t,r,i){var o=this;if(i=i||{},!Array.isArray(e)){if(!n.MIDI_REGISTERED_PARAMETER[e])throw new Error("The specified parameter is not available.");e=n.MIDI_REGISTERED_PARAMETER[e]}return n.toMIDIChannels(r).forEach((function(){o._selectRegisteredParameter(e,r,i.time),o._setCurrentRegisteredParameter(t,r,i.time),o._deselectRegisteredParameter(r,i.time)})),this},i.prototype.setNonRegisteredParameter=function(e,t,r,i){var o=this;if(i=i||{},!(0<=e[0]&&e[0]<=127&&0<=e[1]&&e[1]<=127))throw new Error("Position 0 and 1 of the 2-position parameter array must both be between 0 and 127.");return t=[].concat(t),n.toMIDIChannels(r).forEach((function(){o._selectNonRegisteredParameter(e,r,i.time),o._setCurrentRegisteredParameter(t,r,i.time),o._deselectRegisteredParameter(r,i.time)})),this},i.prototype.incrementRegisteredParameter=function(e,t,r){var i=this;if(r=r||{},!Array.isArray(e)){if(!n.MIDI_REGISTERED_PARAMETER[e])throw new Error("The specified parameter is not available.");e=n.MIDI_REGISTERED_PARAMETER[e]}return n.toMIDIChannels(t).forEach((function(){i._selectRegisteredParameter(e,t,r.time),i.sendControlChange(96,0,t,{time:r.time}),i._deselectRegisteredParameter(t,r.time)})),this},i.prototype.decrementRegisteredParameter=function(e,t,r){if(r=r||{},!Array.isArray(e)){if(!n.MIDI_REGISTERED_PARAMETER[e])throw new TypeError("The specified parameter is not available.");e=n.MIDI_REGISTERED_PARAMETER[e]}return n.toMIDIChannels(t).forEach(function(){this._selectRegisteredParameter(e,t,r.time),this.sendControlChange(97,0,t,{time:r.time}),this._deselectRegisteredParameter(t,r.time)}.bind(this)),this},i.prototype.setPitchBendRange=function(e,t,r,i){var o=this;if(i=i||{},!(0<=(e=Math.floor(e)||0)&&e<=127))throw new RangeError("The semitones value must be between 0 and 127");if(!(0<=(t=Math.floor(t)||0)&&t<=127))throw new RangeError("The cents value must be between 0 and 127");return n.toMIDIChannels(r).forEach((function(){o.setRegisteredParameter("pitchbendrange",[e,t],r,{time:i.time})})),this},i.prototype.setModulationRange=function(e,t,r,i){var o=this;if(i=i||{},!(0<=(e=Math.floor(e)||0)&&e<=127))throw new RangeError("The semitones value must be between 0 and 127");if(!(0<=(t=Math.floor(t)||0)&&t<=127))throw new RangeError("The cents value must be between 0 and 127");return n.toMIDIChannels(r).forEach((function(){o.setRegisteredParameter("modulationrange",[e,t],r,{time:i.time})})),this},i.prototype.setMasterTuning=function(e,t,r){var i=this;if(r=r||{},(e=parseFloat(e)||0)<=-65||64<=e)throw new RangeError("The value must be a decimal number larger than -65 and smaller than 64.");var o=Math.floor(e)+64,s=e-Math.floor(e),a=(s=Math.round((s+1)/2*16383))>>7&127,u=127&s;return n.toMIDIChannels(t).forEach((function(){i.setRegisteredParameter("channelcoarsetuning",o,t,{time:r.time}),i.setRegisteredParameter("channelfinetuning",[a,u],t,{time:r.time})})),this},i.prototype.setTuningProgram=function(e,t,r){var i=this;if(r=r||{},!(0<=(e=Math.floor(e))&&e<=127))throw new RangeError("The program value must be between 0 and 127");return n.toMIDIChannels(t).forEach((function(){i.setRegisteredParameter("tuningprogram",e,t,{time:r.time})})),this},i.prototype.setTuningBank=function(e,t,r){var i=this;if(r=r||{},!(0<=(e=Math.floor(e)||0)&&e<=127))throw new RangeError("The bank value must be between 0 and 127");return n.toMIDIChannels(t).forEach((function(){i.setRegisteredParameter("tuningbank",e,t,{time:r.time})})),this},i.prototype.sendChannelMode=function(e,t,r,i){if(i=i||{},"string"==typeof e){if(!(e=n.MIDI_CHANNEL_MODE_MESSAGES[e]))throw new TypeError("Invalid channel mode message name.")}else if(!(120<=(e=Math.floor(e))&&e<=127))throw new RangeError("Channel mode numerical identifiers must be between 120 and 127.");if((t=Math.floor(t)||0)<0||127<t)throw new RangeError("Value must be an integer between 0 and 127.");return n.toMIDIChannels(r).forEach(function(r){this.send((n.MIDI_CHANNEL_MESSAGES.channelmode<<4)+(r-1),[e,t],this._parseTimeParameter(i.time))}.bind(this)),this},i.prototype.sendProgramChange=function(e,t,r){var i=this;if(r=r||{},e=Math.floor(e),isNaN(e)||e<0||127<e)throw new RangeError("Program numbers must be between 0 and 127.");return n.toMIDIChannels(t).forEach((function(t){i.send((n.MIDI_CHANNEL_MESSAGES.programchange<<4)+(t-1),[e],i._parseTimeParameter(r.time))})),this},i.prototype.sendChannelAftertouch=function(e,t,r){var i=this;r=r||{},e=parseFloat(e),(isNaN(e)||e<0||1<e)&&(e=.5);var o=Math.round(127*e);return n.toMIDIChannels(t).forEach((function(e){i.send((n.MIDI_CHANNEL_MESSAGES.channelaftertouch<<4)+(e-1),[o],i._parseTimeParameter(r.time))})),this},i.prototype.sendPitchBend=function(e,t,r){var i=this;if(r=r||{},isNaN(e)||e<-1||1<e)throw new RangeError("Pitch bend value must be between -1 and 1.");var o=Math.round((e+1)/2*16383),s=o>>7&127,a=127&o;return n.toMIDIChannels(t).forEach((function(e){i.send((n.MIDI_CHANNEL_MESSAGES.pitchbend<<4)+(e-1),[a,s],i._parseTimeParameter(r.time))})),this},i.prototype._parseTimeParameter=function(e){var t,r=parseFloat(e);return"string"==typeof e&&"+"===e.substring(0,1)?r&&0<r&&(t=n.time+r):r>n.time&&(t=r),t},i.prototype._convertNoteToArray=function(e){var t=[];return Array.isArray(e)||(e=[e]),e.forEach((function(e){t.push(n.guessNoteNumber(e))})),t},"function"==typeof define&&"object"==typeof define.amd?define([],(function(){return n})):T?T=n:e.WebMidi||(e.WebMidi=n)}(T);var A=i("23QbL");async function N(){try{await new Promise(((t,n)=>{e(T).enable((r=>{r?n(r):t(e(T))}))}))}catch(e){return console.log(e),()=>()=>{}}console.log(e(T));const t=new A.default;for(const n of e(T).inputs)n.addListener("controlchange","all",(e=>{t.emit({id:`${n.id}.${e.type}.${e.controller.number}`,value:u(0,127,0,1,e.value)})})),n.addListener("pitchbend","all",(e=>{t.emit({id:`${n.id}.${e.type}.${e.channel}`,value:u(-1,1,0,1,e.value)})})),n.addListener("noteon","all",(e=>{t.emit({id:`${n.id}.note.${e.note.number}`,value:e.velocity})})),n.addListener("noteoff","all",(e=>{t.emit({id:`${n.id}.note.${e.note.number}`,value:0})}));return e=>t.listen(e)}A=i("23QbL");class x{resize(e){const t=this.length;this.buffer=s(e,(e=>e<t?this.get(e):null)),this.start=0,this.end=t}growForInsertIfNeeded(){this.length>=this.capacity-1&&this.resize(2*this.capacity)}get length(){return this.start<=this.end?this.end-this.start:this.end+this.buffer.length-this.start}get capacity(){return this.buffer.length}get(e){return this.buffer[(this.start+e)%this.capacity]}push(e){this.growForInsertIfNeeded(),this.buffer[this.end]=e,this.end=(this.end+1)%this.capacity}pop(){if(this.end===this.start)return null;0===this.end?this.end=this.capacity-1:this.end=this.end-1;const e=this.buffer[this.end];return this.buffer[this.end]=null,e}unshift(e){this.growForInsertIfNeeded(),0===this.start?this.start=this.capacity-1:this.start=this.start-1,this.buffer[this.start]=e}shift(){if(this.end===this.start)return null;const e=this.buffer[this.start];return this.buffer[this.start]=null,this.start=(this.start+1)%this.capacity,e}first(){return this.get(0)}last(){return this.get(this.length-1)}constructor(e=32){this.start=0,this.end=0,this.buffer=s(Math.max(e,1),(()=>null))}}class D{debug(e){return null!==e&&this.manager.debug(e,this),this}clear(){this.currentValue=null}read(){return null===this.currentValue&&(this.currentValue=this.update()),this.currentValue}constructor(e){this.manager=e,this.currentValue=null}}class R extends D{update(){return this.value}set(e){this.value=e}constructor(e,t){super(e),this.value=t}}function O(e,t){return t?d(t[0],t[1],e):e}class C extends R{set(e){e=O(e,this.range),super.set(e),this.saveDebounced(e)}constructor(e,t,n,r){super(e,O(f(`signalSetting.${t}`,n),r)),this.key=t,this.saveDebounced=function(e,t){let n;return(...r)=>{void 0!==n&&clearTimeout(n),n=setTimeout((()=>t(...r)),e)}}(200,(e=>p(`signalSetting.${this.key}`,e))),this.range=r||null}}class P extends D{update(){return this.compute()}constructor(e,t){super(e),this.compute=t}}class k{onDebugSignalsChange(e){return this.debugSignalsChangeEvent.listen(e)}onUpdate(e){return this.updateEvent.listen(e)}update(e){this.driver.set(Math.min(e,.03));for(const e of this.signals)e.clear();for(const e of this.signals)e.read();this.updateEvent.emit()}controlled(e){return this.addSignal(new R(this,e))}computed(e){return this.addSignal(new P(this,e))}input(e,t,n){return this.addSignal(new C(this,e,t,n)).debug(e)}sin({min:e=0,max:t=1,frequency:n=1,driver:r=this.driver,offset:i=0}={}){const o=this.toSignal(e),s=this.toSignal(t),a=this.toSignal(n),l=this.toSignal(i);let h=0;return this.computed((()=>{const e=a.read();return h+=r.read()*e,u(-1,1,o.read(),s.read(),Math.cos((l.read()+h)*Math.PI*2))}))}spring(e){const t=e.target;var n;const r=null!==(n=e.driver)&&void 0!==n?n:this.driver;var i;const o=this.toSignal(null!==(i=e.tension)&&void 0!==i?i:230);var s;const a=this.toSignal(null!==(s=e.friction)&&void 0!==s?s:22);let u=t.read(),l=0;return this.computed((()=>{const e=t.read(),n=r.read(),i=o.read(),s=a.read();let h=u,c=l;const d=i*(e-h)-s*l;h=u+l*n*.5,c=l+d*n*.5;const f=c,p=i*(e-h)-s*c;h=u+f*n*.5,c=l+p*n*.5;const m=c,g=i*(e-h)-s*c;h=u+m*n,c=l+g*n;return u+=1/6*(l+2*(f+m)+c)*n,l+=1/6*(d+2*(p+g)+(i*(e-h)-s*c))*n,u}))}add(e,t){const n=this.toSignal(e),r=this.toSignal(t);return this.computed((()=>n.read()+r.read()))}subtract(e,t){const n=this.toSignal(e),r=this.toSignal(t);return this.computed((()=>n.read()-r.read()))}multiply(e,t){const n=this.toSignal(e),r=this.toSignal(t);return this.computed((()=>n.read()*r.read()))}divide(e,t){const n=this.toSignal(e),r=this.toSignal(t);return this.computed((()=>n.read()/r.read()))}switch(e,t,n){const r=this.toSignal(e),i=this.toSignal(t),o=this.toSignal(n);return this.computed((()=>r.read()?i.read():o.read()))}adsr({target:e,attack:t=0,delay:n=0,sustain:r=1,release:i=0,driver:o=this.driver}){const s=this.toSignal(t),a=this.toSignal(n),u=this.toSignal(r),l=this.toSignal(i);var h,c;(c=h||(h={}))[c.Off=0]="Off",c[c.Attacking=1]="Attacking",c[c.Holding=2]="Holding",c[c.Releasing=3]="Releasing";let f=h.Off,p=0,m=0;return this.computed((()=>{const t=e.read();if(0!==t){if(f!==h.Off&&f!==h.Releasing||(f=0===s.read()?h.Holding:h.Attacking),f===h.Attacking&&(p+=t/s.read()*o.read(),p>=t&&(f=h.Holding)),f===h.Holding){const e=t*u.read();p=0===a.read()?e:d(e,t,p+(e-t)/a.read()*o.read())}}else f!==h.Attacking&&f!==h.Holding||(0===p?f=h.Off:(m=p,f=h.Releasing)),f===h.Releasing&&(p-=m/l.read()*o.read(),p<=0&&(p=0,f=h.Off)),f===h.Off&&(p=0);return p}))}easeExponential({target:e,rate:t=.1}){const n=this.toSignal(t);let r=e.read();return this.computed((()=>{const t=e.read()-r;return r+=t*n.read(),r}))}lerp(e,t,n){const r=this.toSignal(e),i=this.toSignal(t),o=this.toSignal(n);return this.computed((()=>a(r.read(),i.read(),o.read())))}delay({target:e,amount:t=0,driver:n=this.driver}){const r=this.toSignal(t);console.log(r.read());const i=new x(1.2*r.read()/(1/60));let o=0,s=e.read();return this.computed((()=>{o+=n.read();const t=r.read();i.push({time:o,value:e.read()});let a=null;for(;(a=i.first())&&a.time+t<=o;)s=a.value,i.shift();return s}))}debug(e,t){g(this.signals.has(t),`signal called ${e} does not belong to this signal manager`);const n=m(this.debugSignalsByName,e)?[...this.debugSignalsByName[e],t]:[t];this.debugSignalsByName={...this.debugSignalsByName,[e]:n},this.debugSignalsChangeEvent.emit()}addSignal(e){return this.signals.add(e),e}toSignal(e){return"number"==typeof e?this.controlled(e):e}constructor(){this.debugSignalsByName={},this.debugSignalsChangeEvent=new A.default,this.updateEvent=new A.default,this.signals=new Set,this.driver=this.controlled(0).debug("internal.driver")}}o=i("bh6RR"),o=i("bh6RR");var G={};i.register("kklnU",(function(e,t){var n,r,o,s,a;n=e.exports,r="useSubscription",o=function(){return a},s=function(e){return a=e},Object.defineProperty(n,r,{get:o,set:s,enumerable:!0,configurable:!0});var u=i("4yvvI"),l=i("bh6RR");a=function(e){var t=e.getCurrentValue,n=e.subscribe,r=l.useState((function(){return{getCurrentValue:t,subscribe:n,value:t()}}));e=r[0];var i=r[1];return r=e.value,e.getCurrentValue===t&&e.subscribe===n||(r=t(),i({getCurrentValue:t,subscribe:n,value:r})),l.useDebugValue(r),l.useEffect((function(){function e(){if(!r){var e=t();i((function(r){return r.getCurrentValue!==t||r.subscribe!==n||r.value===e?r:u({},r,{value:e})}))}}var r=!1,o=n(e);return e(),function(){r=!0,o()}}),[t,n]),r}})),G=i("kklnU");o=i("bh6RR");function H(e,t){const[n,r]=o.useState((()=>f(e,t)));return[n,t=>{try{const i=t instanceof Function?t(n):t;r(i),p(e,i)}catch(e){console.log(e)}}]}const L={position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:"100000",touchAction:"none"};class F{attach(){const e=document.body;!this.attachedTo&&e&&(this.attachedTo=e,this.attachedTo.appendChild(this.cover),this.attachEvents())}remove(){this.attachedTo&&(this.attachedTo.removeChild(this.cover),this.attachedTo=null,this.removeEvents())}attachEvents(){this.onDown&&window.addEventListener("mousedown",this.onDown,!1),this.onMove&&window.addEventListener("mousemove",this.onMove,!1),this.onUp&&window.addEventListener("mouseup",this.onUp,!1)}removeEvents(){this.onDown&&window.removeEventListener("mousedown",this.onDown),this.onMove&&window.removeEventListener("mousemove",this.onMove),this.onUp&&window.removeEventListener("mouseup",this.onUp)}constructor({down:e,move:t,up:n,debug:r,cursor:i}){this.attachedTo=null,this.onDown=e,this.onMove=t,this.onUp=n;const o=document.createElement("div");o.setAttribute("touch-action","none"),Object.assign(o.style,L),r&&(o.style.background="rgba(0, 255, 0, 0.3)"),i&&(o.style.cursor=i),this.cover=o}}o=i("bh6RR");function B(e){return G.useSubscription(o.useMemo((()=>({getCurrentValue:()=>e.read(),subscribe:t=>e.manager.onUpdate(t)})),[e]))}const W=(e,t)=>{const n=e.toString().split(".");if(1===n.length)return n[0];if(2===n.length){if(n[0].length>=t)return n[0];{const e=t-n[0].length;return`${n[0]}.${n[1].slice(0,e)}`}}throw new Error(`unexpected number of value parts: ${n.length}`)},Y=o.memo((function({signal:t,className:n}){const r=B(t);return o.createElement("div",{className:e(_)("text-gray-400",n)},W(r,5))})),q=o.memo((function({signals:e,width:t}){let[{lines:n,min:r,max:i},s]=o.useState((()=>{const t=e.map((e=>e.read()));return{lines:t.map((e=>[e])),min:Math.min(...t),max:Math.max(...t)}}));o.useEffect((()=>e[0].manager.onUpdate((()=>{const n=e.map((e=>e.read()));s((e=>({lines:e.lines.map(((e,r)=>[n[r],...e.slice(0,t-1)])),min:Math.min(e.min,...n),max:Math.max(e.max,...n)})))}))),[e]);const a=Math.round(t/2);return r===i&&(r-=.1,i+=.1),o.createElement("svg",{width:t,height:a},o.createElement("text",{x:t-8,y:16,fill:"#cbd5e0",fontSize:8,textAnchor:"end"},W(i,5)),o.createElement("text",{x:t-8,y:a-8,fill:"#cbd5e0",fontSize:8,textAnchor:"end"},W(r,5)),n.map(((e,n)=>{let s=[];for(let n=0;n<e.length;n++){const o=0===n?"M":"L";s.push(`${o} ${t-n} ${u(r,i,a-8,8,e[n]).toFixed(1)}`)}return o.createElement("path",{key:n,d:s.join(" "),stroke:"#cbd5e0",strokeWidth:1,fill:"none"})})))}));function j({name:t,signal:n,listenToMidi:r}){const[i,s]=o.useState(!1),[a,l]=H(`midiControlForSignal.${t}`,null);return o.useEffect((()=>r((({id:e,value:t})=>{n.range&&(i?(l(e),s(!1),n.set(u(0,1,n.range[0],n.range[1],t))):e===a&&n.set(u(0,1,n.range[0],n.range[1],t)))}))),[r,n,i,a]),o.createElement(o.Fragment,null,n.range&&o.createElement("div",{className:e(_)("cursor-pointer px-1 py-1",i?"text-gray-100":null!==a?"text-gray-300":"text-gray-500 hover:text-gray-300"),onClick:function(e){e.stopPropagation(),null===a?s(!i):l(null)}},i?"◎":null!==a?"◉":"○"),o.createElement("div",{className:"cursor-move pr-2 pl-1 py-1",style:{cursor:"ns-resize"},onMouseDown:function(e){e.preventDefault();const t=e.screenY,r=n.read(),i=n.range?Math.abs(n.range[1]-n.range[0])/250:Math.abs(0===r?.1:.01*r),o=e=>{const o=(t-e)*i;n.set(r+o)},s=new F({move:e=>{o(e.screenY)},up:e=>{o(e.screenY),s.remove()},cursor:"ns-resize"});s.attach()}},"↕",o.createElement(Y,{signal:n,className:"inline-block pl-1"})))}const V=o.memo((function({signals:e,name:t,displayName:n=t,width:r,listenToMidi:i}){const[s,a]=H(`signal.${t}`,!1),u=e.filter((e=>e instanceof C));return o.createElement("div",{className:"text-xs border-t border-gray-700"},o.createElement("div",{className:"flex hover:bg-gray-800 cursor-pointer",onClick:()=>a(!s)},o.createElement("div",{className:"flex-auto whitespace-pre px-2 py-1"},n),u.length?o.createElement(j,{name:t,signal:u[0],listenToMidi:i}):o.createElement(Y,{signal:e[0],className:"px-2 py-1"})),s&&o.createElement(q,{signals:e,width:r}))}));function z({groupName:e,signalNamePairs:t,width:n,listenToMidi:r}){const[i,s]=H(`group.${e}`,!1);return o.createElement("div",{className:"text-xs border-t border-gray-700"},o.createElement("div",{className:"flex hover:bg-gray-800 cursor-pointer px-2 py-1",onClick:()=>s(!i)},o.createElement("div",{className:"flex-auto"},e),o.createElement("div",{className:"text-gray-600"},i?"▽":"▷")),i&&o.createElement(o.Fragment,null,t.map((([t,i])=>o.createElement(V,{key:t,name:t,displayName:`  ${t.slice(e.length+1)}`,signals:i,width:n,listenToMidi:r})))))}var K=o.memo((function({signalManager:e,width:t,listenToMidi:n}){const r=G.useSubscription(o.useMemo((()=>({getCurrentValue:()=>e.debugSignalsByName,subscribe:t=>e.onDebugSignalsChange(t)})),[e])),i=(s=Object.entries(r).filter((([e])=>!e.startsWith("_"))),a=e=>e[0],s.slice().sort(((e,t)=>a(e)<a(t)?-1:1)));var s,a;const[u,l]=function(e,t){const n=[],r=[];for(const i of e)t(i)?n.push(i):r.push(i);return[n,r]}(i,(([e])=>e.includes("."))),h=function(e,t){const n=new Map;for(const r of e){const e=t(r),i=n.get(e);i?i.push(r):n.set(e,[r])}return n}(u,(([e])=>{const t=e.indexOf(".");return g(-1!==t),e.slice(0,t)}));return o.createElement("div",{className:"absolute right-0 top-0 bottom-0 border-l border-gray-600 text-sm h-full overflow-auto",style:{width:t}},o.createElement("div",{className:"py-1 px-2"},"signals"),Array.from(h).map((([e,r])=>o.createElement(z,{key:e,groupName:e,signalNamePairs:r,width:t-1,listenToMidi:n}))),l.map((([e,r])=>o.createElement(V,{key:e,name:e,signals:r,width:t-1,listenToMidi:n}))))})),$=function(){if("undefined"!=typeof Map)return Map;function e(e,t){var n=-1;return e.some((function(e,r){return e[0]===t&&(n=r,!0)})),n}return function(){function t(){this.__entries__=[]}return Object.defineProperty(t.prototype,"size",{get:function(){return this.__entries__.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t){var n=e(this.__entries__,t),r=this.__entries__[n];return r&&r[1]},t.prototype.set=function(t,n){var r=e(this.__entries__,t);~r?this.__entries__[r][1]=n:this.__entries__.push([t,n])},t.prototype.delete=function(t){var n=this.__entries__,r=e(n,t);~r&&n.splice(r,1)},t.prototype.has=function(t){return!!~e(this.__entries__,t)},t.prototype.clear=function(){this.__entries__.splice(0)},t.prototype.forEach=function(e,t){void 0===t&&(t=null);for(var n=0,r=this.__entries__;n<r.length;n++){var i=r[n];e.call(t,i[1],i[0])}},t}()}(),U="undefined"!=typeof window&&"undefined"!=typeof document&&window.document===document,X=void 0!==t&&t.Math===Math?t:"undefined"!=typeof self&&self.Math===Math?self:"undefined"!=typeof window&&window.Math===Math?window:Function("return this")(),J="function"==typeof requestAnimationFrame?requestAnimationFrame.bind(X):function(e){return setTimeout((function(){return e(Date.now())}),1e3/60)};var Q=["top","right","bottom","left","width","height","size","weight"],Z="undefined"!=typeof MutationObserver,ee=function(){function e(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=function(e,t){var n=!1,r=!1,i=0;function o(){n&&(n=!1,e()),r&&a()}function s(){J(o)}function a(){var e=Date.now();if(n){if(e-i<2)return;r=!0}else n=!0,r=!1,setTimeout(s,t);i=e}return a}(this.refresh.bind(this),20)}return e.prototype.addObserver=function(e){~this.observers_.indexOf(e)||this.observers_.push(e),this.connected_||this.connect_()},e.prototype.removeObserver=function(e){var t=this.observers_,n=t.indexOf(e);~n&&t.splice(n,1),!t.length&&this.connected_&&this.disconnect_()},e.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},e.prototype.updateObservers_=function(){var e=this.observers_.filter((function(e){return e.gatherActive(),e.hasActive()}));return e.forEach((function(e){return e.broadcastActive()})),e.length>0},e.prototype.connect_=function(){U&&!this.connected_&&(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),Z?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},e.prototype.disconnect_=function(){U&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},e.prototype.onTransitionEnd_=function(e){var t=e.propertyName,n=void 0===t?"":t;Q.some((function(e){return!!~n.indexOf(e)}))&&this.refresh()},e.getInstance=function(){return this.instance_||(this.instance_=new e),this.instance_},e.instance_=null,e}(),te=function(e,t){for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];Object.defineProperty(e,i,{value:t[i],enumerable:!1,writable:!1,configurable:!0})}return e},ne=function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView||X},re=le(0,0,0,0);function ie(e){return parseFloat(e)||0}function oe(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return t.reduce((function(t,n){return t+ie(e["border-"+n+"-width"])}),0)}function se(e){var t=e.clientWidth,n=e.clientHeight;if(!t&&!n)return re;var r=ne(e).getComputedStyle(e),i=function(e){for(var t={},n=0,r=["top","right","bottom","left"];n<r.length;n++){var i=r[n],o=e["padding-"+i];t[i]=ie(o)}return t}(r),o=i.left+i.right,s=i.top+i.bottom,a=ie(r.width),u=ie(r.height);if("border-box"===r.boxSizing&&(Math.round(a+o)!==t&&(a-=oe(r,"left","right")+o),Math.round(u+s)!==n&&(u-=oe(r,"top","bottom")+s)),!function(e){return e===ne(e).document.documentElement}(e)){var l=Math.round(a+o)-t,h=Math.round(u+s)-n;1!==Math.abs(l)&&(a-=l),1!==Math.abs(h)&&(u-=h)}return le(i.left,i.top,a,u)}var ae="undefined"!=typeof SVGGraphicsElement?function(e){return e instanceof ne(e).SVGGraphicsElement}:function(e){return e instanceof ne(e).SVGElement&&"function"==typeof e.getBBox};function ue(e){return U?ae(e)?function(e){var t=e.getBBox();return le(0,0,t.width,t.height)}(e):se(e):re}function le(e,t,n,r){return{x:e,y:t,width:n,height:r}}var he=function(){function e(e){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=le(0,0,0,0),this.target=e}return e.prototype.isActive=function(){var e=ue(this.target);return this.contentRect_=e,e.width!==this.broadcastWidth||e.height!==this.broadcastHeight},e.prototype.broadcastRect=function(){var e=this.contentRect_;return this.broadcastWidth=e.width,this.broadcastHeight=e.height,e},e}(),ce=function(e,t){var n,r,i,o,s,a,u,l=(r=(n=t).x,i=n.y,o=n.width,s=n.height,a="undefined"!=typeof DOMRectReadOnly?DOMRectReadOnly:Object,u=Object.create(a.prototype),te(u,{x:r,y:i,width:o,height:s,top:i,right:r+o,bottom:s+i,left:r}),u);te(this,{target:e,contentRect:l})},de=function(){function e(e,t,n){if(this.activeObservations_=[],this.observations_=new $,"function"!=typeof e)throw new TypeError("The callback provided as parameter 1 is not a function.");this.callback_=e,this.controller_=t,this.callbackCtx_=n}return e.prototype.observe=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof ne(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)||(t.set(e,new he(e)),this.controller_.addObserver(this),this.controller_.refresh())}},e.prototype.unobserve=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof ne(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)&&(t.delete(e),t.size||this.controller_.removeObserver(this))}},e.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},e.prototype.gatherActive=function(){var e=this;this.clearActive(),this.observations_.forEach((function(t){t.isActive()&&e.activeObservations_.push(t)}))},e.prototype.broadcastActive=function(){if(this.hasActive()){var e=this.callbackCtx_,t=this.activeObservations_.map((function(e){return new ce(e.target,e.broadcastRect())}));this.callback_.call(e,t,e),this.clearActive()}},e.prototype.clearActive=function(){this.activeObservations_.splice(0)},e.prototype.hasActive=function(){return this.activeObservations_.length>0},e}(),fe="undefined"!=typeof WeakMap?new WeakMap:new $,pe=function e(t){if(!(this instanceof e))throw new TypeError("Cannot call a class as a function.");if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");var n=ee.getInstance(),r=new de(t,n,this);fe.set(this,r)};["observe","unobserve","disconnect"].forEach((function(e){pe.prototype[e]=function(){var t;return(t=fe.get(this))[e].apply(t,arguments)}}));var me=void 0!==X.ResizeObserver?X.ResizeObserver:pe;function ge({debuggerEnabled:e,signalManager:t,listenToMidi:n,scene:r}){const[i,s]=o.useState(null),a=o.useRef(null),u=o.useRef(null),[l,h]=o.useState({width:100,height:100,devicePixelRatio:1});return o.useEffect((()=>{let e=!1;g(u.current&&a.current);const n=u.current,i=a.current;h({width:n.clientWidth,height:n.clientHeight,devicePixelRatio:window.devicePixelRatio});const o={width:t.controlled(n.clientWidth).debug("canvas.width"),height:t.controlled(n.clientHeight).debug("canvas.height"),devicePixelRatio:t.controlled(window.devicePixelRatio).debug("canvas.devicePixelRatio"),mouseX:t.controlled(0).debug("canvas.mouseX"),mouseY:t.controlled(0).debug("canvas.mouseY"),mouseDown:t.controlled(0).debug("canvas.mouseDown")},l=new me((()=>{const e=n.clientWidth,t=n.clientHeight,r=window.devicePixelRatio;o.width.set(e),o.height.set(t),o.devicePixelRatio.set(r),h((n=>n.width!==e||n.height!==t||n.devicePixelRatio!==r?{width:e,height:t,devicePixelRatio:r}:n))}));l.observe(n),window.addEventListener("mousemove",(e=>{o.mouseX.set(e.clientX),o.mouseY.set(e.clientY)})),i.addEventListener("mousedown",(()=>{o.mouseDown.set(1);const e=new F({up:()=>{o.mouseDown.set(0),e.remove()}});e.attach()}));const c=Date.now(),d=r(t,n,o);console.log("get frame loop",Date.now()-c,t.debugSignalsByName.size);let f=0;return async function(e){let t=!1;const n=()=>{t=!0};for(;;)if(e(await new Promise((e=>{window.requestAnimationFrame((t=>e(t)))})),n),t)return}(((n,r)=>{if(e)r();else{const e=n-f;f=n,t.update(e/1e3),d.update&&d.update(),d.draw()}})),s(d.children),()=>{e=!0,l.disconnect()}}),[r,t]),o.createElement("div",{style:{position:"absolute",top:0,left:0,bottom:0,right:0}},o.createElement("div",{ref:a,style:{position:"absolute",top:0,left:0,bottom:0,right:e?300:0}},o.createElement("canvas",{ref:u,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:10,pointerEvents:"none"},width:l.width*l.devicePixelRatio,height:l.height*l.devicePixelRatio}),i),e&&o.createElement(K,{signalManager:t,listenToMidi:n,width:300}))}var ve=o.memo(ge);const be={KeyA:33,KeyS:34,KeyD:35,KeyF:36,KeyG:37,KeyH:38,KeyJ:39,KeyK:40,KeyL:41,Semicolon:42,Quote:43,Backslash:44,KeyQ:45,KeyW:46,KeyE:47,KeyR:48,KeyT:49,KeyY:50,KeyU:51,KeyI:52,KeyO:53,KeyP:54,BracketLeft:55,BracketRight:56,Digit1:57,Digit2:58,Digit3:59,Digit4:60,Digit5:61,Digit6:62,Digit7:63,Digit8:64,Digit9:65,Digit0:66,Minus:67,Equal:68};function ye(e,t,n){return(e-t)/n}function Ee(e,t,n){return e*n+t}function _e(e,t,n,r,i){e.strokeStyle=n;for(let n=0;n<t.points.length-i;n++){const{start:i,end:o}=t.points[n];e.beginPath(),e.moveTo(i[0].read(),i[1].read()),e.lineTo(o[0].read(),o[1].read()),e.lineWidth=r-n,e.stroke()}}function Se({canvasScaleSignal:e,canvasTranslateXSignal:t,canvasTranslateYSignal:n,onNoteDown:r,onNoteUp:i}){const s=o.useRef(new Map),a=B(e),u=B(t),l=B(n),[h,c]=o.useState([]);console.log(h);const d=o.useCallback(((e,t)=>{e?s.current.set(t,e):s.current.delete(t)}),[]),f=o.useCallback((i=>{c((o=>{if(o.includes(i))return o;const a=s.current.get(i);if(a){const o=a.getBoundingClientRect();r(i,ye(o.x+o.width/2,t.read(),e.read()),ye(o.y+.8*o.height,n.read(),e.read()))}return u=[...o,i],Array.from(new Set(u));var u}))}),[]),p=o.useCallback((e=>{c((t=>t.includes(e)?(i(e),t.filter((t=>t!==e))):t))}),[]);return o.useEffect((()=>{const e=e=>{const t=be[e.code];void 0!==t&&f(t)},t=e=>{const t=be[e.code];void 0!==t&&p(t)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}}),[]),o.createElement(o.Fragment,null,o.createElement("div",{style:{background:"#7F95D1"},className:"absolute top-0 left-0 w-full h-full"}),o.createElement(w,{lowestNote:33,highestNote:72,scale:a,top:Ee(1100,l,a),left:Ee(650,u,a),notesDown:h,setRefForKey:d}))}!async function(e,t){const n=await N(),r=new k,i=document.getElementById("root");g(i),I.render(o.createElement(ve,{debuggerEnabled:t,signalManager:r,listenToMidi:n,scene:e}),i)}((function(e,t,{mouseX:n,mouseY:r,mouseDown:i,width:a,height:u,devicePixelRatio:l}){const d=t.getContext("2d");g(d);const f=new E(d),p=e.computed((()=>Math.min(a.read()/1300,u.read()/1300))),m=e.computed((()=>(a.read()-1300*p.read())/2)),b=e.computed((()=>(u.read()-1300*p.read())/2)),y=(e.computed((()=>ye(n.read(),m.read(),p.read()))),e.computed((()=>ye(r.read(),b.read(),p.read()))),30),_=e.input("spring.activeFriction",35,[1,40]),S=e.input("spring.activeTension",1e3,[1,1e3]),M=e.input("spring.idleFriction",25,[1,40]),w=e.input("spring.idleTension",180,[1,1e3]),I=e.controlled(650),T=e.controlled(250),A=e.spring({target:I}),N=e.spring({target:T}),x=A,D=e.subtract(N,70),R=s(8,(t=>{const n=e.controlled(0),r=e.controlled(0),i=e.controlled(0),o=e.computed((()=>A.read()+65*(t-3.5))),a=e.computed((()=>N.read()+120*Math.sin(t/7*Math.PI)));let u=o,l=a,c=e.controlled(Math.PI/2-(t-4)/7.2);const d=e.subtract(r,o),f=e.subtract(i,a),p=e.computed((()=>Math.atan2(f.read(),d.read()))),m=e.sin({min:h(-1,.75),max:h(1,.75),frequency:h(.5,.4),offset:Math.random()}),g=h(2,1.5)*Math.sign(h(0,1)),v=e.sin({min:g-2,max:g+2,frequency:h(.5,.4),offset:Math.random()});return{points:s(y,(t=>{const r=y-(t+1),i=e.adsr({target:n,attack:.05*r,release:2}),s=e.adsr({target:n,attack:.05*r}),h=e.lerp(M,_,i),g=e.lerp(w,S,i),b=e.sin({min:-.3,max:.3,frequency:.2*1.1**(t/2),offset:Math.random()}),E=e.add(b,c),I=24*.95**(t/2),T=e.add(u,e.computed((()=>Math.cos(E.read())*I))),A=e.add(l,e.computed((()=>Math.sin(E.read())*I))),N=(t+1)/y,x=20*Math.sin(N*Math.PI),D=e.sin({min:-x,max:x,offset:e.computed((()=>t/y*v.read())),frequency:m}),R=e.computed((()=>o.read()+d.read()*N+Math.sin(-p.read())*D.read())),O=e.computed((()=>a.read()+f.read()*N+Math.cos(p.read())*D.read())),C=e.spring({target:e.lerp(T,R,s),friction:h,tension:g}).debug(29===t?"tentacle.endX":null),P=e.spring({target:e.lerp(A,O,s),friction:h,tension:g}),k=e.subtract(C,u),G=e.subtract(P,l),H=e.computed((()=>Math.sqrt(k.read()*k.read()+G.read()*G.read()))),L={start:[u,l],end:[C,P],leftInner:[e.computed((()=>C.read()-G.read()/H.read()*(17-t+1))),e.computed((()=>P.read()+k.read()/H.read()*(17-t+1)))],rightInner:[e.computed((()=>C.read()+G.read()/H.read()*(17-t+1))),e.computed((()=>P.read()-k.read()/H.read()*(17-t+1)))],leftOuter:[e.computed((()=>C.read()-G.read()/H.read()*(23-t+1))),e.computed((()=>P.read()+k.read()/H.read()*(23-t+1)))],rightOuter:[e.computed((()=>C.read()+G.read()/H.read()*(23-t+1))),e.computed((()=>P.read()-k.read()/H.read()*(23-t+1)))]};return u=C,l=P,c=E,L})),isActive:n,activeTargetX:r,activeTargetY:i}})),O=new Map,C=e.computed((()=>{let e=0;for(let t=0;t<8;t++)e+=R[t].points[29].end[0].read();return e/8})),P=e.computed((()=>{let e=0;for(let t=0;t<8;t++)e+=R[t].points[29].end[1].read();return e/8})),k=function(e){const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}(R);return{update:()=>{const e=new v(C.read()-650,P.read()-400-250),t=e.withMagnitude(e.magnitude**.9);I.set(650+t.x),T.set(250+t.y)},draw:()=>{const e=new v(x.read(),D.read());d.resetTransform(),d.scale(l.read(),l.read()),d.fillStyle="#7F95D1",d.clearRect(0,0,a.read(),u.read()),d.translate(m.read(),b.read()),d.scale(p.read(),p.read()),f.ellipse(e,250,200,{stroke:"#FF709D",strokeWidth:12}),d.lineCap="round",d.lineJoin="round",d.beginPath(),d.moveTo(R[0].points[0].start[0].read(),R[0].points[0].start[1].read());for(let e=1;e<R.length;e++){const t=R[e-1],n=R[e];d.lineTo(t.points[3].rightOuter[0].read(),t.points[3].rightOuter[1].read()),d.bezierCurveTo(t.points[1].rightOuter[0].read(),t.points[1].rightOuter[1].read(),n.points[1].leftOuter[0].read(),n.points[1].leftOuter[1].read(),n.points[3].leftOuter[0].read(),n.points[3].leftOuter[1].read())}d.lineTo(R[R.length-1].points[0].start[0].read(),R[R.length-1].points[0].start[1].read()),d.fillStyle="#FF709D",d.fill();for(let e=0;e<k.length;e++)_e(d,k[e],"#FF709D",46,0),_e(d,k[e],"#FF4782",34,3);f.ellipse(e,250,200,{fill:"#FF4782"}),d.beginPath(),d.moveTo(R[0].points[0].start[0].read(),R[0].points[0].start[1].read());for(let e=1;e<R.length;e++){const t=R[e-1],n=R[e];d.lineTo(t.points[1].rightInner[0].read(),t.points[1].rightInner[1].read()),d.bezierCurveTo(t.points[0].rightInner[0].read(),t.points[0].rightInner[1].read(),n.points[0].leftInner[0].read(),n.points[0].leftInner[1].read(),n.points[1].leftInner[0].read(),n.points[1].leftInner[1].read())}d.lineTo(R[R.length-1].points[0].start[0].read(),R[R.length-1].points[0].start[1].read()),d.fillStyle="#FF4782",d.fill(),f.debugPointX(new v(C.read(),P.read()),{label:"avg end"})},children:o.createElement(Se,{canvasScaleSignal:p,canvasTranslateXSignal:m,canvasTranslateYSignal:b,onNoteDown:(e,t,n)=>{var r;const i=null!==(r=c(R.filter((e=>!O.has(e)))))&&void 0!==r?r:c(R);O.set(i,e),i.isActive.set(1),i.activeTargetX.set(t),i.activeTargetY.set(n)},onNoteUp:e=>{for(const[t,n]of O.entries())n===e&&(O.delete(t),t.isActive.set(0))}})}}),!0);
//# sourceMappingURL=index.f9005e7a.js.map
