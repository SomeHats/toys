import{a as D,b as ce,t as Ye,s as et,L as tt,h as De,g as Q,M as $,N as nt,f as Ke,l as rt,D as ot,C as Ie,F as it,O as st,c as k,P as B,e as at,r as Te}from"../chunks/chunk_assert.66f3ec42.js";/* empty css                               */import{a as ct,r as I}from"../chunks/chunk_index.b0b8f4df.js";import{R as ut,j as y,c as U,F as Re,a as G}from"../chunks/chunk_ResizeObserver.38aa3088.js";import{V as w,b as he,R as H,P as lt,d as dt,c as F,a as pt,e as ze,f as ft,p as ht}from"../chunks/chunk_Vector2.e9b23424.js";import{A as $e}from"../chunks/chunk_AABB.36b4d245.js";var de=function e(t,n){if(t===n)return!0;if(t&&n&&typeof t=="object"&&typeof n=="object"){if(t.constructor!==n.constructor)return!1;var r,i,o;if(Array.isArray(t)){if(r=t.length,r!=n.length)return!1;for(i=r;i--!==0;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if(o=Object.keys(t),r=o.length,r!==Object.keys(n).length)return!1;for(i=r;i--!==0;)if(!Object.prototype.hasOwnProperty.call(n,o[i]))return!1;for(i=r;i--!==0;){var s=o[i];if(!e(t[s],n[s]))return!1}return!0}return t!==t&&n!==n},Ue,ke=ct.exports;Ue=ke.createRoot,ke.hydrateRoot;let ue;const X=new Map,Ae=new WeakMap;function vt(e){for(const t of e){Ae.set(t.target,t);for(const n of ce(X.get(t.target),"callback does not exist for tracked entry"))n(t)}}function Me(){return ue||(ue=new ut(vt)),ue}function gt(e,t){let n=X.get(e);n||(n=new Set,X.set(e,n),Me().observe(e));const r=Ae.get(e);r&&t(r),n.add(t)}function mt(e,t){const n=X.get(e);D(n,"element is not tracked");const r=n.delete(t);D(r,"callback did not exist for element"),n.size===0&&(X.delete(e),Me().unobserve(e))}function yt(e,t){const[n,r]=I.exports.useState(null);return I.exports.useLayoutEffect(()=>{if(!e)return;const i=o=>{console.log({entry:o}),r(t(o))};return gt(e,i),()=>{mt(e,i)}},[e,t]),n}function wt(e){return new w(e.contentRect.width,e.contentRect.height)}const Pt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");class ve{constructor(t,n=16){this.randomLength=n,this.debugIdCounter=0,this.prefix=t,this.Id=`${t}.SAMPLE`;const r=new RegExp(`^${this.prefix}\\.([a-zA-Z0-9_]+)$`);this.parse=he(dt,i=>r.test(i)?H.ok(i):H.error(new lt(`Expected ${this.prefix}.*, got ${i}`,[])))}generate(){const t=Ye(this.randomLength,()=>et(Pt)).join("");return`${this.prefix}.${t}`}}const j=new ve("key"),St=F({id:j.parse,position:w.parse}),ge=new ve("shv"),Et=F({id:ge.parse,keyPointId:j.parse,rawPoints:pt(w.parse)}),qe=new ve("doc"),Ct=F({id:qe.parse,keyPoints:ze(j.parse,St),shapeVersions:ze(ge.parse,Et)});function Dt(){return{id:qe.generate(),keyPoints:{},shapeVersions:{}}}const It=30,Tt=500,zt=10,J={size:16,streamline:.5,smoothing:.5,thinning:.5,simulatePressure:!0,easing:e=>e,start:{},end:{},last:!1};class me{constructor(t,n,r,i,o){this.id=t,this.keyPoints=n,this.shapeVersions=r,this.keyPointIdByShapeVersion=i,this.normalizedShapeVersions=o}with(t){var n,r,i,o,s;return new me((n=t.id)!=null?n:this.id,(r=t.keyPoints)!=null?r:this.keyPoints,(i=t.shapeVersions)!=null?i:this.shapeVersions,(o=t.keyPointIdByShapeVersion)!=null?o:this.keyPointIdByShapeVersion,(s=t.normalizedCenterPointsByShapeVersion)!=null?s:this.normalizedShapeVersions)}}class L{static fromArray(t){return new L(tt(t.map(n=>[n.id,n])))}constructor(t){this.data=t}has(t){return De(this.data,t)}getIfExists(t){return Q(this.data,t)}get(t){const n=this.getIfExists(t);return D(n!=null,`Item with id ${t} not found`),n}insert(t){return new L({...this.data,[t.id]:t})}update(t,n){const r=this.get(t),i=$(r,n);return D(r.id===i.id),this.insert(i)}delete(t){const{[t]:n,...r}=this.data;return new L(r)}*[Symbol.iterator](){for(const t in this.data)De(this.data,t)&&(yield ce(this.data[t]))}}class R{constructor(t={}){this.inverse=t}static build(t,n){const r={};for(const i of n){const o=i.id,s=i[t],a=Q(r,s);a?a.push(o):r[s]=[o]}return new R(r)}lookupInverseIfExists(t){var n;return(n=Q(this.inverse,t))==null?void 0:n[0]}lookupInverse(t){const n=this.lookupInverseIfExists(t);return D(n!=null,`Item with id ${t} not found`),n}add(t,n){const r=Q(this.inverse,n);return r?(D(!r.includes(t),`relation ${n}<->${t} already exists in index`),new R({...this.inverse,[n]:[...r,t]})):new R({...this.inverse,[n]:[t]})}remove(t,n){const r=Q(this.inverse,n);if(r){const i=r.indexOf(t);if(i>=0)return r.length>1?new R({...this.inverse,[n]:nt(r,i)}):new R({...this.inverse,[n]:void 0})}Ke(`relation ${n}<->${t} not found in index`)}}const{min:q,PI:dn}=Math,Oe=.275;function Be(e,t={}){const{size:n=16,smoothing:r=.5,thinning:i=.5,simulatePressure:o=!0,easing:s=m=>m,start:a={},end:c={}}=t,{easing:u=m=>m*(2-m)}=a,{easing:d=m=>--m*m*m+1}=c;if(e.length===0||n<=0)return[];const l=e[e.length-1].runningLength,h=a.taper===!1?0:a.taper===!0?Math.max(n,l):a.taper,P=c.taper===!1?0:c.taper===!0?Math.max(n,l):c.taper,v=Math.pow(n*r,2),p=[];let f=e.slice(0,10).reduce((m,b)=>{let M=b.pressure;if(o){const ne=q(1,b.distance/n),K=q(1,1-ne);M=q(1,m+(K-m)*(ne*Oe))}return(m+M)/2},e[0].pressure),g=be(n,i,e[e.length-1].pressure,s),S=e[0].point,z=S;for(let m=0;m<e.length;m++){let{pressure:b}=e[m];const{point:M,distance:ne,runningLength:K}=e[m];if(m<e.length-1&&l-K<3)continue;if(i){if(o){const Ce=q(1,ne/n),_e=q(1,1-Ce);b=q(1,f+(_e-f)*(Ce*Oe))}g=be(n,i,b,s)}else g=n/2;const He=K<h?u(K/h):1,Xe=l-K<P?d((l-K)/P):1;if(g=Math.max(.01,g*Math.min(He,Xe)),m===e.length-1){p.push({center:M,radius:g});continue}z=M,(m<=1||S.distanceToSq(z)>v)&&(p.push({center:M,radius:g}),S=z),f=b}return p}function Fe(e,t={}){var h,P;const{streamline:n=.5,size:r=16,last:i=!1}=t;if(e.length===0)return[];const o=.15+(1-n)*.85;let s=e.map(v=>({point:w.fromVectorLike(v),pressure:v.pressure}));if(s.length===2){const v=s[1];s=s.slice(0,-1);for(let p=1;p<5;p++)s.push({point:s[0].point.lerp(v.point,p/4),pressure:v.pressure})}s.length===1&&s.push({point:s[0].point.add(w.UNIT),pressure:s[0].pressure});const a=[{point:s[0].point,pressure:s[0].pressure!=null&&s[0].pressure>=0?s[0].pressure:.25,vector:w.UNIT,distance:0,runningLength:0}];let c=!1,u=0,d=a[0];const l=s.length-1;for(let v=1;v<s.length;v++){const p=s[v],f=i&&v===l?p.point:d.point.lerp(p.point,o);if(d.point.equals(f))continue;const g=f.distanceTo(d.point);if(u+=g,v<l&&!c){if(u<r)continue;c=!0}d={point:f,pressure:p.pressure!=null&&p.pressure>=0?p.pressure:.5,vector:d.point.sub(f).normalize(),distance:g,runningLength:u},a.push(d)}return a[0].vector=(P=(h=a[1])==null?void 0:h.vector)!=null?P:w.ZERO,a}function be(e,t,n,r=i=>i){return e*r(.5-t*(.5-n))}function kt(e){if(!e.length)return"";const t=["M",e[0].x,e[0].y,"Q"];for(let n=0;n<e.length;n++){const r=e[n],i=e[(n+1)%e.length],o=r.add(i).scale(.5);t.push(r.x,r.y,o.x,o.y)}return t.push("Z"),t.join(" ")}function je(e,t){const n=[e[0]];if(e.length===0)return[];let r=t,i=e[0],o=e[0].center;for(let s=1;s<e.length;s++){const a=e[s],c=e[Math.min(s+1,e.length-1)],u=a.center.add(c.center).scale(.5),d=a.center.distanceTo(i.center),l=o,h=a.center,P=u;let v=0;for(;d-v>=r;){const p=(r+v)/d;n.push({center:l.lerp(h,p).lerp(h.lerp(P,p),p),radius:rt(i.radius,a.radius,p)}),v+=r,r=t}r-=d-v,i=a,o=u}return n.push(e[e.length-1]),n}function le(e){var i,o;if(e.length===0)return{versions:new L({})};const t=[];let n=0;for(const s of e){const a=Fe(s.rawPoints),c=(o=(i=a[a.length-1])==null?void 0:i.runningLength)!=null?o:0;t.push({id:s.id,strokePoints:a,length:c}),c>n&&(n=c)}const r=Math.floor(n/J.size);return{versions:L.fromArray(t.map(({strokePoints:s,length:a,id:c})=>({id:c,length:a,normalizedCenterPoints:je(Be(s,J),a/r)})))}}function N(){}N.prototype={diff:function(t,n){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=r.callback;typeof r=="function"&&(i=r,r={}),this.options=r;var o=this;function s(p){return i?(setTimeout(function(){i(void 0,p)},0),!0):p}t=this.castInput(t),n=this.castInput(n),t=this.removeEmpty(this.tokenize(t)),n=this.removeEmpty(this.tokenize(n));var a=n.length,c=t.length,u=1,d=a+c;r.maxEditLength&&(d=Math.min(d,r.maxEditLength));var l=[{newPos:-1,components:[]}],h=this.extractCommon(l[0],n,t,0);if(l[0].newPos+1>=a&&h+1>=c)return s([{value:this.join(n),count:n.length}]);function P(){for(var p=-1*u;p<=u;p+=2){var f=void 0,g=l[p-1],S=l[p+1],z=(S?S.newPos:0)-p;g&&(l[p-1]=void 0);var m=g&&g.newPos+1<a,b=S&&0<=z&&z<c;if(!m&&!b){l[p]=void 0;continue}if(!m||b&&g.newPos<S.newPos?(f=bt(S),o.pushComponent(f.components,void 0,!0)):(f=g,f.newPos++,o.pushComponent(f.components,!0,void 0)),z=o.extractCommon(f,n,t,p),f.newPos+1>=a&&z+1>=c)return s(Ot(o,f.components,n,t,o.useLongestToken));l[p]=f}u++}if(i)(function p(){setTimeout(function(){if(u>d)return i();P()||p()},0)})();else for(;u<=d;){var v=P();if(v)return v}},pushComponent:function(t,n,r){var i=t[t.length-1];i&&i.added===n&&i.removed===r?t[t.length-1]={count:i.count+1,added:n,removed:r}:t.push({count:1,added:n,removed:r})},extractCommon:function(t,n,r,i){for(var o=n.length,s=r.length,a=t.newPos,c=a-i,u=0;a+1<o&&c+1<s&&this.equals(n[a+1],r[c+1]);)a++,c++,u++;return u&&t.components.push({count:u}),t.newPos=a,c},equals:function(t,n){return this.options.comparator?this.options.comparator(t,n):t===n||this.options.ignoreCase&&t.toLowerCase()===n.toLowerCase()},removeEmpty:function(t){for(var n=[],r=0;r<t.length;r++)t[r]&&n.push(t[r]);return n},castInput:function(t){return t},tokenize:function(t){return t.split("")},join:function(t){return t.join("")}};function Ot(e,t,n,r,i){for(var o=0,s=t.length,a=0,c=0;o<s;o++){var u=t[o];if(u.removed){if(u.value=e.join(r.slice(c,c+u.count)),c+=u.count,o&&t[o-1].added){var l=t[o-1];t[o-1]=t[o],t[o]=l}}else{if(!u.added&&i){var d=n.slice(a,a+u.count);d=d.map(function(P,v){var p=r[c+v];return p.length>P.length?p:P}),u.value=e.join(d)}else u.value=e.join(n.slice(a,a+u.count));a+=u.count,u.added||(c+=u.count)}}var h=t[s-1];return s>1&&typeof h.value=="string"&&(h.added||h.removed)&&e.equals("",h.value)&&(t[s-2].value+=h.value,t.pop()),t}function bt(e){return{newPos:e.newPos,components:e.components.slice(0)}}var xe=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,Le=/\S/,We=new N;We.equals=function(e,t){return this.options.ignoreCase&&(e=e.toLowerCase(),t=t.toLowerCase()),e===t||this.options.ignoreWhitespace&&!Le.test(e)&&!Le.test(t)};We.tokenize=function(e){for(var t=e.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<t.length-1;n++)!t[n+1]&&t[n+2]&&xe.test(t[n])&&xe.test(t[n+2])&&(t[n]+=t[n+2],t.splice(n+1,2),n--);return t};var ye=new N;ye.tokenize=function(e){var t=[],n=e.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var r=0;r<n.length;r++){var i=n[r];r%2&&!this.options.newlineIsToken?t[t.length-1]+=i:(this.options.ignoreWhitespace&&(i=i.trim()),t.push(i))}return t};function xt(e,t,n){return ye.diff(e,t,n)}var Lt=new N;Lt.tokenize=function(e){return e.split(/(\S.+?[.!?])(?=\s+|$)/)};var Vt=new N;Vt.tokenize=function(e){return e.split(/([{}:;,]|\s+)/)};function ie(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ie=function(t){return typeof t}:ie=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ie(e)}var Nt=Object.prototype.toString,_=new N;_.useLongestToken=!0;_.tokenize=ye.tokenize;_.castInput=function(e){var t=this.options,n=t.undefinedReplacement,r=t.stringifyReplacer,i=r===void 0?function(o,s){return typeof s>"u"?n:s}:r;return typeof e=="string"?e:JSON.stringify(pe(e,null,null,i),i,"  ")};_.equals=function(e,t){return N.prototype.equals.call(_,e.replace(/,([\r\n])/g,"$1"),t.replace(/,([\r\n])/g,"$1"))};function pe(e,t,n,r,i){t=t||[],n=n||[],r&&(e=r(i,e));var o;for(o=0;o<t.length;o+=1)if(t[o]===e)return n[o];var s;if(Nt.call(e)==="[object Array]"){for(t.push(e),s=new Array(e.length),n.push(s),o=0;o<e.length;o+=1)s[o]=pe(e[o],t,n,r,i);return t.pop(),n.pop(),s}if(e&&e.toJSON&&(e=e.toJSON()),ie(e)==="object"&&e!==null){t.push(e),s={},n.push(s);var a=[],c;for(c in e)e.hasOwnProperty(c)&&a.push(c);for(a.sort(),o=0;o<a.length;o+=1)c=a[o],s[c]=pe(e[c],t,n,r,c);t.pop(),n.pop()}else s=e;return s}var fe=new N;fe.tokenize=function(e){return e.slice()};fe.join=fe.removeEmpty=function(e){return e};class A{constructor(t,n=0,r=!0){if(this.data=t,this.version=n,!r)return;const i=this.serialize(),o=A.deserialize(i,this.version);if(!de(this,o)){const s=JSON.stringify(this,null,2),a=JSON.stringify(o,null,2),c=xt(s,a);console.log(c),Ke(`Mismatch after update:
Actual:
${JSON.stringify(this,null,2)}

Expected:
${JSON.stringify(o,null,2)}`)}}static create(){return A.deserialize(Dt())}static deserialize(t,n=0){const r=new L(t.shapeVersions);return new A(new me(t.id,new L(t.keyPoints),r,R.build("keyPointId",r),le(Array.from(r)).versions),n,!1)}with(...t){return new A(this.data.with(...t),this.version+1)}serialize(){return{id:this.data.id,keyPoints:this.data.keyPoints.data,shapeVersions:this.data.shapeVersions.data}}get keyPoints(){return this.data.keyPoints}get shapeVersions(){return this.data.shapeVersions}getShapeVersionForKeyPoint(t){return this.shapeVersions.get(this.data.keyPointIdByShapeVersion.lookupInverse(t))}addKeyPoint(t,n){console.log("doc.addKeyPoint",t);const r=ge.generate(),i=this.keyPoints.insert({id:t,position:n}),o=this.shapeVersions.insert({id:r,keyPointId:t,rawPoints:[]});return this.with({keyPoints:i,shapeVersions:o,keyPointIdByShapeVersion:this.data.keyPointIdByShapeVersion.add(r,t),normalizedCenterPointsByShapeVersion:le(Array.from(o)).versions})}updateKeypoint(t,n){return this.with({keyPoints:this.keyPoints.update(t,n)})}replaceShapeVersionPoints(t,n){console.log("doc.replaceShapeVersionPoints",t);const r=this.shapeVersions.insert({...this.shapeVersions.get(t),rawPoints:n});return this.with({shapeVersions:r,normalizedCenterPointsByShapeVersion:le(Array.from(r)).versions})}}var E=(e=>(e.Draw="draw",e.KeyPoint="keyPoint",e))(E||{});const Kt=ft(E);var Y=(e=>(e.Pan="quickPan",e))(Y||{});const Rt=F({pan:w.parse,zoom:ht});class $t{constructor({pan:t,zoom:n},r,i){this.screenSize=r,this.update=i,this.pan=t,this.zoom=n}handleWheelEvent(t){console.log("wheel",t),t.preventDefault(),t.stopImmediatePropagation();const{deltaX:n,deltaY:r}=t;if(t.ctrlKey){const i=w.fromEvent(t);this.update(({pan:o,zoom:s})=>{const a=Math.exp(-r/100)*s,c=i.add(o).scale(a/s).sub(i);return{zoom:a,pan:c}})}else this.update(({pan:i,zoom:o})=>({pan:i.add(new w(n,r)),zoom:o}))}origin(){return this.pan.sub(this.screenSize.scale(.5*this.zoom))}visibleSceneBounds(){return new $e(this.origin(),this.screenSize)}screenToScene(t){return t.add(this.origin()).scale(1/this.zoom)}sceneToScreen(t){return t.scale(this.zoom).sub(this.origin())}eventSceneCoords(t){return this.screenToScene(w.fromEvent(t))}getSceneTransform(){const t=this.origin();return`translate(${-t.x}, ${-t.y}) scale(${this.zoom}) `}}const Ut=F({keyPointId:j.parse,viewport:Rt,tool:Kt}),we=class{constructor({keyPointId:e,viewport:t={pan:w.ZERO,zoom:1},tool:n=E.Draw}){this.keyPointId=e,this.viewportState=t,this.tool=n}serialize(){return{keyPointId:this.keyPointId,viewport:this.viewportState,tool:this.tool}}with(e){var t,n,r;return new we({keyPointId:(t=e.keyPointId)!=null?t:this.keyPointId,viewport:(n=e.viewport)!=null?n:this.viewportState,tool:(r=e.tool)!=null?r:this.tool})}};let Pe=we;Pe.parse=he(Ut,e=>H.ok(new we(e)));const At=F({doc:he(Ct,e=>H.ok(A.deserialize(e))),location:Pe.parse});function Mt(e){return Ie(`splatapus.${e}`)?At(Ie(`splatapus.${e}`)).mapErr(n=>n.toString()):H.error("No saved data found")}function qt(e,{doc:t,location:n}){it(`splatapus.${e}`,{doc:t.serialize(),location:n.serialize()})}const Bt=ot(Tt,qt);function Ve(){const e=j.generate();return{doc:A.create().addKeyPoint(e,w.ZERO),location:new Pe({keyPointId:e})}}function Ze(e){const t=I.exports.useRef();return I.exports.useLayoutEffect(()=>{t.current=e}),I.exports.useCallback((...n)=>{const r=t.current;return D(r,"fn does not exist"),r(...n)},[])}function Ft(e){return st?e.metaKey:e.ctrlKey}function Qe(e,t){var r,i,o;const n=typeof t=="string"?{key:t}:t;return e.key.toLowerCase()===n.key.toLowerCase()&&((r=n.command)!=null?r:!1)===Ft(e)&&((i=n.shift)!=null?i:!1)===e.shiftKey&&((o=n.alt)!=null?o:!1)===e.altKey}function C(e,t){return Qe(e,t)&&e.repeat===!1}function jt(e){return null}function Se(){return function(t){return{getCanvasClassName:n=>"",Overlay:jt,...t}}}function Ee(e){const t={initialize:n=>({state:"idle",childState:n}),isIdle:n=>n.state==="idle",getState:n=>n.childState,onPointerEvent:(n,r,i)=>{switch(n.eventType){case"down":switch(r.state){case"idle":{const o=e.onDragStart(n,r.childState,i);return o?(n.event.preventDefault(),e.onTap?{state:"dragUnconfirmed",pointerId:n.event.pointerId,startPosition:w.fromEvent(n.event),childState:o,startArg:i}:{state:"dragConfirmed",pointerId:n.event.pointerId,childState:o,startArg:i}):r}case"dragUnconfirmed":case"dragConfirmed":return r;default:throw k(r)}case"move":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;const o=e.onDragMove(n,r.childState);return r.startPosition.distanceTo(w.fromEvent(n.event))>=zt?{state:"dragConfirmed",pointerId:r.pointerId,childState:o,startArg:r.startArg}:Object.is(r.childState,o)?r:{...r,childState:o}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const o=e.onDragMove(n,r.childState);return Object.is(r.childState,o)?r:{...r,childState:o}}default:throw k(r)}case"up":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;let o=e.onDragCancel(n,r.childState);return o=e.onTap?e.onTap(n,o,r.startArg):o,{state:"idle",childState:o}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const o=e.onDragEnd(n,r.childState);return{state:"idle",childState:o}}default:throw k(r)}case"cancel":switch(r.state){case"idle":return r;case"dragUnconfirmed":case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const o=e.onDragCancel(n,r.childState);return{state:"idle",childState:o}}default:throw k(r)}default:k(n.eventType)}},createOnPointerEvent:n=>(r,i,o)=>B(i,n,s=>t.onPointerEvent(r,s,o))};return t}const W=Ee({onDragStart:({event:e,viewport:t})=>({state:"drawing",points:[t.eventSceneCoords(e)]}),onDragMove:({event:e,viewport:t},n)=>({state:"drawing",points:[...n.points,t.eventSceneCoords(e)]}),onDragEnd:({updateDocument:e,location:t},n)=>(e(r=>r.replaceShapeVersionPoints(r.getShapeVersionForKeyPoint(t.keyPointId).id,n.points)),{state:"idle"}),onDragCancel:(e,t)=>({state:"idle"})}),ee=Se()({initialize:()=>({type:E.Draw,gesture:W.initialize({state:"idle"})}),isIdle:e=>W.isIdle(e.gesture),getDebugProperties:e=>{const t=W.getState(e.gesture);switch(t.state){case"idle":return{_:"idle"};case"drawing":return{_:"drawing",points:String(t.points.length)};default:k(t)}},getState:e=>W.getState(e.gesture),onPointerEvent:W.createOnPointerEvent("gesture")});function Wt({position:e,children:t,className:n,style:r,...i}){return y("div",{className:U("absolute top-0 left-0",n),style:{transform:`translate(${e.x}px, ${e.y}px)`,...r},...i,children:t})}function Zt({position:e,viewport:t,screenOffset:n=w.ZERO,...r}){return y(Wt,{position:t.sceneToScreen(e).add(n),...r})}const re=Ee({onTap:({updateLocation:e},t,n)=>(n&&e(r=>r.with({keyPointId:n})),t),onDragStart:({updateLocation:e,viewport:t,event:n},r,i)=>i?(e(o=>o.with({keyPointId:i})),{state:"moving",keyPointId:i,delta:w.ZERO,startingPosition:t.eventSceneCoords(n)}):null,onDragMove:({viewport:e,event:t},n)=>({...n,delta:e.eventSceneCoords(t).sub(n.startingPosition)}),onDragEnd:({event:e,viewport:t,updateDocument:n},r)=>{const i=t.eventSceneCoords(e).sub(r.startingPosition);return n(o=>o.updateKeypoint(r.keyPointId,s=>({...s,position:s.position.add(i)}))),{state:"idle"}},onDragCancel:()=>({state:"idle"})}),Qt=new w(-12,-12),te=Se()({initialize:()=>({type:E.KeyPoint,gesture:re.initialize({state:"idle"})}),isIdle:e=>!0,getDebugProperties:e=>{const t=re.getState(e.gesture);switch(t.state){case"idle":return{_:t.state};case"moving":return{_:t.state,keyPointId:t.keyPointId,delta:t.delta.toString(2)}}},onPointerEvent:re.createOnPointerEvent("gesture"),Overlay:({tool:e,document:t,viewport:n,location:r,onUpdateTool:i})=>{const o=re.getState(e.gesture);return y(Re,{children:Array.from(t.data.keyPoints,(s,a)=>{const c=o.state==="moving"&&o.keyPointId===s.id?s.position.add(o.delta):s.position;return y(Zt,{position:c,screenOffset:Qt,viewport:n,className:U("flex h-6 w-6 cursor-move items-center justify-center rounded-full border border-stone-200 bg-white text-xs text-stone-400 shadow-md",s.id===r.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onPointerDown:u=>{i((d,l)=>te.onPointerEvent({...d,event:u,eventType:"down"},l,s.id))},children:a+1},s.id)})})}}),oe=Ee({onDragStart:({event:e,location:t})=>({state:"active",initialPan:t.viewportState.pan,previousScreenPoint:w.fromEvent(e)}),onDragMove:({event:e,updateViewport:t},n)=>{const r=w.fromEvent(e);return t(({pan:i,zoom:o})=>({pan:i.add(n.previousScreenPoint.sub(r).scale(o)),zoom:o})),{...n,previousScreenPoint:r}},onDragEnd:()=>({state:"idle"}),onDragCancel:({updateViewport:e},t)=>(e(({zoom:n})=>({zoom:n,pan:t.initialPan})),{state:"idle"})}),ae=Se()({initialize:()=>({type:Y.Pan,gesture:oe.initialize({state:"idle"})}),getDebugProperties:e=>{const t=oe.getState(e.gesture);switch(t.state){case"idle":return{_:t.state};case"active":return{_:t.state,initialPan:t.initialPan.toString(2),previousScreenPoint:t.previousScreenPoint.toString(0)}}},isIdle:e=>oe.isIdle(e.gesture),getCanvasClassName:e=>ae.isIdle(e)?"cursor-grab":"cursor-grabbing",gesture:oe}),Ge={[E.Draw]:ee,[E.KeyPoint]:te,[Y.Pan]:ae};function se(e){return Ge[e]}function Je(e){const t=se(e.type).getDebugProperties(e),n=at(t).map(([r,i])=>r.startsWith("_")?i:`${r} = ${i}`).join(", ");return`${e.type}(${n})`}const x={initialize:e=>se(e).initialize(),initializeForKeyDown:({event:e})=>C(e,"d")?ee.initialize():C(e,"k")?te.initialize():null,isIdle:e=>se(e.type).isIdle(e),getCanvasClassName:e=>se(e.type).getCanvasClassName(e),toDebugString:Je,onPointerEvent:(e,t)=>{switch(t.type){case E.Draw:return ee.onPointerEvent(e,t);case E.KeyPoint:return te.onPointerEvent(e,t);default:k(t)}}},Z={initializeForKeyDown:({event:e})=>C(e," ")?ae.initialize():null,toDebugString:Je,getCanvasClassName:e=>Ge[e.type].getCanvasClassName(e),onPointerEvent:(e,t)=>{switch(t.type){case Y.Pan:return B(t,"gesture",n=>ae.gesture.onPointerEvent(e,n))}},onKeyUp:({event:e},t)=>{switch(t.type){case Y.Pan:return Qe(e," ")?null:t}}},V={initialize:e=>({undoStates:[],redoStates:[],pendingOp:null,current:{...e,options:{}}}),beginOperation:e=>{const t=Math.random();return D(e.pendingOp==null,"pending op already in progress"),{undoStack:{...e,pendingOp:{txId:t,initialDoc:e.current.doc,initialOptions:e.current.options},current:{...e.current,options:{}}},txId:t}},updateOperation:(e,t,n)=>{var r;return D(((r=e.pendingOp)==null?void 0:r.txId)===t,"pending op mismatch"),{...e,current:{...e.current,doc:$(e.current.doc,n)}}},revertOperation:(e,t)=>{var n;return D(((n=e.pendingOp)==null?void 0:n.txId)===t,"Pending op mismatch"),{...e,pendingOp:null,current:{doc:e.pendingOp.initialDoc,location:e.current.location,options:e.pendingOp.initialOptions}}},commitOperation:(e,t,n={})=>{var o;D(((o=e.pendingOp)==null?void 0:o.txId)===t,"Pending op mismatch");const r=[{doc:e.pendingOp.initialDoc,location:e.current.location,options:e.pendingOp.initialOptions},...e.undoStates];for(;r.length>It;)r.pop();const i={...e.current,options:n};return n.lockstepLocation&&(i.location=$(i.location,n.lockstepLocation)),{...e,current:i,pendingOp:null,undoStates:r,redoStates:null}},updateDocument:(e,t,n)=>{let r;return{undoStack:e,txId:r}=V.beginOperation(e),e=V.updateOperation(e,r,t),V.commitOperation(e,r,n)},undo:e=>{var i;if(D(e.pendingOp==null,"Pending op in progress"),e.undoStates.length==0)return e;const[t,...n]=e.undoStates;if(!de(t.location,e.current.location)&&!e.current.options.lockstepLocation)return{...e,current:{...e.current,location:t.location}};const r=[e.current,...(i=e.redoStates)!=null?i:[]];return{...e,current:t,undoStates:n,redoStates:r}},redo:e=>{if(D(e.pendingOp==null,"pending op in progress"),!e.redoStates||e.redoStates.length==0)return e;const[t,...n]=e.redoStates;if(!de(t.location,e.current.location)&&!t.options.lockstepLocation)return{...e,current:{...e.current,location:t.location}};const r=[e.current,...e.undoStates];return{...e,current:t.options.lockstepLocation?{...t,location:$(e.current.location,t.options.lockstepLocation)}:t,undoStates:r,redoStates:n.length===0?null:n}},updateLocation:(e,t)=>({...e,current:{...e.current,location:$(e.current.location,t)}})},T={initialize:e=>({quickTool:null,selectedTool:x.initialize(e)}),toDebugString:e=>e.quickTool?Z.toDebugString(e.quickTool):x.toDebugString(e.selectedTool),getCanvasClassName:e=>e.quickTool?Z.getCanvasClassName(e.quickTool):x.getCanvasClassName(e.selectedTool),updateSelectedTool:(e,t)=>B(e,"selectedTool",t),updateQuickTool:(e,t)=>B(e,"quickTool",t),requestSetSelectedTool:(e,t)=>e.quickTool||!x.isIdle(e.selectedTool)?e:{...e,selectedTool:x.initialize(t)},onKeyDown:(e,t)=>{if(x.isIdle(t.selectedTool)){if(!t.quickTool){const i=Z.initializeForKeyDown(e);if(i)return{...t,quickTool:i}}const r=x.initializeForKeyDown(e);if(r&&!t.quickTool)return{...t,selectedTool:r};if(C(e.event,{key:"z",command:!0}))return e.updateUndoStack(i=>V.undo(i)),t;if(C(e.event,{key:"z",command:!0,shift:!0}))return e.updateUndoStack(i=>V.redo(i)),t}if(C(e.event,{key:"0",command:!0}))return e.updateViewport({pan:w.ZERO,zoom:1}),t;const n=r=>{var o;const i=(o=[...e.document.keyPoints][r])==null?void 0:o.id;i&&e.updateLocation(s=>s.with({keyPointId:i}))};return C(e.event,"1")&&n(0),C(e.event,"2")&&n(1),C(e.event,"3")&&n(2),C(e.event,"4")&&n(3),C(e.event,"5")&&n(4),C(e.event,"6")&&n(5),C(e.event,"7")&&n(6),C(e.event,"8")&&n(7),C(e.event,"9")&&n(8),t},onKeyUp:(e,t)=>{if(t.quickTool){const n=Z.onKeyUp(e,t.quickTool);if(n!==t.quickTool)return{...t,quickTool:n}}return t},onPointerEvent:(e,t)=>t.quickTool?T.updateQuickTool(t,n=>Z.onPointerEvent(e,ce(n))):T.updateSelectedTool(t,n=>x.onPointerEvent(e,n)),Overlay:({interaction:e,onUpdateInteraction:t,...n})=>{const r=i=>t((o,s)=>T.updateSelectedTool(s,a=>(D(a.type===s.selectedTool.type),i(o,a))));switch(e.selectedTool.type){case E.Draw:return y(ee.Overlay,{tool:e.selectedTool,onUpdateTool:r,...n});case E.KeyPoint:return y(te.Overlay,{tool:e.selectedTool,onUpdateTool:r,...n});default:k(e.selectedTool)}}};function Gt({selectedToolType:e,updateInteraction:t}){const n=r=>()=>t((i,o)=>T.requestSetSelectedTool(o,r));return G("div",{className:"pointer-events-none absolute top-0 bottom-0 flex cursor-wait flex-col items-center justify-center gap-3 p-3",children:[y(Ne,{letter:"d",isSelected:e===E.Draw,onClick:n(E.Draw)}),y(Ne,{letter:"k",isSelected:e===E.KeyPoint,onClick:n(E.KeyPoint)})]})}function Ne({letter:e,onClick:t,isSelected:n}){return y("button",{className:U("pointer-events-auto flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 bg-white shadow-md",n?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:t,children:e})}function Jt(e){const t=[],n=[];if(e.length===0)return[];if(e.length===1){const l=[];for(let h=0;h<12;h++)l.push(e[0].center.add(w.fromPolar(h*Math.PI/6,e[0].radius)));return l}const r=e[0],o=e[1].center.sub(r.center).normalize(),s=o.perpendicular().scale(r.radius);t.push(r.center.sub(o.scale(r.radius))),t.push(r.center.sub(s)),n.push(r.center.add(s));for(let l=1;l<e.length-1;l++){const h=e[l-1],P=e[l],f=e[l+1].center.sub(h.center).normalize().perpendicular().scale(P.radius);t.push(P.center.sub(f)),n.push(P.center.add(f))}const a=e[e.length-2],c=e[e.length-1],u=c.center.sub(a.center).normalize(),d=u.perpendicular().scale(c.radius);return t.push(c.center.sub(d)),t.push(c.center.add(u.scale(c.radius))),n.push(c.center.add(d)),t.concat(n.reverse())}function Ht({centerPoints:e}){return y("path",{d:kt(Jt(e))})}function Xt({document:e,keyPointId:t,interaction:n}){const r=e.getShapeVersionForKeyPoint(t);let i=e.data.normalizedShapeVersions.get(r.id).normalizedCenterPoints;switch(n.selectedTool.type){case E.Draw:{const o=ee.getState(n.selectedTool);switch(o.state){case"drawing":i=je(Be(Fe(o.points,J),J),J.size);break;case"idle":break;default:k(o)}break}case E.KeyPoint:break;default:k(n.selectedTool)}return y(Ht,{centerPoints:i})}const O={initialize:e=>({undoStack:V.initialize(e),interaction:T.initialize(E.Draw)}),updateUndoStack:(e,t)=>B(e,"undoStack",t),updateLocation:(e,t)=>O.updateUndoStack(e,n=>V.updateLocation(n,t)),updateDocument:(e,t,n)=>O.updateUndoStack(e,r=>V.updateDocument(r,t,n)),updateViewport:(e,t)=>O.updateLocation(e,n=>n.with({viewport:$(n.viewportState,t)})),updateInteraction:(e,t)=>B(e,"interaction",t)};function _t(e){return(t,n)=>{const r=[];let i=!1;function o(a){D(!i),r.push(a)}const s=e();n({update:o,updateUndoStack:a=>o(c=>O.updateUndoStack(c,a)),updateLocation:a=>o(c=>O.updateLocation(c,a)),updateDocument:(a,c)=>o(u=>O.updateDocument(u,a,c)),updateViewport:a=>o(c=>O.updateViewport(c,a)),updateInteraction:a=>o(c=>O.updateInteraction(c,a)),document:t.undoStack.current.doc,location:t.undoStack.current.location,viewport:s.viewport});for(let a=0;a<r.length;a++)t=r[a](t);return i=!0,t}}function Yt(e,t){const n=Ze(t),r=I.exports.useMemo(()=>_t(n),[n]),[i,o]=I.exports.useReducer(r,null,e);return{...I.exports.useMemo(()=>{const a=u=>o(d=>d.updateInteraction(l=>u(d,l))),c=u=>d=>a((l,h)=>T.onPointerEvent({...l,event:d,eventType:u},h));return{updateUndoStack:u=>o(d=>d.updateUndoStack(l=>u(d,l))),updateLocation:u=>o(d=>d.updateLocation(l=>u(d,l))),updateDocument:(u,d)=>o(l=>l.updateDocument(h=>u(l,h),d)),updateViewport:u=>o(d=>d.updateViewport(l=>u(d,l))),updateInteraction:a,onPointerDown:c("down"),onPointerMove:c("move"),onPointerUp:c("up"),onPointerCancel:c("cancel"),onKeyDown:u=>a((d,l)=>T.onKeyDown({...d,event:u},l)),onKeyUp:u=>a((d,l)=>T.onKeyUp({...d,event:u},l))}},[]),document:i.undoStack.current.doc,location:i.undoStack.current.location,interaction:i.interaction}}function en(e,t){const n=t.visibleSceneBounds(),r=$e.fromLeftTopRightBottom(n.left+n.width/10,n.top+n.height/10,n.right-n.width/10,n.bottom-n.height/10),i=Array.from(e.keyPoints,c=>c.position),s=(Math.min(n.width,n.height)/10)**2;let a=r.getCenter();for(let c=0;c<500;c++){if(i.every(u=>u.distanceToSq(a)>s))return a;a=new w(Te(r.left,r.right),Te(r.top,r.bottom))}return a}function tn(){const[e,t]=I.exports.useState(null),n=yt(e,wt);return console.log(n),y("div",{ref:t,className:"absolute inset-0 touch-none",children:n&&y(nn,{size:n})})}function nn({size:e}){const{document:t,location:n,interaction:r,updateDocument:i,updateLocation:o,updateInteraction:s,onPointerDown:a,onPointerMove:c,onPointerUp:u,onPointerCancel:d,onKeyDown:l,onKeyUp:h}=Yt(()=>{{const f=Mt("autosave");if(f.isOk())return O.initialize(f.value);console.error(`Error loading autosave: ${f.error}`)}return O.initialize(Ve())},()=>({viewport:v}));I.exports.useEffect(()=>{Bt("autosave",{doc:t,location:n})},[t,n]);const P=I.exports.useCallback(f=>o((g,S)=>S.with({viewport:$(S.viewportState,f)})),[o]),v=I.exports.useMemo(()=>new $t(n.viewportState,e,P),[n.viewportState,e,P]);I.exports.useEffect(()=>{const f=r.selectedTool.type;o((g,S)=>S.tool!==f?S.with({tool:f}):S)},[r.selectedTool.type,o]);const p=Ze(f=>v.handleWheelEvent(f));return I.exports.useEffect(()=>(window.addEventListener("wheel",p,{passive:!1}),window.addEventListener("keydown",l),window.addEventListener("keyup",h),()=>{window.removeEventListener("wheel",p),window.removeEventListener("keydown",l),window.removeEventListener("keyup",h)}),[l,h,p]),G(Re,{children:[y("div",{className:"pointer-events-none absolute top-0",children:T.toDebugString(r)}),G("div",{className:"absolute inset-0",onPointerDown:a,onPointerMove:c,onPointerUp:u,onPointerCancel:d,children:[y("svg",{viewBox:`0 0 ${e.x} ${e.y}`,className:U("absolute top-0 left-0",T.getCanvasClassName(r)),children:y("g",{transform:v.getSceneTransform(),children:y(Xt,{document:t,keyPointId:n.keyPointId,interaction:r})})}),y(T.Overlay,{interaction:r,viewport:v,document:t,location:n,onUpdateInteraction:s})]}),y(Gt,{selectedToolType:r.selectedTool.type,updateInteraction:s}),G("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-center gap-3 p-3",children:[G("div",{className:"flex min-w-0 flex-auto items-center justify-center gap-3",children:[Array.from(t.keyPoints,(f,g)=>y("button",{className:U("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1",f.id===n.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:()=>{o((S,z)=>z.with({keyPointId:f.id}))},children:g+1},f.id)),y("button",{className:U("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const f=j.generate();i((g,S)=>S.addKeyPoint(f,en(S,v)),{lockstepLocation:g=>g.with({keyPointId:f})})},children:"+"})]}),y("button",{className:U("absolute right-3 flex h-10 flex-none items-center justify-center justify-self-end rounded-full border border-stone-200 px-3 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const{doc:f,location:g}=Ve();i(()=>f,{lockstepLocation:g})},children:"reset"})]})]})}const rn=ce(document.getElementById("root"));Ue(rn).render(y(tn,{}));
