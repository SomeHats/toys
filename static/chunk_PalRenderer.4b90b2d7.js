import{n as g,z as d,D as a,E as D,r as p,F as k,l as O,G as X,B as R,t as b,a as T,m as E}from"./chunk_assert.6e3d4d7d.js";import{C as f}from"./chunk_index.dc2a5aeb.js";import{V as l}from"./chunk_Vector2.cb3dfab2.js";import{C as u}from"./chunk_Entity.540220d2.js";import{C as H}from"./chunk_Circle.c946af55.js";import{S as w,C as M}from"./chunk_CirclePathSegment.9a8e7a13.js";function L(s,t,e,i){s.arc(t,e,i,0,2*Math.PI,!1)}function z(s,t){t.segments.length&&s.moveTo(t.segments[0].getStart().x,t.segments[0].getStart().y);for(const e of t.segments)if(e instanceof w)s.lineTo(e.getEnd().x,e.getEnd().y);else if(e instanceof M)s.arc(e.circle.center.x,e.circle.center.y,e.circle.radius,e.startAngle,e.endAngle,e.isAnticlockwise);else throw new Error(`Unknown path segment type: ${e.toString()}`)}const I=80,B=200,v=200;class F extends u{constructor(t,e){super(t),this.speed=0,this.heading=0,this.headingVelocity=0,this.position=e}getVelocity(){return this.getHeadingVec().scale(this.speed)}getHeadingVec(){return l.fromPolar(this.heading,1)}}class N extends u{constructor(t,e){super(t),this.target=e,this.data=t.addComponent(F,e)}setTarget(t){this.target=t}update(t){const e=t/1e3,i=this.data.position.angleTo(this.target),o=this.target.distanceTo(this.data.position);if(o>15?this.accelerate(B,e):this.accelerate(-v,e),o>10){const n=g(i-this.data.heading),r=this.data.heading;this.data.heading+=n/10,this.data.headingVelocity=g(this.data.heading-r)/e}else this.data.headingVelocity=0}accelerate(t,e){const i=this.data.speed;this.data.speed=d(0,I,this.data.speed+t*e);const o=(i+this.data.speed)/2;this.data.position=this.data.position.add(l.fromPolar(this.data.heading,o*e))}}class $ extends u{constructor(t,e){super(t),this.data=t.addComponent(F,e)}setPosition(t,e,i){const o=this.data.position,n=this.data.heading;this.data.heading=e,this.data.headingVelocity=g(this.data.heading-n)/i,this.data.speed=o.distanceTo(t)/i,this.data.position=t}}new f("#F8FFE5");new f("#06D6A0");const Y=new f("#1B9AAA");new f("#EF476F");new f("#FFC43D");Y.lighten(.2);const J=()=>{const s=a(14,.2),t=a(s*.7,.3),e=a(s*2,.3),i=e-(s-t);return{radius:s,bodHeight:e,bodBob:a(s,.2),eyeY:a(s*.5,.2),eyeX:a(s*.4,.3),eyeRadius:a(s*.15,.4),mouthThickness:a(s*.15,.4),mouthY:D(0,s*.2),mouthWidth:a(s*.5,.3),mouthSmile:a(s*.3,.3),buttTop:a(s*.4,.2),buttBottom:a(s*.85,.15),buttThickness:a(s*.1,.5),color:Y.lighten(p(-.2,.2)).saturate(p(-.2,.2)).rotate(p(-10,10)),hipHeight:t,kneeScale:D(1.3,.3),legMaxLift:p(.2,.5),kneeMaxOut:a(i*.6,.4),stepDuration:a(i*.01,.4),stepRestDuration:a(i*.0083,.4),stepThreshold:a(i*.01,.4),fullStepDistance:a(i*.7,.4),legWidth:a(s*.3,.4),legPairs:k(1,4)}},y=({radius:s,hipHeight:t,legWidth:e})=>Math.sqrt(s*s-(s-t)*(s-t))-e;class A{constructor(t,e,i,o){this.palData=t,this.palGeom=e,this.config=i,this.angleOffset=o,this.liftAmount=0,this.hipRadius=y(i),this.kneeRadius=y(i)*i.kneeScale,this.floorRadius=y(i),this.footXY=this.getIdealFootRestingXY(),this.footOrigin=this.getIdealFootRestingXY()}update(t){this.footXY=t.footXY,this.footOrigin=t.footProjectionOrigin,this.liftAmount=t.liftAmount}getIdealFootRestingXY(){return l.fromPolar(this.palData.heading+this.angleOffset,this.floorRadius).add(this.palData.position)}getFootXY(){return this.footXY}getFootZ(){return O(0,this.getHipZ()*this.config.legMaxLift,this.liftAmount)}getFootOrigin(){return this.footOrigin}getKneeXY(){return this.palData.position.add(l.fromPolar(this.palData.heading+this.angleOffset,this.kneeRadius)).add(l.fromPolar(this.palData.heading,this.liftAmount*this.config.kneeMaxOut))}getKneeZ(){return(this.getFootZ()+this.getHipZ())/2}getKneeOrigin(){return this.getHipOrigin().lerp(this.getFootOrigin(),.5)}getHipXY(){return this.palData.position.add(l.fromPolar(this.palData.heading+this.angleOffset,this.hipRadius))}getHipZ(){const t=this.palGeom.getBod();return this.palData.position.y-t.center.y-(t.radius-this.config.hipHeight)}getHipOrigin(){return this.palData.position}}const m=Math.PI/2;class Z extends u{constructor(t,e){super(t),this.config=e,this.animationController=null,this.bobAmount=0,this.controlData=t.getComponent(F),this.legs=X(R(b(e.legPairs,i=>{const o=(i+1)/(e.legPairs+1);return[new A(this.controlData,this,e,O(m-1,m+1,o)),new A(this.controlData,this,e,O(-m+1,-m-1,o))]})))}setAnimationController(t){this.animationController=t}update(t){if(this.animationController){const e=this.animationController.update(t,this.controlData,this.legs);this.bobAmount=e.bobAmount,T(e.legs.length===this.legs.length,"Assertion Error: update.legs.length === this.legs.length"),this.legs.forEach((i,o)=>i.update(e.legs[o]))}}getBod(){const t=this.config.bodBob*this.bobAmount;return H.create(this.controlData.position.x,this.controlData.position.y-this.config.bodHeight-t,this.config.radius)}}function P({stepProgress:s}){return s>0}function V({restTimer:s}){return s>0}class Q{constructor(t){this.config=t,this.legStates=new Map}update(t,e,i){const o=t/1e3;for(const h of i)this.updateLegState(o,e,i,h);const n=i.map(h=>this.getLegUpdate(e,h));return{bobAmount:n.reduce((h,C)=>h+C.liftAmount,0)/i.length,legs:n}}canLiftLeg(t,e,i){T(e.includes(i),"whos leg even is this");const o=e.filter(r=>r!==i&&!P(this.getLegState(t,i))).length>Math.floor(Math.log(e.length)),n=e.some(r=>{const c=this.getLegState(t,r);return c.stepProgress>0&&c.stepProgress<1/(e.length/2)});return o&&!n}updateLegState(t,e,i,o){const n=this.getLegState(e,o);if(n.restTimer=d(0,this.config.stepRestDuration,n.restTimer-t),!V(n))if(P(n))n.stepProgress=d(0,1,n.stepProgress+t/this.config.stepDuration),n.stepProgress===1&&(n.lastFootOnFloorXY=this.getFootXY(e,o,n),n.lastFootOnFloorPalPosition=e.position,n.stepProgress=0,n.restTimer=this.config.stepDuration);else{const r=o.getFootXY().distanceTo(o.getIdealFootRestingXY());r>this.config.stepThreshold&&this.canLiftLeg(e,i,o)&&(n.currentStepMaxLift=d(0,1,E(this.config.stepThreshold,this.config.fullStepDistance,.1,1,r)),n.stepProgress=d(0,1,n.stepProgress+t/this.config.stepDuration))}}getInitialLegState(t,e){return{lastFootOnFloorXY:e.getIdealFootRestingXY(),lastFootOnFloorPalPosition:t.position,stepProgress:0,restTimer:0,currentStepMaxLift:1}}getLegState(t,e){const i=this.legStates.get(e);if(i)return i;const o=this.getInitialLegState(t,e);return this.legStates.set(e,o),o}getLegUpdate(t,e){const i=this.getLegState(t,e);return{footXY:this.getFootXY(t,e,i),footProjectionOrigin:this.getFootOrigin(t,e,i),liftAmount:this.getLegLiftAmount(i)}}getFootXY(t,e,i){if(P(i)){const o=i.lastFootOnFloorXY,n=this.getPredictedIdealFootXYAtEndOfOfStep(t,e,i);return o.lerp(n,i.stepProgress)}return i.lastFootOnFloorXY}getFootOrigin(t,e,i){return P(i)?i.lastFootOnFloorPalPosition.lerp(t.position,i.stepProgress):i.lastFootOnFloorPalPosition}getPredictedIdealFootXYAtEndOfOfStep(t,e,i){const o=(1.4-i.stepProgress)*this.config.stepDuration,n=t.getVelocity().scale(o).add(t.position),r=t.heading+t.headingVelocity*o;return l.fromPolar(r+e.angleOffset,e.floorRadius).add(n)}getLegLiftAmount({stepProgress:t,currentStepMaxLift:e}){return Math.sin(t*Math.PI)*e}}const W=.3,S=Math.PI/2;class x extends u{constructor(t,e){super(t),this.config=e,this.data=t.getComponent(F),this.geom=t.getComponent(Z)}draw(t){const e=g(this.data.heading);t.setLineDash([]),t.beginPath();const i=this.geom.getBod();t.ellipse(this.data.position.x,this.data.position.y,i.radius*.8,i.radius*.8*.3,0,0,2*Math.PI),t.fillStyle="rgba(0, 0, 0, 0.2)",t.fill(),this.geom.legs.filter(o=>g(o.angleOffset+e)<0).forEach(o=>this.drawLeg(t,o)),this.geom.legs.filter(o=>g(o.angleOffset+e)>=0).forEach(o=>this.drawLeg(t,o)),this.drawBod(t,i)}drawLeg(t,e){t.beginPath();const i=this.data.heading+e.angleOffset,o=d(0,1,Math.abs(g(-S-i)/S)),n=this.config.color.darken(.2*(1-o*o)),r=this.projectZ(e.getHipXY(),e.getHipZ(),e.getHipOrigin()),c=this.projectZ(e.getKneeXY(),e.getKneeZ(),e.getKneeOrigin()),h=this.projectZ(e.getFootXY(),e.getFootZ(),e.getFootOrigin());t.moveTo(r.x,r.y),t.quadraticCurveTo(c.x,c.y,h.x,h.y),t.lineCap="round",t.strokeStyle=n.toString(),t.lineWidth=this.config.legWidth,t.stroke()}drawBod(t,e){t.save(),t.beginPath(),L(t,e.center.x,e.center.y,this.config.radius),t.fillStyle=this.config.color.toString(),t.fill(),t.clip();const i=g(S-this.data.heading)/S*this.config.radius;t.beginPath(),L(t,i+e.center.x+this.config.eyeX,e.center.y-this.config.eyeY,this.config.eyeRadius),L(t,i+e.center.x-this.config.eyeX,e.center.y-this.config.eyeY,this.config.eyeRadius),t.fillStyle=this.config.color.darken(.5).toString(),t.fill(),t.beginPath(),t.moveTo(i+e.center.x-this.config.mouthWidth,e.center.y-this.config.mouthY),t.quadraticCurveTo(i+e.center.x,e.center.y-this.config.mouthY+this.config.mouthSmile,i+e.center.x+this.config.mouthWidth,e.center.y-this.config.mouthY),t.lineWidth=this.config.mouthThickness,t.strokeStyle=this.config.color.darken(.5).toString(),t.stroke(),t.beginPath(),this.makeButtLine(t,e,i+this.config.radius*2),this.makeButtLine(t,e,i-this.config.radius*2),t.lineWidth=this.config.buttThickness,t.strokeStyle=this.config.color.darken(.3).toString(),t.stroke(),t.restore()}makeButtLine(t,e,i){t.moveTo(i*1.6+e.center.x,e.center.y+this.config.buttTop),t.quadraticCurveTo(i*1.7+e.center.x,e.center.y+(this.config.buttTop+this.config.buttBottom)*.65,i+e.center.x,e.center.y+this.config.buttBottom)}projectZ(t,e,i){return new l(t.x,i.y-e+(t.y-i.y)*W)}}export{$ as P,Z as a,Q as b,L as c,x as d,N as e,J as g,z as p};
