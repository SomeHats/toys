var Re=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var E=(t,e,n)=>(Re(t,e,"read from private field"),n?n.call(t):e.get(t)),R=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},U=(t,e,n,r)=>(Re(t,e,"write to private field"),r?r.call(t,n):e.set(t,n),n);import{t as N,s as wt,N as Ve,h as Ue,g as yt,a as I,O as j,b as Le,l as nt,f as le,P as je,E as Pt,D as Ze,G as St,c as D,Q as ee,e as It,r as Je}from"../chunks/chunk_assert.67ae27bf.js";/* empty css                               */import{r as x}from"../chunks/chunk_index.b0b8f4df.js";import{e as De,d as We,b,m as Ct,u as rt,a as Et,s as Tt,c as kt}from"../chunks/chunk_debugPropsToString.827f18ab.js";import{c as B}from"../chunks/chunk_index.01d43779.js";import{b as Oe,R as de,P as Dt,d as bt,c as Q,V as v,a as zt,e as Ce,f as xt,p as Vt}from"../chunks/chunk_Vector2.60c0b602.js";import{A as ot}from"../chunks/chunk_AABB.e3ed9fa1.js";import{j as w,F as Ae,a as M}from"../chunks/chunk_jsx-runtime.14e4b900.js";import{b as Lt}from"../chunks/chunk_easings.49fa61fa.js";const Ot="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");class Ie{constructor(e,n=16){this.randomLength=n,this.debugIdCounter=0,this.prefix=e,this.Id=`${e}.SAMPLE`;const r=new RegExp(`^${this.prefix}\\.([a-zA-Z0-9_]+)$`);this.parse=Oe(bt,o=>r.test(o)?de.ok(o):de.error(new Dt(`Expected ${this.prefix}.*, got ${o}`,[])))}generate(){const e=N(this.randomLength,()=>wt(Ot)).join("");return`${this.prefix}.${e}`}}const ne=new Ie("key"),At=Q({id:ne.parse,position:v.parse}),re=new Ie("shp"),Nt=Q({id:re.parse}),Ne=new Ie("shv"),Mt=Q({id:Ne.parse,keyPointId:ne.parse,shapeId:re.parse,rawPoints:zt(v.parse)}),it=new Ie("doc"),$t=Q({id:it.parse,keyPoints:Ce(ne.parse,At),shapes:Ce(re.parse,Nt),shapeVersions:Ce(Ne.parse,Mt)});function Bt(){return{id:it.generate(),keyPoints:{},shapes:{},shapeVersions:{}}}const st=300,Kt=30,Ft=500,qt=10,ce={size:16,streamline:.5,smoothing:.5,thinning:.5,simulatePressure:!0,easing:t=>t,start:{},end:{},last:!1};class A{static fromArray(e){return new A(Ve(e.map(n=>[n.id,n])))}constructor(e){this.data=e}has(e){return Ue(this.data,e)}getIfExists(e){return yt(this.data,e)}get(e){const n=this.getIfExists(e);return I(n!=null,`Item with id ${e} not found`),n}insert(e){return new A({...this.data,[e.id]:e})}update(e,n){const r=this.get(e),o=j(r,n);return I(r.id===o.id),this.insert(o)}delete(e){const{[e]:n,...r}=this.data;return new A(r)}*[Symbol.iterator](){for(const e in this.data)Ue(this.data,e)&&(yield Le(this.data[e]))}toJSON(){return this.data}}var $,J,X;const Pe=class{constructor(e,n,r,o){R(this,$,void 0);R(this,J,void 0);R(this,X,void 0);this.index=e,U(this,$,n),U(this,J,r),U(this,X,o)}static build(e,n,r,o){const i=new Map;for(const s of e){const a=n(s);I(!i.has(a)),i.set(a,r(s))}return new Pe(i,n,r,o)}withIndex(e){return new Pe(e,E(this,$),E(this,J),E(this,X))}lookup(e){return this.index.get(E(this,X).call(this,e))}insert(e){const n=E(this,$).call(this,e);I(!this.index.has(n),`key ${n} already exists in index`);const r=new Map(this.index);return r.set(n,E(this,J).call(this,e)),this.withIndex(r)}remove(e){const n=E(this,$).call(this,e);I(this.index.has(n),`key ${n} does not exist in index`);const r=new Map(this.index);return r.delete(n),this.withIndex(r)}update(e){const n=E(this,$).call(this,e);I(this.index.has(n),`key ${n} does not exist in index`);const r=new Map(this.index);return r.set(n,E(this,J).call(this,e)),this.withIndex(r)}toJSON(){return Ve(this.index)}};let be=Pe;$=new WeakMap,J=new WeakMap,X=new WeakMap;const Rt=new Set;var W,G,Y;const Se=class{constructor(e,n,r,o){R(this,W,void 0);R(this,G,void 0);R(this,Y,void 0);this.index=e,U(this,W,n),U(this,G,r),U(this,Y,o)}static build(e,n,r,o){const i=new Map;for(const s of e){const a=n(s);let l=i.get(a);l||(l=new Set,i.set(a,l)),l.add(r(s))}return new Se(i,n,r,o)}withIndex(e){return new Se(e,E(this,W),E(this,G),E(this,Y))}lookup(e){var n;return(n=this.index.get(E(this,Y).call(this,e)))!=null?n:Rt}insert(e){const n=E(this,W).call(this,e),r=E(this,G).call(this,e),o=this.index.get(n);let i;o?(I(!o.has(r),"already exists"),i=new Set(o)):i=new Set,i.add(r);const s=new Map(this.index);return s.set(n,i),this.withIndex(s)}remove(e){const n=E(this,W).call(this,e),r=E(this,G).call(this,e),o=this.index.get(n);I(o&&o.has(r),"value does not exist"),new Set(o).delete(r);const s=new Map(this.index);return s.delete(n),this.withIndex(s)}update(e,n){return this.remove(e).insert(n)}toJSON(){return Ve(this.index)}};let we=Se;W=new WeakMap,G=new WeakMap,Y=new WeakMap;const{min:H,PI:$n}=Math,Ge=.275;function at(t,e={}){const{size:n=16,smoothing:r=.5,thinning:o=.5,simulatePressure:i=!0,easing:s=P=>P,start:a={},end:l={}}=e,{easing:c=P=>P*(2-P)}=a,{easing:p=P=>--P*P*P+1}=l;if(t.length===0||n<=0)return[];const u=t[t.length-1].runningLength,d=a.taper===!1?0:a.taper===!0?Math.max(n,u):a.taper,f=l.taper===!1?0:l.taper===!0?Math.max(n,u):l.taper,m=Math.pow(n*r,2),h=[];let y=t.slice(0,10).reduce((P,L)=>{let _=L.pressure;if(i){const ge=H(1,L.distance/n),q=H(1,1-ge);_=H(1,P+(q-P)*(ge*Ge))}return(P+_)/2},t[0].pressure),g=Qe(n,o,t[t.length-1].pressure,s),C=t[0].point,S=C;for(let P=0;P<t.length;P++){let{pressure:L}=t[P];const{point:_,distance:ge,runningLength:q}=t[P];if(P<t.length-1&&u-q<3)continue;if(o){if(i){const qe=H(1,ge/n),vt=H(1,1-qe);L=H(1,y+(vt-y)*(qe*Ge))}g=Qe(n,o,L,s)}else g=n/2;const gt=q<d?c(q/d):1,mt=u-q<f?p((u-q)/f):1;if(g=Math.max(.01,g*Math.min(gt,mt)),P===t.length-1){h.push({center:_,radius:g});continue}S=_,(P<=1||C.distanceToSq(S)>m)&&(h.push({center:_,radius:g}),C=S),y=L}return h}function lt(t,e={}){var d,f;const{streamline:n=.5,size:r=16,last:o=!1}=e;if(t.length===0)return[];const i=.15+(1-n)*.85;let s=t.map(m=>({point:v.fromVectorLike(m),pressure:m.pressure}));if(s.length===2){const m=s[1];s=s.slice(0,-1);for(let h=1;h<5;h++)s.push({point:s[0].point.lerp(m.point,h/4),pressure:m.pressure})}s.length===1&&s.push({point:s[0].point.add(v.UNIT),pressure:s[0].pressure});const a=[{point:s[0].point,pressure:s[0].pressure!=null&&s[0].pressure>=0?s[0].pressure:.25,vector:v.UNIT,distance:0,runningLength:0}];let l=!1,c=0,p=a[0];const u=s.length-1;for(let m=1;m<s.length;m++){const h=s[m],y=o&&m===u?h.point:p.point.lerp(h.point,i);if(p.point.equals(y))continue;const g=y.distanceTo(p.point);if(c+=g,m<u&&!l){if(c<r)continue;l=!0}p={point:y,pressure:h.pressure!=null&&h.pressure>=0?h.pressure:.5,vector:p.point.sub(y).normalize(),distance:g,runningLength:c},a.push(p)}return a[0].vector=(f=(d=a[1])==null?void 0:d.vector)!=null?f:v.ZERO,a}function Qe(t,e,n,r=o=>o){return t*r(.5-e*(.5-n))}function Ut(t){if(!t.length)return"";const e=["M",t[0].x,t[0].y,"Q"];for(let n=0;n<t.length;n++){const r=t[n],o=t[(n+1)%t.length],i=r.add(o).scale(.5);e.push(r.x,r.y,i.x,i.y)}return e.push("Z"),e.join(" ")}function ct(t,e){const n=[t[0]];if(t.length===0)return[];let r=e,o=t[0],i=t[0].center;for(let s=1;s<t.length;s++){const a=t[s],l=t[Math.min(s+1,t.length-1)],c=a.center.add(l.center).scale(.5),p=a.center.distanceTo(o.center),u=i,d=a.center,f=c;let m=0;for(;p-m>=r;){const h=(r+m)/p;n.push({center:u.lerp(d,h).lerp(d.lerp(f,h),h),radius:nt(o.radius,a.radius,h)}),m+=r,r=e}r-=p-m,o=a,i=c}return n.push(t[t.length-1]),n}function Ee(t){var i,s;const e=Array.from(t);if(e.length===0)return{versions:new A({})};const n=[];let r=0;for(const a of e){const l=lt(a.rawPoints),c=(s=(i=l[l.length-1])==null?void 0:i.runningLength)!=null?s:0;n.push({id:a.id,strokePoints:l,length:c}),c>r&&(r=c)}const o=Math.floor(r/ce.size);return{versions:A.fromArray(n.map(({strokePoints:a,length:l,id:c})=>({id:c,length:l,normalizedCenterPoints:ct(at(a,ce),l/o)})))}}function F(){}F.prototype={diff:function(e,n){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=r.callback;typeof r=="function"&&(o=r,r={}),this.options=r;var i=this;function s(h){return o?(setTimeout(function(){o(void 0,h)},0),!0):h}e=this.castInput(e),n=this.castInput(n),e=this.removeEmpty(this.tokenize(e)),n=this.removeEmpty(this.tokenize(n));var a=n.length,l=e.length,c=1,p=a+l;r.maxEditLength&&(p=Math.min(p,r.maxEditLength));var u=[{newPos:-1,components:[]}],d=this.extractCommon(u[0],n,e,0);if(u[0].newPos+1>=a&&d+1>=l)return s([{value:this.join(n),count:n.length}]);function f(){for(var h=-1*c;h<=c;h+=2){var y=void 0,g=u[h-1],C=u[h+1],S=(C?C.newPos:0)-h;g&&(u[h-1]=void 0);var P=g&&g.newPos+1<a,L=C&&0<=S&&S<l;if(!P&&!L){u[h]=void 0;continue}if(!P||L&&g.newPos<C.newPos?(y=Zt(C),i.pushComponent(y.components,void 0,!0)):(y=g,y.newPos++,i.pushComponent(y.components,!0,void 0)),S=i.extractCommon(y,n,e,h),y.newPos+1>=a&&S+1>=l)return s(jt(i,y.components,n,e,i.useLongestToken));u[h]=y}c++}if(o)(function h(){setTimeout(function(){if(c>p)return o();f()||h()},0)})();else for(;c<=p;){var m=f();if(m)return m}},pushComponent:function(e,n,r){var o=e[e.length-1];o&&o.added===n&&o.removed===r?e[e.length-1]={count:o.count+1,added:n,removed:r}:e.push({count:1,added:n,removed:r})},extractCommon:function(e,n,r,o){for(var i=n.length,s=r.length,a=e.newPos,l=a-o,c=0;a+1<i&&l+1<s&&this.equals(n[a+1],r[l+1]);)a++,l++,c++;return c&&e.components.push({count:c}),e.newPos=a,l},equals:function(e,n){return this.options.comparator?this.options.comparator(e,n):e===n||this.options.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],r=0;r<e.length;r++)e[r]&&n.push(e[r]);return n},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function jt(t,e,n,r,o){for(var i=0,s=e.length,a=0,l=0;i<s;i++){var c=e[i];if(c.removed){if(c.value=t.join(r.slice(l,l+c.count)),l+=c.count,i&&e[i-1].added){var u=e[i-1];e[i-1]=e[i],e[i]=u}}else{if(!c.added&&o){var p=n.slice(a,a+c.count);p=p.map(function(f,m){var h=r[l+m];return h.length>f.length?h:f}),c.value=t.join(p)}else c.value=t.join(n.slice(a,a+c.count));a+=c.count,c.added||(l+=c.count)}}var d=e[s-1];return s>1&&typeof d.value=="string"&&(d.added||d.removed)&&t.equals("",d.value)&&(e[s-2].value+=d.value,e.pop()),e}function Zt(t){return{newPos:t.newPos,components:t.components.slice(0)}}var _e=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,He=/\S/,ut=new F;ut.equals=function(t,e){return this.options.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t===e||this.options.ignoreWhitespace&&!He.test(t)&&!He.test(e)};ut.tokenize=function(t){for(var e=t.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&_e.test(e[n])&&_e.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};var dt=new F;dt.tokenize=function(t){var e=[],n=t.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var r=0;r<n.length;r++){var o=n[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=o:(this.options.ignoreWhitespace&&(o=o.trim()),e.push(o))}return e};var Jt=new F;Jt.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var Wt=new F;Wt.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function ve(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ve=function(e){return typeof e}:ve=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ve(t)}var Gt=Object.prototype.toString,te=new F;te.useLongestToken=!0;te.tokenize=dt.tokenize;te.castInput=function(t){var e=this.options,n=e.undefinedReplacement,r=e.stringifyReplacer,o=r===void 0?function(i,s){return typeof s>"u"?n:s}:r;return typeof t=="string"?t:JSON.stringify(ze(t,null,null,o),o,"  ")};te.equals=function(t,e){return F.prototype.equals.call(te,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function Qt(t,e,n){return te.diff(t,e,n)}function ze(t,e,n,r,o){e=e||[],n=n||[],r&&(t=r(o,t));var i;for(i=0;i<e.length;i+=1)if(e[i]===t)return n[i];var s;if(Gt.call(t)==="[object Array]"){for(e.push(t),s=new Array(t.length),n.push(s),i=0;i<t.length;i+=1)s[i]=ze(t[i],e,n,r,o);return e.pop(),n.pop(),s}if(t&&t.toJSON&&(t=t.toJSON()),ve(t)==="object"&&t!==null){e.push(t),s={},n.push(s);var a=[],l;for(l in t)t.hasOwnProperty(l)&&a.push(l);for(a.sort(),i=0;i<a.length;i+=1)l=a[i],s[l]=ze(t[l],e,n,r,l);e.pop(),n.pop()}else s=t;return s}var xe=new F;xe.tokenize=function(t){return t.slice()};xe.join=xe.removeEmpty=function(t){return t};class Z{constructor(e,n=0,r=!0){if(this.data=e,this.version=n,!r)return;const o=this.serialize(),i=Z.deserialize(o,this.version);if(!De(this,i)){console.log({actual:this,expected:i});const s=JSON.stringify(this,null,2),a=JSON.stringify(i,null,2);for(const l of Qt(s,a))console.log("CHANGE",l);le(`Mismatch after update:
Actual:
${JSON.stringify(this,null,2)}

Expected:
${JSON.stringify(i,null,2)}`)}}static create(){return Z.deserialize(Bt())}static deserialize(e,n=0){const r=new A(e.shapeVersions);return new Z({id:e.id,keyPoints:new A(e.keyPoints),shapes:new A(e.shapes),shapeVersions:r,shapeVersionLookup:be.build(r,o=>`${o.shapeId}/${o.keyPointId}`,o=>o.id,([o,i])=>`${o}/${i}`),shapeVersionIdsByShape:we.build(r,o=>o.shapeId,o=>o.id,je),shapeVersionIdsByKeyPoint:we.build(r,o=>o.keyPointId,o=>o.id,je),normalizedShapeVersions:Ee(Array.from(r)).versions},n,!1)}with(e){return new Z({...this.data,...e},this.version+1)}serialize(){return{id:this.data.id,keyPoints:this.data.keyPoints.data,shapes:this.data.shapes.data,shapeVersions:this.data.shapeVersions.data}}get shapes(){return this.data.shapes}get keyPoints(){return this.data.keyPoints}get shapeVersions(){return this.data.shapeVersions}getShapeVersion(e,n){const r=this.data.shapeVersionLookup.lookup([n,e]);return r?this.shapeVersions.get(r):null}getNormalizedCenterPointsForShapeVersion(e){return this.data.normalizedShapeVersions.get(e).normalizedCenterPoints}*iterateShapeVersionsForShape(e){for(const n of this.data.shapeVersionIdsByShape.lookup(e))yield this.shapeVersions.get(n)}addShape(e){console.log("doc.addShape",e);const n=this.shapes.insert({id:e});return this.with({shapes:n})}addKeyPoint(e,n){console.log("doc.addKeyPoint",e);const r=this.keyPoints.insert({id:e,position:n});return this.with({keyPoints:r})}updateKeypoint(e,n){return this.with({keyPoints:this.keyPoints.update(e,n)})}replacePointsForVersion(e,n,r){const o=this.getShapeVersion(e,n);if(o){const a=this.shapeVersions.insert({...o,rawPoints:r});return this.with({shapeVersions:a,normalizedShapeVersions:Ee(a).versions})}const i={id:Ne.generate(),keyPointId:e,shapeId:n,rawPoints:r},s=this.shapeVersions.insert(i);return this.with({shapeVersions:s,normalizedShapeVersions:Ee(s).versions,shapeVersionLookup:this.data.shapeVersionLookup.insert(i),shapeVersionIdsByShape:this.data.shapeVersionIdsByShape.insert(i),shapeVersionIdsByKeyPoint:this.data.shapeVersionIdsByKeyPoint.insert(i)})}}var T=(t=>(t.Draw="draw",t.KeyPoint="keyPoint",t))(T||{});const _t=xt(T);var pe=(t=>(t.Pan="quickPan",t))(pe||{});const Ht=Q({pan:v.parse,zoom:Vt});class Xt{constructor({pan:e,zoom:n},r,o){this.screenSize=r,this.update=o,this.pan=e,this.zoom=n}canvasScreenSize(){return this.screenSize.sub(new v(st,0))}handleWheelEvent(e){console.log("wheel",e),e.preventDefault(),e.stopImmediatePropagation();const{deltaX:n,deltaY:r}=e;if(e.ctrlKey){const o=v.fromEvent(e);this.update(({pan:i,zoom:s})=>{const a=Math.exp(-r/100)*s,l=o.add(i).scale(a/s).sub(o);return{zoom:a,pan:l}})}else this.update(({pan:o,zoom:i})=>({pan:o.add(new v(n,r)),zoom:i}))}origin(){return this.pan.sub(this.canvasScreenSize().scale(.5*this.zoom))}visibleSceneBounds(){return new ot(this.origin(),this.canvasScreenSize())}screenToScene(e){return e.add(this.origin()).scale(1/this.zoom)}sceneToScreen(e){return e.scale(this.zoom).sub(this.origin())}eventSceneCoords(e){return this.screenToScene(v.fromEvent(e))}getSceneTransform(){const e=this.origin();return`translate(${-e.x}, ${-e.y}) scale(${this.zoom}) `}}const Yt=Q({keyPointId:ne.parse,shapeId:re.parse,viewport:Ht,tool:_t}),Me=class{constructor({keyPointId:t,shapeId:e,viewport:n={pan:v.ZERO,zoom:1},tool:r=T.Draw}){this.keyPointId=t,this.shapeId=e,this.viewportState=n,this.tool=r}serialize(){return{keyPointId:this.keyPointId,shapeId:this.shapeId,viewport:this.viewportState,tool:this.tool}}with(t){var e,n,r,o;return new Me({keyPointId:(e=t.keyPointId)!=null?e:this.keyPointId,shapeId:(n=t.shapeId)!=null?n:this.shapeId,viewport:(r=t.viewport)!=null?r:this.viewportState,tool:(o=t.tool)!=null?o:this.tool})}};let $e=Me;$e.parse=Oe(Yt,t=>de.ok(new Me(t)));const en=Q({doc:Oe($t,t=>de.ok(Z.deserialize(t))),location:$e.parse});function tn(t){return Ze(`splatapus.${t}`)?en(Ze(`splatapus.${t}`)).mapErr(n=>n.toString()):de.error("No saved data found")}function nn(t,{doc:e,location:n}){St(`splatapus.${t}`,{doc:e.serialize(),location:n.serialize()})}const rn=Pt(Ft,nn);function Xe(){const t=ne.generate(),e=re.generate();return{doc:Z.create().addKeyPoint(t,v.ZERO).addShape(e).replacePointsForVersion(t,e,[]),location:new $e({keyPointId:t,shapeId:e})}}const Ye={initialize(){return{state:"idle"}},onPointerEvent(t,e){switch(t.eventType){case"down":switch(e.state){case"idle":return{pan:{state:"oneFingerDown",pointerA:{id:t.event.pointerId,startScreenPosition:v.fromEvent(t.event),currentScreenPosition:v.fromEvent(t.event),startEvent:t.event}},passthroughContext:t};case"oneFingerDown":return{pan:{state:"bothFingersDown",pointerA:e.pointerA,pointerB:{id:t.event.pointerId,startScreenPosition:v.fromEvent(t.event),currentScreenPosition:v.fromEvent(t.event),startEvent:t.event},initialPan:t.viewport.pan,initialZoom:t.viewport.zoom},passthroughContext:{...t,eventType:"cancel",event:e.pointerA.startEvent}};case"bothFingersDown":return{pan:e,passthroughContext:t};default:throw D(e)}case"move":switch(e.state){case"idle":return{pan:e,passthroughContext:t};case"oneFingerDown":return e.pointerA.id===t.event.pointerId?{pan:{...e,pointerA:{...e.pointerA,currentScreenPosition:v.fromEvent(t.event)}},passthroughContext:t}:{pan:e,passthroughContext:t};case"bothFingersDown":if(t.event.pointerId===e.pointerA.id||t.event.pointerId===e.pointerB.id){const n=t.event.pointerId===e.pointerA.id?v.fromEvent(t.event):e.pointerA.currentScreenPosition,r=t.event.pointerId===e.pointerB.id?v.fromEvent(t.event):e.pointerB.currentScreenPosition,o=e.pointerA.startScreenPosition.distanceTo(e.pointerB.startScreenPosition),s=n.distanceTo(r)/o,a=e.pointerA.startScreenPosition.lerp(e.pointerB.startScreenPosition,.5),l=n.lerp(r,.5);return t.updateViewport(()=>{const c=a.add(e.initialPan).scale(s).sub(l);return{zoom:e.initialZoom*s,pan:c}}),{pan:{...e,pointerA:{...e.pointerA,currentScreenPosition:n},pointerB:{...e.pointerB,currentScreenPosition:r}},passthroughContext:null}}return{pan:e,passthroughContext:t};default:throw D(e)}case"up":case"cancel":switch(e.state){case"idle":return{pan:e,passthroughContext:t};case"oneFingerDown":return t.event.pointerId===e.pointerA.id?{pan:{state:"idle"},passthroughContext:t}:{pan:e,passthroughContext:t};case"bothFingersDown":return t.event.pointerId===e.pointerA.id||t.event.pointerId===e.pointerB.id?{pan:{state:"idle"},passthroughContext:null}:{pan:e,passthroughContext:t};default:throw D(e)}default:D(t.eventType)}}};function on(t){return null}function Be(){return function(e){return{getCanvasClassName:n=>"",getPreviewPosition:n=>null,Overlay:on,...e}}}function Ke(t){const e={initialize:n=>({state:"idle",childState:n}),isIdle:n=>n.state==="idle",getState:n=>n.childState,onPointerEvent:(n,r,o)=>{switch(n.eventType){case"down":switch(r.state){case"idle":{const i=t.onDragStart(n,r.childState,o);return i?(n.event.preventDefault(),t.onTap?{state:"dragUnconfirmed",pointerId:n.event.pointerId,startPosition:v.fromEvent(n.event),childState:i,startArg:o}:{state:"dragConfirmed",pointerId:n.event.pointerId,childState:i,startArg:o}):r}case"dragUnconfirmed":case"dragConfirmed":return r;default:throw D(r)}case"move":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragMove(n,r.childState);return r.startPosition.distanceTo(v.fromEvent(n.event))>=qt?{state:"dragConfirmed",pointerId:r.pointerId,childState:i,startArg:r.startArg}:Object.is(r.childState,i)?r:{...r,childState:i}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragMove(n,r.childState);return Object.is(r.childState,i)?r:{...r,childState:i}}default:throw D(r)}case"up":switch(r.state){case"idle":return r;case"dragUnconfirmed":{if(r.pointerId!==n.event.pointerId)return r;let i=t.onDragCancel(n,r.childState);return i=t.onTap?t.onTap(n,i,r.startArg):i,{state:"idle",childState:i}}case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragEnd(n,r.childState);return{state:"idle",childState:i}}default:throw D(r)}case"cancel":switch(r.state){case"idle":return r;case"dragUnconfirmed":case"dragConfirmed":{if(r.pointerId!==n.event.pointerId)return r;const i=t.onDragCancel(n,r.childState);return{state:"idle",childState:i}}default:throw D(r)}default:D(n.eventType)}},createOnPointerEvent:n=>(r,o,i)=>ee(o,n,s=>e.onPointerEvent(r,s,i))};return e}const oe=Ke({onDragStart:({event:t,viewport:e})=>({state:"drawing",points:[e.eventSceneCoords(t)]}),onDragMove:({event:t,viewport:e},n)=>({state:"drawing",points:[...n.points,e.eventSceneCoords(t)]}),onDragEnd:({updateDocument:t,location:e},n)=>(t(r=>{const o=r.shapes.get(e.shapeId);return r.replacePointsForVersion(e.keyPointId,o.id,n.points)}),{state:"idle"}),onDragCancel:(t,e)=>({state:"idle"})}),he=Be()({initialize:()=>({type:T.Draw,gesture:oe.initialize({state:"idle"})}),isIdle:t=>oe.isIdle(t.gesture),getDebugProperties:t=>{const e=oe.getState(t.gesture);switch(e.state){case"idle":return{_:"idle"};case"drawing":return{_:"drawing",points:String(e.points.length)};default:D(e)}},getState:t=>oe.getState(t.gesture),onPointerEvent:oe.createOnPointerEvent("gesture")}),Fe={interpolated:(t,e)=>({type:"interpolated",scenePosition:t,selectedShapeId:e}),keyPointId:(t,e)=>({type:"keyPointId",keyPointId:t,selectedShapeId:e}),toDebugString:t=>{switch(t.type){case"interpolated":return We(t.type,{_:t.scenePosition.toString(2),shape:t.selectedShapeId});case"keyPointId":return We(t.type,{_:t.keyPointId,shape:t.selectedShapeId});default:D(t)}}};function sn({position:t,children:e,className:n,style:r,...o}){return w("div",{className:B("absolute top-0 left-0",n),style:{transform:`translate(${t.x}px, ${t.y}px)`,...r},...o,children:e})}function an({position:t,viewport:e,screenOffset:n=v.ZERO,...r}){return w(sn,{position:e.sceneToScreen(t).add(n),...r})}const ie=Ke({onTap:({updateLocation:t},e,n)=>(n&&t(r=>r.with({keyPointId:n})),e),onDragStart:({updateLocation:t,viewport:e,event:n},r,o)=>o?(t(i=>i.with({keyPointId:o})),{state:"moving",keyPointId:o,delta:v.ZERO,startingPosition:e.eventSceneCoords(n)}):null,onDragMove:({viewport:t,event:e},n)=>({...n,delta:t.eventSceneCoords(e).sub(n.startingPosition)}),onDragEnd:({event:t,viewport:e,updateDocument:n},r)=>{const o=e.eventSceneCoords(t).sub(r.startingPosition);return n(i=>i.updateKeypoint(r.keyPointId,s=>({...s,position:s.position.add(o)}))),{state:"idle"}},onDragCancel:()=>({state:"idle"})}),ln=new v(-12,-12),fe=Be()({initialize:()=>({type:T.KeyPoint,gesture:ie.initialize({state:"idle"}),previewPosition:null}),isIdle:t=>!0,getDebugProperties:t=>{const e=ie.getState(t.gesture);switch(e.state){case"idle":return{_:e.state};case"moving":return{_:e.state,keyPointId:e.keyPointId,delta:e.delta.toString(2)}}},getPreviewPosition:(t,e)=>ie.isIdle(t.gesture)&&t.previewPosition?Fe.interpolated(t.previewPosition,e):null,onPointerEvent:(t,e,n)=>({...e,previewPosition:t.viewport.eventSceneCoords(t.event),gesture:ie.onPointerEvent(t,e.gesture,n)}),Overlay:({tool:t,document:e,viewport:n,location:r,onUpdateTool:o})=>{const i=ie.getState(t.gesture);return w(Ae,{children:Array.from(e.keyPoints,(s,a)=>{const l=i.state==="moving"&&i.keyPointId===s.id?s.position.add(i.delta):s.position;return w(an,{position:l,screenOffset:ln,viewport:n,className:B("flex h-6 w-6 cursor-move items-center justify-center rounded-full border border-stone-200 bg-white text-xs text-stone-400 shadow-md",s.id===r.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onPointerDown:c=>{o((p,u)=>fe.onPointerEvent({...p,event:c,eventType:"down"},u,s.id))},children:a+1},s.id)})})}}),me=Ke({onDragStart:({event:t,location:e})=>({state:"active",initialPan:e.viewportState.pan,previousScreenPoint:v.fromEvent(t)}),onDragMove:({event:t,updateViewport:e},n)=>{const r=v.fromEvent(t);return e(({pan:o,zoom:i})=>({pan:o.add(n.previousScreenPoint.sub(r).scale(i)),zoom:i})),{...n,previousScreenPoint:r}},onDragEnd:()=>({state:"idle"}),onDragCancel:({updateViewport:t},e)=>(t(({zoom:n})=>({zoom:n,pan:e.initialPan})),{state:"idle"})}),ye=Be()({initialize:()=>({type:pe.Pan,gesture:me.initialize({state:"idle"})}),getDebugProperties:t=>{const e=me.getState(t.gesture);switch(e.state){case"idle":return{_:e.state};case"active":return{_:e.state,initialPan:e.initialPan.toString(2),previousScreenPoint:e.previousScreenPoint.toString(0)}}},isIdle:t=>me.isIdle(t.gesture),getCanvasClassName:t=>ye.isIdle(t)?"cursor-grab":"cursor-grabbing",gesture:me}),pt={[T.Draw]:he,[T.KeyPoint]:fe,[pe.Pan]:ye};function ae(t){return pt[t]}function ht(t){const e=ae(t.type).getDebugProperties(t),n=It(e).map(([r,o])=>r.startsWith("_")?o:`${r} = ${o}`).join(", ");return`${t.type}(${n})`}const O={initialize:t=>ae(t).initialize(),initializeForKeyDown:({event:t})=>b(t,"d")?he.initialize():b(t,"k")?fe.initialize():null,isIdle:t=>ae(t.type).isIdle(t),getCanvasClassName:t=>ae(t.type).getCanvasClassName(t),getPreviewPosition:(t,e)=>ae(t.type).getPreviewPosition(t,e),toDebugString:ht,onPointerEvent:(t,e)=>{switch(e.type){case T.Draw:return he.onPointerEvent(t,e);case T.KeyPoint:return fe.onPointerEvent(t,e);default:D(e)}}},se={initializeForKeyDown:({event:t})=>b(t," ")?ye.initialize():null,toDebugString:ht,getCanvasClassName:t=>pt[t.type].getCanvasClassName(t),onPointerEvent:(t,e)=>{switch(e.type){case pe.Pan:return ee(e,"gesture",n=>ye.gesture.onPointerEvent(t,n))}},onKeyUp:({event:t},e)=>{switch(e.type){case pe.Pan:return Ct(t," ")?null:e}}},K={initialize:t=>({undoStates:[],redoStates:[],pendingOp:null,current:{...t,options:{}}}),beginOperation:t=>{const e=Math.random();return I(t.pendingOp==null,"pending op already in progress"),{undoStack:{...t,pendingOp:{txId:e,initialDoc:t.current.doc,initialOptions:t.current.options},current:{...t.current,options:{}}},txId:e}},updateOperation:(t,e,n)=>{var r;return I(((r=t.pendingOp)==null?void 0:r.txId)===e,"pending op mismatch"),{...t,current:{...t.current,doc:j(t.current.doc,n)}}},revertOperation:(t,e)=>{var n;return I(((n=t.pendingOp)==null?void 0:n.txId)===e,"Pending op mismatch"),{...t,pendingOp:null,current:{doc:t.pendingOp.initialDoc,location:t.current.location,options:t.pendingOp.initialOptions}}},commitOperation:(t,e,n={})=>{var i;I(((i=t.pendingOp)==null?void 0:i.txId)===e,"Pending op mismatch");const r=[{doc:t.pendingOp.initialDoc,location:t.current.location,options:t.pendingOp.initialOptions},...t.undoStates];for(;r.length>Kt;)r.pop();const o={...t.current,options:n};return n.lockstepLocation&&(o.location=j(o.location,n.lockstepLocation)),{...t,current:o,pendingOp:null,undoStates:r,redoStates:null}},updateDocument:(t,e,n)=>{let r;return{undoStack:t,txId:r}=K.beginOperation(t),t=K.updateOperation(t,r,e),K.commitOperation(t,r,n)},undo:t=>{var o;if(I(t.pendingOp==null,"Pending op in progress"),t.undoStates.length==0)return t;const[e,...n]=t.undoStates;if(!De(e.location,t.current.location)&&!t.current.options.lockstepLocation)return{...t,current:{...t.current,location:e.location}};const r=[t.current,...(o=t.redoStates)!=null?o:[]];return{...t,current:e,undoStates:n,redoStates:r}},redo:t=>{if(I(t.pendingOp==null,"pending op in progress"),!t.redoStates||t.redoStates.length==0)return t;const[e,...n]=t.redoStates;if(!De(e.location,t.current.location)&&!e.options.lockstepLocation)return{...t,current:{...t.current,location:e.location}};const r=[t.current,...t.undoStates];return{...t,current:e.options.lockstepLocation?{...e,location:j(t.current.location,e.options.lockstepLocation)}:e,undoStates:r,redoStates:n.length===0?null:n}},updateLocation:(t,e)=>({...t,current:{...t.current,location:j(t.current.location,e)}})},z={initialize:t=>({multiTouchPan:Ye.initialize(),quickTool:null,selectedTool:O.initialize(t)}),toDebugString:t=>t.quickTool?se.toDebugString(t.quickTool):O.toDebugString(t.selectedTool),getCanvasClassName:t=>t.quickTool?se.getCanvasClassName(t.quickTool):O.getCanvasClassName(t.selectedTool),getPreviewPosition:(t,e)=>O.getPreviewPosition(t.selectedTool,e),updateSelectedTool:(t,e)=>ee(t,"selectedTool",e),updateQuickTool:(t,e)=>ee(t,"quickTool",e),requestSetSelectedTool:(t,e)=>t.quickTool||!O.isIdle(t.selectedTool)?t:{...t,selectedTool:O.initialize(e)},onKeyDown:(t,e)=>{if(O.isIdle(e.selectedTool)){if(!e.quickTool){const o=se.initializeForKeyDown(t);if(o)return{...e,quickTool:o}}const r=O.initializeForKeyDown(t);if(r&&!e.quickTool)return{...e,selectedTool:r};if(b(t.event,{key:"z",command:!0}))return t.updateUndoStack(o=>K.undo(o)),e;if(b(t.event,{key:"z",command:!0,shift:!0}))return t.updateUndoStack(o=>K.redo(o)),e}if(b(t.event,{key:"0",command:!0}))return t.updateViewport({pan:v.ZERO,zoom:1}),e;const n=r=>{var i;const o=(i=[...t.document.keyPoints][r])==null?void 0:i.id;o&&t.updateLocation(s=>s.with({keyPointId:o}))};return b(t.event,"1")&&n(0),b(t.event,"2")&&n(1),b(t.event,"3")&&n(2),b(t.event,"4")&&n(3),b(t.event,"5")&&n(4),b(t.event,"6")&&n(5),b(t.event,"7")&&n(6),b(t.event,"8")&&n(7),b(t.event,"9")&&n(8),e},onKeyUp:(t,e)=>{if(e.quickTool){const n=se.onKeyUp(t,e.quickTool);if(n!==e.quickTool)return{...e,quickTool:n}}return e},onPointerEvent:(t,e)=>{const{pan:n,passthroughContext:r}=Ye.onPointerEvent(t,e.multiTouchPan);return n!==e.multiTouchPan&&(e={...e,multiTouchPan:n}),r?e.quickTool?z.updateQuickTool(e,o=>se.onPointerEvent(r,Le(o))):z.updateSelectedTool(e,o=>O.onPointerEvent(r,o)):e},Overlay:({interaction:t,onUpdateInteraction:e,...n})=>{const r=o=>e((i,s)=>z.updateSelectedTool(s,a=>(I(a.type===s.selectedTool.type),o(i,a))));switch(t.selectedTool.type){case T.Draw:return w(he.Overlay,{tool:t.selectedTool,onUpdateTool:r,...n});case T.KeyPoint:return w(fe.Overlay,{tool:t.selectedTool,onUpdateTool:r,...n});default:D(t.selectedTool)}}};function cn({selectedToolType:t,updateInteraction:e}){const n=r=>()=>e((o,i)=>z.requestSetSelectedTool(i,r));return M("div",{className:"pointer-events-none absolute top-0 bottom-0 flex cursor-wait flex-col items-center justify-center gap-3 p-3",children:[w(et,{letter:"d",isSelected:t===T.Draw,onClick:n(T.Draw)}),w(et,{letter:"k",isSelected:t===T.KeyPoint,onClick:n(T.KeyPoint)})]})}function et({letter:t,onClick:e,isSelected:n}){return w("button",{className:B("pointer-events-auto flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 bg-white shadow-md",n?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:e,children:t})}class ue{static distance(e,n){let r=0;for(let o=0;o<e.length;o++)r+=Math.pow(e[o]-n[o],2);return Math.sqrt(r)}static kernel(e,n){const r=ue.distance(e,n);return r===0?0:Math.pow(r,2)*Math.log(r)}constructor(e,n){e.length===0&&le("bad centers array :/"),e.every(c=>c.length===e[0].length)||le("centers must have same dimensions :/"),this.centers=e;const r=n.slice(),o=[],i=[];for(let c=0;c<e.length;c++){const p=[],u=[1];for(let d=0;d<e[c].length;d++)u.push(e[c][d]);for(let d=0;d<e.length;d++)p.push(ue.kernel(e[c],e[d]));i.push(u),o.push(p.concat(u))}const a=k.transpose(i).map(c=>{for(let p=c.length;p<o[0].length;p++)c.push(0);return c});for(let c=0;c<a.length;c++)o.push(a[c]),r.push(0);const l=this.solve(r,o);l||le("rbf failed to compile with given centers./nCenters must be unique :/"),this.ws=l}solve(e,n){const r=k.inverse(n);return r?k.multiplyVector(r,e):null}getValue(e){I(this.ws);let n=0,r=0;for(r=0;r<this.centers.length;r++)n+=Number(this.ws[r])*ue.kernel(e,this.centers[r]);for(n+=Number(this.ws[this.centers.length]),r=0;r<e.length;r++)n+=e[r]*Number(this.ws[this.centers.length+(r+1)]);return n}}const k={create(t){return t.map(e=>e.slice())},fromVector(t){return t.map(e=>[e])},identity(t){return N(t,e=>N(t,n=>e===n?1:0))},col(t,e){return t.map(n=>n[e-1])},clone(t){return t.slice()},canMultiplyFromLeft(t,e){return t[0].length===e.length},multiplyMatrix(t,e){if(!k.canMultiplyFromLeft(t,e))return null;const n=t[0].length;return N(t.length,r=>N(e[0].length,o=>{let i=0;for(let s=0;s<n;s++)i+=t[r][s]*e[s][o];return i}))},multiplyVector(t,e){return k.multiplyMatrix(t,k.fromVector(e))},transpose(t){return N(t[0].length,e=>N(t.length,n=>t[n][e]))},isSquare(t){return t.length===t[0].length},toRightTriangular(t){const e=k.clone(t),n=t.length,r=t[0].length;for(let o=0;o<n;o++){if(e[o][o]===0){for(let i=o+1;i<n;i++)if(e[i][o]!==0){const s=[];for(let a=0;a<r;a++)s.push(e[o][a]+e[i][a]);e[o]=s;break}}if(e[o][o]!==0)for(let i=o+1;i<n;i++){const s=e[i][o]/e[o][o],a=[];for(let l=0;l<r;l++)a.push(l<=o?0:e[i][l]-e[o][l]*s);e[i]=a}}return e},determinant(t){if(!k.isSquare(t))return null;const e=k.toRightTriangular(t);let n=e[0][0];for(let r=1;r<e.length;r++)n=n*e[r][r];return n},isSingular(t){return k.isSquare(t)&&k.determinant(t)===0},augment(t,e){const n=k.clone(t),r=n[0].length;I(n.length===e.length);for(let o=0;o<n.length;o++)for(let i=0;i<e[0].length;i++)n[o][r+i]=e[o][i];return n},inverse(t){if(!k.isSquare(t)||k.isSingular(t))return null;const e=t.length,n=[],r=k.toRightTriangular(k.augment(t,k.identity(e))),o=r[0].length;let i=t.length;for(;i--;){const s=[];n[i]=[];const a=r[i][i];for(let c=0;c<o;c++){const p=r[i][c]/a;s.push(p),c>=e&&n[i].push(p)}r[i]=s;let l=i;for(;l--;){const c=[];for(let p=0;p<o;p++)c.push(r[l][p]-r[i][p]*r[l][i]);r[l]=c}}return n}};class un{interpolate(e){le("cannot interpolate none")}}class dn{constructor(e){this.value=e}interpolate(e){return this.value}}class pn{constructor(e,n,r,o){this.centerA=e,this.centerB=n,this.valueA=r,this.valueB=o}interpolate(e){const n=this.centerB.sub(this.centerA),o=e.sub(this.centerA).dot(n)/n.dot(n);return nt(this.valueA,this.valueB,o)}}class hn extends ue{constructor(e,n){super(e.map(({x:r,y:o})=>[r,o]),n)}interpolate(e){return this.getValue([e.x,e.y])}}class Te{constructor(e,n){switch(I(e.length===n.length),e.length){case 0:this.interpolator=new un;break;case 1:this.interpolator=new dn(n[0]);break;case 2:this.interpolator=new pn(e[0],e[1],n[0],n[1]);break;default:this.interpolator=new hn(e,n)}}interpolate(e){return this.interpolator.interpolate(e)}}class fn{constructor(){this.cache=new Map}getCenterPointsAtPosition(e,n,r){switch(r.type){case"keyPointId":{const o=e.getShapeVersion(r.keyPointId,n);if(!o){const i=e.keyPoints.get(r.keyPointId);return this.getCenterPointsAtInterpolatedPosition(e,n,i.position)}return e.getNormalizedCenterPointsForShapeVersion(o.id)}case"interpolated":return this.getCenterPointsAtInterpolatedPosition(e,n,r.scenePosition);default:D(r)}}getCenterPointsAtInterpolatedPosition(e,n,r){const o=e.shapes.get(n),i=new Set(e.iterateShapeVersionsForShape(n));if(!i.size)return[];const s=new Set;for(const c of i)s.add(e.keyPoints.get(c.keyPointId));const a=this.getCacheEntry(o,i,s);let l;return a?l=a.interpolators:(l=this.calculateInterpolators(e,i),this.cache.set(o,{versions:i,keyPoints:s,interpolators:l})),l.map(({x:c,y:p,r:u})=>({center:new v(c.interpolate(r),p.interpolate(r)),radius:u.interpolate(r)}))}calculateInterpolators(e,n){console.time("calculatInterpolators");const r=Array.from(n,a=>({normalizedCenterPoints:e.getNormalizedCenterPointsForShapeVersion(a.id),version:a,keyPoint:e.keyPoints.get(a.keyPointId)})),o=r.map(({keyPoint:a})=>a.position),i=Math.min(...r.map(({normalizedCenterPoints:a})=>a.length)),s=[];for(let a=0;a<i;a++){const l=r.map(({normalizedCenterPoints:u})=>u[a].center.x),c=r.map(({normalizedCenterPoints:u})=>u[a].center.y),p=r.map(({normalizedCenterPoints:u})=>u[a].radius);s.push({x:new Te(o,l),y:new Te(o,c),r:new Te(o,p)})}return console.timeEnd("calculatInterpolators"),s}getCacheEntry(e,n,r){const o=this.cache.get(e);if(!o||n.size!==o.versions.size||r.size!==o.keyPoints.size)return null;for(const i of n)if(!o.versions.has(i))return null;for(const i of r)if(!o.keyPoints.has(i))return null;return o}}const gn=new fn;function mn(t){const e=[],n=[];if(t.length===0)return[];if(t.length===1){const u=[];for(let d=0;d<12;d++)u.push(t[0].center.add(v.fromPolar(d*Math.PI/6,t[0].radius)));return u}const r=t[0],i=t[1].center.sub(r.center).normalize(),s=i.perpendicular().scale(r.radius);e.push(r.center.sub(i.scale(r.radius))),e.push(r.center.sub(s)),n.push(r.center.add(s));for(let u=1;u<t.length-1;u++){const d=t[u-1],f=t[u],y=t[u+1].center.sub(d.center).normalize().perpendicular().scale(f.radius);e.push(f.center.sub(y)),n.push(f.center.add(y))}const a=t[t.length-2],l=t[t.length-1],c=l.center.sub(a.center).normalize(),p=c.perpendicular().scale(l.radius);return e.push(l.center.sub(p)),e.push(l.center.add(c.scale(l.radius))),n.push(l.center.add(p)),e.concat(n.reverse())}function vn({interaction:t,document:e,shapeId:n,previewPosition:r}){let o=null;if(r.selectedShapeId===n)switch(t.selectedTool.type){case T.Draw:{const i=he.getState(t.selectedTool);switch(i.state){case"drawing":o=ct(at(lt(i.points,ce),ce),ce.size);break;case"idle":break;default:D(i)}break}case T.KeyPoint:break;default:D(t.selectedTool)}return o||(o=gn.getCenterPointsAtPosition(e,n,r)),w("path",{d:Ut(mn(o)),className:B(r.selectedShapeId===n?"fill-stone-800":"fill-stone-600")})}function wn({document:t,previewPosition:e,interaction:n}){return w(Ae,{children:Array.from(t.shapes,r=>w(vn,{document:t,interaction:n,shapeId:r.id,previewPosition:e},r.id))})}const V={initialize:t=>({undoStack:K.initialize(t),interaction:z.initialize(T.Draw)}),updateUndoStack:(t,e)=>ee(t,"undoStack",e),updateLocation:(t,e)=>V.updateUndoStack(t,n=>K.updateLocation(n,e)),updateDocument:(t,e,n)=>V.updateUndoStack(t,r=>K.updateDocument(r,e,n)),updateViewport:(t,e)=>V.updateLocation(t,n=>n.with({viewport:j(n.viewportState,e)})),updateInteraction:(t,e)=>ee(t,"interaction",e)};function yn(t){return(e,n)=>{const r=[];let o=!1;function i(a){I(!o),r.push(a)}const s=t();n({update:i,updateUndoStack:a=>i(l=>V.updateUndoStack(l,a)),updateLocation:a=>i(l=>V.updateLocation(l,a)),updateDocument:(a,l)=>i(c=>V.updateDocument(c,a,l)),updateViewport:a=>i(l=>V.updateViewport(l,a)),updateInteraction:a=>i(l=>V.updateInteraction(l,a)),document:e.undoStack.current.doc,location:e.undoStack.current.location,viewport:s.viewport});for(let a=0;a<r.length;a++)e=r[a](e);return o=!0,e}}function Pn(t,e){const n=rt(e),r=x.exports.useMemo(()=>yn(n),[n]),[o,i]=x.exports.useReducer(r,null,t),s=x.exports.useMemo(()=>{const c=u=>i(d=>d.updateInteraction(f=>u(d,f))),p=u=>d=>c((f,m)=>z.onPointerEvent({...f,event:d,eventType:u},m));return{updateUndoStack:u=>i(d=>d.updateUndoStack(f=>u(d,f))),updateLocation:u=>i(d=>d.updateLocation(f=>u(d,f))),updateDocument:(u,d)=>i(f=>f.updateDocument(m=>u(f,m),d)),updateViewport:u=>i(d=>d.updateViewport(f=>u(d,f))),updateInteraction:c,onPointerDown:p("down"),onPointerMove:p("move"),onPointerUp:p("up"),onPointerCancel:p("cancel"),onKeyDown:u=>c((d,f)=>z.onKeyDown({...d,event:u},f)),onKeyUp:u=>c((d,f)=>z.onKeyUp({...d,event:u},f))}},[]),{keyPointId:a,shapeId:l}=o.undoStack.current.location;return{...s,document:o.undoStack.current.doc,location:o.undoStack.current.location,interaction:o.interaction,previewPosition:x.exports.useMemo(()=>{var c;return(c=z.getPreviewPosition(o.interaction,l))!=null?c:Fe.keyPointId(a,l)},[a,l,o.interaction])}}function Sn(t,e){const n=e.visibleSceneBounds(),r=ot.fromLeftTopRightBottom(n.left+n.width/10,n.top+n.height/10,n.right-n.width/10,n.bottom-n.height/10),o=Array.from(t.keyPoints,l=>l.position),s=(Math.min(n.width,n.height)/10)**2;let a=r.getCenter();for(let l=0;l<500;l++){if(o.every(c=>c.distanceToSq(a)>s))return a;a=new v(Je(r.left,r.right),Je(r.top,r.bottom))}return a}const ft=60,ke=10,tt=N(ke,t=>`rgba(250, 250, 249, ${Lt(t/(ke-1))*1}) ${(ft*(t/(ke-1))).toFixed(2)}px`),In={width:st+ft,background:"rgba(250, 250, 249, 0.7)",webkitMaskImage:`linear-gradient(to right, ${tt.join(",")})`,maskImage:`linear-gradient(to right, ${tt.join(",")})`};function Cn({document:t,location:e,updateDocument:n,updateLocation:r}){return w("div",{className:"absolute top-0 right-0 h-full overflow-auto pl-8 backdrop-blur-lg",style:In,children:M("div",{className:"flex flex-col gap-3 p-5",children:[Array.from(t.shapes,(o,i)=>M("button",{className:"flex items-center justify-between rounded px-3 py-1 hover:bg-stone-300/25",onClick:()=>r(({location:s})=>s.with({shapeId:o.id})),children:["Shape ",i+1,o.id===e.shapeId&&w("div",{className:"h-3 w-3 rounded-full bg-purple-500"})]})),w("button",{className:"flex items-center justify-center rounded px-3 py-1 text-center hover:bg-stone-300/25",onClick:()=>{const o=re.generate();n(({document:i})=>i.addShape(o),{lockstepLocation:i=>i.with({shapeId:o})})},children:"+ shape"})]})})}function En(){const[t,e]=x.exports.useState(null),n=Et(t,Tt);return console.log(n),w("div",{ref:e,className:"absolute inset-0 touch-none",children:n&&w(Tn,{size:n})})}function Tn({size:t}){const{document:e,location:n,interaction:r,previewPosition:o,updateDocument:i,updateLocation:s,updateInteraction:a,onPointerDown:l,onPointerMove:c,onPointerUp:p,onPointerCancel:u,onKeyDown:d,onKeyUp:f}=Pn(()=>{{const g=tn("autosave");if(g.isOk())return V.initialize(g.value);console.error(`Error loading autosave: ${g.error}`)}return V.initialize(Xe())},()=>({viewport:h}));x.exports.useEffect(()=>{rn("autosave",{doc:e,location:n})},[e,n]);const m=x.exports.useCallback(g=>s((C,S)=>S.with({viewport:j(S.viewportState,g)})),[s]),h=x.exports.useMemo(()=>new Xt(n.viewportState,t,m),[n.viewportState,t,m]);x.exports.useEffect(()=>{const g=r.selectedTool.type;s((C,S)=>S.tool!==g?S.with({tool:g}):S)},[r.selectedTool.type,s]);const y=rt(g=>h.handleWheelEvent(g));return x.exports.useEffect(()=>(window.addEventListener("wheel",y,{passive:!1}),window.addEventListener("keydown",d),window.addEventListener("keyup",f),()=>{window.removeEventListener("wheel",y),window.removeEventListener("keydown",d),window.removeEventListener("keyup",f)}),[d,f,y]),M(Ae,{children:[M("div",{className:"pointer-events-none absolute top-0",children:[Fe.toDebugString(o)," |"," ",z.toDebugString(r)]}),M("div",{className:"absolute inset-0",onPointerDown:l,onPointerMove:c,onPointerUp:p,onPointerCancel:u,children:[w("svg",{viewBox:`0 0 ${t.x} ${t.y}`,className:B("absolute top-0 left-0",z.getCanvasClassName(r)),children:w("g",{transform:h.getSceneTransform(),children:w(wn,{document:e,previewPosition:o,interaction:r})})}),w(z.Overlay,{interaction:r,viewport:h,document:e,location:n,onUpdateInteraction:a})]}),w(cn,{selectedToolType:r.selectedTool.type,updateInteraction:a}),w(Cn,{document:e,location:n,updateDocument:i,updateLocation:s}),M("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-center gap-3 p-3",children:[M("div",{className:"flex min-w-0 flex-auto items-center justify-center gap-3",children:[Array.from(e.keyPoints,(g,C)=>w("button",{className:B("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1",g.id===n.keyPointId?"text-stone-500 ring-2 ring-inset ring-purple-400":"text-stone-400"),onClick:()=>{s((S,P)=>P.with({keyPointId:g.id}))},children:C+1},g.id)),w("button",{className:B("flex h-10 w-10 items-center justify-center rounded-full border border-stone-200 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const g=ne.generate();i((C,S)=>S.addKeyPoint(g,Sn(S,h)),{lockstepLocation:C=>C.with({keyPointId:g})})},children:"+"})]}),w("button",{className:B("absolute right-3 flex h-10 flex-none items-center justify-center justify-self-end rounded-full border border-stone-200 px-4 text-stone-400 shadow-md transition-transform hover:-translate-y-1"),onClick:()=>{const{doc:g,location:C}=Xe();i(()=>g,{lockstepLocation:C})},children:"reset"})]})]})}const kn=Le(document.getElementById("root"));kt(kn).render(w(En,{}));
