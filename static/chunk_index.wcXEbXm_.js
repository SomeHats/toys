var Fs=Object.defineProperty;var Gs=(n,e,t)=>e in n?Fs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var y=(n,e,t)=>Gs(n,typeof e!="symbol"?e+"":e,t);import{a as qe,d as I,U as P,b as we,s as ae,c as Z,i as Ye,R as Qe,w as Re,e as Zs,v as Ys,o as fe,g as Qs,h as Xs}from"./chunk_index.BVMwOSmr.js";import{c as De,g as Js}from"./chunk__commonjsHelpers.Cpj98o6Y.js";function Gn(n,e){const t=[];e:for(const r of n){for(const s of t)if(e?e(r,s):r===s)continue e;t.push(r)}return t}function Zn(n){return n.filter(e=>e!=null)}function Yn(n){return n[n.length-1]}function Qn(n,e){let t,r=1/0;for(const s of n){const i=e(s);i<r&&(t=s,r=i)}return t}function Xn(n,e){let t,r=-1/0;for(const s of n){const i=e(s);i>r&&(t=s,r=i)}return t}function ks(n,e){if(n===e)return!0;if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!Object.is(n[t],e[t]))return!1;return!0}function Jn(n,e,t){const r=new Set(e.map(i=>i[n])),s=[];for(const i of t)r.has(i[n])||s.push(i);for(const i of e)s.push(i);return s}class cr{constructor(){y(this,"items",new WeakMap)}get(e,t){return this.items.has(e)||this.items.set(e,t(e)),this.items.get(e)}}/*!
 * MIT License: https://github.com/ai/nanoid/blob/main/LICENSE
 * Modified code originally from <https://github.com/ai/nanoid>
 * Copyright 2017 Andrey Sitnik <andrey@sitnik.ru>
 *
 * `nanoid` is currently only distributed as an ES module. Some tools (jest, playwright) don't
 * properly support ESM-only code yet, and tldraw itself is distributed as both an ES module and a
 * CommonJS module. By including nanoid here, we can make sure it works well in every environment
 * where tldraw is used. We can also remove some unused features like custom alphabets.
 */const Wt=globalThis.crypto,en="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",tn=128;let se,ce;function rn(n){!se||se.length<n?(se=new Uint8Array(n*tn),Wt.getRandomValues(se),ce=0):ce+n>se.length&&(Wt.getRandomValues(se),ce=0),ce+=n}function sn(n=21){rn(n-=0);let e="";for(let t=ce-n;t<ce;t++)e+=en[se[t]&63];return e}let nn=sn;function ur(n){return nn(n)}function on(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function it(n,e){if(on(n,e))return n[e]}function an(n){return Object.keys(n)}function x(n){return Object.values(n)}function Y(n){return Object.entries(n)}function kn(n){return Object.fromEntries(n)}function Xe(n,e){const t={};let r=!1;for(const[s,i]of Y(n))e(s,i)?t[s]=i:r=!0;return r?t:n}function ei(n,e){const t={};for(const[r,s]of Y(n)){const i=e(r,s);t[r]=i}return t}function ti(n,e){if(n===e)return!0;const t=new Set(Object.keys(n)),r=new Set(Object.keys(e));if(t.size!==r.size)return!1;for(const s of t)if(!r.has(s)||!Object.is(n[s],e[s]))return!1;return!0}const cn=()=>typeof process<"u"&&!1,ue=[],un=60,je=Math.ceil(1e3/un);let ve,Je=0,ot=0;const fn=()=>{const n=ue.splice(0,ue.length);for(const e of n)e()};function fr(){if(ve)return;const n=Date.now(),e=n-ot;if(Je+e<je){ve=requestAnimationFrame(()=>{ve=void 0,fr()});return}ve=requestAnimationFrame(()=>{ve=void 0,ot=n,Je=Math.min(Je+e-je,je*10),fn()})}let Ft=!1;function dn(n){return cn()?(n(),()=>{}):(ue.includes(n)||(ue.push(n),Ft||(Ft=!0,ot=Date.now()-je-1),fr()),()=>{const e=ue.indexOf(n);e>-1&&ue.splice(e,1)})}/*!
 * This file was lovingly and delicately extracted from Immutable.js
 * MIT License: https://github.com/immutable-js/immutable-js/blob/main/LICENSE
 * Copyright (c) 2014-present, Lee Byron and other contributors.
 */function ct(n){return n>>>1&1073741824|n&3221225471}const ln=Object.prototype.valueOf;function ne(n){if(n==null)return Gt(n);if(typeof n.hashCode=="function")return ct(n.hashCode(n));const e=mn(n);if(e==null)return Gt(e);switch(typeof e){case"boolean":return e?1108378657:1108378656;case"number":return hn(e);case"string":return e.length>yn?pn(e):at(e);case"object":case"function":return _n(e);case"symbol":return gn(e);default:if(typeof e.toString=="function")return at(e.toString());throw new Error("Value type "+typeof e+" cannot be hashed.")}}function Gt(n){return n===null?1108378658:1108378659}function hn(n){if(n!==n||n===1/0)return 0;let e=n|0;for(e!==n&&(e^=n*4294967295);n>4294967295;)n/=4294967295,e^=n;return ct(e)}function pn(n){let e=tt[n];return e===void 0&&(e=at(n),et===vn&&(et=0,tt={}),et++,tt[n]=e),e}function at(n){let e=0;for(let t=0;t<n.length;t++)e=31*e+n.charCodeAt(t)|0;return ct(e)}function gn(n){let e=Yt[n];return e!==void 0||(e=dr(),Yt[n]=e),e}function _n(n){let e=Zt.get(n);return e!==void 0||(e=dr(),Zt.set(n,e)),e}function mn(n){return n.valueOf!==ln&&typeof n.valueOf=="function"?n.valueOf(n):n}function dr(){const n=++ke;return ke&1073741824&&(ke=0),n}const Zt=new WeakMap,Yt=Object.create(null);let ke=0;const yn=16,vn=255;let et=0,tt={};const le=5,be=1<<le,he=be-1,U={};function Qt(){return{value:!1}}function $(n){n&&(n.value=!0)}function ut(n,e){e=e||0;const t=Math.max(0,n.length-e),r=new Array(t);for(let s=0;s<t;s++)r[s]=n[s+e];return r}const pe=Object.is;class lr{}class ft{constructor(e){y(this,"_root");y(this,"size");y(this,"__ownerID");y(this,"__hash");y(this,"__altered");return e==null?de():e instanceof ft?e:de().withMutations(t=>{for(const[r,s]of e)t.set(r,s)})}get(e,t){return this._root?this._root.get(0,void 0,e,t):t}set(e,t){return kt(this,e,t)}delete(e){return kt(this,e,U)}deleteAll(e){return this.withMutations(t=>{for(const r of e)t.delete(r)})}__ensureOwner(e){return e===this.__ownerID?this:e?ht(this.size,this._root,e,this.__hash):this.size===0?de():(this.__ownerID=e,this.__altered=!1,this)}withMutations(e){const t=this.asMutable();return e(t),t.wasAltered()?t.__ensureOwner(this.__ownerID):this}wasAltered(){return this.__altered}asMutable(){return this.__ownerID?this:this.__ensureOwner(new lr)}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}entries(){return new rt(this,wn,!1)}keys(){return new rt(this,hr,!1)}values(){return new rt(this,pr,!1)}}class dt{constructor(e,t){this.ownerID=e,this.entries=t}get(e,t,r,s){const i=this.entries;for(let c=0,f=i.length;c<f;c++)if(pe(r,i[c][0]))return i[c][1];return s}update(e,t,r,s,i,c,f){const d=i===U,p=this.entries;let l=0;const g=p.length;for(;l<g&&!pe(s,p[l][0]);l++);const _=l<g;if(_?p[l][1]===i:d)return this;if($(f),(d||!_)&&$(c),d&&p.length===1)return;if(!_&&!d&&p.length>=Tn)return En(e,p,s,i);const v=e&&e===this.ownerID,w=v?p:ut(p);return _?d?l===g-1?w.pop():w[l]=w.pop():w[l]=[s,i]:w.push([s,i]),v?(this.entries=w,this):new dt(e,w)}}class ze{constructor(e,t,r){this.ownerID=e,this.bitmap=t,this.nodes=r}get(e,t,r,s){t===void 0&&(t=ne(r));const i=1<<((e===0?t:t>>>e)&he),c=this.bitmap;return c&i?this.nodes[tr(c&i-1)].get(e+le,t,r,s):s}update(e,t,r,s,i,c,f){r===void 0&&(r=ne(s));const d=(t===0?r:r>>>t)&he,p=1<<d,l=this.bitmap,g=(l&p)!==0;if(!g&&i===U)return this;const _=tr(l&p-1),v=this.nodes,w=g?v[_]:void 0,m=pt(w,e,t+le,r,s,i,c,f);if(m===w)return this;if(!g&&m&&v.length>=Mn)return Sn(e,v,l,d,m);if(g&&!m&&v.length===2&&er(v[_^1]))return v[_^1];if(g&&m&&v.length===1&&er(m))return m;const H=e&&e===this.ownerID,Q=g?m?l:l^p:l|p,N=g?m?gr(v,_,m,H):On(v,_,H):In(v,_,m,H);return H?(this.bitmap=Q,this.nodes=N,this):new ze(e,Q,N)}}class lt{constructor(e,t,r){this.ownerID=e,this.count=t,this.nodes=r}get(e,t,r,s){t===void 0&&(t=ne(r));const i=(e===0?t:t>>>e)&he,c=this.nodes[i];return c?c.get(e+le,t,r,s):s}update(e,t,r,s,i,c,f){r===void 0&&(r=ne(s));const d=(t===0?r:r>>>t)&he,p=i===U,l=this.nodes,g=l[d];if(p&&!g)return this;const _=pt(g,e,t+le,r,s,i,c,f);if(_===g)return this;let v=this.count;if(!g)v++;else if(!_&&(v--,v<Hn))return Cn(e,l,v,d);const w=e&&e===this.ownerID,m=gr(l,d,_,w);return w?(this.count=v,this.nodes=m,this):new lt(e,v,m)}}class Ne{constructor(e,t,r){this.ownerID=e,this.keyHash=t,this.entries=r}get(e,t,r,s){const i=this.entries;for(let c=0,f=i.length;c<f;c++)if(pe(r,i[c][0]))return i[c][1];return s}update(e,t,r,s,i,c,f){r===void 0&&(r=ne(s));const d=i===U;if(r!==this.keyHash)return d?this:($(f),$(c),gt(this,e,t,r,[s,i]));const p=this.entries;let l=0;const g=p.length;for(;l<g&&!pe(s,p[l][0]);l++);const _=l<g;if(_?p[l][1]===i:d)return this;if($(f),(d||!_)&&$(c),d&&g===2)return new ie(e,this.keyHash,p[l^1]);const v=e&&e===this.ownerID,w=v?p:ut(p);return _?d?l===g-1?w.pop():w[l]=w.pop():w[l]=[s,i]:w.push([s,i]),v?(this.entries=w,this):new Ne(e,this.keyHash,w)}}class ie{constructor(e,t,r){this.ownerID=e,this.keyHash=t,this.entry=r}get(e,t,r,s){return pe(r,this.entry[0])?this.entry[1]:s}update(e,t,r,s,i,c,f){const d=i===U,p=pe(s,this.entry[0]);if(p?i===this.entry[1]:d)return this;if($(f),d){$(c);return}return p?e&&e===this.ownerID?(this.entry[1]=i,this):new ie(e,this.keyHash,[s,i]):($(c),gt(this,e,t,ne(s),[s,i]))}}class rt{constructor(e,t,r){y(this,"_stack");this._type=t,this._reverse=r,this._stack=e._root&&Xt(e._root)}[Symbol.iterator](){return this}next(){const e=this._type;let t=this._stack;for(;t;){const r=t.node,s=t.index++;let i;if(r.entry){if(s===0)return st(e,r.entry)}else if("entries"in r&&r.entries){if(i=r.entries.length-1,s<=i)return st(e,r.entries[this._reverse?i-s:s])}else if(i=r.nodes.length-1,s<=i){const c=r.nodes[this._reverse?i-s:s];if(c){if(c.entry)return st(e,c.entry);t=this._stack=Xt(c,t)}continue}t=this._stack=this._stack.__prev}return An()}}function st(n,e){return bn(n,e[0],e[1])}function Xt(n,e){return{node:n,index:0,__prev:e}}const hr=0,pr=1,wn=2;function bn(n,e,t,r){const s=n===hr?e:n===pr?t:[e,t];return r?r.value=s:r={value:s,done:!1},r}function An(){return{value:void 0,done:!0}}function ht(n,e,t,r){const s=Object.create(ft.prototype);return s.size=n,s._root=e,s.__ownerID=t,s.__hash=r,s.__altered=!1,s}let Jt;function de(){return Jt||(Jt=ht(0))}function kt(n,e,t){let r,s;if(n._root){const i=Qt(),c=Qt();if(r=pt(n._root,n.__ownerID,0,void 0,e,t,i,c),!c.value)return n;s=n.size+(i.value?t===U?-1:1:0)}else{if(t===U)return n;s=1,r=new dt(n.__ownerID,[[e,t]])}return n.__ownerID?(n.size=s,n._root=r,n.__hash=void 0,n.__altered=!0,n):r?ht(s,r):de()}function pt(n,e,t,r,s,i,c,f){return n?n.update(e,t,r,s,i,c,f):i===U?n:($(f),$(c),new ie(e,r,[s,i]))}function er(n){return n.constructor===ie||n.constructor===Ne}function gt(n,e,t,r,s){if(n.keyHash===r)return new Ne(e,r,[n.entry,s]);const i=(t===0?n.keyHash:n.keyHash>>>t)&he,c=(t===0?r:r>>>t)&he;let f;const d=i===c?[gt(n,e,t+le,r,s)]:(f=new ie(e,r,s),i<c?[n,f]:[f,n]);return new ze(e,1<<i|1<<c,d)}function En(n,e,t,r){n||(n=new lr);let s=new ie(n,ne(t),[t,r]);for(let i=0;i<e.length;i++){const c=e[i];s=s.update(n,0,void 0,c[0],c[1])}return s}function Cn(n,e,t,r){let s=0,i=0;const c=new Array(t);for(let f=0,d=1,p=e.length;f<p;f++,d<<=1){const l=e[f];l!==void 0&&f!==r&&(s|=d,c[i++]=l)}return new ze(n,s,c)}function Sn(n,e,t,r,s){let i=0;const c=new Array(be);for(let f=0;t!==0;f++,t>>>=1)c[f]=t&1?e[i++]:void 0;return c[r]=s,new lt(n,i+1,c)}function tr(n){return n-=n>>1&1431655765,n=(n&858993459)+(n>>2&858993459),n=n+(n>>4)&252645135,n+=n>>8,n+=n>>16,n&127}function gr(n,e,t,r){const s=r?n:ut(n);return s[e]=t,s}function In(n,e,t,r){const s=n.length+1;if(r&&e+1===s)return n[e]=t,n;const i=new Array(s);let c=0;for(let f=0;f<s;f++)f===e?(i[f]=t,c=-1):i[f]=n[f+c];return i}function On(n,e,t){const r=n.length-1;if(t&&e===r)return n.pop(),n;const s=new Array(r);let i=0;for(let c=0;c<r;c++)c===e&&(i=1),s[c]=n[c+i];return s}const Tn=be/4,Mn=be/2,Hn=be/4;var or,ar;class rr{constructor(e,t){y(this,"atoms");y(this,or,"AtomMap");this.name=e;let r=de();t&&(r=r.withMutations(s=>{for(const[i,c]of t)s.set(i,qe(`${e}:${String(i)}`,c))})),this.atoms=qe(`${e}:atoms`,r)}getAtom(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);if(!t){this.atoms.get();return}return t}get(e){var r;const t=(r=this.getAtom(e))==null?void 0:r.get();return I(t!==P),t}__unsafe__getWithoutCapture(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);if(!t)return;const r=t.__unsafe__getWithoutCapture();return I(r!==P),r}has(e){const t=this.getAtom(e);return t?t.get()!==P:!1}__unsafe__hasWithoutCapture(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);return t?(I(t.__unsafe__getWithoutCapture()!==P),!0):!1}set(e,t){const r=this.atoms.__unsafe__getWithoutCapture().get(e);return r?r.set(t):this.atoms.update(s=>s.set(e,qe(`${this.name}:${String(e)}`,t))),this}update(e,t){const r=this.atoms.__unsafe__getWithoutCapture().get(e);if(!r)throw new Error(`AtomMap: key ${e} not found`);const s=r.__unsafe__getWithoutCapture();I(s!==P),r.set(t(s))}delete(e){const t=this.atoms.__unsafe__getWithoutCapture().get(e);return t?(we(()=>{t.set(P),this.atoms.update(r=>r.delete(e))}),!0):!1}deleteMany(e){return we(()=>{const t=[],r=this.atoms.get().withMutations(s=>{for(const i of e){const c=s.get(i);if(!c)continue;const f=c.get();I(f!==P),t.push([i,f]),s.delete(i),c.set(P)}});return t.length&&this.atoms.set(r),t})}clear(){return we(()=>{for(const e of this.atoms.__unsafe__getWithoutCapture().values())e.set(P);this.atoms.set(de())})}*entries(){for(const[e,t]of this.atoms.get()){const r=t.get();I(r!==P),yield[e,r]}}*keys(){for(const e of this.atoms.get().keys())yield e}*values(){for(const e of this.atoms.get().values()){const t=e.get();I(t!==P),yield t}}get size(){return this.atoms.get().size}forEach(e,t){for(const[r,s]of this.entries())e.call(t,s,r,this)}[(ar=Symbol.iterator,or=Symbol.toStringTag,ar)](){return this.entries()}}class nt{constructor(e){y(this,"nextValue");y(this,"diff");this.previousValue=e}get(){var r,s,i,c;const e=((s=(r=this.diff)==null?void 0:r.removed)==null?void 0:s.size)??0,t=((c=(i=this.diff)==null?void 0:i.added)==null?void 0:c.size)??0;if(!(e===0&&t===0))return{value:this.nextValue,diff:this.diff}}_add(e,t){var r,s;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.add(e),this.diff??(this.diff={}),t?(r=this.diff.removed)==null||r.delete(e):((s=this.diff).added??(s.added=new Set),this.diff.added.add(e))}add(e){var s,i,c;const t=this.previousValue.has(e);if(t)return((i=(s=this.diff)==null?void 0:s.removed)==null?void 0:i.has(e))?this._add(e,t):void 0;(c=this.nextValue)!=null&&c.has(e)||this._add(e,t)}_remove(e,t){var r,s;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.delete(e),this.diff??(this.diff={}),t?((r=this.diff).removed??(r.removed=new Set),this.diff.removed.add(e)):(s=this.diff.added)==null||s.delete(e)}remove(e){var s,i,c,f;const t=this.previousValue.has(e);if(!t)return((i=(s=this.diff)==null?void 0:s.added)==null?void 0:i.has(e))?this._remove(e,t):void 0;(f=(c=this.diff)==null?void 0:c.removed)!=null&&f.has(e)||this._remove(e,t)}}class _t{constructor(e,t){y(this,"createDefaultProperties");y(this,"validator");y(this,"ephemeralKeys");y(this,"ephemeralKeySet");y(this,"scope");this.typeName=e,this.createDefaultProperties=t.createDefaultProperties,this.validator=t.validator??{validate:s=>s},this.scope=t.scope??"document",this.ephemeralKeys=t.ephemeralKeys;const r=new Set;if(t.ephemeralKeys)for(const[s,i]of Y(t.ephemeralKeys))i&&r.add(s);this.ephemeralKeySet=r}create(e){const t={...this.createDefaultProperties(),id:"id"in e?e.id:this.createId()};for(const[r,s]of Object.entries(e))s!==void 0&&(t[r]=s);return t.typeName=this.typeName,t}clone(e){return{...ae(e),id:this.createId()}}createId(e){return this.typeName+":"+(e??ur())}createCustomId(e){return this.typeName+":"+e}parseId(e){if(!this.isId(e))throw new Error(`ID "${e}" is not a valid ID for type "${this.typeName}"`);return e.slice(this.typeName.length+1)}isInstance(e){return(e==null?void 0:e.typeName)===this.typeName}isId(e){if(!e)return!1;for(let t=0;t<this.typeName.length;t++)if(e[t]!==this.typeName[t])return!1;return e[this.typeName.length]===":"}withDefaultProperties(e){return new _t(this.typeName,{createDefaultProperties:e,validator:this.validator,scope:this.scope,ephemeralKeys:this.ephemeralKeys})}validate(e,t){return t&&this.validator.validateUsingKnownGoodVersion?this.validator.validateUsingKnownGoodVersion(t,e):this.validator.validate(e)}}function ri(n,e){return new _t(n,{createDefaultProperties:()=>({}),validator:e.validator,scope:e.scope,ephemeralKeys:e.ephemeralKeys})}function si(){return{added:{},updated:{},removed:{}}}function ni(n){const e={added:n.removed,removed:n.added,updated:{}};for(const[t,r]of Object.values(n.updated))e.updated[t.id]=[r,t];return e}function ii(n){return Object.keys(n.added).length===0&&Object.keys(n.updated).length===0&&Object.keys(n.removed).length===0}function _r(n){const e={added:{},removed:{},updated:{}};return xn(e,n),e}function xn(n,e){for(const t of e){for(const[r,s]of Y(t.added))if(n.removed[r]){const i=n.removed[r];delete n.removed[r],i!==s&&(n.updated[r]=[i,s])}else n.added[r]=s;for(const[r,[s,i]]of Y(t.updated)){if(n.added[r]){n.added[r]=i,delete n.updated[r],delete n.removed[r];continue}if(n.updated[r]){n.updated[r]=[n.updated[r][0],i],delete n.removed[r];continue}n.updated[r]=t.updated[r],delete n.removed[r]}for(const[r,s]of Y(t.removed))n.added[r]?delete n.added[r]:n.updated[r]?(n.removed[r]=n.updated[r][0],delete n.updated[r]):n.removed[r]=s}}var Pe={exports:{}};Pe.exports;(function(n,e){var t=200,r="__lodash_hash_undefined__",s=1,i=2,c=9007199254740991,f="[object Arguments]",d="[object Array]",p="[object AsyncFunction]",l="[object Boolean]",g="[object Date]",_="[object Error]",v="[object Function]",w="[object GeneratorFunction]",m="[object Map]",H="[object Number]",Q="[object Null]",N="[object Object]",mt="[object Promise]",wr="[object Proxy]",yt="[object RegExp]",Ae="[object Set]",vt="[object String]",br="[object Symbol]",Ar="[object Undefined]",Le="[object WeakMap]",wt="[object ArrayBuffer]",Ee="[object DataView]",Er="[object Float32Array]",Cr="[object Float64Array]",Sr="[object Int8Array]",Ir="[object Int16Array]",Or="[object Int32Array]",Tr="[object Uint8Array]",Mr="[object Uint8ClampedArray]",Hr="[object Uint16Array]",xr="[object Uint32Array]",Rr=/[\\^$.*+?()[\]{}|]/g,Dr=/^\[object .+?Constructor\]$/,qr=/^(?:0|[1-9]\d*)$/,A={};A[Er]=A[Cr]=A[Sr]=A[Ir]=A[Or]=A[Tr]=A[Mr]=A[Hr]=A[xr]=!0,A[f]=A[d]=A[wt]=A[l]=A[Ee]=A[g]=A[_]=A[v]=A[m]=A[H]=A[N]=A[yt]=A[Ae]=A[vt]=A[Le]=!1;var bt=typeof De=="object"&&De&&De.Object===Object&&De,jr=typeof self=="object"&&self&&self.Object===Object&&self,L=bt||jr||Function("return this")(),At=e&&!e.nodeType&&e,Et=At&&!0&&n&&!n.nodeType&&n,Ct=Et&&Et.exports===At,Be=Ct&&bt.process,St=function(){try{return Be&&Be.binding&&Be.binding("util")}catch{}}(),It=St&&St.isTypedArray;function Pr(o,a){for(var u=-1,h=o==null?0:o.length,E=0,b=[];++u<h;){var S=o[u];a(S,u,o)&&(b[E++]=S)}return b}function $r(o,a){for(var u=-1,h=a.length,E=o.length;++u<h;)o[E+u]=a[u];return o}function zr(o,a){for(var u=-1,h=o==null?0:o.length;++u<h;)if(a(o[u],u,o))return!0;return!1}function Nr(o,a){for(var u=-1,h=Array(o);++u<o;)h[u]=a(u);return h}function Lr(o){return function(a){return o(a)}}function Br(o,a){return o.has(a)}function Vr(o,a){return o==null?void 0:o[a]}function Ur(o){var a=-1,u=Array(o.size);return o.forEach(function(h,E){u[++a]=[E,h]}),u}function Kr(o,a){return function(u){return o(a(u))}}function Wr(o){var a=-1,u=Array(o.size);return o.forEach(function(h){u[++a]=h}),u}var Fr=Array.prototype,Gr=Function.prototype,Ce=Object.prototype,Ve=L["__core-js_shared__"],Ot=Gr.toString,z=Ce.hasOwnProperty,Tt=function(){var o=/[^.]+$/.exec(Ve&&Ve.keys&&Ve.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}(),Mt=Ce.toString,Zr=RegExp("^"+Ot.call(z).replace(Rr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ht=Ct?L.Buffer:void 0,Se=L.Symbol,xt=L.Uint8Array,Rt=Ce.propertyIsEnumerable,Yr=Fr.splice,X=Se?Se.toStringTag:void 0,Dt=Object.getOwnPropertySymbols,Qr=Ht?Ht.isBuffer:void 0,Xr=Kr(Object.keys,Object),Ue=oe(L,"DataView"),ge=oe(L,"Map"),Ke=oe(L,"Promise"),We=oe(L,"Set"),Fe=oe(L,"WeakMap"),_e=oe(Object,"create"),Jr=ee(Ue),kr=ee(ge),es=ee(Ke),ts=ee(We),rs=ee(Fe),qt=Se?Se.prototype:void 0,Ge=qt?qt.valueOf:void 0;function J(o){var a=-1,u=o==null?0:o.length;for(this.clear();++a<u;){var h=o[a];this.set(h[0],h[1])}}function ss(){this.__data__=_e?_e(null):{},this.size=0}function ns(o){var a=this.has(o)&&delete this.__data__[o];return this.size-=a?1:0,a}function is(o){var a=this.__data__;if(_e){var u=a[o];return u===r?void 0:u}return z.call(a,o)?a[o]:void 0}function os(o){var a=this.__data__;return _e?a[o]!==void 0:z.call(a,o)}function as(o,a){var u=this.__data__;return this.size+=this.has(o)?0:1,u[o]=_e&&a===void 0?r:a,this}J.prototype.clear=ss,J.prototype.delete=ns,J.prototype.get=is,J.prototype.has=os,J.prototype.set=as;function B(o){var a=-1,u=o==null?0:o.length;for(this.clear();++a<u;){var h=o[a];this.set(h[0],h[1])}}function cs(){this.__data__=[],this.size=0}function us(o){var a=this.__data__,u=Oe(a,o);if(u<0)return!1;var h=a.length-1;return u==h?a.pop():Yr.call(a,u,1),--this.size,!0}function fs(o){var a=this.__data__,u=Oe(a,o);return u<0?void 0:a[u][1]}function ds(o){return Oe(this.__data__,o)>-1}function ls(o,a){var u=this.__data__,h=Oe(u,o);return h<0?(++this.size,u.push([o,a])):u[h][1]=a,this}B.prototype.clear=cs,B.prototype.delete=us,B.prototype.get=fs,B.prototype.has=ds,B.prototype.set=ls;function k(o){var a=-1,u=o==null?0:o.length;for(this.clear();++a<u;){var h=o[a];this.set(h[0],h[1])}}function hs(){this.size=0,this.__data__={hash:new J,map:new(ge||B),string:new J}}function ps(o){var a=Te(this,o).delete(o);return this.size-=a?1:0,a}function gs(o){return Te(this,o).get(o)}function _s(o){return Te(this,o).has(o)}function ms(o,a){var u=Te(this,o),h=u.size;return u.set(o,a),this.size+=u.size==h?0:1,this}k.prototype.clear=hs,k.prototype.delete=ps,k.prototype.get=gs,k.prototype.has=_s,k.prototype.set=ms;function Ie(o){var a=-1,u=o==null?0:o.length;for(this.__data__=new k;++a<u;)this.add(o[a])}function ys(o){return this.__data__.set(o,r),this}function vs(o){return this.__data__.has(o)}Ie.prototype.add=Ie.prototype.push=ys,Ie.prototype.has=vs;function K(o){var a=this.__data__=new B(o);this.size=a.size}function ws(){this.__data__=new B,this.size=0}function bs(o){var a=this.__data__,u=a.delete(o);return this.size=a.size,u}function As(o){return this.__data__.get(o)}function Es(o){return this.__data__.has(o)}function Cs(o,a){var u=this.__data__;if(u instanceof B){var h=u.__data__;if(!ge||h.length<t-1)return h.push([o,a]),this.size=++u.size,this;u=this.__data__=new k(h)}return u.set(o,a),this.size=u.size,this}K.prototype.clear=ws,K.prototype.delete=bs,K.prototype.get=As,K.prototype.has=Es,K.prototype.set=Cs;function Ss(o,a){var u=Me(o),h=!u&&Ls(o),E=!u&&!h&&Ze(o),b=!u&&!h&&!E&&Ut(o),S=u||h||E||b,O=S?Nr(o.length,String):[],T=O.length;for(var C in o)z.call(o,C)&&!(S&&(C=="length"||E&&(C=="offset"||C=="parent")||b&&(C=="buffer"||C=="byteLength"||C=="byteOffset")||js(C,T)))&&O.push(C);return O}function Oe(o,a){for(var u=o.length;u--;)if(Nt(o[u][0],a))return u;return-1}function Is(o,a,u){var h=a(o);return Me(o)?h:$r(h,u(o))}function me(o){return o==null?o===void 0?Ar:Q:X&&X in Object(o)?Ds(o):Ns(o)}function jt(o){return ye(o)&&me(o)==f}function Pt(o,a,u,h,E){return o===a?!0:o==null||a==null||!ye(o)&&!ye(a)?o!==o&&a!==a:Os(o,a,u,h,Pt,E)}function Os(o,a,u,h,E,b){var S=Me(o),O=Me(a),T=S?d:W(o),C=O?d:W(a);T=T==f?N:T,C=C==f?N:C;var R=T==N,j=C==N,M=T==C;if(M&&Ze(o)){if(!Ze(a))return!1;S=!0,R=!1}if(M&&!R)return b||(b=new K),S||Ut(o)?$t(o,a,u,h,E,b):xs(o,a,T,u,h,E,b);if(!(u&s)){var D=R&&z.call(o,"__wrapped__"),q=j&&z.call(a,"__wrapped__");if(D||q){var F=D?o.value():o,V=q?a.value():a;return b||(b=new K),E(F,V,u,h,b)}}return M?(b||(b=new K),Rs(o,a,u,h,E,b)):!1}function Ts(o){if(!Vt(o)||$s(o))return!1;var a=Lt(o)?Zr:Dr;return a.test(ee(o))}function Ms(o){return ye(o)&&Bt(o.length)&&!!A[me(o)]}function Hs(o){if(!zs(o))return Xr(o);var a=[];for(var u in Object(o))z.call(o,u)&&u!="constructor"&&a.push(u);return a}function $t(o,a,u,h,E,b){var S=u&s,O=o.length,T=a.length;if(O!=T&&!(S&&T>O))return!1;var C=b.get(o);if(C&&b.get(a))return C==a;var R=-1,j=!0,M=u&i?new Ie:void 0;for(b.set(o,a),b.set(a,o);++R<O;){var D=o[R],q=a[R];if(h)var F=S?h(q,D,R,a,o,b):h(D,q,R,o,a,b);if(F!==void 0){if(F)continue;j=!1;break}if(M){if(!zr(a,function(V,te){if(!Br(M,te)&&(D===V||E(D,V,u,h,b)))return M.push(te)})){j=!1;break}}else if(!(D===q||E(D,q,u,h,b))){j=!1;break}}return b.delete(o),b.delete(a),j}function xs(o,a,u,h,E,b,S){switch(u){case Ee:if(o.byteLength!=a.byteLength||o.byteOffset!=a.byteOffset)return!1;o=o.buffer,a=a.buffer;case wt:return!(o.byteLength!=a.byteLength||!b(new xt(o),new xt(a)));case l:case g:case H:return Nt(+o,+a);case _:return o.name==a.name&&o.message==a.message;case yt:case vt:return o==a+"";case m:var O=Ur;case Ae:var T=h&s;if(O||(O=Wr),o.size!=a.size&&!T)return!1;var C=S.get(o);if(C)return C==a;h|=i,S.set(o,a);var R=$t(O(o),O(a),h,E,b,S);return S.delete(o),R;case br:if(Ge)return Ge.call(o)==Ge.call(a)}return!1}function Rs(o,a,u,h,E,b){var S=u&s,O=zt(o),T=O.length,C=zt(a),R=C.length;if(T!=R&&!S)return!1;for(var j=T;j--;){var M=O[j];if(!(S?M in a:z.call(a,M)))return!1}var D=b.get(o);if(D&&b.get(a))return D==a;var q=!0;b.set(o,a),b.set(a,o);for(var F=S;++j<T;){M=O[j];var V=o[M],te=a[M];if(h)var Kt=S?h(te,V,M,a,o,b):h(V,te,M,o,a,b);if(!(Kt===void 0?V===te||E(V,te,u,h,b):Kt)){q=!1;break}F||(F=M=="constructor")}if(q&&!F){var He=o.constructor,xe=a.constructor;He!=xe&&"constructor"in o&&"constructor"in a&&!(typeof He=="function"&&He instanceof He&&typeof xe=="function"&&xe instanceof xe)&&(q=!1)}return b.delete(o),b.delete(a),q}function zt(o){return Is(o,Us,qs)}function Te(o,a){var u=o.__data__;return Ps(a)?u[typeof a=="string"?"string":"hash"]:u.map}function oe(o,a){var u=Vr(o,a);return Ts(u)?u:void 0}function Ds(o){var a=z.call(o,X),u=o[X];try{o[X]=void 0;var h=!0}catch{}var E=Mt.call(o);return h&&(a?o[X]=u:delete o[X]),E}var qs=Dt?function(o){return o==null?[]:(o=Object(o),Pr(Dt(o),function(a){return Rt.call(o,a)}))}:Ks,W=me;(Ue&&W(new Ue(new ArrayBuffer(1)))!=Ee||ge&&W(new ge)!=m||Ke&&W(Ke.resolve())!=mt||We&&W(new We)!=Ae||Fe&&W(new Fe)!=Le)&&(W=function(o){var a=me(o),u=a==N?o.constructor:void 0,h=u?ee(u):"";if(h)switch(h){case Jr:return Ee;case kr:return m;case es:return mt;case ts:return Ae;case rs:return Le}return a});function js(o,a){return a=a??c,!!a&&(typeof o=="number"||qr.test(o))&&o>-1&&o%1==0&&o<a}function Ps(o){var a=typeof o;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?o!=="__proto__":o===null}function $s(o){return!!Tt&&Tt in o}function zs(o){var a=o&&o.constructor,u=typeof a=="function"&&a.prototype||Ce;return o===u}function Ns(o){return Mt.call(o)}function ee(o){if(o!=null){try{return Ot.call(o)}catch{}try{return o+""}catch{}}return""}function Nt(o,a){return o===a||o!==o&&a!==a}var Ls=jt(function(){return arguments}())?jt:function(o){return ye(o)&&z.call(o,"callee")&&!Rt.call(o,"callee")},Me=Array.isArray;function Bs(o){return o!=null&&Bt(o.length)&&!Lt(o)}var Ze=Qr||Ws;function Vs(o,a){return Pt(o,a)}function Lt(o){if(!Vt(o))return!1;var a=me(o);return a==v||a==w||a==p||a==wr}function Bt(o){return typeof o=="number"&&o>-1&&o%1==0&&o<=c}function Vt(o){var a=typeof o;return o!=null&&(a=="object"||a=="function")}function ye(o){return o!=null&&typeof o=="object"}var Ut=It?Lr(It):Ms;function Us(o){return Bs(o)?Ss(o):Hs(o)}function Ks(){return[]}function Ws(){return!1}n.exports=Vs})(Pe,Pe.exports);var Rn=Pe.exports;const mr=Js(Rn);function Dn(n){if(n.length===0)return new Set;const e=n[0],t=n.slice(1),r=new Set;for(const s of e)t.every(i=>i.has(s))&&r.add(s);return r}function qn(n,e){const t={};for(const r of e)n.has(r)||(t.added??(t.added=new Set),t.added.add(r));for(const r of n)e.has(r)||(t.removed??(t.removed=new Set),t.removed.add(r));return t.added||t.removed?t:void 0}function sr(n,e){for(const[t,r]of Object.entries(n)){const s=r,i=e[t];if("eq"in s&&i!==s.eq||"neq"in s&&i===s.neq||"gt"in s&&(typeof i!="number"||i<=s.gt))return!1}return!0}function nr(n,e,t){const r=Object.fromEntries(Object.keys(t).map(s=>[s,new Set]));for(const[s,i]of Object.entries(t))if("eq"in i){const f=n.index(e,s).get().get(i.eq);if(f)for(const d of f)r[s].add(d)}else if("neq"in i){const c=n.index(e,s);for(const[f,d]of c.get())if(f!==i.neq)for(const p of d)r[s].add(p)}else if("gt"in i){const c=n.index(e,s);for(const[f,d]of c.get())if(f>i.gt)for(const p of d)r[s].add(p)}return Dn(Object.values(r))}class jn{constructor(e,t){y(this,"indexCache",new Map);y(this,"historyCache",new Map);this.recordMap=e,this.history=t}filterHistory(e){if(this.historyCache.has(e))return this.historyCache.get(e);const t=Z("filterHistory:"+e,(r,s)=>{if(Ye(r))return this.history.get();const i=this.history.getDiffSince(s);if(i===Qe)return this.history.get();const c={added:{},removed:{},updated:{}};let f=0,d=0,p=0;for(const l of i){for(const g of x(l.added))if(g.typeName===e)if(c.removed[g.id]){const _=c.removed[g.id];delete c.removed[g.id],d--,_!==g&&(c.updated[g.id]=[_,g],p++)}else c.added[g.id]=g,f++;for(const[g,_]of x(l.updated))_.typeName===e&&(c.added[_.id]?c.added[_.id]=_:c.updated[_.id]?c.updated[_.id]=[c.updated[_.id][0],_]:(c.updated[_.id]=[g,_],p++));for(const g of x(l.removed))g.typeName===e&&(c.added[g.id]?(delete c.added[g.id],f--):c.updated[g.id]?(c.removed[g.id]=c.updated[g.id][0],delete c.updated[g.id],p--,d++):(c.removed[g.id]=g,d++))}return f||d||p?Re(this.history.get(),c):r},{historyLength:100});return this.historyCache.set(e,t),t}index(e,t){const r=e+":"+t;if(this.indexCache.has(r))return this.indexCache.get(r);const s=this.__uncached_createIndex(e,t);return this.indexCache.set(r,s),s}__uncached_createIndex(e,t){const r=this.filterHistory(e),s=()=>{r.get();const i=new Map;for(const c of this.recordMap.values())if(c.typeName===e){const f=c[t];i.has(f)||i.set(f,new Set),i.get(f).add(c.id)}return i};return Z("index:"+e+":"+t,(i,c)=>{if(Ye(i))return s();const f=r.getDiffSince(c);if(f===Qe)return s();const d=new Map,p=(v,w)=>{let m=d.get(v);m||(m=new nt(i.get(v)??new Set)),m.add(w),d.set(v,m)},l=(v,w)=>{let m=d.get(v);m||(m=new nt(i.get(v)??new Set)),m.remove(w),d.set(v,m)};for(const v of f){for(const w of x(v.added))if(w.typeName===e){const m=w[t];p(m,w.id)}for(const[w,m]of x(v.updated))if(m.typeName===e){const H=w[t],Q=m[t];H!==Q&&(l(H,m.id),p(Q,m.id))}for(const w of x(v.removed))if(w.typeName===e){const m=w[t];l(m,w.id)}}let g,_;for(const[v,w]of d){const m=w.get();m&&(g||(g=new Map(i)),_||(_=new Map),m.value.size===0?g.delete(v):g.set(v,m.value),_.set(v,m.diff))}return g&&_?Re(g,_):i},{historyLength:100})}record(e,t=()=>({}),r="record:"+e+(t?":"+t.toString():"")){const s=this.ids(e,t,r);return Z(r,()=>{for(const i of s.get())return this.recordMap.get(i)})}records(e,t=()=>({}),r="records:"+e+(t?":"+t.toString():"")){const s=this.ids(e,t,"ids:"+r);return Z(r,()=>Array.from(s.get(),i=>this.recordMap.get(i)),{isEqual:ks})}ids(e,t=()=>({}),r="ids:"+e+(t?":"+t.toString():"")){const s=this.filterHistory(e),i=()=>{s.get();const d=t();if(Object.keys(d).length===0){const p=new Set;for(const l of this.recordMap.values())l.typeName===e&&p.add(l.id);return p}return nr(this,e,d)},c=d=>{const p=i(),l=qn(d,p);return l?Re(p,l):d},f=Z("ids_query:"+r,t,{isEqual:mr});return Z("query:"+r,(d,p)=>{const l=f.get();if(Ye(d))return i();if(p<f.lastChangedEpoch)return c(d);const g=s.getDiffSince(p);if(g===Qe)return c(d);const _=new nt(d);for(const w of g){for(const m of x(w.added))m.typeName===e&&sr(l,m)&&_.add(m.id);for(const[m,H]of x(w.updated))H.typeName===e&&(sr(l,H)?_.add(H.id):_.remove(H.id));for(const m of x(w.removed))m.typeName===e&&_.remove(m.id)}const v=_.get();return v?Re(v.value,v.diff):d},{historyLength:50})}exec(e,t){const r=nr(this,e,t);return r.size===0?Zs:Array.from(r,s=>this.recordMap.get(s))}}class Pn{constructor(e){y(this,"_beforeCreateHandlers",{});y(this,"_afterCreateHandlers",{});y(this,"_beforeChangeHandlers",{});y(this,"_afterChangeHandlers",{});y(this,"_beforeDeleteHandlers",{});y(this,"_afterDeleteHandlers",{});y(this,"_operationCompleteHandlers",[]);y(this,"_isEnabled",!0);this.store=e}isEnabled(){return this._isEnabled}setIsEnabled(e){this._isEnabled=e}handleBeforeCreate(e,t){if(!this._isEnabled)return e;const r=this._beforeCreateHandlers[e.typeName];if(r){let s=e;for(const i of r)s=i(s,t);return s}return e}handleAfterCreate(e,t){if(!this._isEnabled)return;const r=this._afterCreateHandlers[e.typeName];if(r)for(const s of r)s(e,t)}handleBeforeChange(e,t,r){if(!this._isEnabled)return t;const s=this._beforeChangeHandlers[t.typeName];if(s){let i=t;for(const c of s)i=c(e,i,r);return i}return t}handleAfterChange(e,t,r){if(!this._isEnabled)return;const s=this._afterChangeHandlers[t.typeName];if(s)for(const i of s)i(e,t,r)}handleBeforeDelete(e,t){if(!this._isEnabled)return!0;const r=this._beforeDeleteHandlers[e.typeName];if(r){for(const s of r)if(s(e,t)===!1)return!1}return!0}handleAfterDelete(e,t){if(!this._isEnabled)return;const r=this._afterDeleteHandlers[e.typeName];if(r)for(const s of r)s(e,t)}handleOperationComplete(e){if(this._isEnabled)for(const t of this._operationCompleteHandlers)t(e)}register(e){const t=[];for(const[r,s]of Object.entries(e))s!=null&&s.beforeCreate&&t.push(this.registerBeforeCreateHandler(r,s.beforeCreate)),s!=null&&s.afterCreate&&t.push(this.registerAfterCreateHandler(r,s.afterCreate)),s!=null&&s.beforeChange&&t.push(this.registerBeforeChangeHandler(r,s.beforeChange)),s!=null&&s.afterChange&&t.push(this.registerAfterChangeHandler(r,s.afterChange)),s!=null&&s.beforeDelete&&t.push(this.registerBeforeDeleteHandler(r,s.beforeDelete)),s!=null&&s.afterDelete&&t.push(this.registerAfterDeleteHandler(r,s.afterDelete));return()=>{for(const r of t)r()}}registerBeforeCreateHandler(e,t){return this._beforeCreateHandlers[e]||(this._beforeCreateHandlers[e]=[]),this._beforeCreateHandlers[e].push(t),()=>re(this._beforeCreateHandlers[e],t)}registerAfterCreateHandler(e,t){return this._afterCreateHandlers[e]||(this._afterCreateHandlers[e]=[]),this._afterCreateHandlers[e].push(t),()=>re(this._afterCreateHandlers[e],t)}registerBeforeChangeHandler(e,t){return this._beforeChangeHandlers[e]||(this._beforeChangeHandlers[e]=[]),this._beforeChangeHandlers[e].push(t),()=>re(this._beforeChangeHandlers[e],t)}registerAfterChangeHandler(e,t){return this._afterChangeHandlers[e]||(this._afterChangeHandlers[e]=[]),this._afterChangeHandlers[e].push(t),()=>re(this._afterChangeHandlers[e],t)}registerBeforeDeleteHandler(e,t){return this._beforeDeleteHandlers[e]||(this._beforeDeleteHandlers[e]=[]),this._beforeDeleteHandlers[e].push(t),()=>re(this._beforeDeleteHandlers[e],t)}registerAfterDeleteHandler(e,t){return this._afterDeleteHandlers[e]||(this._afterDeleteHandlers[e]=[]),this._afterDeleteHandlers[e].push(t),()=>re(this._afterDeleteHandlers[e],t)}registerOperationCompleteHandler(e){return this._operationCompleteHandlers.push(e),()=>re(this._operationCompleteHandlers,e)}}function re(n,e){const t=n.indexOf(e);t>=0&&n.splice(t,1)}let $n=class{constructor(e){y(this,"id");y(this,"records");y(this,"history",qe("history",0,{historyLength:1e3}));y(this,"query");y(this,"listeners",new Set);y(this,"historyAccumulator",new Nn);y(this,"historyReactor");y(this,"schema");y(this,"props");y(this,"scopedTypes");y(this,"sideEffects",new Pn(this));y(this,"isMergingRemoteChanges",!1);y(this,"_integrityChecker");y(this,"_isPossiblyCorrupted",!1);y(this,"pendingAfterEvents",null);y(this,"_isInAtomicOp",!1);const{initialData:t,schema:r,id:s}=e;this.id=s??ur(),this.schema=r,this.props=e.props,t?this.records=new rr("store",Y(t).map(([i,c])=>[i,this.schema.validateRecord(this,c,"initialize",null)])):this.records=new rr("store"),this.query=new jn(this.records,this.history),this.historyReactor=Ys("Store.historyReactor",()=>{this.history.get(),this._flushHistory()},{scheduleEffect:i=>this.cancelHistoryReactor=dn(i)}),this.scopedTypes={document:new Set(x(this.schema.types).filter(i=>i.scope==="document").map(i=>i.typeName)),session:new Set(x(this.schema.types).filter(i=>i.scope==="session").map(i=>i.typeName)),presence:new Set(x(this.schema.types).filter(i=>i.scope==="presence").map(i=>i.typeName))}}cancelHistoryReactor(){}_flushHistory(){if(this.historyAccumulator.hasChanges()){const e=this.historyAccumulator.flush();for(const{changes:t,source:r}of e){let s=null,i=null,c=null;for(const{onHistory:f,filters:d}of this.listeners)if(!(d.source!=="all"&&d.source!==r))if(d.scope!=="all")if(d.scope==="document"){if(i??(i=this.filterChangesByScope(t,"document")),!i)continue;f({changes:i,source:r})}else if(d.scope==="session"){if(s??(s=this.filterChangesByScope(t,"session")),!s)continue;f({changes:s,source:r})}else{if(c??(c=this.filterChangesByScope(t,"presence")),!c)continue;f({changes:c,source:r})}else f({changes:t,source:r})}}}dispose(){this.cancelHistoryReactor()}filterChangesByScope(e,t){const r={added:Xe(e.added,(s,i)=>this.scopedTypes[t].has(i.typeName)),updated:Xe(e.updated,(s,i)=>this.scopedTypes[t].has(i[1].typeName)),removed:Xe(e.removed,(s,i)=>this.scopedTypes[t].has(i.typeName))};return Object.keys(r.added).length===0&&Object.keys(r.updated).length===0&&Object.keys(r.removed).length===0?null:r}updateHistory(e){this.historyAccumulator.add({changes:e,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.get()+1,e)}validate(e){this.allRecords().forEach(t=>this.schema.validateRecord(this,t,e,null))}put(e,t){this.atomic(()=>{const r={},s={};let i,c=!1;const f=this.isMergingRemoteChanges?"remote":"user";for(let d=0,p=e.length;d<p;d++){i=e[d];const l=this.records.__unsafe__getWithoutCapture(i.id);if(l){if(i=this.sideEffects.handleBeforeChange(l,i,f),this.schema.validateRecord(this,i,t??"updateRecord",l)===l)continue;i=i,this.records.set(i.id,i),c=!0,r[i.id]=[l,i],this.addDiffForAfterEvent(l,i)}else i=this.sideEffects.handleBeforeCreate(i,f),c=!0,i=this.schema.validateRecord(this,i,t??"createRecord",null),i=i,s[i.id]=i,this.addDiffForAfterEvent(null,i),this.records.set(i.id,i)}c&&this.updateHistory({added:s,updated:r,removed:{}})})}remove(e){this.atomic(()=>{const t=new Set(e),r=this.isMergingRemoteChanges?"remote":"user";if(this.sideEffects.isEnabled())for(const c of e){const f=this.records.__unsafe__getWithoutCapture(c);f&&this.sideEffects.handleBeforeDelete(f,r)===!1&&t.delete(c)}const s=this.records.deleteMany(t);if(s.length===0)return;const i={};for(const[c,f]of s)i[c]=f,this.addDiffForAfterEvent(f,null);this.updateHistory({added:{},updated:{},removed:i})})}get(e){return this.records.get(e)}unsafeGetWithoutCapture(e){return this.records.__unsafe__getWithoutCapture(e)}serialize(e="document"){const t={};for(const[r,s]of this.records)(e==="all"||this.scopedTypes[e].has(s.typeName))&&(t[r]=s);return t}getStoreSnapshot(e="document"){return{store:this.serialize(e),schema:this.schema.serialize()}}getSnapshot(e="document"){return console.warn("[tldraw] `Store.getSnapshot` is deprecated and will be removed in a future release. Use `getSnapshot` from the `tldraw` package instead."),this.getStoreSnapshot(e)}migrateSnapshot(e){const t=this.schema.migrateStoreSnapshot(e);if(t.type==="error")throw new Error(`Failed to migrate snapshot: ${t.reason}`);return{store:t.value,schema:this.schema.serialize()}}loadStoreSnapshot(e){const t=this.schema.migrateStoreSnapshot(e);if(t.type==="error")throw new Error(`Failed to migrate snapshot: ${t.reason}`);const r=this.sideEffects.isEnabled();try{this.sideEffects.setIsEnabled(!1),this.atomic(()=>{this.clear(),this.put(Object.values(t.value)),this.ensureStoreIsUsable()})}finally{this.sideEffects.setIsEnabled(r)}}loadSnapshot(e){console.warn("[tldraw] `Store.loadSnapshot` is deprecated and will be removed in a future release. Use `loadSnapshot` from the 'tldraw' package instead."),this.loadStoreSnapshot(e)}allRecords(){return Array.from(this.records.values())}clear(){this.remove(Array.from(this.records.keys()))}update(e,t){const r=this.unsafeGetWithoutCapture(e);if(!r){console.error(`Record ${e} not found. This is probably an error`);return}this.put([t(r)])}has(e){return this.records.has(e)}listen(e,t){this._flushHistory();const r={onHistory:e,filters:{source:(t==null?void 0:t.source)??"all",scope:(t==null?void 0:t.scope)??"all"}};return this.historyReactor.scheduler.isActivelyListening||(this.historyReactor.start(),this.historyReactor.scheduler.execute()),this.listeners.add(r),()=>{this.listeners.delete(r),this.listeners.size===0&&this.historyReactor.stop()}}mergeRemoteChanges(e){if(this.isMergingRemoteChanges)return e();if(this._isInAtomicOp)throw new Error("Cannot merge remote changes while in atomic operation");try{this.atomic(e,!0,!0)}finally{this.ensureStoreIsUsable()}}extractingChanges(e){const t=[],r=this.historyAccumulator.addInterceptor(s=>t.push(s.changes));try{return we(e),_r(t)}finally{r()}}applyDiff(e,{runCallbacks:t=!0,ignoreEphemeralKeys:r=!1}={}){this.atomic(()=>{const s=x(e.added);for(const[c,f]of x(e.updated)){const d=this.schema.getType(f.typeName);if(r&&d.ephemeralKeySet.size){const p=this.get(f.id);if(!p){s.push(f);continue}let l=null;for(const[g,_]of Object.entries(f))d.ephemeralKeySet.has(g)||Object.is(_,it(p,g))||(l||(l={...p}),l[g]=_);l&&s.push(l)}else s.push(f)}const i=an(e.removed);s.length&&this.put(s),i.length&&this.remove(i)},t)}createCache(e){const t=new cr;return{get:r=>{const s=this.records.getAtom(r);if(s)return t.get(s,()=>e(r,s)).get()}}}createComputedCache(e,t,r){return this.createCache((s,i)=>{const c=r!=null&&r.areRecordsEqual?Z(`${e}:${s}:isEqual`,()=>i.get(),{isEqual:r.areRecordsEqual}):i;return Z(e+":"+s,()=>t(c.get()),{isEqual:r==null?void 0:r.areResultsEqual})})}ensureStoreIsUsable(){this.atomic(()=>{var e;this._integrityChecker??(this._integrityChecker=this.schema.createIntegrityChecker(this)),(e=this._integrityChecker)==null||e.call(this)})}markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}addDiffForAfterEvent(e,t){if(I(this.pendingAfterEvents,"must be in event operation"),e===t||(e&&t&&I(e.id===t.id),!e&&!t))return;const r=(e||t).id,s=this.pendingAfterEvents.get(r);s?s.after=t:this.pendingAfterEvents.set(r,{before:e,after:t})}flushAtomicCallbacks(e){let t=0,r=e?"remote":"user";for(;this.pendingAfterEvents;){const s=this.pendingAfterEvents;if(this.pendingAfterEvents=null,!!this.sideEffects.isEnabled()){if(t++,t>100)throw new Error("Maximum store update depth exceeded, bailing out");for(const{before:i,after:c}of s.values())i&&c&&i!==c&&!mr(i,c)?this.sideEffects.handleAfterChange(i,c,r):i&&!c?this.sideEffects.handleAfterDelete(i,r):!i&&c&&this.sideEffects.handleAfterCreate(c,r);this.pendingAfterEvents?r="user":this.sideEffects.handleOperationComplete(r)}}}atomic(e,t=!0,r=!1){return we(()=>{if(this._isInAtomicOp){this.pendingAfterEvents||(this.pendingAfterEvents=new Map);const i=this.sideEffects.isEnabled();I(!r,"cannot call mergeRemoteChanges while in atomic operation");try{return i&&!t&&this.sideEffects.setIsEnabled(!1),e()}finally{this.sideEffects.setIsEnabled(i)}}this.pendingAfterEvents=new Map;const s=this.sideEffects.isEnabled();this.sideEffects.setIsEnabled(t??s),this._isInAtomicOp=!0,r&&(this.isMergingRemoteChanges=!0);try{const i=e();return this.isMergingRemoteChanges=!1,this.flushAtomicCallbacks(r),i}finally{this.pendingAfterEvents=null,this.sideEffects.setIsEnabled(s),this._isInAtomicOp=!1,this.isMergingRemoteChanges=!1}})}addHistoryInterceptor(e){return this.historyAccumulator.addInterceptor(t=>e(t,this.isMergingRemoteChanges?"remote":"user"))}};function zn(n){if(n.length===0)return[];const e=[];let t=[n[0]],r;for(let s=1,i=n.length;s<i;s++)r=n[s],t[0].source!==r.source&&(e.push(t),t=[]),t.push(r);return e.push(t),e.map(s=>({source:s[0].source,changes:_r(s.map(i=>i.changes))}))}class Nn{constructor(){y(this,"_history",[]);y(this,"_interceptors",new Set)}addInterceptor(e){return this._interceptors.add(e),()=>{this._interceptors.delete(e)}}add(e){this._history.push(e);for(const t of this._interceptors)t(e)}flush(){const e=zn(this._history);return this._history=[],e}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function ai(n,e,t){const r=new cr;return{get(s,i){return r.get(s,()=>(s instanceof $n?s:s.store).createComputedCache(n,d=>e(s,d),t)).get(i)}}}function Ln(n){const e=[];for(let t=n.length-1;t>=0;t--){const r=n[t];if("id"in r)e.unshift(r);else{const s=r.dependsOn,i=e[0];i&&(e[0]={...i,dependsOn:s.concat(i.dependsOn??[])})}}return e}function Bn({sequence:n,sequenceId:e,retroactive:t=!0}){const r={sequenceId:e,retroactive:t,sequence:Ln(n)};return yr(r),r}function ci(n,e){return Object.fromEntries(Y(e).map(([t,r])=>[t,`${n}/${r}`]))}function ui(n){const e=n.sequenceId;return Bn({sequenceId:e,retroactive:n.retroactive??!0,sequence:n.sequence.map(t=>"id"in t?{...t,scope:"record",filter:r=>{var s,i;return r.typeName===n.recordType&&(((s=t.filter)==null?void 0:s.call(t,r))??!0)&&(((i=n.filter)==null?void 0:i.call(n,r))??!0)}}:t)})}function Vn(n){const e=new Map(n.map(i=>[i.id,i])),t=new Set,r=[];function s(i){I(!t.has(i.id),`Circular dependency in migrations: ${i.id}`),t.add(i.id);const{version:c,sequenceId:f}=$e(i.id),d=e.get(`${f}/${c-1}`);if(d&&s(d),i.dependsOn)for(const p of i.dependsOn){const l=e.get(p);l&&s(l)}e.delete(i.id),r.push(i)}for(const i of e.values())s(i);return r}function $e(n){const[e,t]=n.split("/");return{sequenceId:e,version:parseInt(t)}}function ir(n,e){e&&I(n.startsWith(e+"/"),`Every migration in sequence '${e}' must have an id starting with '${e}/'. Got invalid id: '${n}'`),I(n.match(/^(.*?)\/(0|[1-9]\d*)$/),`Invalid migration id: '${n}'`)}function yr(n){if(I(!n.sequenceId.includes("/"),`sequenceId cannot contain a '/', got ${n.sequenceId}`),I(n.sequenceId.length,"sequenceId must be a non-empty string"),n.sequence.length===0)return;ir(n.sequence[0].id,n.sequenceId);let e=$e(n.sequence[0].id).version;I(e===1,`Expected the first migrationId to be '${n.sequenceId}/1' but got '${n.sequence[0].id}'`);for(let t=1;t<n.sequence.length;t++){const r=n.sequence[t].id;ir(r,n.sequenceId);const s=$e(r).version;I(s===e+1,`Migration id numbers must increase in increments of 1, expected ${n.sequenceId}/${e+1} but got '${n.sequence[t].id}'`),e=s}}var G=(n=>(n.IncompatibleSubtype="incompatible-subtype",n.UnknownType="unknown-type",n.TargetVersionTooNew="target-version-too-new",n.TargetVersionTooOld="target-version-too-old",n.MigrationError="migration-error",n.UnrecognizedSubtype="unrecognized-subtype",n))(G||{});function Un(n){if(n.schemaVersion>2||n.schemaVersion<1)return fe.err("Bad schema version");if(n.schemaVersion===2)return fe.ok(n);const e={schemaVersion:2,sequences:{"com.tldraw.store":n.storeVersion}};for(const[t,r]of Object.entries(n.recordVersions))if(e.sequences[`com.tldraw.${t}`]=r.version,"subTypeKey"in r)for(const[s,i]of Object.entries(r.subTypeVersions))e.sequences[`com.tldraw.${t}.${s}`]=i;return fe.ok(e)}class vr{constructor(e,t){y(this,"migrations",{});y(this,"sortedMigrations");var s;this.types=e,this.options=t;for(const i of t.migrations??[])I(!this.migrations[i.sequenceId],`Duplicate migration sequenceId ${i.sequenceId}`),yr(i),this.migrations[i.sequenceId]=i;const r=Object.values(this.migrations).flatMap(i=>i.sequence);this.sortedMigrations=Vn(r);for(const i of this.sortedMigrations)if((s=i.dependsOn)!=null&&s.length)for(const c of i.dependsOn){const f=r.find(d=>d.id===c);I(f,`Migration '${i.id}' depends on missing migration '${c}'`)}}static create(e,t){return new vr(e,t??{})}validateRecord(e,t,r,s){try{const i=it(this.types,t.typeName);if(!i)throw new Error(`Missing definition for record type ${t.typeName}`);return i.validate(t,s??void 0)}catch(i){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:e,record:t,phase:r,recordBefore:s,error:i});throw i}}getMigrationsSince(e){const t=Un(e);if(!t.ok)return t;const r=t.value,s=new Set(Object.keys(r.sequences).filter(c=>this.migrations[c]));for(const c in this.migrations)r.sequences[c]===void 0&&this.migrations[c].retroactive&&s.add(c);if(s.size===0)return fe.ok([]);const i=new Set;for(const c of s){const f=r.sequences[c];if(typeof f!="number"&&this.migrations[c].retroactive||f===0){for(const l of this.migrations[c].sequence)i.add(l.id);continue}const d=`${c}/${f}`,p=this.migrations[c].sequence.findIndex(l=>l.id===d);if(p===-1)return fe.err("Incompatible schema?");for(const l of this.migrations[c].sequence.slice(p+1))i.add(l.id)}return fe.ok(this.sortedMigrations.filter(({id:c})=>i.has(c)))}migratePersistedRecord(e,t,r="up"){const s=this.getMigrationsSince(t);if(!s.ok)return console.error("Error migrating record",s.error),{type:"error",reason:G.MigrationError};let i=s.value;if(i.length===0)return{type:"success",value:e};if(i.some(c=>c.scope==="store"))return{type:"error",reason:r==="down"?G.TargetVersionTooOld:G.TargetVersionTooNew};if(r==="down"){if(!i.every(c=>c.down))return{type:"error",reason:G.TargetVersionTooOld};i=i.slice().reverse()}e=ae(e);try{for(const c of i){if(c.scope==="store")throw new Error;if(!(c.filter?c.filter(e):!0))continue;const d=c[r](e);d&&(e=ae(d))}}catch(c){return console.error("Error migrating record",c),{type:"error",reason:G.MigrationError}}return{type:"success",value:e}}migrateStoreSnapshot(e){let{store:t}=e;const r=this.getMigrationsSince(e.schema);if(!r.ok)return console.error("Error migrating store",r.error),{type:"error",reason:G.MigrationError};const s=r.value;if(s.length===0)return{type:"success",value:t};t=ae(t);try{for(const i of s)if(i.scope==="record")for(const[c,f]of Object.entries(t)){if(!(i.filter?i.filter(f):!0))continue;const p=i.up(f);p&&(t[c]=ae(p))}else if(i.scope==="store"){const c=i.up(t);c&&(t=ae(c))}else Qs(i)}catch(i){return console.error("Error migrating store",i),{type:"error",reason:G.MigrationError}}return{type:"success",value:t}}createIntegrityChecker(e){var t,r;return((r=(t=this.options).createIntegrityChecker)==null?void 0:r.call(t,e))??void 0}serialize(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e,sequence:t})=>[e,t.length?$e(t.at(-1).id).version:0]))}}serializeEarliestVersion(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e})=>[e,0]))}}getType(e){const t=it(this.types,e);return I(t,"record type does not exists"),t}}Xs("@tldraw/store","3.13.3","esm");export{rr as A,_r as B,an as C,ai as D,Jn as E,nt as I,_t as R,vr as S,cr as W,$n as a,ci as b,ri as c,ui as d,Bn as e,Xe as f,it as g,on as h,Y as i,x as j,Gn as k,ks as l,ei as m,ti as n,kn as o,mr as p,Zn as q,ii as r,ni as s,xn as t,ur as u,si as v,dn as w,Qn as x,Yn as y,Xn as z};
